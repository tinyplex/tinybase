<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="preload" as="image" href="/favicon.svg"><link rel="preload" as="image" href="/vite-tinybase-sync.png"><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D1MGR8VRWJ"></script><link rel="dns-prefetch" href="https://www.googletagmanager.com/"><link href="https://www.googletagmanager.com/gtag/js?id=G-D1MGR8VRWJ" rel="preload" as="script"><link rel="preload" as="font" href="/fonts/inter.woff2" type="font/woff2" crossorigin="anonymous"><link rel="preload" as="font" href="/fonts/inconsolata.woff2" type="font/woff2" crossorigin="anonymous"><link rel="preload" as="font" href="/fonts/shantell.woff2" type="font/woff2" crossorigin="anonymous"><title>Cloudflare Durable Objects | TinyBase</title><meta name="description" content="[Durable Objects](https://developers.cloudflare.com/durable-objects/) are a new type of serverless compute platform from Cloudflare, and provide a way to run stateful applications in a serverless environment, without needing to manage infrastructure."><meta property="og:type" content="website"><meta property="og:title" content="Cloudflare Durable Objects | TinyBase"><meta property="og:description" content="[Durable Objects](https://developers.cloudflare.com/durable-objects/) are a new type of serverless compute platform from Cloudflare, and provide a way to run stateful applications in a serverless environment, without needing to manage infrastructure."><meta property="og:url" content="https://beta.tinybase.org/guides/integrations/cloudflare-durable-objects/"><meta property="og:image" content="https://beta.tinybase.org/favicon_pad.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Cloudflare Durable Objects | TinyBase"><meta name="twitter:description" content="[Durable Objects](https://developers.cloudflare.com/durable-objects/) are a new type of serverless compute platform from Cloudflare, and provide a way to run stateful applications in a serverless environment, without needing to manage infrastructure."><meta name="twitter:site" content="@tinybasejs"><meta name="twitter:image" content="https://beta.tinybase.org/favicon_pad.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="canonical" href="https://beta.tinybase.org/guides/integrations/cloudflare-durable-objects/"><link rel="stylesheet" href="/css/index.css"><script src="/js/app.js"></script></head><body><header><a href="/"><img src="/favicon.svg" alt="TinyBase logo"><span>TinyBase <em>β</em></span></a><nav><ul><li><a href="/guides/">Guides</a></li><li><a href="/demos/">Demos</a></li><li><a href="/api/">API</a></li><li><a href="https://github.com/tinyplex/tinybase">GitHub</a></li></ul></nav><span id="dark"></span></header><main><nav><ul><li id="root" class="parent open"><span></span><a href="/">TinyBase</a><ul><li id="G" class="parent open"><span></span><a href="/guides/">Guides</a><ul><li id="TB" class="parent"><span></span><a href="/guides/the-basics/">The Basics</a></li><li id="BUI" class="parent"><span></span><a href="/guides/building-uis/">Building UIs</a></li><li id="S" class="parent"><span></span><a href="/guides/schemas/">Schemas</a></li><li id="P" class="parent"><span></span><a href="/guides/persistence/">Persistence</a></li><li id="S2" class="parent"><span></span><a href="/guides/synchronization/">Synchronization</a></li><li id="I" class="parent open"><span></span><a href="/guides/integrations/">Integrations</a><ul><li id="CDO" class="current"><span></span><a href="/guides/integrations/cloudflare-durable-objects/">Cloudflare Durable Objects</a></li></ul></li><li id="UM" class="parent"><span></span><a href="/guides/using-metrics/">Using Metrics</a></li><li id="UI" class="parent"><span></span><a href="/guides/using-indexes/">Using Indexes</a></li><li id="UR" class="parent"><span></span><a href="/guides/using-relationships/">Using Relationships</a></li><li id="UC2" class="parent"><span></span><a href="/guides/using-checkpoints/">Using Checkpoints</a></li><li id="UQ" class="parent"><span></span><a href="/guides/using-queries/">Using Queries</a></li><li id="ID"><span></span><a href="/guides/inspecting-data/">Inspecting Data</a></li><li id="HTBIB" class="parent"><span></span><a href="/guides/how-tinybase-is-built/">How TinyBase Is Built</a></li><li id="FAQ"><span></span><a href="/guides/faq/">FAQ</a></li><li id="R"><span></span><a href="/guides/releases/">Releases</a></li></ul></li><li id="D2" class="parent"><span></span><a href="/demos/">Demos</a></li><li id="api" class="parent"><span></span><a href="/api/">API</a></li></ul></li></ul></nav><article><nav><ul><li><a href="/">TinyBase</a></li><li><a href="/guides/">Guides</a></li><li><a href="/guides/integrations/">Integrations</a></li><li><a href="/guides/integrations/cloudflare-durable-objects/">Cloudflare Durable Objects</a></li></ul></nav><section class="s1" id="/guides/integrations/cloudflare-durable-objects/" data-id="CDO"><h1>Cloudflare Durable Objects</h1><p><a href="https://developers.cloudflare.com/durable-objects/">Durable Objects</a> are a new type of serverless compute platform from Cloudflare, and provide a way to run stateful applications in a serverless environment, without needing to manage infrastructure.</p><h3 id="what-are-durable-objects">What Are Durable Objects?</h3><p>Each Durable Object can function as a WebSocket server, so it can co-ordinate messages between multiple clients. But importantly, it also has private, transactional and strongly consistent storage attached. Combined with a TinyBase <a href="/api/store/interfaces/store/store/"><code>Store</code></a> on the client, and using the built-in synchronization and persistence functionality, this gives you an full-stack way to build complex, real-time, multi-device (and even collaborative) apps.</p><p><embed src="/durable.svg" title="Durable Objects"></p><p>As this guide hopefully shows, this can be done with minimal effort!</p><h3 id="getting-started-with-vite"><a href="/guides/the-basics/getting-started/">Getting Started</a> with Vite</h3><p>The quickest way to get started with TinyBase and Cloudflare Durable Objects is to use our <a href="https://github.com/tinyplex/vite-tinybase-ts-react-sync-durable-object">Vite template</a>. This includes both a client implementation (that by default connects to a demo server we provide) and a server implementation that you can instead use for your own Cloudflare installation.</p><h4 id="install-the-client">Install The Client</h4><ol><li>Make a copy of the template into a new directory:</li></ol><pre><code>npx tiged tinyplex/vite-tinybase-ts-react-sync-durable-object my-tinybase-app
</code></pre><ol start="2"><li>Go into the client directory:</li></ol><pre><code><span class="builtin">cd</span> my-tinybase-app/client
</code></pre><ol start="3"><li>Install the dependencies:</li></ol><pre><code><span class="function">npm</span> <span class="function">install</span>
</code></pre><ol start="4"><li>Run the application:</li></ol><pre><code><span class="function">npm</span> run dev
</code></pre><ol start="5"><li>Go the URL shown and enjoy!</li></ol><p><img src="/vite-tinybase-sync.png" alt="Vite app" title="Vite app"></p><h4 id="run-your-own-server">Run Your Own Server</h4><p>This template uses a lightweight socket server on <code>vite.tinybase.cloud</code> to synchronize data between clients. This is fine for a demo but not intended as a production server for your apps!</p><p>If you wish to run your own instance, see the <code>server</code> directory and start from there.</p><p>The <code>vite.tinybase.cloud</code> server is hosted on Cloudflare (of course), so you should adapt the <code>wrangler.toml</code> configuration in the server directory. Update it to match your account, domains, and required configuration. In the <code>index.ts</code> file, you can configure whether data will be stored in the Durable Object or just synchronized between clients.</p><p>You will also have to have your client communicate with your new server by configuring the <code>SERVER</code> constant at the top of the client&#x27;s <code>App.tsx</code> file.</p><h3 id="how-it-all-works">How It All Works</h3><h4 id="client-persistence-and-synchronization">Client: <a href="/guides/persistence/">Persistence</a> and <a href="/guides/synchronization/">Synchronization</a></h4><p>On the client, we create a simple TinyBase <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> to encapsulate the data we need for the app. The following are simplified extracts of the code in the <code>App.tsx</code> file of the Vite template:</p><pre><code><span class="keyword">export</span> <span class="keyword">const</span> <span class="function-variable">App</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
  <span class="keyword">const</span> store <span class="operator">=</span> <span class="function"><a href="/api/ui-react/functions/store-hooks/usecreatemergeablestore/">useCreateMergeableStore</a></span><span class="punctuation">(</span>createMergeableStore<span class="punctuation">)</span><span class="punctuation">;</span>
  <span class="comment">// ...</span>
</code></pre><p>(Because the template is using React, we use the <code>useCreateMergeableStore</code> hook so it&#x27;s not re-created on every render.)</p><p>We also create a local <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> so that if the client goes offline, and the browser window is refreshed, changes will have been cached locally in session storage, with a key &#x27;foo&#x27;:</p><pre><code><span class="comment">// ...</span>
<span class="function"><a href="/api/ui-react/functions/persister-hooks/usecreatepersister/">useCreatePersister</a></span><span class="punctuation">(</span>
  store<span class="punctuation">,</span>
  <span class="punctuation">(</span><span class="parameter">store</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="function"><a href="/api/persister-browser/functions/creation/createlocalpersister/">createLocalPersister</a></span><span class="punctuation">(</span>store<span class="punctuation">,</span> <span class="string">'foo'</span><span class="punctuation">)</span><span class="punctuation">,</span>
  <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>
  <span class="keyword">async</span> <span class="punctuation">(</span><span class="parameter">persister</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
    <span class="keyword">await</span> persister<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/load/startautoload/">startAutoLoad</a></span><span class="punctuation">(</span><span class="comment">/* any initial contents */</span><span class="punctuation">)</span><span class="punctuation">;</span>
    <span class="keyword">await</span> persister<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/save/startautosave/">startAutoSave</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
  <span class="punctuation">}</span><span class="punctuation">,</span>
<span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// ...</span>
</code></pre><p>More interestingly, we also set up a <a href="/api/synchronizers/interfaces/synchronizer/synchronizer/"><code>Synchronizer</code></a> that connects to the Cloudflare installation, on a path that also happens to be called &#x27;foo&#x27;:</p><pre><code><span class="comment">// ...</span>
<span class="function"><a href="/api/ui-react/functions/synchronizer-hooks/usecreatesynchronizer/">useCreateSynchronizer</a></span><span class="punctuation">(</span>store<span class="punctuation">,</span> <span class="keyword">async</span> <span class="punctuation">(</span><span class="parameter">store</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
  <span class="keyword">const</span> synchronizer <span class="operator">=</span> <span class="keyword">await</span> <span class="function"><a href="/api/synchronizer-ws-client/functions/creation/createwssynchronizer/">createWsSynchronizer</a></span><span class="punctuation">(</span>
    store<span class="punctuation">,</span>
    <span class="keyword">new</span> <span class="class-name">WebSocket</span><span class="punctuation">(</span><span class="string">'wss://example.com/foo'</span><span class="punctuation">)</span><span class="punctuation">,</span>
  <span class="punctuation">)</span><span class="punctuation">;</span>
  <span class="keyword">await</span> synchronizer<span class="punctuation">.</span><span class="function"><a href="/api/synchronizers/interfaces/synchronizer/synchronizer/methods/synchronization/startsync/">startSync</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
  <span class="keyword">return</span> synchronizer<span class="punctuation">;</span>
<span class="punctuation">}</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre><p>Those simple lines are enough to have the <a href="/api/store/interfaces/store/store/"><code>Store</code></a> attempt to synchronize itself with the common Durable Object called <code>/foo</code> on the server.</p><h4 id="server-worker-and-durable-object">Server: Worker and Durable Object</h4><p>On the server, Cloudflare needs us to configure a worker and Durable Object. It will help if you are familiar with these concepts already - and if not, start with the documentation <a href="https://developers.cloudflare.com/durable-objects/get-started/walkthrough/">here</a>.</p><p>Following the instructions above, you&#x27;ll have a <code>wrangler.toml</code> file containing the configuration for your worker and the Durable Object. In there you&#x27;ll need to bind a namespace of Durable Objects to a class, something like:</p><pre><code><span class="punctuation">[</span><span class="punctuation">[</span><span class="table">durable_objects.bindings</span><span class="punctuation">]</span><span class="punctuation">]</span>
<span class="key">name</span> <span class="punctuation">=</span> <span class="string">"TinyBaseDurableObjects"</span>
<span class="key">class_name</span> <span class="punctuation">=</span> <span class="string">"TinyBaseDurableObject"</span>

<span class="punctuation">[</span><span class="punctuation">[</span><span class="table">migrations</span><span class="punctuation">]</span><span class="punctuation">]</span>
<span class="key">tag</span> <span class="punctuation">=</span> <span class="string">"v1"</span>
<span class="key">new_classes</span> <span class="punctuation">=</span> <span class="punctuation">[</span><span class="string">"TinyBaseDurableObject"</span><span class="punctuation">]</span>
</code></pre><p>(Again, take a look at the contents of the Vite template for the full configuration file.)</p><p>In the main worker file, probably called <code>index.js</code> or <code>index.ts</code>, you&#x27;ll need to configure the worker as the default export from the file. TinyBase provides a convenience <a href="/api/synchronizer-ws-server-durable-object/functions/creation/getwsserverdurableobjectfetch/"><code>getWsServerDurableObjectFetch</code></a> function that will create a <code>fetch</code> method that routes WebSocket requests based on the path of the URL:</p><pre><code><span class="keyword">export</span> <span class="keyword">default</span> <span class="punctuation">{</span>
  <span class="literal-property">fetch</span><span class="operator">:</span> <span class="function"><a href="/api/synchronizer-ws-server-durable-object/functions/creation/getwsserverdurableobjectfetch/">getWsServerDurableObjectFetch</a></span><span class="punctuation">(</span><span class="string">'TinyBaseDurableObjects'</span><span class="punctuation">)</span><span class="punctuation">,</span>
<span class="punctuation">}</span><span class="punctuation">;</span>
</code></pre><p>In here, the argument is the namespace containing your bound Durable Objects.</p><p>Now we need to create the Durable Object itself. This can be as simple as simply extending TinyBase&#x27;s <a href="/api/synchronizer-ws-server-durable-object/classes/creation/wsserverdurableobject/"><code>WsServerDurableObject</code></a> class:</p><pre><code><span class="keyword">export</span> <span class="keyword">class</span> <span class="class-name">TinyBaseDurableObject</span> <span class="keyword">extends</span> <span class="class-name"><a href="/api/synchronizer-ws-server-durable-object/classes/creation/wsserverdurableobject/">WsServerDurableObject</a></span> <span class="punctuation">{</span>
  <span class="comment">// ...</span>
<span class="punctuation">}</span>
</code></pre><p>This sets up synchronization between any clients that connect to this common <code>/foo</code> path so that their <a href="/api/store/interfaces/store/store/"><code>Store</code></a> data stays in sync.</p><p>But if all your clients disconnect and flush their locally-stored data, it is technically possible to lose it all! So it&#x27;s also a good idea to have the Durable Object store a synchronized copy too. We do this by overriding the <a href="/api/synchronizer-ws-server-durable-object/classes/creation/wsserverdurableobject/methods/creation/createpersister/"><code>createPersister</code></a> method:</p><pre><code><span class="comment">// ...</span>
<span class="function"><a href="/api/synchronizer-ws-server-durable-object/classes/creation/wsserverdurableobject/methods/creation/createpersister/">createPersister</a></span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="punctuation">{</span>
  <span class="keyword">return</span> <span class="function"><a href="/api/persister-durable-object-storage/functions/creation/createdurableobjectstoragepersister/">createDurableObjectStoragePersister</a></span><span class="punctuation">(</span>
    <span class="function"><a href="/api/mergeable-store/functions/creation/createmergeablestore/">createMergeableStore</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>
    <span class="keyword">this</span><span class="punctuation">.</span>ctx<span class="punctuation">.</span>storage<span class="punctuation">,</span>
  <span class="punctuation">)</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
<span class="comment">// ...</span>
</code></pre><p>In this method, all we need to do is create a <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> (that will reside in the Durable Object memory whenever it is running and not hibernated), and indicate how it will be persisted. Almost always you will want to return a <a href="/api/persister-durable-object-storage/interfaces/persister/durableobjectstoragepersister/"><code>DurableObjectStoragePersister</code></a> object, which is dedicated to storing a TinyBase <a href="/api/store/interfaces/store/store/"><code>Store</code></a> in Durable Object storage - as indicated by the <code>this.ctx.storage</code> argument.</p><p>With this in place you now have the full set up! The clients are storing a local copy of the TinyBase data so they can go offline and reload without loss of data; and the server is also storing a copy of the data in Durable Object storage. When online, the clients will connect to the worker, which routes the request to the Durable Object indicated by the URL path, and synchronization between them all keeps them each up-to-date!</p><h3 id="final-notes">Final Notes</h3><p>Durable Objects have limitations on the data that can be stored in each key of their key-value structure. The <a href="/api/persister-durable-object-storage/interfaces/persister/durableobjectstoragepersister/"><code>DurableObjectStoragePersister</code></a> uses one key per TinyBase <a href="/api/store/type-aliases/store/value/"><code>Value</code></a>, one key per <a href="/api/store/type-aliases/store/cell/"><code>Cell</code></a>, one key per <a href="/api/store/type-aliases/store/row/"><code>Row</code></a>, and one key per <a href="/api/store/type-aliases/store/table/"><code>Table</code></a>. Mostly this is CRDT metadata, but the main caution is to ensure that each individual TinyBase <a href="/api/store/type-aliases/store/cell/"><code>Cell</code></a> and <a href="/api/store/type-aliases/store/value/"><code>Value</code></a> data does not exceed the (128 KiB) limit.</p><p>The <a href="/api/synchronizer-ws-server-durable-object/classes/creation/wsserverdurableobject/"><code>WsServerDurableObject</code></a> is an overridden implementation of the DurableObject class, so you can have access to its members as well as the TinyBase-specific methods. If you are using the storage for other data, you may want to configure a <code>prefix</code> parameter to ensure you don&#x27;t accidentally collide with TinyBase data.</p><p>Also, always remember to call the <code>super</code> implementations of the methods that TinyBase uses (the constructor, <code>fetch</code>, <code>webSocketMessage</code>, and <code>webSocketClose</code>) if you further override them.</p><p>Finally, the <a href="/api/synchronizer-ws-server-durable-object/classes/creation/wsserverdurableobject/"><code>WsServerDurableObject</code></a> uses hibernation, which is a Cloudflare feature to minimize the amount of memory used by your Durable Object. After a small amount of time with no WebSocket activity, it will be &#x27;hibernated&#x27; even though the WebSockets stay connected. This means that the in-memory TinyBase <a href="/api/store/interfaces/store/store/"><code>Store</code></a> will be removed (which is a good thing for your Cloudflare usage!) and then re-created with the <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> when new activity arrives. This lifecycle should be transparent, but should be understood if you want to debug certain Durable Object behaviors.</p></section></article><aside></aside></main><footer><nav><a id="gh" href="https://github.com/tinyplex/tinybase" target="_blank">GitHub</a><a id="bs" href="https://bsky.app/profile/tinybase.bsky.social" target="_blank">Bluesky</a><a id="tw" href="https://x.com/tinybasejs" target="_blank">X / Twitter</a><a id="dc" href="https://discord.com/invite/mGz3mevwP8" target="_blank">Discord</a></nav><nav><a href="/">TinyBase <span id="version"></span></a> © 2022-</nav></footer><script>window.dataLayer=window.dataLayer||[];function g(){dataLayer.push(arguments);}g('js',new Date());g('config','G-D1MGR8VRWJ');</script></body></html>