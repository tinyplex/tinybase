<nav><ul><li><a href="/">TinyBase</a></li><li><a href="/guides/">Guides</a></li><li><a href="/guides/synchronization/">Synchronization</a></li><li><a href="/guides/synchronization/using-a-mergeablestore/">Using A MergeableStore</a></li></ul></nav><section class="s1" id="/guides/synchronization/using-a-mergeablestore/" data-id="UAMS"><h1>Using A MergeableStore</h1><p>The basic building block of <a href="/">TinyBase</a>&#x27;s synchronization system is the <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> interface.</p><h3 id="the-anatomy-of-a-mergeablestore">The Anatomy Of A <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a></h3><p>The <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> interface is a sub-type of the regular <a href="/api/store/interfaces/store/store/"><code>Store</code></a> - and it shares its underlying implementation.</p><p>This means that if you want to add synchronization to your app, all of your existing calls to the <a href="/api/store/interfaces/store/store/"><code>Store</code></a> methods will be unchanged - you just need to use the <a href="/api/mergeable-store/functions/creation/createmergeablestore/"><code>createMergeableStore</code></a> function to instantiate it, instead of the classic <a href="/api/store/functions/creation/createstore/"><code>createStore</code></a> function.</p><pre><code><span class="keyword">import</span> <span class="punctuation">{</span>createMergeableStore<span class="punctuation">}</span> <span class="keyword">from</span> <span class="string">'tinybase'</span><span class="punctuation">;</span>

<span class="keyword">const</span> store1 <span class="operator">=</span> <span class="function"><a href="/api/mergeable-store/functions/creation/createmergeablestore/">createMergeableStore</a></span><span class="punctuation">(</span><span class="string">'store1'</span><span class="punctuation">)</span><span class="punctuation">;</span>
store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setcell/">setCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'species'</span><span class="punctuation">,</span> <span class="string">'dog'</span><span class="punctuation">)</span><span class="punctuation">;</span>

console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/getcontent/">getContent</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> [{pets: {fido: {species: 'dog'}}}, {}]</span>
</code></pre><p>The difference, though, is that a <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> records additional metadata as the data is changed so that potential conflicts between it and another instance can be reconciled. This metadata is intended to be opaque, but you can see it if you call the <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/methods/getter/getmergeablecontent/"><code>getMergeableContent</code></a> method:</p><pre><code>console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store1<span class="punctuation">.</span><span class="function"><a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/methods/getter/getmergeablecontent/">getMergeableContent</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -></span>
<span class="punctuation">[</span>
  <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="literal-property">pets</span><span class="operator">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
          <span class="literal-property">fido</span><span class="operator">:</span> <span class="punctuation">[</span>
            <span class="punctuation">{</span><span class="literal-property">species</span><span class="operator">:</span> <span class="punctuation">[</span><span class="string">'dog'</span><span class="punctuation">,</span> <span class="string">'Nn1JUF-----FnHIC'</span><span class="punctuation">,</span> <span class="number">290599168</span><span class="punctuation">]</span><span class="punctuation">}</span><span class="punctuation">,</span>
            <span class="string">''</span><span class="punctuation">,</span>
            <span class="number">2682656941</span><span class="punctuation">,</span>
          <span class="punctuation">]</span><span class="punctuation">,</span>
        <span class="punctuation">}</span><span class="punctuation">,</span>
        <span class="string">''</span><span class="punctuation">,</span>
        <span class="number">2102515304</span><span class="punctuation">,</span>
      <span class="punctuation">]</span><span class="punctuation">,</span>
    <span class="punctuation">}</span><span class="punctuation">,</span>
    <span class="string">''</span><span class="punctuation">,</span>
    <span class="number">3506229770</span><span class="punctuation">,</span>
  <span class="punctuation">]</span><span class="punctuation">,</span>
  <span class="punctuation">[</span><span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span> <span class="string">''</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">]</span><span class="punctuation">,</span>
<span class="punctuation">]</span><span class="punctuation">;</span>
</code></pre><p>Without going into the detail of this, the main point to understand is that each update gets a timestamp, based on a hybrid logical clock (HLC), and a hash. As a result, <a href="/">TinyBase</a> is able to understand which parts of the data have changed, and which changes are the most recent. The resulting &#x27;last write wins&#x27; (LWW) approach allows the <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> to act as a Conflict-Free Replicated Data Type (CRDT).</p><p>(Notice we provided an explicit <code>uniqueId</code> when we initialized the <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a>: this is not normally required, but here it just ensures the hashes in the example are deterministic).</p><p>We can of course, create a second <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> with different data:</p><pre><code><span class="keyword">const</span> store2 <span class="operator">=</span> <span class="function"><a href="/api/mergeable-store/functions/creation/createmergeablestore/">createMergeableStore</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setcell/">setCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'felix'</span><span class="punctuation">,</span> <span class="string">'species'</span><span class="punctuation">,</span> <span class="string">'cat'</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre><p>And now merge them together with the convenient <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/methods/setter/merge/"><code>merge</code></a> method:</p><pre><code>store1<span class="punctuation">.</span><span class="function"><a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/methods/setter/merge/">merge</a></span><span class="punctuation">(</span>store2<span class="punctuation">)</span><span class="punctuation">;</span>

console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/getcontent/">getContent</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> [{pets: {felix: {species: 'cat'}, fido: {species: 'dog'}}}, {}]</span>

console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/getcontent/">getContent</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> [{pets: {felix: {species: 'cat'}, fido: {species: 'dog'}}}, {}]</span>
</code></pre><p>Magic!</p><p>This all said, it&#x27;s very unlikely you will need to use the numerous extra methods available on a <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> (compared to a <a href="/api/store/interfaces/store/store/"><code>Store</code></a>) since most of them exist to support synchronization behind the scenes.</p><p>In general, you&#x27;ll just use a <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> in the same was as you would have used a <a href="/api/store/interfaces/store/store/"><code>Store</code></a>, and instead rely on the more approachable <a href="/api/synchronizers/interfaces/synchronizer/synchronizer/"><code>Synchronizer</code></a> API for synchronization. We&#x27;ll discuss this next in the <a href="/guides/synchronization/using-a-synchronizer/">Using A Synchronizer</a> guide.</p><h2 id="persisting-a-mergeablestore">Persisting A <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a></h2><p>Once important thing that you need to be aware of is that a <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> cannot currently be persisted by every type of <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> available to a regular <a href="/api/store/interfaces/store/store/"><code>Store</code></a>. This is partly because some are already designed to work with alternative third-party CRDT systems (like the <a href="/api/persister-yjs/interfaces/persister/yjspersister/"><code>YjsPersister</code></a> and <a href="/api/persister-automerge/interfaces/persister/automergepersister/"><code>AutomergePersister</code></a>), and partly because this extra metadata cannot be easily stored in a plain SQLite database.</p><p>The following <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> types <em>can</em> be used to persist a <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a>:</p><div class="table"><table><thead><tr><th><a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a></th><th>Storage</th></tr></thead><tbody><tr><td><a href="/api/persister-browser/interfaces/persister/sessionpersister/"><code>SessionPersister</code></a></td><td>Browser session storage</td></tr><tr><td><a href="/api/persister-browser/interfaces/persister/localpersister/"><code>LocalPersister</code></a></td><td>Browser local storage</td></tr><tr><td><a href="/api/persister-file/interfaces/persister/filepersister/"><code>FilePersister</code></a></td><td>Local file (where possible)</td></tr></tbody></table></div><p>The following database-oriented <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> types can be used to persist a <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a>, but <em>only</em> in the &#x27;JSON-serialization&#x27; mode:</p><div class="table"><table><thead><tr><th><a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a></th><th>Storage</th></tr></thead><tbody><tr><td><a href="/api/persister-sqlite3/interfaces/persister/sqlite3persister/"><code>Sqlite3Persister</code></a></td><td>SQLite in Node, via <a href="https://github.com/TryGhost/node-sqlite3">sqlite3</a></td></tr><tr><td><a href="/api/persister-sqlite-wasm/interfaces/persister/sqlitewasmpersister/"><code>SqliteWasmPersister</code></a></td><td>SQLite in a browser, via <a href="https://github.com/tomayac/sqlite-wasm">sqlite-wasm</a></td></tr><tr><td><a href="/api/persister-expo-sqlite/interfaces/persister/exposqlitepersister/"><code>ExpoSqlitePersister</code></a></td><td>SQLite in React Native, via <a href="https://github.com/expo/expo/tree/main/packages/expo-sqlite">expo-sqlite</a></td></tr><tr><td><a href="/api/persister-postgres/interfaces/persister/postgrespersister/"><code>PostgresPersister</code></a></td><td>PostgreSQL, via <a href="https://github.com/porsager/postgres">postgres</a></td></tr></tbody></table></div><p>The following database-oriented <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> types <em>cannot</em> currently be used to persist a <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a>:</p><div class="table"><table><thead><tr><th><a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a></th><th>Storage</th></tr></thead><tbody><tr><td><a href="/api/persister-indexed-db/interfaces/persister/indexeddbpersister/"><code>IndexedDbPersister</code></a></td><td>Browser IndexedDB</td></tr><tr><td><a href="/api/persister-remote/interfaces/persister/remotepersister/"><code>RemotePersister</code></a></td><td>Remote server</td></tr><tr><td><a href="/api/persister-cr-sqlite-wasm/interfaces/persister/crsqlitewasmpersister/"><code>CrSqliteWasmPersister</code></a></td><td>SQLite CRDTs, via <a href="https://github.com/vlcn-io/cr-sqlite">cr-sqlite-wasm</a></td></tr><tr><td><a href="/api/persister-electric-sql/interfaces/persister/electricsqlpersister/"><code>ElectricSqlPersister</code></a></td><td>Electric SQL, via <a href="https://github.com/electric-sql/electric">electric-sql</a></td></tr><tr><td><a href="/api/persister-libsql/interfaces/persister/libsqlpersister/"><code>LibSqlPersister</code></a></td><td>LibSQL for Turso, via <a href="https://github.com/tursodatabase/libsql-client-ts">libsql-client</a></td></tr><tr><td><a href="/api/persister-powersync/interfaces/persister/powersyncpersister/"><code>PowerSyncPersister</code></a></td><td>PowerSync, via <a href="https://github.com/powersync-ja/powersync-js">powersync-sdk</a></td></tr><tr><td><a href="/api/persister-yjs/interfaces/persister/yjspersister/"><code>YjsPersister</code></a></td><td>Yjs CRDTs, via <a href="https://github.com/yjs/yjs">yjs</a></td></tr><tr><td><a href="/api/persister-automerge/interfaces/persister/automergepersister/"><code>AutomergePersister</code></a></td><td>Automerge CRDTs, via <a href="https://github.com/automerge/automerge-repo">automerge-repo</a></td></tr><tr><td><a href="/api/persister-partykit-client/interfaces/persister/partykitpersister/"><code>PartyKitPersister</code></a></td><td><a href="https://www.partykit.io/">PartyKit</a>, via the <a href="/api/persister-partykit-server/"><code>persister-partykit-server</code></a> module</td></tr></tbody></table></div><p>Next, let&#x27;s see how to synchronize <a href="/api/mergeable-store/interfaces/mergeable/mergeablestore/"><code>MergeableStore</code></a> objects together with the <a href="/api/synchronizers/"><code>synchronizers</code></a> module. Please continue on to the <a href="/guides/synchronization/using-a-synchronizer/">Using A Synchronizer</a> guide.</p></section>