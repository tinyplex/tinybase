<nav><ul><li><a href="/">TinyBase</a></li><li><a href="/guides/">Guides</a></li><li><a href="/guides/schemas-and-persistence/">Schemas And Persistence</a></li><li><a href="/guides/schemas-and-persistence/synchronizing-data/">Synchronizing Data</a></li></ul></nav><section class="s1" id="/guides/schemas-and-persistence/synchronizing-data/" data-id="SD"><h1>Synchronizing Data</h1><p>Some persister modules let you save and load <a href="/api/store/interfaces/store/store/"><code>Store</code></a> data to underlying storage types that can provide synchronization, local-first reconciliation, and CRDTs.</p><p>These include:</p><ul><li>The <a href="/api/persister-yjs/functions/creation/createyjspersister/"><code>createYjsPersister</code></a> function (in the <a href="/api/persister-yjs/"><code>persister-yjs</code></a> module) returns a <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> that connects to a <a href="https://yjs.dev/">Yjs</a> document.</li><li>The <a href="/api/persister-automerge/functions/creation/createautomergepersister/"><code>createAutomergePersister</code></a> function (in the <a href="/api/persister-automerge/"><code>persister-automerge</code></a> module) returns a <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> that connects to an <a href="https://automerge.org/">Automerge</a> document via <a href="https://github.com/automerge/automerge-repo">automerge-repo</a>.</li></ul><p>The APIs are exactly the same as for other persisters, but there is some additional infrastructure behind the scenes to ensure that the updates are as incremental and atomic as possible, improving the reconciliation capabilities.</p><h3 id="a-synchronization-walkthrough">A Synchronization Walkthrough</h3><p>For fully-fledged synchronization, you will want to use both auto-load and auto-save between the <a href="/api/store/interfaces/store/store/"><code>Store</code></a> and the underlying synchronization framework.</p><p>In this case, we have two Yjs documents that are each bound to their respective <a href="/api/store/interfaces/store/store/"><code>Store</code></a> objects by a <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> with auto-load and auto-save:</p><pre><code><span class="keyword">const</span> doc1 <span class="operator">=</span> <span class="keyword">new</span> <span class="class-name">Y<span class="punctuation">.</span>Doc</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">const</span> store1 <span class="operator">=</span> <span class="function"><a href="/api/store/functions/creation/createstore/">createStore</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">const</span> persister1 <span class="operator">=</span> <span class="function"><a href="/api/persister-yjs/functions/creation/createyjspersister/">createYjsPersister</a></span><span class="punctuation">(</span>store1<span class="punctuation">,</span> doc1<span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> persister1<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/load/startautoload/">startAutoLoad</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> persister1<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/save/startautosave/">startAutoSave</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>

<span class="keyword">const</span> doc2 <span class="operator">=</span> <span class="keyword">new</span> <span class="class-name">Y<span class="punctuation">.</span>Doc</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">const</span> store2 <span class="operator">=</span> <span class="function"><a href="/api/store/functions/creation/createstore/">createStore</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">const</span> persister2 <span class="operator">=</span> <span class="function"><a href="/api/persister-yjs/functions/creation/createyjspersister/">createYjsPersister</a></span><span class="punctuation">(</span>store2<span class="punctuation">,</span> doc2<span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> persister2<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/load/startautoload/">startAutoLoad</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> persister2<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/save/startautosave/">startAutoSave</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre><p>Typically, real-world synchronization for Yjs happens between two systems via a Yjs connection provider with state machine vectors and so on. For the purposes of illustration here, we synthesize that with a simple <code>syncDocs</code> function that copies full state between the documents:</p><pre><code><span class="keyword">const</span> <span class="function-variable">syncDocs</span> <span class="operator">=</span> <span class="keyword">async</span> <span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
  <span class="comment">// ...</span>
  <span class="constant">Y</span><span class="punctuation">.</span><span class="function">applyUpdate</span><span class="punctuation">(</span>doc1<span class="punctuation">,</span> <span class="constant">Y</span><span class="punctuation">.</span><span class="function">encodeStateAsUpdate</span><span class="punctuation">(</span>doc2<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
  <span class="constant">Y</span><span class="punctuation">.</span><span class="function">applyUpdate</span><span class="punctuation">(</span>doc2<span class="punctuation">,</span> <span class="constant">Y</span><span class="punctuation">.</span><span class="function">encodeStateAsUpdate</span><span class="punctuation">(</span>doc1<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="punctuation">}</span><span class="punctuation">;</span>
</code></pre><p>It is good practice to establish a synchronization baseline between the Stores:</p><pre><code><span class="keyword">await</span> <span class="function">syncDocs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre><p>Now imagine that we make a change to one of the Stores, and synchronize again:</p><pre><code>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/settables/">setTables</a></span><span class="punctuation">(</span><span class="punctuation">{</span><span class="literal-property">pets</span><span class="operator">:</span> <span class="punctuation">{</span><span class="literal-property">fido</span><span class="operator">:</span> <span class="punctuation">{</span><span class="literal-property">species</span><span class="operator">:</span> <span class="string">'dog'</span><span class="punctuation">}</span><span class="punctuation">}</span><span class="punctuation">}</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> <span class="function">syncDocs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre><p>If all goes well, we should see those changes in the other <a href="/api/store/interfaces/store/store/"><code>Store</code></a>!</p><pre><code>console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/gettables/">getTables</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> {pets: {fido: {species: 'dog'}}}</span>
</code></pre><p>And of course we can make changes propagate back again:</p><pre><code>store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setvalue/">setValue</a></span><span class="punctuation">(</span><span class="string">'open'</span><span class="punctuation">,</span> <span class="boolean">true</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> <span class="function">syncDocs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/getvalues/">getValues</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> {open: true}</span>
</code></pre><h3 id="conflicts">Conflicts</h3><p><a href="/">TinyBase</a> deliberately avoids having an opinion on simultaneous or conflicting updates, deferring that to the underlying CRDT framework. However, most changes are dealt with as atomically as possible - in other words at a <a href="/api/store/type-aliases/store/cell/"><code>Cell</code></a> or <a href="/api/store/type-aliases/store/value/"><code>Value</code></a> level - in order to limit data loss by default.</p><p>Here we update two adjacent Cells in the same <a href="/api/store/type-aliases/store/row/"><code>Row</code></a>:</p><pre><code>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setcell/">setCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'color'</span><span class="punctuation">,</span> <span class="string">'brown'</span><span class="punctuation">)</span><span class="punctuation">;</span>
store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setcell/">setCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'legs'</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// ...</span>
<span class="keyword">await</span> <span class="function">syncDocs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/gettables/">getTables</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> {pets: {fido: {species: 'dog', color: 'brown', 'legs': 4}}}</span>
console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/gettables/">getTables</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> {pets: {fido: {species: 'dog', color: 'brown', 'legs': 4}}}</span>
</code></pre><p>If there are two conflicting changes to the same <a href="/api/store/type-aliases/store/cell/"><code>Cell</code></a>, Yjs typically runs a tie-break based on the client ID of the document, where the higher one wins.</p><pre><code><span class="comment">// Here we force the clientID so that the reconciliation is deterministic.</span>
doc1<span class="punctuation">.</span>clientID <span class="operator">=</span> <span class="number">1</span><span class="punctuation">;</span>
doc2<span class="punctuation">.</span>clientID <span class="operator">=</span> <span class="number">2</span><span class="punctuation">;</span>

store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setcell/">setCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'price'</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">;</span>
store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setcell/">setCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'price'</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// ...</span>
<span class="keyword">await</span> <span class="function">syncDocs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/getcell/">getCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'price'</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> 5</span>
console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/getcell/">getCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'price'</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> 5</span>
</code></pre><p>However, in production use, you are highly discouraged from setting the clientID yourself, and hence the reconciliation will not be deterministic without manual resolution.</p></section>