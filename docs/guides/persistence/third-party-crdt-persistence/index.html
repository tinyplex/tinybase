<!DOCTYPE html><html lang="en"><head><link rel="dns-prefetch" href="https://www.googletagmanager.com/"><link href="https://www.googletagmanager.com/gtag/js?id=G-D1MGR8VRWJ" rel="preload" as="script"><link rel="preload" as="font" href="/fonts/inter.woff2" type="font/woff2" crossorigin="anonymous"><link rel="preload" as="font" href="/fonts/inconsolata.woff2" type="font/woff2" crossorigin="anonymous"><link rel="preload" as="font" href="/fonts/icons.woff2" type="font/woff2" crossorigin="anonymous"><link rel="preload" as="font" href="/fonts/shantell.woff2" type="font/woff2" crossorigin="anonymous"><title>Third-Party CRDT Persistence | TinyBase</title><meta name="description" content="Some persister modules let you save and load Store data to underlying storage types that can provide synchronization, local-first reconciliation, and CRDTs."><meta property="og:type" content="website"><meta property="og:title" content="Third-Party CRDT Persistence | TinyBase"><meta property="og:description" content="Some persister modules let you save and load Store data to underlying storage types that can provide synchronization, local-first reconciliation, and CRDTs."><meta property="og:url" content="https://beta.tinybase.org/guides/persistence/third-party-crdt-persistence/"><meta property="og:image" content="https://beta.tinybase.org/favicon_pad.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Third-Party CRDT Persistence | TinyBase"><meta name="twitter:description" content="Some persister modules let you save and load Store data to underlying storage types that can provide synchronization, local-first reconciliation, and CRDTs."><meta name="twitter:site" content="@tinybasejs"><meta name="twitter:image" content="https://beta.tinybase.org/favicon_pad.png"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="stylesheet" href="/css/index.css"><link rel="canonical" href="https://beta.tinybase.org/guides/persistence/third-party-crdt-persistence/"><script src="/js/app.js"></script></head><body><header><a href="/"><img src="/favicon.svg" alt="TinyBase logo"><span>TinyBase <em title="5.0.0-beta.27">β</em></span></a><nav><ul><li><a href="/guides/">Guides</a></li><li><a href="/demos/">Demos</a></li><li><a href="/api/">API</a></li><li><a href="https://github.com/tinyplex/tinybase">GitHub</a></li></ul></nav><span id="dark"></span></header><main><nav><ul><li id="root" class="parent open"><span></span><a href="/">TinyBase</a><ul><li id="G" class="parent open"><span></span><a href="/guides/">Guides</a><ul><li id="TB" class="parent"><span></span><a href="/guides/the-basics/">The Basics</a></li><li id="BUI" class="parent"><span></span><a href="/guides/building-uis/">Building UIs</a></li><li id="S" class="parent"><span></span><a href="/guides/schemas/">Schemas</a></li><li id="P" class="parent open"><span></span><a href="/guides/persistence/">Persistence</a><ul><li id="AITP"><span></span><a href="/guides/persistence/an-intro-to-persistence/">An Intro To Persistence</a></li><li id="DP"><span></span><a href="/guides/persistence/database-persistence/">Database Persistence</a></li><li id="TPCRDTP" class="current"><span></span><a href="/guides/persistence/third-party-crdt-persistence/">Third-Party CRDT Persistence</a></li><li id="CP"><span></span><a href="/guides/persistence/custom-persistence/">Custom Persistence</a></li></ul></li><li id="S2"><span></span><a href="/guides/synchronization/">Synchronization</a></li><li id="UM" class="parent"><span></span><a href="/guides/using-metrics/">Using Metrics</a></li><li id="UI" class="parent"><span></span><a href="/guides/using-indexes/">Using Indexes</a></li><li id="UR" class="parent"><span></span><a href="/guides/using-relationships/">Using Relationships</a></li><li id="UC2" class="parent"><span></span><a href="/guides/using-checkpoints/">Using Checkpoints</a></li><li id="UQ" class="parent"><span></span><a href="/guides/using-queries/">Using Queries</a></li><li id="DT" class="parent"><span></span><a href="/guides/developer-tools/">Developer Tools</a></li><li id="HTBIB" class="parent"><span></span><a href="/guides/how-tinybase-is-built/">How TinyBase Is Built</a></li><li id="FAQ"><span></span><a href="/guides/faq/">FAQ</a></li><li id="R"><span></span><a href="/guides/releases/">Releases</a></li></ul></li><li id="D2" class="parent"><span></span><a href="/demos/">Demos</a></li><li id="api" class="parent"><span></span><a href="/api/">API</a></li></ul></li></ul></nav><article><nav><ul><li><a href="/">TinyBase</a></li><li><a href="/guides/">Guides</a></li><li><a href="/guides/persistence/">Persistence</a></li><li><a href="/guides/persistence/third-party-crdt-persistence/">Third-Party CRDT Persistence</a></li></ul></nav><section class="s1" id="/guides/persistence/third-party-crdt-persistence/" data-id="TPCRDTP"><h1>Third-Party CRDT Persistence</h1><p>Some persister modules let you save and load <a href="/api/store/interfaces/store/store/"><code>Store</code></a> data to underlying storage types that can provide synchronization, local-first reconciliation, and CRDTs.</p><div class="table"><table><thead><tr><th><a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a></th><th>Storage</th></tr></thead><tbody><tr><td><a href="/api/persister-yjs/interfaces/persister/yjspersister/"><code>YjsPersister</code></a></td><td>Yjs CRDTs, via <a href="https://github.com/yjs/yjs">yjs</a></td></tr><tr><td><a href="/api/persister-automerge/interfaces/persister/automergepersister/"><code>AutomergePersister</code></a></td><td>Automerge CRDTs, via <a href="https://github.com/automerge/automerge-repo">automerge-repo</a></td></tr></tbody></table></div><p>The APIs are exactly the same as for other persisters, but there is some additional infrastructure behind the scenes to ensure that the updates are as incremental and atomic as possible, improving the reconciliation capabilities.</p><p>For <a href="/">TinyBase</a> v5&#x27;s first-party CRDT and synchronization techniques, see instead the <a href="/guides/synchronization/">Synchronization</a> guides.</p><h3 id="a-synchronization-walkthrough">A <a href="/guides/synchronization/">Synchronization</a> Walkthrough</h3><p>For fully-fledged synchronization with a third-party framework, you will want to use both auto-load and auto-save between the <a href="/api/store/interfaces/store/store/"><code>Store</code></a> and the underlying synchronization framework.</p><p>In this case, we have two Yjs documents that are each bound to their respective <a href="/api/store/interfaces/store/store/"><code>Store</code></a> objects by a <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> with auto-load and auto-save:</p><pre><code><span class="keyword">import</span> <span class="punctuation">{</span>Doc<span class="punctuation">}</span> <span class="keyword">from</span> <span class="string">'yjs'</span><span class="punctuation">;</span>
<span class="keyword">import</span> <span class="punctuation">{</span>createStore<span class="punctuation">}</span> <span class="keyword">from</span> <span class="string">'tinybase'</span><span class="punctuation">;</span>
<span class="keyword">import</span> <span class="punctuation">{</span>createYjsPersister<span class="punctuation">}</span> <span class="keyword">from</span> <span class="string">'tinybase/persisters/persister-yjs'</span><span class="punctuation">;</span>

<span class="keyword">const</span> doc1 <span class="operator">=</span> <span class="keyword">new</span> <span class="class-name">Doc</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">const</span> store1 <span class="operator">=</span> <span class="function"><a href="/api/store/functions/creation/createstore/">createStore</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">const</span> persister1 <span class="operator">=</span> <span class="function"><a href="/api/persister-yjs/functions/creation/createyjspersister/">createYjsPersister</a></span><span class="punctuation">(</span>store1<span class="punctuation">,</span> doc1<span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> persister1<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/load/startautoload/">startAutoLoad</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> persister1<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/save/startautosave/">startAutoSave</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>

<span class="keyword">const</span> doc2 <span class="operator">=</span> <span class="keyword">new</span> <span class="class-name">Doc</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">const</span> store2 <span class="operator">=</span> <span class="function"><a href="/api/store/functions/creation/createstore/">createStore</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">const</span> persister2 <span class="operator">=</span> <span class="function"><a href="/api/persister-yjs/functions/creation/createyjspersister/">createYjsPersister</a></span><span class="punctuation">(</span>store2<span class="punctuation">,</span> doc2<span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> persister2<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/load/startautoload/">startAutoLoad</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> persister2<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/save/startautosave/">startAutoSave</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre><p>Typically, real-world synchronization for Yjs happens between two systems via a Yjs connection provider with state machine vectors and so on. For the purposes of illustration here, we synthesize that with a simple <code>syncDocs</code> function that copies full state between the documents:</p><pre><code><span class="keyword">import</span> <span class="punctuation">{</span>applyUpdate<span class="punctuation">,</span> encodeStateAsUpdate<span class="punctuation">}</span> <span class="keyword">from</span> <span class="string">'yjs'</span><span class="punctuation">;</span>

<span class="keyword">const</span> <span class="function-variable">syncDocs</span> <span class="operator">=</span> <span class="keyword">async</span> <span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
  <span class="comment">// ...</span>
  <span class="function">applyUpdate</span><span class="punctuation">(</span>doc1<span class="punctuation">,</span> <span class="function">encodeStateAsUpdate</span><span class="punctuation">(</span>doc2<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
  <span class="function">applyUpdate</span><span class="punctuation">(</span>doc2<span class="punctuation">,</span> <span class="function">encodeStateAsUpdate</span><span class="punctuation">(</span>doc1<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="punctuation">}</span><span class="punctuation">;</span>
</code></pre><p>It is good practice to establish a synchronization baseline between the Stores:</p><pre><code><span class="keyword">await</span> <span class="function">syncDocs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre><p>Now imagine that we make a change to one of the Stores, and synchronize again:</p><pre><code>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/settables/">setTables</a></span><span class="punctuation">(</span><span class="punctuation">{</span><span class="literal-property">pets</span><span class="operator">:</span> <span class="punctuation">{</span><span class="literal-property">fido</span><span class="operator">:</span> <span class="punctuation">{</span><span class="literal-property">species</span><span class="operator">:</span> <span class="string">'dog'</span><span class="punctuation">}</span><span class="punctuation">}</span><span class="punctuation">}</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> <span class="function">syncDocs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre><p>If all goes well, we should see those changes in the other <a href="/api/store/interfaces/store/store/"><code>Store</code></a>!</p><pre><code>console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/gettables/">getTables</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> {pets: {fido: {species: 'dog'}}}</span>
</code></pre><p>And of course we can make changes propagate back again:</p><pre><code>store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setvalue/">setValue</a></span><span class="punctuation">(</span><span class="string">'open'</span><span class="punctuation">,</span> <span class="boolean">true</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="keyword">await</span> <span class="function">syncDocs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/getvalues/">getValues</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> {open: true}</span>
</code></pre><h3 id="conflicts">Conflicts</h3><p><a href="/">TinyBase</a> deliberately avoids having an opinion on simultaneous or conflicting updates, deferring that to the underlying CRDT framework. However, most changes are dealt with as atomically as possible - in other words at a <a href="/api/store/type-aliases/store/cell/"><code>Cell</code></a> or <a href="/api/store/type-aliases/store/value/"><code>Value</code></a> level - in order to limit data loss by default.</p><p>Here we update two adjacent Cells in the same <a href="/api/store/type-aliases/store/row/"><code>Row</code></a>:</p><pre><code>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setcell/">setCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'color'</span><span class="punctuation">,</span> <span class="string">'brown'</span><span class="punctuation">)</span><span class="punctuation">;</span>
store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setcell/">setCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'legs'</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// ...</span>
<span class="keyword">await</span> <span class="function">syncDocs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/gettables/">getTables</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> {pets: {fido: {species: 'dog', color: 'brown', 'legs': 4}}}</span>
console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/gettables/">getTables</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> {pets: {fido: {species: 'dog', color: 'brown', 'legs': 4}}}</span>
</code></pre><p>If there are two conflicting changes to the same <a href="/api/store/type-aliases/store/cell/"><code>Cell</code></a>, Yjs typically runs a tie-break based on the client ID of the document, where the higher one wins.</p><pre><code><span class="comment">// Here we force the clientID so that the reconciliation is deterministic.</span>
doc1<span class="punctuation">.</span>clientID <span class="operator">=</span> <span class="number">1</span><span class="punctuation">;</span>
doc2<span class="punctuation">.</span>clientID <span class="operator">=</span> <span class="number">2</span><span class="punctuation">;</span>

store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setcell/">setCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'price'</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">;</span>
store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/setter/setcell/">setCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'price'</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// ...</span>
<span class="keyword">await</span> <span class="function">syncDocs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store1<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/getcell/">getCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'price'</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> 5</span>
console<span class="punctuation">.</span><span class="function">log</span><span class="punctuation">(</span>store2<span class="punctuation">.</span><span class="function"><a href="/api/store/interfaces/store/store/methods/getter/getcell/">getCell</a></span><span class="punctuation">(</span><span class="string">'pets'</span><span class="punctuation">,</span> <span class="string">'fido'</span><span class="punctuation">,</span> <span class="string">'price'</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="comment">// -> 5</span>
</code></pre><p>However, in production use, you are highly discouraged from setting the clientID yourself, and hence the reconciliation will not be deterministic without manual resolution.</p></section></article><aside></aside></main><footer><nav><a id="tw" href="https://twitter.com/tinybasejs" target="_blank">Twitter</a><a id="fb" href="https://facebook.com/tinybasejs" target="_blank">Facebook</a></nav><nav><a href="/">TinyBase 5.0.0-beta.27</a> © 2021- All Rights Reserved</nav></footer></body><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D1MGR8VRWJ"></script><script>window.dataLayer=window.dataLayer||[];function g(){dataLayer.push(arguments);}g('js',new Date());g('config','G-D1MGR8VRWJ');</script></html>