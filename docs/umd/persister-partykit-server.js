var a,t;a=this,t=function(a){"use strict";const t=a=>typeof a,e=t(""),s="t",n=(a,t)=>a.startsWith(t),i=Promise,r=a=>null==a,o=(a,t,e)=>r(a)?e?.():t(a),c=(a,t,e)=>a.slice(t,e),l=a=>a.length,f=async a=>i.all(a),y=(a,t)=>a.map(t),h=(a,...t)=>a.push(...t),g=Object,w=(a=[])=>g.fromEntries(a),u=(a,t)=>y(g.entries(a),(([a,e])=>t(e,a))),d=(a,t,e)=>(((a,t)=>!r(((a,t)=>o(a,(a=>a[t])))(a,t)))(a,t)||(a[t]=e()),a[t]),p=a=>JSON.stringify(a,((a,t)=>t instanceof Map?g.fromEntries([...t]):t)),S=JSON.parse,P=(a,s,n)=>a+s+(t(n)==e?n:p(n)),m=(a,t,e)=>{const s=l(a);return n(t,a)?[t[s],(e?S:String)(c(t,s+1))]:void 0},x=(a,t)=>((a,t)=>a?.forEach(t))(a,((a,e)=>t(e,a))),b="hasStore",T=w(y(["Origin","Methods","Headers"],(a=>["Access-Control-Allow-"+a,"*"]))),D=async(a,t="")=>!!await a.get(t+b),v=async(a,t="")=>{const e={},n={};return x(await a.list(),((a,i)=>o(m(t,a),(([a,t])=>{if(a==s){const[a,s,n]=S("["+t+"]");d(d(e,a,w),s,w)[n]=i}else"v"==a&&(n[t]=i)})))),[e,n]},R=async(a,t,e)=>a.party.broadcast(P(a.config.messagePrefix,"s",t),e),C=async(a,t,e,i)=>{const o=a.party.storage,c=a.config.storagePrefix,y={[c+b]:1},g=[],w=[];await f(u(t[0],(async(t,n)=>r(t)?!e&&await a.canDelTable(n,i)&&((a,...t)=>a.unshift(...t))(w,O(c,s,n)):await a.canSetTable(n,e,i)&&await f(u(t,(async(t,l)=>r(t)?!e&&await a.canDelRow(n,l,i)&&h(w,O(c,s,n,l)):await a.canSetRow(n,l,e,i)&&await f(u(t,(async(t,f)=>{const w=[n,l,f],u=O(c,s,...w);r(t)?!e&&await a.canDelCell(...w,i)&&h(g,u):await a.canSetCell(...w,t,e,i,await o.get(u))&&(y[u]=t)}))))))))),await f(u(t[1],(async(t,s)=>{const n=c+"v"+s;r(t)?!e&&await a.canDelValue(s,i)&&h(g,n):await a.canSetValue(s,t,e,i,await o.get(n))&&(y[n]=t)}))),0!=l(w)&&x(await o.list(),(a=>w.every((t=>!n(a,t)||h(g,a)&&0)))),await o.delete(g),await o.put(y)},O=(a,t,...e)=>P(a,t,c(p(e),1,-1)),V=async(a,t,e=null)=>new Response(e,{status:t,headers:a.config.responseHeaders});a.TinyBasePartyKitServer=class{constructor(a){this.party=a,this.config={},this.config.storePath??="/store",this.config.messagePrefix??="",this.config.storagePrefix??="",this.config.responseHeaders??=T}async onRequest(a){const{party:{storage:t},config:{storePath:e,storagePrefix:s}}=this;if(new URL(a.url).pathname.endsWith(e)){const e=await D(t,s),n=await a.text();return"PUT"==a.method?e?V(this,205):(await C(this,S(n),!0,a),V(this,201)):V(this,200,e?p(await v(t,s)):"")}return V(this,404)}async onMessage(a,t){const{config:{messagePrefix:e,storagePrefix:s}}=this;await o(m(e,a,1),(async([a,e])=>{"s"==a&&await D(this.party.storage,s)&&(await C(this,e,!1,t),R(this,e,[t.id]))}))}async canSetTable(a,t,e){return!0}async canDelTable(a,t){return!0}async canSetRow(a,t,e,s){return!0}async canDelRow(a,t,e){return!0}async canSetCell(a,t,e,s,n,i,r){return!0}async canDelCell(a,t,e,s){return!0}async canSetValue(a,t,e,s,n){return!0}async canDelValue(a,t){return!0}},a.broadcastTransactionChanges=R,a.hasStoreInStorage=D,a.loadStoreFromStorage=v},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((a="undefined"!=typeof globalThis?globalThis:a||self).TinyBasePersisterPartyKitServer={});
