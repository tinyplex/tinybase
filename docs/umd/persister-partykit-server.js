var a,t;a=this,t=function(a){"use strict";const t=a=>typeof a,e=t(""),s="t",n=(a,t)=>a.startsWith(t),i=Promise,r=a=>null==a,o=(a,t,e)=>r(a)?e?.():t(a),c=(a,t,e)=>a.slice(t,e),l=a=>a.length,f=async a=>i.all(a),y=(a,t)=>a.map(t),h=(a,...t)=>a.push(...t),g=Object,w=g.entries,u=(a=[])=>g.fromEntries(a),d=(a,t)=>y(w(a),(([a,e])=>t(e,a))),p=(a,t,e)=>(((a,t)=>t in a)(a,t)||(a[t]=e()),a[t]),S=a=>JSON.stringify(a,((a,t)=>t instanceof Map?g.fromEntries([...t]):t)),P=JSON.parse,m=(a,s,n)=>a+s+(t(n)==e?n:S(n)),x=(a,t,e)=>{const s=l(a);return n(t,a)?[t[s],(e?P:String)(c(t,s+1))]:void 0},b=(a,t)=>((a,t)=>a?.forEach(t))(a,((a,e)=>t(e,a))),T="hasStore",D=u(y(["Origin","Methods","Headers"],(a=>["Access-Control-Allow-"+a,"*"]))),v=async(a,t="")=>!!await a.get(t+T),R=async(a,t="")=>{const e={},n={};return b(await a.list(),((a,i)=>o(x(t,a),(([a,t])=>{if(a==s){const[a,s,n]=P("["+t+"]");p(p(e,a,u),s,u)[n]=i}else"v"==a&&(n[t]=i)})))),[e,n]},C=async(a,t,e)=>a.party.broadcast(m(a.config.messagePrefix,"s",t),e),O=async(a,t,e,i)=>{const o=a.party.storage,c=a.config.storagePrefix,y={[c+T]:1},g=[],w=[];await f(d(t[0],(async(t,n)=>r(t)?!e&&await a.canDelTable(n,i)&&((a,...t)=>a.unshift(...t))(w,V(c,s,n)):await a.canSetTable(n,e,i)&&await f(d(t,(async(t,l)=>r(t)?!e&&await a.canDelRow(n,l,i)&&h(w,V(c,s,n,l)):await a.canSetRow(n,l,e,i)&&await f(d(t,(async(t,f)=>{const w=[n,l,f],u=V(c,s,...w);r(t)?!e&&await a.canDelCell(...w,i)&&h(g,u):await a.canSetCell(...w,t,e,i,await o.get(u))&&(y[u]=t)}))))))))),await f(d(t[1],(async(t,s)=>{const n=c+"v"+s;r(t)?!e&&await a.canDelValue(s,i)&&h(g,n):await a.canSetValue(s,t,e,i,await o.get(n))&&(y[n]=t)}))),0!=l(w)&&b(await o.list(),(a=>w.every((t=>!n(a,t)||h(g,a)&&0)))),await o.delete(g),await o.put(y)},V=(a,t,...e)=>m(a,t,c(S(e),1,-1)),E=async(a,t,e=null)=>new Response(e,{status:t,headers:a.config.responseHeaders});a.TinyBasePartyKitServer=class{constructor(a){this.party=a,this.config={},this.config.storePath??="/store",this.config.messagePrefix??="",this.config.storagePrefix??="",this.config.responseHeaders??=D}async onRequest(a){const{party:{storage:t},config:{storePath:e,storagePrefix:s}}=this;if(new URL(a.url).pathname.endsWith(e)){const e=await v(t,s),n=await a.text();return"PUT"==a.method?e?E(this,205):(await O(this,P(n),!0,a),E(this,201)):E(this,200,e?S(await R(t,s)):"")}return E(this,404)}async onMessage(a,t){const{config:{messagePrefix:e,storagePrefix:s}}=this;await o(x(e,a,1),(async([a,e])=>{"s"==a&&await v(this.party.storage,s)&&(await O(this,e,!1,t),C(this,e,[t.id]))}))}async canSetTable(a,t,e){return!0}async canDelTable(a,t){return!0}async canSetRow(a,t,e,s){return!0}async canDelRow(a,t,e){return!0}async canSetCell(a,t,e,s,n,i,r){return!0}async canDelCell(a,t,e,s){return!0}async canSetValue(a,t,e,s,n){return!0}async canDelValue(a,t){return!0}},a.broadcastChanges=C,a.hasStoreInStorage=v,a.loadStoreFromStorage=R},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((a="undefined"!=typeof globalThis?globalThis:a||self).TinyBasePersisterPartyKitServer={});
