var t,e;t=this,e=function(t,e){"use strict";const a=t=>typeof t,s=a(""),n="t",o="v",r=t=>null==t,i=(t,e,a)=>r(t)?a?.():e(t),c=t=>t.length,d=t=>t.shift(),l=Object,g=t=>l.getPrototypeOf(t),u=l.entries,y=l.keys,p=l.freeze,f=(t=[])=>l.fromEntries(t),h=(t,e)=>e in t,v=(t,e)=>((t,e)=>t.map(e))(u(t),(([t,a])=>e(a,t))),w=t=>(t=>!r(t)&&i(g(t),(t=>t==l.prototype||r(g(t))),(()=>!0)))(t)&&0==(t=>c(y(t)))(t),S=(t,e,a)=>(h(t,e)||(t[e]=a()),t[e]),A=t=>new Map(t),b=(t,e)=>t?.get(e),O=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,a)=>e(a,t))),j=(t,e,a)=>{return r(a)?(s=t,n=e,s?.delete(n),t):t?.set(e,a);var s,n},C=(t,e,a,s)=>{var n,o;return n=t,o=e,n?.has(o)||j(t,e,a()),b(t,e)},L=A(),M=A(),J="delete",N=t=>[t.get(n),t.get(o)],T=(t,a,s,n)=>{const o=r(a)?t:t.get(a)??t.set(a,new e.Map);let i;return v(s,((t,e)=>{n(o,e,t)&&(i=1)})),o.forEach(((t,e)=>{h(s,e)||(o.delete(e),i=1)})),r(a)||o.size||t.delete(a),i};t.createYjsPersister=(t,l,g="tinybase",u)=>{const y=l.getMap(g);return((t,e,n,o,c,l,g,u={},y=[])=>{let f,h,v,S=0;C(L,y,(()=>0)),C(M,y,(()=>[]));const[A,O,J,N]=((t,e)=>[0,e.getContent,e.getTransactionChanges,([t,e])=>!w(t)||!w(e)])(0,t),T=async t=>(2!=S&&(S=1,await z.schedule((async()=>{await t(),S=0}))),z),m=e=>{var n;(A&&(n=e?.[0],a(n)==s)?1===e?.[1][2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},z={load:async(a,s)=>await T((async()=>{try{m(await e())}catch(e){l?.(e),t.setContent([a,s])}})),startAutoLoad:async(t={},a={})=>(await z.stopAutoLoad().load(t,a),h=o((async(t,a)=>{const s=a?.();await T((async()=>{try{m(s??t?.()??await e())}catch(t){l?.(t)}}))})),z),stopAutoLoad:()=>(h&&(c(h),h=void 0),z),isAutoLoading:()=>!r(h),save:async t=>(1!=S&&(S=2,await z.schedule((async()=>{try{await n(O,t)}catch(t){l?.(t)}S=0}))),z),startAutoSave:async()=>(await z.stopAutoSave().save(),v=t.addDidFinishTransactionListener((()=>{const t=J();N(t)&&z.save((()=>t))})),z),stopAutoSave:()=>(i(v,t.delListener),v=void 0,z),isAutoSaving:()=>!r(v),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(b(M,y),...t),await(async()=>{if(!b(L,y)){for(j(L,y,1);!r(f=d(b(M,y)));)try{await f()}catch(t){l?.(t)}j(L,y,0)}})(),z),getStore:()=>t,destroy:()=>z.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...u};return p(z)})(t,(async()=>y.size?[y.get(n).toJSON(),y.get(o).toJSON()]:void 0),(async(t,a)=>l.transact((()=>((t,a,s)=>{t.size||(t.set(n,new e.Map),t.set(o,new e.Map));const[c,d]=N(t),l=()=>{g=1};let g=1;if(i(s?.(),(([t,e])=>{g=0,v(t,((t,e)=>g?0:r(t)?c.delete(e):i(c.get(e),(e=>v(t,((t,a)=>g?0:r(t)?e.delete(a):i(e.get(a),(e=>v(t,((t,a)=>r(t)?e.delete(a):e.set(a,t)))),l)))),l))),v(e,((t,e)=>g?0:r(t)?d.delete(e):d.set(e,t)))})),g){const[t,e]=a();T(c,void 0,t,((t,e,a)=>T(c,e,a,((t,e,a)=>T(t,e,a,((t,e,a)=>{if(t.get(e)!==a)return t.set(e,a),1})))))),T(d,void 0,e,((t,e,a)=>{d.get(e)!==a&&d.set(e,a)}))}})(y,t,a)))),(t=>{const e=e=>t(void 0,(()=>((t,e)=>{if(1==c(e)&&(a=e[0].path,0==c(a)))return[t.get(n).toJSON(),t.get(o).toJSON(),1];var a;const[s,r]=N(t),l={},g={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>d(t)==n?i(d(t),(a=>{const n=S(l,a,f),o=s.get(a);i(d(t),(t=>{const a=S(n,t,f),s=o.get(t);O(e,((t,{action:e})=>a[t]=e==J?null:s.get(t)))}),(()=>O(e,((t,{action:e})=>n[t]=e==J?null:o.get(t)?.toJSON()))))}),(()=>O(e,((t,{action:e})=>l[t]=e==J?null:s.get(t)?.toJSON())))):O(e,((t,{action:e})=>g[t]=e==J?null:r.get(t)))))})(e),[l,g,1]})(y,e)));return y.observeDeep(e),e}),(t=>{y.unobserveDeep(t)}),u,0,{getYDoc:()=>l})}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
