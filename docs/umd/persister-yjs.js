var e,t;e=this,t=function(e,t){"use strict";const a="t",s="v",n=e=>null==e,o=(e,t,a)=>n(e)?a?.():t(e),r=e=>e.length,i=e=>e.shift(),c=Object,g=e=>c.getPrototypeOf(e),l=c.entries,d=c.keys,y=c.freeze,u=(e=[])=>c.fromEntries(e),p=(e,t)=>t in e,f=(e,t)=>((e,t)=>e.map(t))(l(e),(([e,a])=>t(a,e))),h=e=>(e=>!n(e)&&o(g(e),(e=>e==c.prototype||n(g(e))),(()=>!0)))(e)&&0==(e=>r(d(e)))(e),v=(e,t,a)=>(p(e,t)||(e[t]=a()),e[t]),w=e=>new Map(e),b=(e,t)=>e?.get(t),S=(e,t)=>((e,t)=>e?.forEach(t))(e,((e,a)=>t(a,e))),C=(e,t,a)=>{return n(a)?(s=e,o=t,s?.delete(o),e):e?.set(t,a);var s,o},M=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)||C(e,t,a()),b(e,t)},A=w(),O=w(),j="delete",J=e=>[e.get(a),e.get(s)],N=(e,a,s,o)=>{const r=n(a)?e:e.get(a)??e.set(a,new t.Map);let i;return f(s,((e,t)=>{o(r,t,e)&&(i=1)})),r.forEach(((e,t)=>{p(s,t)||(r.delete(t),i=1)})),n(a)||r.size||e.delete(a),i};e.createYjsPersister=(e,c,g="tinybase",l)=>{const d=c.getMap(g);return((e,t,a,s,r,c,g,l={},d=[])=>{let u,p,f,v=0;M(A,d,(()=>0)),M(O,d,(()=>[]));const[w,S,j,J,N]=((e=1,t)=>e>1&&t.isMergeable()?[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!h(e)||!h(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!h(e)||!h(t),t.setContent]:(e=>{throw Error("Store type not supported by this Persister")})())(g,e),T=t=>{var a;(w&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},D=async e=>(2!=v&&(v=1,await z((async()=>{try{T(await t())}catch(t){c?.(t),e&&N(e)}v=0}))),P),E=()=>(p&&(r(p),p=void 0),P),L=async e=>(1!=v&&(v=2,await z((async()=>{try{await a(S,e)}catch(e){c?.(e)}v=0}))),P),m=()=>(o(f,e.delListener),f=void 0,P),z=async(...e)=>(((e,...t)=>{e.push(...t)})(b(O,d),...e),await(async()=>{if(!b(A,d)){for(C(A,d,1);!n(u=i(b(O,d)));)try{await u()}catch(e){c?.(e)}C(A,d,0)}})(),P),P={load:D,startAutoLoad:async e=>(await E().load(e),p=s((async(e,t)=>{t||e?2!=v&&(v=1,T(t??e),v=0):await D()})),P),stopAutoLoad:E,isAutoLoading:()=>!n(p),save:L,startAutoSave:async()=>(await m().save(),f=e.addDidFinishTransactionListener((()=>{const e=j();J(e)&&L(e)})),P),stopAutoSave:m,isAutoSaving:()=>!n(f),schedule:z,getStore:()=>e,destroy:()=>E().stopAutoSave(),getStats:()=>({}),...l};return y(P)})(e,(async()=>d.size?[d.get(a).toJSON(),d.get(s).toJSON()]:void 0),(async(e,r)=>c.transact((()=>((e,r,i)=>{e.size||(e.set(a,new t.Map),e.set(s,new t.Map));const[c,g]=J(e),l=()=>{d=1};let d=1;if(o(i,(([e,t])=>{d=0,f(e,((e,t)=>d?0:n(e)?c.delete(t):o(c.get(t),(t=>f(e,((e,a)=>d?0:n(e)?t.delete(a):o(t.get(a),(t=>f(e,((e,a)=>n(e)?t.delete(a):t.set(a,e)))),l)))),l))),f(t,((e,t)=>d?0:n(e)?g.delete(t):g.set(t,e)))})),d){const[e,t]=r();N(c,void 0,e,((e,t,a)=>N(c,t,a,((e,t,a)=>N(e,t,a,((e,t,a)=>{if(e.get(t)!==a)return e.set(t,a),1})))))),N(g,void 0,t,((e,t,a)=>{g.get(t)!==a&&g.set(t,a)}))}})(d,e,r)))),(e=>{const t=t=>e(void 0,((e,t)=>{if(1==r(t)&&(n=t[0].path,0==r(n)))return[e.get(a).toJSON(),e.get(s).toJSON(),1];var n;const[c,g]=J(e),l={},d={};return((e,t)=>{e.forEach((({path:e,changes:{keys:t}})=>i(e)==a?o(i(e),(a=>{const s=v(l,a,u),n=c.get(a);o(i(e),(e=>{const a=v(s,e,u),o=n.get(e);S(t,((e,{action:t})=>a[e]=t==j?null:o.get(e)))}),(()=>S(t,((e,{action:t})=>s[e]=t==j?null:n.get(e)?.toJSON()))))}),(()=>S(t,((e,{action:t})=>l[e]=t==j?null:c.get(e)?.toJSON())))):S(t,((e,{action:t})=>d[e]=t==j?null:g.get(e)))))})(t),[l,d,1]})(d,t));return d.observeDeep(t),t}),(e=>{d.unobserveDeep(e)}),l,1,{getYDoc:()=>c})}},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterYjs={},e.yjs);
