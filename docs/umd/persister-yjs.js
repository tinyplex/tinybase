var t,e;t=this,e=function(t,e){"use strict";const s="t",a="v",n=t=>null==t,o=(t,e,s)=>n(t)?s?.():e(t),c=t=>t.length,r=t=>t.shift(),i=Object,d=i.keys,l=i.freeze,u=(t=[])=>i.fromEntries(t),y=(t,e)=>!n(((t,e)=>o(t,(t=>t[e])))(t,e)),g=(t,e)=>((t,e)=>t.map(e))(i.entries(t),(([t,s])=>e(s,t))),f=t=>(t=>t instanceof i&&t.constructor==i)(t)&&0==(t=>c(d(t)))(t),p=(t,e,s)=>(y(t,e)||(t[e]=s()),t[e]),h=t=>new Map(t),v=(t,e)=>t?.get(e),w=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,s)=>e(s,t))),S=(t,e,s)=>{return n(s)?(a=t,o=e,a?.delete(o),t):t?.set(e,s);var a,o},A=(t,e,s)=>{var a,n;return a=t,n=e,a?.has(n)||S(t,e,s()),v(t,e)},b=h(),j=h(),O="delete",J=t=>[t.get(s),t.get(a)],L=(t,s,a,o)=>{const c=n(s)?t:t.get(s)??t.set(s,new e.Map);let r;return g(a,((t,e)=>{o(c,e,t)&&(r=1)})),c.forEach(((t,e)=>{y(a,e)||(c.delete(e),r=1)})),n(s)||c.size||t.delete(s),r};t.createYjsPersister=(t,i,d="tinybase",y)=>{const h=i.getMap(d);return((t,e,s,a,c,i,[d,u]=[],y=[])=>{let g,p,h,w=0,O=0;A(b,y,(()=>0)),A(j,y,(()=>[]));const J=async t=>(2!=w&&(w=1,await L.schedule((async()=>{await t(),w=0}))),L),L={load:async(s,a)=>await J((async()=>{try{t.setContent(await e())}catch{t.setContent([s,a])}})),startAutoLoad:async(s={},n={})=>(L.stopAutoLoad(),await L.load(s,n),O=1,h=a((async(s,a)=>{if(a){const e=a();await J((async()=>t.setTransactionChanges(e)))}else await J((async()=>{try{t.setContent(s?.()??await e())}catch(t){i?.(t)}}))})),L),stopAutoLoad:()=>(O&&(c(h),h=void 0,O=0),L),save:async e=>(1!=w&&(w=2,await L.schedule((async()=>{try{await s(t.getContent,e)}catch(t){i?.(t)}w=0}))),L),startAutoSave:async()=>(await L.stopAutoSave().save(),g=t.addDidFinishTransactionListener(((t,e)=>{const[s,a]=e();f(s)&&f(a)||L.save((()=>[s,a]))})),L),stopAutoSave:()=>(o(g,t.delListener),L),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(v(j,y),...t),await(async()=>{if(!v(b,y)){for(S(b,y,1);!n(p=r(v(j,y)));)try{await p()}catch(t){i?.(t)}S(b,y,0)}})(),L),getStore:()=>t,destroy:()=>L.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return d&&(L[d]=()=>u),l(L)})(t,(async()=>h.size?[h.get(s).toJSON(),h.get(a).toJSON()]:void 0),(async(t,c)=>i.transact((()=>((t,c,r)=>{t.size||(t.set(s,new e.Map),t.set(a,new e.Map));const[i,d]=J(t),l=()=>{u=1};let u=1;if(o(r?.(),(([t,e])=>{u=0,g(t,((t,e)=>u?0:n(t)?i.delete(e):o(i.get(e),(e=>g(t,((t,s)=>u?0:n(t)?e.delete(s):o(e.get(s),(e=>g(t,((t,s)=>n(t)?e.delete(s):e.set(s,t)))),l)))),l))),g(e,((t,e)=>u?0:n(t)?d.delete(e):d.set(e,t)))})),u){const[t,e]=c();L(i,void 0,t,((t,e,s)=>L(i,e,s,((t,e,s)=>L(t,e,s,((t,e,s)=>{if(t.get(e)!==s)return t.set(e,s),1})))))),L(d,void 0,e,((t,e,s)=>{d.get(e)!==s&&d.set(e,s)}))}})(h,t,c)))),(t=>{const e=e=>t(void 0,(()=>((t,e)=>{if(1==c(e)&&(n=e[0].path,0==c(n)))return[t.get(s).toJSON(),t.get(a).toJSON()];var n;const[i,d]=J(t),l={},y={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>r(t)==s?o(r(t),(s=>{const a=p(l,s,u),n=i.get(s);o(r(t),(t=>{const s=p(a,t,u),o=n.get(t);w(e,((t,{action:e})=>s[t]=e==O?null:o.get(t)))}),(()=>w(e,((t,{action:e})=>a[t]=e==O?null:n.get(t)?.toJSON()))))}),(()=>w(e,((t,{action:e})=>l[t]=e==O?null:i.get(t)?.toJSON())))):w(e,((t,{action:e})=>y[t]=e==O?null:d.get(t)))))})(e),[l,y]})(h,e)));return h.observeDeep(e),e}),(t=>{h.unobserveDeep(t)}),y,["getYDoc",i])}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
