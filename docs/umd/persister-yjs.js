var t,e;t=this,e=function(t,e){"use strict";const a=t=>typeof t,s=a(""),n="t",o="v",r=t=>null==t,i=(t,e,a)=>r(t)?a?.():e(t),c=t=>t.length,l=t=>t.shift(),d=Object,y=t=>d.getPrototypeOf(t),u=d.entries,g=d.keys,p=d.freeze,f=(t=[])=>d.fromEntries(t),h=(t,e)=>e in t,v=(t,e)=>((t,e)=>t.map(e))(u(t),(([t,a])=>e(a,t))),w=t=>(t=>!r(t)&&i(y(t),(t=>t==d.prototype||r(y(t))),(()=>!0)))(t)&&0==(t=>c(g(t)))(t),S=(t,e,a)=>(h(t,e)||(t[e]=a()),t[e]),b=t=>new Map(t),A=(t,e)=>t?.get(e),O=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,a)=>e(a,t))),j=(t,e,a)=>{return r(a)?(s=t,n=e,s?.delete(n),t):t?.set(e,a);var s,n},C=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||j(t,e,a()),A(t,e)},J=b(),L=b(),M="delete",N=t=>[t.get(n),t.get(o)],T=(t,a,s,n)=>{const o=r(a)?t:t.get(a)??t.set(a,new e.Map);let i;return v(s,((t,e)=>{n(o,e,t)&&(i=1)})),o.forEach(((t,e)=>{h(s,e)||(o.delete(e),i=1)})),r(a)||o.size||t.delete(a),i};t.createYjsPersister=(t,d,y="tinybase",u)=>{const g=d.getMap(y);return((t,e,n,o,c,d,y,[u,g]=[],f=[])=>{let h,v,S,b=0,O=0;C(J,f,(()=>0)),C(L,f,(()=>[]));const M=t.getContent,N=t.getTransactionChanges,T=async t=>(2!=b&&(b=1,await m.schedule((async()=>{await t(),b=0}))),m),m={load:async(n,o)=>await T((async()=>{try{const n=await e();(y&&(t=>a(t)==s)(n[0])?t.applyMergeableChanges:t.setContent)(n)}catch{t.setContent([n,o])}})),startAutoLoad:async(a={},s={})=>(m.stopAutoLoad(),await m.load(a,s),O=1,S=o((async(a,s)=>{if(s){const e=s();await T((async()=>t.applyChanges(e)))}else await T((async()=>{try{t.setContent(a?.()??await e())}catch(t){d?.(t)}}))})),m),stopAutoLoad:()=>(O&&(c(S),S=void 0,O=0),m),save:async t=>(1!=b&&(b=2,await m.schedule((async()=>{try{await n(M,t)}catch(t){d?.(t)}b=0}))),m),startAutoSave:async()=>(await m.stopAutoSave().save(),h=t.addDidFinishTransactionListener((()=>{const[t,e]=N();w(t)&&w(e)||m.save((()=>[t,e]))})),m),stopAutoSave:()=>(i(h,t.delListener),h=void 0,m),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(A(L,f),...t),await(async()=>{if(!A(J,f)){for(j(J,f,1);!r(v=l(A(L,f)));)try{await v()}catch(t){d?.(t)}j(J,f,0)}})(),m),getStore:()=>t,destroy:()=>m.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return u&&(m[u]=()=>g),p(m)})(t,(async()=>g.size?[g.get(n).toJSON(),g.get(o).toJSON()]:void 0),(async(t,a)=>d.transact((()=>((t,a,s)=>{t.size||(t.set(n,new e.Map),t.set(o,new e.Map));const[c,l]=N(t),d=()=>{y=1};let y=1;if(i(s?.(),(([t,e])=>{y=0,v(t,((t,e)=>y?0:r(t)?c.delete(e):i(c.get(e),(e=>v(t,((t,a)=>y?0:r(t)?e.delete(a):i(e.get(a),(e=>v(t,((t,a)=>r(t)?e.delete(a):e.set(a,t)))),d)))),d))),v(e,((t,e)=>y?0:r(t)?l.delete(e):l.set(e,t)))})),y){const[t,e]=a();T(c,void 0,t,((t,e,a)=>T(c,e,a,((t,e,a)=>T(t,e,a,((t,e,a)=>{if(t.get(e)!==a)return t.set(e,a),1})))))),T(l,void 0,e,((t,e,a)=>{l.get(e)!==a&&l.set(e,a)}))}})(g,t,a)))),(t=>{const e=e=>t(void 0,(()=>((t,e)=>{if(1==c(e)&&(a=e[0].path,0==c(a)))return[t.get(n).toJSON(),t.get(o).toJSON()];var a;const[s,r]=N(t),d={},y={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>l(t)==n?i(l(t),(a=>{const n=S(d,a,f),o=s.get(a);i(l(t),(t=>{const a=S(n,t,f),s=o.get(t);O(e,((t,{action:e})=>a[t]=e==M?null:s.get(t)))}),(()=>O(e,((t,{action:e})=>n[t]=e==M?null:o.get(t)?.toJSON()))))}),(()=>O(e,((t,{action:e})=>d[t]=e==M?null:s.get(t)?.toJSON())))):O(e,((t,{action:e})=>y[t]=e==M?null:r.get(t)))))})(e),[d,y]})(g,e)));return g.observeDeep(e),e}),(t=>{g.unobserveDeep(t)}),u,!1,["getYDoc",d])}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
