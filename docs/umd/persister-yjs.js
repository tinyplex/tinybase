var t,e;t=this,e=function(t,e){"use strict";const a="t",s="v",n=t=>null==t,o=(t,e,a)=>n(t)?a?.():e(t),r=t=>t.length,i=t=>t.shift(),c=Object,d=t=>c.getPrototypeOf(t),l=c.entries,u=c.keys,y=c.freeze,g=(t=[])=>c.fromEntries(t),p=(t,e)=>!n(((t,e)=>o(t,(t=>t[e])))(t,e)),f=(t,e)=>((t,e)=>t.map(e))(l(t),(([t,a])=>e(a,t))),h=t=>(t=>!n(t)&&o(d(t),(t=>t==c.prototype||n(d(t))),(()=>!0)))(t)&&0==(t=>r(u(t)))(t),v=(t,e,a)=>(p(t,e)||(t[e]=a()),t[e]),w=t=>new Map(t),S=(t,e)=>t?.get(e),A=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,a)=>e(a,t))),O=(t,e,a)=>{return n(a)?(s=t,o=e,s?.delete(o),t):t?.set(e,a);var s,o},b=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||O(t,e,a()),S(t,e)},j=w(),J=w(),L="delete",N=t=>[t.get(a),t.get(s)],C=(t,a,s,o)=>{const r=n(a)?t:t.get(a)??t.set(a,new e.Map);let i;return f(s,((t,e)=>{o(r,e,t)&&(i=1)})),r.forEach(((t,e)=>{p(s,e)||(r.delete(e),i=1)})),n(a)||r.size||t.delete(a),i};t.createYjsPersister=(t,c,d="tinybase",l)=>{const u=c.getMap(d);return((t,e,a,s,r,c,[d,l]=[],u=[])=>{let g,p,f,v=0,w=0;b(j,u,(()=>0)),b(J,u,(()=>[]));const A=async t=>(2!=v&&(v=1,await L.schedule((async()=>{await t(),v=0}))),L),L={load:async(a,s)=>await A((async()=>{try{t.setContent(await e())}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},n={})=>(L.stopAutoLoad(),await L.load(a,n),w=1,f=s((async(a,s)=>{if(s){const e=s();await A((async()=>t.setTransactionChanges(e)))}else await A((async()=>{try{t.setContent(a?.()??await e())}catch(t){c?.(t)}}))})),L),stopAutoLoad:()=>(w&&(r(f),f=void 0,w=0),L),save:async e=>(1!=v&&(v=2,await L.schedule((async()=>{try{await a(t.getContent,e)}catch(t){c?.(t)}v=0}))),L),startAutoSave:async()=>(await L.stopAutoSave().save(),g=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();h(a)&&h(s)||L.save((()=>[a,s]))})),L),stopAutoSave:()=>(o(g,t.delListener),g=void 0,L),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(S(J,u),...t),await(async()=>{if(!S(j,u)){for(O(j,u,1);!n(p=i(S(J,u)));)try{await p()}catch(t){c?.(t)}O(j,u,0)}})(),L),getStore:()=>t,destroy:()=>L.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return d&&(L[d]=()=>l),y(L)})(t,(async()=>u.size?[u.get(a).toJSON(),u.get(s).toJSON()]:void 0),(async(t,r)=>c.transact((()=>((t,r,i)=>{t.size||(t.set(a,new e.Map),t.set(s,new e.Map));const[c,d]=N(t),l=()=>{u=1};let u=1;if(o(i?.(),(([t,e])=>{u=0,f(t,((t,e)=>u?0:n(t)?c.delete(e):o(c.get(e),(e=>f(t,((t,a)=>u?0:n(t)?e.delete(a):o(e.get(a),(e=>f(t,((t,a)=>n(t)?e.delete(a):e.set(a,t)))),l)))),l))),f(e,((t,e)=>u?0:n(t)?d.delete(e):d.set(e,t)))})),u){const[t,e]=r();C(c,void 0,t,((t,e,a)=>C(c,e,a,((t,e,a)=>C(t,e,a,((t,e,a)=>{if(t.get(e)!==a)return t.set(e,a),1})))))),C(d,void 0,e,((t,e,a)=>{d.get(e)!==a&&d.set(e,a)}))}})(u,t,r)))),(t=>{const e=e=>t(void 0,(()=>((t,e)=>{if(1==r(e)&&(n=e[0].path,0==r(n)))return[t.get(a).toJSON(),t.get(s).toJSON()];var n;const[c,d]=N(t),l={},u={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>i(t)==a?o(i(t),(a=>{const s=v(l,a,g),n=c.get(a);o(i(t),(t=>{const a=v(s,t,g),o=n.get(t);A(e,((t,{action:e})=>a[t]=e==L?null:o.get(t)))}),(()=>A(e,((t,{action:e})=>s[t]=e==L?null:n.get(t)?.toJSON()))))}),(()=>A(e,((t,{action:e})=>l[t]=e==L?null:c.get(t)?.toJSON())))):A(e,((t,{action:e})=>u[t]=e==L?null:d.get(t)))))})(e),[l,u]})(u,e)));return u.observeDeep(e),e}),(t=>{u.unobserveDeep(t)}),l,["getYDoc",c])}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
