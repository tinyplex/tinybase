var t,e;t=this,e=function(t,e){"use strict";const a="t",s="v",n=t=>null==t,o=(t,e,a)=>n(t)?a?.():e(t),r=t=>t.length,i=t=>t.shift(),c=Object,d=t=>c.getPrototypeOf(t),l=c.entries,g=c.keys,u=c.freeze,y=(t=[])=>c.fromEntries(t),p=(t,e)=>e in t,f=(t,e)=>((t,e)=>t.map(e))(l(t),(([t,a])=>e(a,t))),h=t=>(t=>!n(t)&&o(d(t),(t=>t==c.prototype||n(d(t))),(()=>!0)))(t)&&0==(t=>r(g(t)))(t),v=(t,e,a)=>(p(t,e)||(t[e]=a()),t[e]),w=t=>new Map(t),S=(t,e)=>t?.get(e),A=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,a)=>e(a,t))),b=(t,e,a)=>{return n(a)?(s=t,o=e,s?.delete(o),t):t?.set(e,a);var s,o},O=(t,e,a,s)=>{var n,o;return n=t,o=e,n?.has(o)||b(t,e,a()),S(t,e)},j=w(),C=w(),L="delete",M=t=>[t.get(a),t.get(s)],J=(t,a,s,o)=>{const r=n(a)?t:t.get(a)??t.set(a,new e.Map);let i;return f(s,((t,e)=>{o(r,e,t)&&(i=1)})),r.forEach(((t,e)=>{p(s,e)||(r.delete(e),i=1)})),n(a)||r.size||t.delete(a),i};t.createYjsPersister=(t,c,d="tinybase",l)=>{const g=c.getMap(d);return((t,e,a,s,r,c,d,l={},g=[])=>{let y,p,f,v=0;O(j,g,(()=>0)),O(C,g,(()=>[]));const[w,A,L,M,J]=((t,e)=>[0,e.getContent,e.getTransactionChanges,([t,e])=>!h(t)||!h(e),e.setContent])(0,t),N=async t=>(2!=v&&(v=1,await m.schedule((async()=>{await t(),v=0}))),m),T=e=>{var a;(w&&(a=e?.[0],Array.isArray(a))?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},m={load:async t=>await N((async()=>{try{T(await e())}catch(e){c?.(e),t&&J(t)}})),startAutoLoad:async t=>(await m.stopAutoLoad().load(t),p=s((async(t,a)=>{const s=a?.();await N((async()=>{try{T(s??t?.()??await e())}catch(t){c?.(t)}}))})),m),stopAutoLoad:()=>(p&&(r(p),p=void 0),m),isAutoLoading:()=>!n(p),save:async t=>(1!=v&&(v=2,await m.schedule((async()=>{try{await a(A,t)}catch(t){c?.(t)}v=0}))),m),startAutoSave:async()=>(await m.stopAutoSave().save(),f=t.addDidFinishTransactionListener((()=>{const t=L();M(t)&&m.save((()=>t))})),m),stopAutoSave:()=>(o(f,t.delListener),f=void 0,m),isAutoSaving:()=>!n(f),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(S(C,g),...t),await(async()=>{if(!S(j,g)){for(b(j,g,1);!n(y=i(S(C,g)));)try{await y()}catch(t){c?.(t)}b(j,g,0)}})(),m),getStore:()=>t,destroy:()=>m.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...l};return u(m)})(t,(async()=>g.size?[g.get(a).toJSON(),g.get(s).toJSON()]:void 0),(async(t,r)=>c.transact((()=>((t,r,i)=>{t.size||(t.set(a,new e.Map),t.set(s,new e.Map));const[c,d]=M(t),l=()=>{g=1};let g=1;if(o(i?.(),(([t,e])=>{g=0,f(t,((t,e)=>g?0:n(t)?c.delete(e):o(c.get(e),(e=>f(t,((t,a)=>g?0:n(t)?e.delete(a):o(e.get(a),(e=>f(t,((t,a)=>n(t)?e.delete(a):e.set(a,t)))),l)))),l))),f(e,((t,e)=>g?0:n(t)?d.delete(e):d.set(e,t)))})),g){const[t,e]=r();J(c,void 0,t,((t,e,a)=>J(c,e,a,((t,e,a)=>J(t,e,a,((t,e,a)=>{if(t.get(e)!==a)return t.set(e,a),1})))))),J(d,void 0,e,((t,e,a)=>{d.get(e)!==a&&d.set(e,a)}))}})(g,t,r)))),(t=>{const e=e=>t(void 0,(()=>((t,e)=>{if(1==r(e)&&(n=e[0].path,0==r(n)))return[t.get(a).toJSON(),t.get(s).toJSON(),1];var n;const[c,d]=M(t),l={},g={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>i(t)==a?o(i(t),(a=>{const s=v(l,a,y),n=c.get(a);o(i(t),(t=>{const a=v(s,t,y),o=n.get(t);A(e,((t,{action:e})=>a[t]=e==L?null:o.get(t)))}),(()=>A(e,((t,{action:e})=>s[t]=e==L?null:n.get(t)?.toJSON()))))}),(()=>A(e,((t,{action:e})=>l[t]=e==L?null:c.get(t)?.toJSON())))):A(e,((t,{action:e})=>g[t]=e==L?null:d.get(t)))))})(e),[l,g,1]})(g,e)));return g.observeDeep(e),e}),(t=>{g.unobserveDeep(t)}),l,0,{getYDoc:()=>c})}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
