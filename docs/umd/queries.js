var e,t;e=this,t=function(e){"use strict";const t=(e,t)=>e.every(t),s=(e,t)=>e.forEach(t),n=e=>r(e,((e,t)=>e+t),0),l=e=>e.length,o=e=>0==l(e),r=(e,t,s)=>e.reduce(t,s),a=(e,...t)=>e.push(...t),d=e=>typeof e,i=d(""),u=d(!0),c=d(0),R=d(d),w=Math.max,f=Math.min,h=isFinite,g=e=>null==e,L=(e,t,s)=>g(e)?s?.():t(e),b=e=>d(e)==R,T=()=>{},v=e=>e.size,C=(e,t)=>e?.has(t)??!1,I=e=>g(e)||0==v(e),y=e=>[...e?.values()??[]],p=e=>e.clear(),m=(e,t)=>e?.forEach(t),E=(e,t)=>e?.delete(t),S=e=>new Map(e),Q=e=>[...e?.keys()??[]],x=(e,t)=>e?.get(t),M=(e,t)=>m(e,((e,s)=>t(s,e))),j=(e,t,s)=>g(s)?(E(e,t),e):e?.set(t,s),k=(e,t,s)=>(C(e,t)||j(e,t,s()),x(e,t)),D=(e,t,s,n,o=0)=>L((s?k:x)(e,t[o],o>l(t)-2?s:S),(r=>{if(o>l(t)-2)return n?.(r)&&j(e,t[o]),r;const a=D(r,t,s,n,o+1);return I(r)&&j(e,t[o]),a})),F=e=>new Set(e),z=(e,t)=>e?.add(t),O=S([["avg",[(e,t)=>n(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>w(...e),(e,t)=>w(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:w(t,e)]],["min",[e=>f(...e),(e,t)=>f(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:f(t,e)]],["sum",[e=>n(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),W=e=>{const t=d(e);return(e=>e==i||e==u)(t)||t==c&&h(e)?t:void 0},_=Object,B=_.keys,P=_.freeze,q=(e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))})((e=>{const n=e.createStore,[r,d,i,u,c,,,R,,w,f,h,_]=((e,t,n)=>{const l=e.hasRow,r=S(),a=S(),d=S(),i=S(),u=S(),c=(t,n,...l)=>{const o=k(u,t,F);return s(l,(t=>z(o,t)&&n&&e.callListener(t))),l},R=(t,...n)=>L(x(u,t),(l=>{s(o(n)?y(l):n,(t=>{e.delListener(t),E(l,t)})),I(l)&&j(u,t)})),w=(e,s)=>{j(r,e,s),C(a,e)||(j(a,e,t()),j(d,e,S()),j(i,e,S()))},f=e=>{j(r,e),j(a,e),j(d,e),j(i,e),R(e)};return[()=>e,()=>Q(r),e=>M(a,e),e=>C(a,e),e=>x(r,e),e=>x(a,e),(e,t)=>j(a,e,t),w,(t,o,r,a,u)=>{w(t,o);const f=S(),h=S(),L=x(d,t),b=x(i,t),T=t=>{const s=s=>e.getCell(o,t,s),r=x(L,t),d=l(o,t)?n(a(s,t)):void 0;if(r!=d&&j(f,t,[r,d]),!g(u)){const e=x(b,t),n=l(o,t)?u(s,t):void 0;e!=n&&j(h,t,n)}},v=e=>{r((()=>{m(f,(([,e],t)=>j(L,t,e))),m(h,((e,t)=>j(b,t,e)))}),f,h,L,b,e),p(f),p(h)};M(L,T),e.hasTable(o)&&s(e.getRowIds(o),(e=>{C(L,e)||T(e)})),v(!0),R(t),c(t,0,e.addRowListener(o,null,((e,t,s)=>T(s))),e.addTableListener(o,(()=>v())))},f,()=>M(u,f),c,R]})(e,(()=>!0),T),q=n(),A=n(),G=n(),H=S(),J=(e,t,...n)=>s(n,(s=>z(k(k(H,t,S),e,F),s))),K=e=>s([G,A,q],(t=>t.delTable(e))),N=(e,t,s)=>J(t,e,t.addWillFinishTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),U={setQueryDefinition:(n,r,d)=>{let i;R(n,r),K(n);const u=[],c=[[null,[r,null,null,[],S()]]],w=[],f=[],T=[],P=[];d({select:(e,t)=>{const s=b(e)?[l(u)+"",e]:[g(t)?e:t,s=>s(e,t)];return a(u,s),{as:e=>s[0]=e}},join:(e,t,s)=>{const n=g(s)||b(t)?null:t,l=g(n)?t:s,o=[e,[e,n,b(l)?l:e=>e(l),[],S()]];return a(c,o),{as:e=>o[0]=e}},where:(e,t,s)=>a(w,b(e)?e:g(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,l)=>{const o=[e,[e,b(t)?[t,s,n,l]:x(O,t)??[(e,t)=>t]]];return a(f,o),{as:e=>o[0]=e}},having:(e,t)=>a(T,b(e)?e:s=>s(e)===t),order:(e,t)=>a(P,[b(e)?e:t=>t(e)??0,t]),limit:(e,t)=>{i=g(t)?[0,e]:[e,t]}});const H=S(u);if(I(H))return U;const V=S(c);M(V,((e,[,t])=>L(x(V,t),(({3:t})=>g(e)?0:a(t,e)))));const X=S(f);let Y=q,Z=A;if(o(P)&&g(i))Z=G;else{N(n,Z,G);const e=(e,t)=>{const s=x(r,e)??[],n=x(r,t)??[],l=P.findIndex(((e,t)=>s[t]!==n[t]));return l<0?0:(o=s[l],a=n[l],(o<a?-1:1)*(P[l][1]?-1:1));var o,a},r=S(),a=S();J(Z,n,o(P)?Z.addRowIdsListener(n,(()=>p(a))):Z.addRowListener(n,null,((e,s,o)=>{let d=null;if(Z.hasRow(n,o)){const e=x(r,o)??[],s=Z.getRow(n,o),R=e=>s[e];if(c=([e])=>e(R,o),d=P.map(c),u=d,l(i=e)===l(u)&&t(i,((e,t)=>u[t]===e)))return void(x(a,o)&&G.setRow(n,o,s))}var i,u,c;j(r,o,d),p(a)})),Z.addTableListener(n,(()=>{if(I(a)&&(G.delTable(n),Z.hasTable(n))){const o=Z.getTable(n);s((t=B(o),l=e,t.sort(l)),(e=>j(a,e,0))),s(L(i,(([e,t])=>((e,t,s)=>e.slice(t,s))(Q(a),e,e+t)),(()=>Q(a))),(e=>{G.setRow(n,e,o[e]),j(a,e,1)}))}var t,l})))}if(I(X)&&o(T))Y=Z;else{N(n,Y,Z);const e=S();M(X,((t,[s,n])=>z(k(e,s,F),[t,n])));const s=F();M(H,(t=>C(e,t)?0:z(s,t)));const l=S(),o=(s,l,o,r)=>L(s,(([s,a,d,i])=>{M(l,((t,[n])=>{const l=k(s,t,S),a=x(l,o),d=r?void 0:n;if(a!==d){const s=F([[a,d]]),n=v(l);j(l,o,d),m(x(e,t),(([e,t])=>{const o=((e,t,s,n,l,o=!1)=>{if(I(s))return;const[r,a,d,i]=l;return o||=g(e),m(n,(([s,n])=>{o||(e=g(s)?a?.(e,n,t++):g(n)?d?.(e,s,t--):i?.(e,n,s,t),o||=g(e))})),o?r(y(s),v(s)):e})(i[e],n,l,s,t);i[e]=g(W(o))?null:o}))}})),(I(a)||!t(T,(e=>e((e=>i[e]))))?Z.delRow:Z.setRow)(n,d,i)}));J(Y,n,Y.addRowListener(n,null,((t,r,d,i)=>{const u=[],c=[],R=S(),w=Y.hasRow(n,d);let f=!w;m(s,(e=>{const[t,s,l]=i(n,d,e);a(u,s),a(c,l),f||=t})),M(e,(e=>{const[t,,s]=i(n,d,e);(f||t)&&j(R,e,[s])})),f&&o(D(l,u,void 0,(([,e,t])=>{if(E(e,d),I(e))return Z.delRow(n,t),1})),R,d,1),w&&o(D(l,c,(()=>{const e={};return m(s,(t=>e[t]=Y.getCell(n,d,t))),[S(),F(),Z.addRow(n,e,1),e]}),(([,e])=>{z(e,d)})),R,d)})))}N(n,e,Y);const $=s=>{const l=(t,n)=>e.getCell(...g(n)?[r,s,t]:t===r?[r,s,n]:[x(V,t)?.[0],x(x(V,t)?.[4],s)?.[0],n]);Y.transaction((()=>t(w,(e=>e(l)))?M(H,((e,t)=>((e,t,s,n,l)=>g(l)?e.delCell(t,s,n,!0):e.setCell(t,s,n,l))(Y,n,s,e,t(l,s)))):Y.delRow(n,s)))},ee=(t,l,o,r)=>{const a=t=>e.getCell(l,o,t);s(r,(s=>{const[l,,o,r,d]=x(V,s),i=o?.(a,t),[u,c]=x(d,t)??[];i!=u&&(g(c)||_(n,c),j(d,t,g(i)?null:[i,...h(n,1,e.addRowListener(l,i,(()=>ee(t,l,i,r))))]))})),$(t)},{3:te}=x(V,null);return Y.transaction((()=>h(n,1,e.addRowListener(r,null,((t,s,l)=>{e.hasRow(r,l)?ee(l,r,l,te):(Y.delRow(n,l),m(V,(({4:e})=>L(x(e,l),(([,t])=>{_(n,t),j(e,l)})))))}))))),U},delQueryDefinition:e=>(M(x(H,e),((e,t)=>m(t,(t=>e.delListener(t))))),K(e),w(e),U),getStore:r,getQueryIds:d,forEachQuery:i,hasQuery:u,getTableId:c,getResultTable:e=>G.getTable(e),getResultRowIds:e=>G.getRowIds(e),getResultSortedRowIds:(e,t,s)=>G.getSortedRowIds(e,t,s),getResultRow:(e,t)=>G.getRow(e,t),getResultCellIds:(e,t)=>G.getCellIds(e,t),getResultCell:(e,t,s)=>G.getCell(e,t,s),hasResultTable:e=>G.hasTable(e),hasResultRow:(e,t)=>G.hasRow(e,t),hasResultCell:(e,t,s)=>G.hasCell(e,t,s),forEachResultTable:e=>G.forEachTable(e),forEachResultRow:(e,t)=>G.forEachRow(e,t),forEachResultCell:(e,t,s)=>G.forEachCell(e,t,s),addResultTableListener:(e,t)=>G.addTableListener(e,((e,...s)=>t(U,...s))),addResultRowIdsListener:(e,t,s)=>G.addRowIdsListener(e,((e,...s)=>t(U,...s)),s),addResultSortedRowIdsListener:(e,t,s,n)=>G.addSortedRowIdsListener(e,t,s,((e,...t)=>n(U,...t))),addResultRowListener:(e,t,s)=>G.addRowListener(e,t,((e,...t)=>s(U,...t))),addResultCellIdsListener:(e,t,s)=>G.addCellIdsListener(e,t,((e,...t)=>s(U,...t))),addResultCellListener:(e,t,s,n)=>G.addCellListener(e,t,s,((e,...t)=>n(U,...t))),delListener:e=>(G.delListener(e),U),destroy:f,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=G.getListenerStats();return n}};return P(U)}));e.createQueries=q,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseQueries={});
