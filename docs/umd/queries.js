var e,t;e=this,t=function(e){"use strict";const t=(e,t)=>e.every(t),s=(e,t)=>e.forEach(t),n=e=>r(e,((e,t)=>e+t),0),l=e=>e.length,o=e=>0==l(e),r=(e,t,s)=>e.reduce(t,s),a=(e,...t)=>e.push(...t),d=e=>typeof e,i=d(""),c=d(!0),u=d(0),R=d(d),f=Math.max,h=Math.min,w=isFinite,g=e=>null==e,L=(e,t,s)=>g(e)?s?.():t(e),b=e=>d(e)==R,T=()=>{},v=e=>e.size,C=(e,t)=>e?.has(t)??!1,y=e=>g(e)||0==v(e),p=e=>[...e?.values()??[]],I=e=>e.clear(),m=(e,t)=>e?.forEach(t),E=(e,t)=>e?.delete(t),Q=e=>new Map(e),S=e=>[...e?.keys()??[]],x=(e,t)=>e?.get(t),M=(e,t)=>m(e,((e,s)=>t(s,e))),j=(e,t,s)=>g(s)?(E(e,t),e):e?.set(t,s),k=(e,t,s)=>(C(e,t)||e.set(t,s()),x(e,t)),D=(e,t,s,n,o=0)=>L((s?k:x)(e,t[o],o>l(t)-2?s:Q),(r=>{if(o>l(t)-2)return n?.(r)&&j(e,t[o]),r;const a=D(r,t,s,n,o+1);return y(r)&&j(e,t[o]),a})),F=e=>new Set(e),z=(e,t)=>e?.add(t),O=Q([["avg",[(e,t)=>n(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>f(...e),(e,t)=>f(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:f(t,e)]],["min",[e=>h(...e),(e,t)=>h(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:h(t,e)]],["sum",[e=>n(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),W=e=>{const t=d(e);return(e=>e==i||e==c)(t)||t==u&&w(e)?t:void 0},_=Object,B=_.keys,P=_.freeze,q=(e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))})((e=>{const[n,r,d,i,c,,,u,,R,f,h,w]=((e,t,n)=>{const l=e.hasRow,r=Q(),a=Q(),d=Q(),i=Q(),c=Q(),u=(t,n,...l)=>{const o=k(c,t,F);return s(l,(t=>z(o,t)&&n&&e.callListener(t))),l},R=(t,...n)=>L(x(c,t),(l=>{s(o(n)?p(l):n,(t=>{e.delListener(t),E(l,t)})),y(l)&&j(c,t)})),f=(e,s)=>{j(r,e,s),C(a,e)||(j(a,e,t()),j(d,e,Q()),j(i,e,Q()))},h=e=>{j(r,e),j(a,e),j(d,e),j(i,e),R(e)};return[()=>e,()=>S(r),e=>M(a,e),e=>C(a,e),e=>x(r,e),e=>x(a,e),(e,t)=>j(a,e,t),f,(t,o,r,a,c)=>{f(t,o);const h=Q(),w=Q(),L=x(d,t),b=x(i,t),T=t=>{const s=s=>e.getCell(o,t,s),r=x(L,t),d=l(o,t)?n(a(s,t)):void 0;if(r!=d&&j(h,t,[r,d]),!g(c)){const e=x(b,t),n=l(o,t)?c(s,t):void 0;e!=n&&j(w,t,n)}},v=e=>{r((()=>{m(h,(([,e],t)=>j(L,t,e))),m(w,((e,t)=>j(b,t,e)))}),h,w,L,b,e),I(h),I(w)};M(L,T),e.hasTable(o)&&s(e.getRowIds(o),(e=>{C(L,e)||T(e)})),v(!0),R(t),u(t,0,e.addRowListener(o,null,((e,t,s)=>T(s))),e.addTableListener(o,(()=>v())))},h,()=>M(c,h),u,R]})(e,(()=>!0),T),_=e.createStore(),q=e.createStore(),A=e.createStore(),G=Q(),H=(e,t,...n)=>s(n,(s=>z(k(k(G,t,Q),e,F),s))),J=(e,t,s)=>h(e,0,t.addWillFinishTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),K={setQueryDefinition:(n,r,d)=>{let i;u(n,r),_.delTable(n),q.delTable(n),A.delTable(n);const c=[],R=[[null,[r,null,null,[],Q()]]],f=[],T=[],P=[],G=[];d({select:(e,t)=>{const s=b(e)?[l(c)+"",e]:[g(t)?e:t,s=>s(e,t)];return a(c,s),{as:e=>s[0]=e}},join:(e,t,s)=>{const n=g(s)||b(t)?null:t,l=g(n)?t:s,o=[e,[e,n,b(l)?l:e=>e(l),[],Q()]];return a(R,o),{as:e=>o[0]=e}},where:(e,t,s)=>a(f,b(e)?e:g(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,l)=>{const o=[e,[e,b(t)?[t,s,n,l]:x(O,t)??[(e,t)=>t]]];return a(T,o),{as:e=>o[0]=e}},having:(e,t)=>a(P,b(e)?e:s=>s(e)===t),order:(e,t)=>a(G,[b(e)?e:t=>t(e)??0,t]),limit:(e,t)=>{i=g(t)?[0,e]:[e,t]}});const N=Q(c);if(y(N))return K;const U=Q(R);M(U,((e,[,t])=>L(x(U,t),(({3:t})=>g(e)?0:a(t,e)))));const V=Q(T);let X=_,Y=q;if(o(G)&&g(i))Y=A;else{J(n,Y,A);const e=(e,t)=>{const s=x(r,e)??[],n=x(r,t)??[],l=G.findIndex(((e,t)=>s[t]!==n[t]));return l<0?0:(o=s[l],a=n[l],(o<a?-1:1)*(G[l][1]?-1:1));var o,a},r=Q(),a=Q();H(Y,n,o(G)?Y.addRowIdsListener(n,(()=>I(a))):Y.addRowListener(n,null,((e,s,o)=>{let d=null;if(Y.hasRow(n,o)){const e=x(r,o)??[],s=Y.getRow(n,o),R=e=>s[e];if(u=([e])=>e(R,o),d=G.map(u),c=d,l(i=e)===l(c)&&t(i,((e,t)=>c[t]===e)))return void(x(a,o)&&A.setRow(n,o,s))}var i,c,u;j(r,o,d),I(a)})),Y.addTableListener(n,(()=>{if(y(a)&&(A.delTable(n),Y.hasTable(n))){const o=Y.getTable(n);s((t=B(o),l=e,t.sort(l)),(e=>j(a,e,0))),s(L(i,(([e,t])=>((e,t,s)=>e.slice(t,s))(S(a),e,e+t)),(()=>S(a))),(e=>{A.setRow(n,e,o[e]),j(a,e,1)}))}var t,l})))}if(y(V)&&o(P))X=Y;else{J(n,X,Y);const e=Q();M(V,((t,[s,n])=>z(k(e,s,F),[t,n])));const s=F();M(N,(t=>C(e,t)?0:z(s,t)));const l=Q(),o=(s,l,o,r)=>L(s,(([s,a,d,i])=>{M(l,((t,[n])=>{const l=k(s,t,Q),a=x(l,o),d=r?void 0:n;if(a!==d){const s=F([[a,d]]),n=v(l);j(l,o,d),m(x(e,t),(([e,t])=>{const o=((e,t,s,n,l,o=!1)=>{if(y(s))return;const[r,a,d,i]=l;return o||=g(e),m(n,(([s,n])=>{o||(e=g(s)?a?.(e,n,t++):g(n)?d?.(e,s,t--):i?.(e,n,s,t),o||=g(e))})),o?r(p(s),v(s)):e})(i[e],n,l,s,t);i[e]=g(W(o))?null:o}))}})),(y(a)||!t(P,(e=>e((e=>i[e]))))?Y.delRow:Y.setRow)(n,d,i)}));H(X,n,X.addRowListener(n,null,((t,r,d,i)=>{const c=[],u=[],R=Q(),f=X.hasRow(n,d);let h=!f;m(s,(e=>{const[t,s,l]=i(n,d,e);a(c,s),a(u,l),h||=t})),M(e,(e=>{const[t,,s]=i(n,d,e);(h||t)&&j(R,e,[s])})),h&&o(D(l,c,void 0,(([,e,t])=>{if(E(e,d),y(e))return Y.delRow(n,t),1})),R,d,1),f&&o(D(l,u,(()=>{const e={};return m(s,(t=>e[t]=X.getCell(n,d,t))),[Q(),F(),Y.addRow(n,e,1),e]}),(([,e])=>{z(e,d)})),R,d)})))}J(n,e,X);const Z=s=>{const l=(t,n)=>e.getCell(...g(n)?[r,s,t]:t===r?[r,s,n]:[x(U,t)?.[0],x(x(U,t)?.[4],s)?.[0],n]);X.transaction((()=>t(f,(e=>e(l)))?M(N,((e,t)=>((e,t,s,n,l)=>g(l)?e.delCell(t,s,n,!0):e.setCell(t,s,n,l))(X,n,s,e,t(l,s)))):X.delRow(n,s)))},$=(t,l,o,r)=>{const a=t=>e.getCell(l,o,t);s(r,(s=>{const[l,,o,r,d]=x(U,s),i=o?.(a,t),[c,u]=x(d,t)??[];i!=c&&(g(u)||w(n,u),j(d,t,g(i)?null:[i,...h(n,1,e.addRowListener(l,i,(()=>$(t,l,i,r))))]))})),Z(t)},{3:ee}=x(U,null);return X.transaction((()=>h(n,1,e.addRowListener(r,null,((t,s,l)=>{e.hasRow(r,l)?$(l,r,l,ee):(X.delRow(n,l),m(U,(({4:e})=>L(x(e,l),(([,t])=>{w(n,t),j(e,l)})))))}))))),K},delQueryDefinition:e=>(M(x(G,e),((e,t)=>m(t,(t=>e.delListener(t))))),R(e),K),getStore:n,getQueryIds:r,forEachQuery:d,hasQuery:i,getTableId:c,getResultTable:e=>A.getTable(e),getResultRowIds:e=>A.getRowIds(e),getResultRow:(e,t)=>A.getRow(e,t),getResultCellIds:(e,t)=>A.getCellIds(e,t),getResultCell:(e,t,s)=>A.getCell(e,t,s),hasResultTable:e=>A.hasTable(e),hasResultRow:(e,t)=>A.hasRow(e,t),hasResultCell:(e,t,s)=>A.hasCell(e,t,s),forEachResultTable:e=>A.forEachTable(e),forEachResultRow:(e,t)=>A.forEachRow(e,t),forEachResultCell:(e,t,s)=>A.forEachCell(e,t,s),addResultTableListener:(e,t)=>A.addTableListener(e,((e,...s)=>t(K,...s))),addResultRowIdsListener:(e,t,s)=>A.addRowIdsListener(e,((e,...s)=>t(K,...s)),s),addResultRowListener:(e,t,s)=>A.addRowListener(e,t,((e,...t)=>s(K,...t))),addResultCellIdsListener:(e,t,s,n)=>A.addCellIdsListener(e,t,((e,...t)=>s(K,...t)),n),addResultCellListener:(e,t,s,n)=>A.addCellListener(e,t,s,((e,...t)=>n(K,...t))),delListener:e=>(A.delListener(e),K),destroy:f,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=A.getListenerStats();return n}};return P(K)}));e.createQueries=q,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseQueries={});
