var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n=t(""),s=t(!0),r=t(0),o=t(t),a="Listener",i="Result",l="Ids",d="Table",c="Row",u=c+"Count",f=c+l,h="Sorted"+c+l,g="Cell",v=g+l,w=Math.max,L=Math.min,y=isFinite,R=e=>null==e,p=(e,t,n)=>R(e)?n?.():t(e),T=e=>t(e)==o,b=e=>Array.isArray(e),m=e=>e.length,C=()=>{},Q=(e,t)=>e.every(t),S=(e,t)=>e.forEach(t),I=e=>E(e,((e,t)=>e+t),0),x=e=>0==m(e),E=(e,t,n)=>e.reduce(t,n),M=(e,...t)=>e.push(...t),j=Object,D=j.entries,k=j.freeze,z=e=>e?.size??0,A=(e,t)=>e?.has(t)??!1,F=e=>R(e)||0==z(e),B=e=>[...e?.values()??[]],O=e=>e.clear(),W=(e,t)=>e?.forEach(t),q=(e,t)=>e?.delete(t),G=e=>new Map(e),H=(e,t)=>e?.get(t),J=(e,t)=>W(e,((e,n)=>t(n,e))),K=(e,t,n)=>R(n)?(q(e,t),e):e?.set(t,n),N=(e,t,n)=>(A(e,t)||K(e,t,n()),H(e,t)),P=(e,t,n,s,r=0)=>p((n?N:H)(e,t[r],r>m(t)-2?n:G),(o=>{if(r>m(t)-2)return s?.(o)&&K(e,t[r]),o;const a=P(o,t,n,s,r+1);return F(o)&&K(e,t[r]),a})),U=e=>new Set(b(e)||R(e)?e:[e]),V=(e,t)=>e?.add(t),X=G([["avg",[(e,t)=>I(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,s)=>e+(t-n)/s]],["max",[e=>w(...e),(e,t)=>w(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:w(t,e)]],["min",[e=>L(...e),(e,t)=>L(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:L(t,e)]],["sum",[e=>I(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),Y=((e,o)=>{const l=new WeakMap;return e=>(l.has(e)||l.set(e,(e=>{const o=e.createStore,l=o(),w=o(),L=G(),{addListener:I,callListeners:E,delListener:j}=w,[Y,Z,$,_,ee,,,te,,ne,se,re,oe,ae]=((e,t,n,s,r)=>{const o=e.hasRow,a=G(),i=G(),l=G(),d=G(),c=G(),u=G(),f=(t,n,...s)=>{const r=N(u,t,U);return S(s,(t=>V(r,t)&&n&&e.callListener(t))),s},h=(t,...n)=>p(H(u,t),(s=>{S(x(n)?B(s):n,(t=>{e.delListener(t),q(s,t)})),F(s)&&K(u,t)})),g=(e,t)=>{K(a,e,t),A(i,e)||(K(i,e,!0),K(d,e,G()),K(c,e,G()),r(l))},v=e=>{K(a,e),K(i,e),K(d,e),K(c,e),h(e),r(l)};return[()=>e,()=>{return e=a,[...e?.keys()??[]];var e},e=>J(i,e),e=>A(i,e),e=>H(a,e),e=>H(i,e),(e,t)=>K(i,e,t),g,(t,s,r,a,i)=>{g(t,s);const l=G(),u=G(),v=H(d,t),w=H(c,t),L=t=>{const r=n=>e.getCell(s,t,n),d=H(v,t),c=o(s,t)?n(a(r,t)):void 0;var f,h;if(d===c||b(d)&&b(c)&&(h=c,m(f=d)===m(h)&&Q(f,((e,t)=>h[t]===e)))||K(l,t,[d,c]),!R(i)){const e=H(w,t),n=o(s,t)?i(r,t):void 0;e!=n&&K(u,t,n)}},y=e=>{r((()=>{W(l,(([,e],t)=>K(v,t,e))),W(u,((e,t)=>K(w,t,e)))}),l,u,v,w,e),O(l),O(u)};J(v,L),e.hasTable(s)&&S(e.getRowIds(s),(e=>{A(v,e)||L(e)})),y(!0),h(t),f(t,0,e.addRowListener(s,null,((e,t,n)=>L(n))),e.addTableListener(s,(()=>y())))},v,e=>s(e,l),()=>J(u,v),f,h]})(e,0,C,I,E),ie=(e,t,...n)=>S(n,(n=>V(N(N(L,t,G),e,U),n))),le=e=>{p(H(L,e),(e=>{J(e,((e,t)=>W(t,(t=>e.delListener(t))))),O(e)})),S([w,l],(t=>t.delTable(e)))},de=(e,t,n)=>ie(t,e,t.addStartTransactionListener(n.startTransaction),t.addDidFinishTransactionListener((()=>n.finishTransaction()))),ce={setQueryDefinition:(o,a,i)=>{te(o,a),le(o);const d=[],c=[[null,[a,null,null,[],G()]]],u=[],f=[],h=[];i({select:(e,t)=>{const n=T(e)?[m(d)+"",e]:[R(t)?e:t,n=>n(e,t)];return M(d,n),{as:e=>n[0]=e}},join:(e,t,n)=>{const s=R(n)||T(t)?null:t,r=R(s)?t:n,o=[e,[e,s,T(r)?r:e=>e(r),[],G()]];return M(c,o),{as:e=>o[0]=e}},where:(e,t,n)=>M(u,T(e)?e:R(n)?n=>n(e)===t:s=>s(e,t)===n),group:(e,t,n,s,r)=>{const o=[e,[e,T(t)?[t,n,s,r]:H(X,t)??[(e,t)=>t]]];return M(f,o),{as:e=>o[0]=e}},having:(e,t)=>M(h,T(e)?e:n=>n(e)===t)});const g=G(d);if(F(g))return ce;const v=G(c);J(v,((e,[,t])=>p(H(v,t),(({3:t})=>R(e)?0:M(t,e)))));const L=G(f);let b=l;if(F(L)&&x(h))b=w;else{de(o,b,w);const e=G();J(L,((t,[n,s])=>V(N(e,n,U),[t,s])));const a=U();J(g,(t=>A(e,t)?0:V(a,t)));const i=G(),l=(a,i,l,d)=>p(a,(([c,u,f,g])=>{J(i,((o,[a])=>{const i=N(c,o,G),u=H(i,l),f=d?void 0:a;if(u!==f){const a=U([[u,f]]),d=z(i);K(i,l,f),W(H(e,o),(([e,o])=>{const l=((e,t,n,s,r,o=!1)=>{if(F(n))return;const[a,i,l,d]=r;return o||=R(e),W(s,(([n,s])=>{o||(e=R(n)?i?.(e,s,t++):R(s)?l?.(e,n,t--):d?.(e,s,n,t),o||=R(e))})),o?a(B(n),z(n)):e})(g[e],d,i,a,o);g[e]=R((e=>{const o=t(e);return(e=>e==n||e==s)(o)||o==r&&y(e)?o:void 0})(l))?null:l}))}})),F(u)||!Q(h,(e=>e((e=>g[e]))))?w.delRow(o,f):R(f)?a[2]=w.addRow(o,g):w.setRow(o,f,g)}));ie(b,o,b.addRowListener(o,null,((t,n,s,r)=>{const d=[],c=[],u=G(),f=b.hasRow(o,s);let h=!f;W(a,(e=>{const[t,n,a]=r(o,s,e);M(d,n),M(c,a),h||=t})),J(e,(e=>{const[t,,n]=r(o,s,e);(h||t)&&K(u,e,[n])})),h&&l(P(i,d,void 0,(([,e])=>(q(e,s),F(e)))),u,s,1),f&&l(P(i,c,(()=>{const e={};return W(a,(t=>e[t]=b.getCell(o,s,t))),[G(),U(),void 0,e]}),(([,e])=>{V(e,s)})),u,s)})))}de(o,e,b);const C=(t,n,s,r)=>{const i=t=>e.getCell(n,s,t);S(r,(n=>{const[s,,r,a,l]=H(v,n),d=r?.(i,t),[c,u]=H(l,t)??[];d!=c&&(R(u)||ae(o,u),K(l,t,R(d)?null:[d,...oe(o,1,e.addRowListener(s,d,(()=>C(t,s,d,a))))]))})),(t=>{const n=(n,s)=>e.getCell(...R(s)?[a,t,n]:n===a?[a,t,s]:[H(v,n)?.[0],H(H(v,n)?.[4],t)?.[0],s]);b.transaction((()=>Q(u,(e=>e(n)))?J(g,((e,s)=>((e,t,n,s,r)=>R(r)?e.delCell(t,n,s,!0):e.setCell(t,n,s,r))(b,o,t,e,s(n,t)))):b.delRow(o,t)))})(t)},{3:I}=H(v,null);return b.transaction((()=>oe(o,1,e.addRowListener(a,null,((t,n,s)=>{e.hasRow(a,s)?C(s,a,s,I):(b.delRow(o,s),W(v,(({4:e})=>p(H(e,s),(([,t])=>{ae(o,t),K(e,s)})))))}))))),ce},delQueryDefinition:e=>(le(e),ne(e),ce),getStore:Y,getQueryIds:Z,forEachQuery:$,hasQuery:_,getTableId:ee,addQueryIdsListener:e=>se((()=>e(ce))),delListener:e=>(j(e),ce),destroy:re,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:n,...s}=w.getListenerStats();return s}};var ue;return ue=([e,t],n)=>{S(e?["get","has","forEach"]:["get"],(e=>ce[e+i+n]=(...t)=>w[e+n](...t))),ce["add"+i+n+a]=(...e)=>{return w["add"+n+a](...(s=e,0,r=t,s.slice(0,r)),((n,...s)=>e[t](ce,...s)),!0);var s,r}},((e,t)=>{e.map(t)})(D({[d]:[1,1],[d+v]:[0,1],[u]:[0,1],[f]:[0,1],[h]:[0,5],[c]:[1,2],[v]:[0,2],[g]:[1,3]}),(([e,t])=>ue(t,e))),k(ce)})(e)),l.get(e))})();e.createQueries=Y},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseQueries={});
