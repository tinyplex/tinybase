var e,t;e=this,t=function(e){"use strict";const t=Promise,a=Math.max,n=e=>null==e,s=(e,t,a)=>n(e)?a?.():t(e),o=(e,t,a)=>e.slice(t,a),r=e=>new t(e),i=(e,t)=>e.forEach(t),l=Object,c=e=>l.getPrototypeOf(e),g=l.entries,d=l.keys,u=l.freeze,y=(e,t)=>i(g(e),(([e,a])=>t(a,e))),f=e=>(e=>!n(e)&&s(c(e),(e=>e==l.prototype||n(c(e))),(()=>!0)))(e)&&0==(e=>d(e).length)(e),h=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),p=(e,t)=>e?.delete(t),v=e=>new Map(e),b=(e,t)=>e?.get(t),w=(e,t,a)=>n(a)?(p(e,t),e):e?.set(t,a),S=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)||w(e,t,a()),b(e,t)},C=new globalThis.TextEncoder,M=(e,t)=>t?[e,t]:[e],A=(e,t)=>((e??"")>(t??"")?e:t)??"",T=(e="")=>M(((e=[])=>l.fromEntries(e))(),e),m=v(),L=v(),D=2**36,H=2**30,x=2**24,O=2**18,E=4096,z=64,N=e=>String.fromCharCode(48+(63&e)),P=(e,t)=>((e,t)=>e.charCodeAt(t))(e,t)-48;e.createWsSynchronizer=async(e,t,l=1,c)=>{let g;const d=(e,a)=>t.addEventListener(e,a),W=((e,t,o,l,c,g,d={})=>{let W;const[j]=(e=>{let t=0,s=-1;const o=(e=>{let t=2166136261;return i(C.encode(e),(e=>{t^=e,t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24)})),t>>>0})(e),r=e=>{const o=t,[r,i]=n(e)||""==e?[0,0]:[P(l=e,0)*D+P(l,1)*H+P(l,2)*x+P(l,3)*O+P(l,4)*E+P(l,5)*z+P(l,6),P(l,7)*O+P(l,8)*E+P(l,9)*z+P(l,10),P(l,11)*x+P(l,12)*O+P(l,13)*E+P(l,14)*z+P(l,15)];var l;t=a(o,r,Date.now()),s=t==o?t==r?a(s,i):s:t==r?i:-1};return[()=>{return r(),a=++s,n=o,N((e=t)/D)+N(e/H)+N(e/x)+N(e/O)+N(e/E)+N(e/z)+N(e)+N(a/O)+N(a/E)+N(a/z)+N(a)+N(n/x)+N(n/O)+N(n/E)+N(n/z)+N(n);var e,a,n},r]})(e.getId()),k=v();o(((a,o,r,i)=>{0==r?s(b(k,o),(([e,t])=>n(e)||e==a?t(i,a):0)):2==r&&$.isAutoLoading()?V(a,i).then((e=>{W?.(void 0,e)})):3==r&&$.isAutoLoading()?W?.(void 0,i):s(1==r&&$.isAutoSaving()?e.getMergeableContentHashes():4==r?e.getMergeableTableDiff(i):5==r?e.getMergeableRowDiff(i):6==r?e.getMergeableCellDiff(i):7==r?e.getMergeableValueDiff(i):void 0,(e=>{t(a,o,0,e)}))}));const J=async(e,a,n="")=>r(((s,o)=>{const r=j(),i=setTimeout((()=>{p(k,r),o(`No response from ${e??"anyone"} to '${a}'`)}),1e3*c);w(k,r,[e,(e,t)=>{clearTimeout(i),p(k,r),s([e,t])}]),t(e,r,a,n)})),R=(e,[t,a])=>{y(t,(([t,a],n)=>{const s=h(e[0],n,T);y(t,(([e,t],a)=>{const n=h(s[0],a,T);y(e,(([e,t],a)=>n[0][a]=M(e,t))),n[1]=A(n[1],t)})),s[1]=A(s[1],a)})),e[1]=A(e[1],a)},V=async(t=null,a)=>{n(a)&&([a,t]=await J(t,1));const[s,o]=a,[r,i]=e.getMergeableContentHashes();let l=T();if(r!=s){const[a,n]=(await J(t,4,e.getMergeableTableHashes()))[0];if(l=a,!f(n)){const[a,s]=(await J(t,5,e.getMergeableRowHashes(n)))[0];if(R(l,a),!f(s)){const a=(await J(t,6,e.getMergeableCellHashes(s)))[0];R(l,a)}}}return[l,i==o?T():(await J(t,7,e.getMergeableValuesHashes()))[0],1]},$=((e,t,a,o,r,i,l,c={},g=[])=>{let d,y,h,p=0;S(m,g,(()=>0)),S(L,g,(()=>[]));const[v,C,M,A,T]=((e=1,t)=>e>1&&"getMergeableContent"in t?[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!f(e)||!f(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!f(e)||!f(t),t.setContent]:0)(l,e),D=t=>{var a;(v&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},H=async e=>(2!=p&&(p=1,await z((async()=>{try{D(await t())}catch(t){i?.(t),e&&T(e)}p=0}))),N),x=()=>(y&&(r(y),y=void 0),N),O=async e=>(1!=p&&(p=2,await z((async()=>{try{await a(C,e)}catch(e){i?.(e)}p=0}))),N),E=()=>(s(h,e.delListener),h=void 0,N),z=async(...e)=>(((e,...t)=>{e.push(...t)})(b(L,g),...e),await(async()=>{if(!b(m,g)){for(w(m,g,1);!n((e=b(L,g),d=e.shift()));)try{await d()}catch(e){i?.(e)}w(m,g,0)}var e})(),N),N={load:H,startAutoLoad:async e=>(await x().load(e),y=o((async(e,t)=>{t||e?2!=p&&(p=1,D(t??e),p=0):await H()})),N),stopAutoLoad:x,isAutoLoading:()=>!n(y),save:O,startAutoSave:async()=>(await E().save(),h=e.addDidFinishTransactionListener((()=>{const e=M();A(e)&&O(e)})),N),stopAutoSave:E,isAutoSaving:()=>!n(h),schedule:z,getStore:()=>e,destroy:()=>x().stopAutoSave(),getStats:()=>({}),...c};return u(N)})(e,(async()=>{const e=await V();return f(e[0][0])&&f(e[1][0])?void 0:e}),(async(a,n)=>{n?t(null,null,3,n):t(null,null,2,e.getMergeableContentHashes())}),(e=>W=e),(()=>W=void 0),g,2,{startSync:async e=>await(await $.startAutoLoad(e)).startAutoSave(),stopSync:()=>$.stopAutoLoad().stopAutoSave(),destroy:()=>(l(),$.stopSync()),getSynchronizerStats:()=>({}),...d});return $})(e,((e,...a)=>{t.send((e??"")+"\n"+JSON.stringify(a,((e,t)=>void 0===t?"￼":t)))}),(e=>{g=e}),(()=>{t.close()}),l,c,{getWebSocket:()=>t});return d("message",(({data:e})=>{if(!n(g)){const a=e.toString("utf8").indexOf("\n");-1!==a&&g(o(e,0,a),...(t=o(e,a+1),JSON.parse(t,((e,t)=>"￼"===t?void 0:t))))}var t})),r(((e,a)=>{t.readyState!=t.OPEN?(d("error",a),d("open",(()=>e(W)))):e(W)}))}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerWsClient={});
