var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a="",n=t(a),s=Promise,o=Math.max,r=e=>null==e,i=(e,t,a)=>r(e)?a?.():t(e),c=(e,t,a)=>e.slice(t,a),l=e=>new s(e),g=Object,d=e=>g.getPrototypeOf(e),u=g.keys,y=g.freeze,h=e=>(e=>!r(e)&&i(d(e),(e=>e==g.prototype||r(d(e))),(()=>!0)))(e)&&0==(e=>u(e).length)(e),f=JSON.parse,p=(e,t)=>e?.delete(t),w=e=>new Map(e),b=(e,t)=>e?.get(t),v=(e,t,a)=>r(a)?(p(e,t),e):e?.set(t,a),S=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)||v(e,t,a()),b(e,t)},C=w(),M=w(),A=new globalThis.TextEncoder,T=2**36,L=2**30,m=2**24,H=2**18,x=4096,O=64,D=e=>String.fromCharCode(48+(63&e)),E=(e,t)=>((e,t)=>e.charCodeAt(t))(e,t)-48;e.createWsSynchronizer=async(e,s,d=1,u)=>{let z;const N=(e,t)=>s.addEventListener(e,t),I=((e,s,c,g,d,u,f={})=>{let z;const[N]=(e=>{let t=0,a=-1;const n=(e=>{let t=2166136261;var a;return a=e=>{t^=e,t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24)},A.encode(e).forEach(a),t>>>0})(e),s=e=>{const n=t,[s,i]=r(e)||""==e?[0,0]:[E(c=e,0)*T+E(c,1)*L+E(c,2)*m+E(c,3)*H+E(c,4)*x+E(c,5)*O+E(c,6),E(c,7)*H+E(c,8)*x+E(c,9)*O+E(c,10),E(c,11)*m+E(c,12)*H+E(c,13)*x+E(c,14)*O+E(c,15)];var c;t=o(n,s,Date.now()),a=t==n?t==s?o(a,i):a:t==s?i:-1};return[()=>{return s(),o=++a,r=n,D((e=t)/T)+D(e/L)+D(e/m)+D(e/H)+D(e/x)+D(e/O)+D(e)+D(o/H)+D(o/x)+D(o/O)+D(o)+D(r/m)+D(r/H)+D(r/x)+D(r/O)+D(r);var e,o,r},s]})(e.getId()),I=w();c(((t,a,n,o)=>{0==n?i(b(I,a),(([e,a])=>r(e)||e==t?a(o,t):0)):1==n&&j.isAutoLoading()?W(t,o).then((e=>z?.(void 0,(()=>e)))):i(2==n&&j.isAutoSaving()?e.getMergeableContentHashes():3==n?e.getMergeableTableIdsDiff(o):4==n?e.getMergeableRowIdsDiff(o):5==n?e.getMergeableTablesChanges(o):6==n?e.getMergeableValuesChanges(o):void 0,(e=>{s(t,a,0,e)}))}));const P=async(e,t,a="")=>l(((n,o)=>{const r=N(),i=setTimeout((()=>{p(I,r),o(`No response from ${e??"anyone"} to '${t}'`)}),1e3*d);v(I,r,[e,(e,t)=>{clearTimeout(i),p(I,r),n([e,t])}]),s(e,r,t,a)})),W=async(t=null,n)=>{r(n)&&([n,t]=await P(t,2));const[s,[o,i]]=n,[,[c,l]]=e.getMergeableContentHashes(),g=[a,[[a,{}],[a,{}],1]];return c!=o&&(g[0]=s,g[1][0]=(await P(t,5,e.getMergeableCellHashes((await P(t,4,e.getMergeableRowHashes((await P(t,3,e.getMergeableTableHashes()))[0])))[0])))[0]),l!=i&&(g[0]=s,g[1][1]=(await P(t,6,e.getMergeableValuesHashes()))[0]),g},j=((e,a,s,o,c,l,g,d={},u=[])=>{let f,p,w,A=0;S(C,u,(()=>0)),S(M,u,(()=>[]));const[T,L,m,H,x]=((e,t)=>r(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!h(e)||!h(t),t.setContent]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!h(e)||!h(t),t.setDefaultContent])(0,e),O=async e=>(2!=A&&(A=1,await E.schedule((async()=>{await e(),A=0}))),E),D=a=>{var s;(T&&(s=a?.[0],t(s)==n)?1===a?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===a?.[2]?e.applyChanges:e.setContent)(a)},E={load:async e=>await O((async()=>{try{D(await a())}catch(t){l?.(t),e&&x(e)}})),startAutoLoad:async e=>(await E.stopAutoLoad().load(e),p=o((async(e,t)=>{const n=t?.();await O((async()=>{try{D(n??e?.()??await a())}catch(e){l?.(e)}}))})),E),stopAutoLoad:()=>(p&&(c(p),p=void 0),E),isAutoLoading:()=>!r(p),save:async e=>(1!=A&&(A=2,await E.schedule((async()=>{try{await s(L,e)}catch(e){l?.(e)}A=0}))),E),startAutoSave:async()=>(await E.stopAutoSave().save(),w=e.addDidFinishTransactionListener((()=>{const e=m();H(e)&&E.save((()=>e))})),E),stopAutoSave:()=>(i(w,e.delListener),w=void 0,E),isAutoSaving:()=>!r(w),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(b(M,u),...e),await(async()=>{if(!b(C,u)){for(v(C,u,1);!r((e=b(M,u),f=e.shift()));)try{await f()}catch(e){l?.(e)}v(C,u,0)}var e})(),E),getStore:()=>e,destroy:()=>E.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...d};return y(E)})(e,(async()=>{const e=await W();return e[0]!=a?e:void 0}),(async()=>{s(null,null,1,e.getMergeableContentHashes())}),(e=>z=e),(()=>z=void 0),u,0,{startSync:async e=>await(await j.startAutoLoad(e)).startAutoSave(),stopSync:()=>j.stopAutoLoad().stopAutoSave(),destroy:()=>(g(),j.stopSync()),getSynchronizerStats:()=>({}),...f});return j})(e,((e,...t)=>{s.send((e??a)+"\n"+JSON.stringify(t,((e,t)=>t instanceof Map?g.fromEntries([...t]):t)))}),(e=>{z=e}),(()=>{s.close()}),d,u,{getWebSocket:()=>s});return N("message",(({data:e})=>{if(!r(z)){const t=e.toString("utf8").indexOf("\n");-1!==t&&z(c(e,0,t),...f(c(e,t+1)))}})),l(((e,t)=>{s.readyState!=s.OPEN?(N("error",t),N("open",(()=>e(I)))):e(I)}))}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerWsClient={});
