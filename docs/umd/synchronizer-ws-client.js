var e,t;e=this,t=function(e){"use strict";const t=Promise,a=Math.max,n=e=>null==e,s=(e,t,a)=>n(e)?a?.():t(e),o=(e,t,a)=>e.slice(t,a),r=e=>new t(e),i=(e,t)=>e.forEach(t),c=Object,l=e=>c.getPrototypeOf(e),g=c.entries,d=c.keys,u=c.freeze,y=(e,t)=>i(g(e),(([e,a])=>t(a,e))),f=e=>(e=>!n(e)&&s(l(e),(e=>e==c.prototype||n(l(e))),(()=>!0)))(e)&&0==(e=>d(e).length)(e),h=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),p=(e,t)=>e?.delete(t),v=e=>new Map(e),w=(e,t)=>e?.get(t),b=(e,t,a)=>n(a)?(p(e,t),e):e?.set(t,a),S=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)||b(e,t,a()),w(e,t)},A=new globalThis.TextEncoder,C=(e,t)=>t?[e,t]:[e],M=(e,t)=>((e??"")>(t??"")?e:t)??"",L=(e="")=>C(((e=[])=>c.fromEntries(e))(),e),T=v(),m=v(),D=2**36,H=2**30,x=2**24,O=2**18,E=4096,z=64,N=e=>String.fromCharCode(48+(63&e)),P=(e,t)=>((e,t)=>e.charCodeAt(t))(e,t)-48;e.createWsSynchronizer=async(e,t,c=1,l)=>{let g;const d=(e,a)=>t.addEventListener(e,a),W=((e,t,o,c,l,g,d={})=>{let W;const[j]=(e=>{let t=0,s=-1;const o=(e=>{let t=2166136261;return i(A.encode(e),(e=>{t^=e,t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24)})),t>>>0})(e),r=e=>{const o=t,[r,i]=n(e)||""==e?[0,0]:[P(c=e,0)*D+P(c,1)*H+P(c,2)*x+P(c,3)*O+P(c,4)*E+P(c,5)*z+P(c,6),P(c,7)*O+P(c,8)*E+P(c,9)*z+P(c,10),P(c,11)*x+P(c,12)*O+P(c,13)*E+P(c,14)*z+P(c,15)];var c;t=a(o,r,Date.now()),s=t==o?t==r?a(s,i):s:t==r?i:-1};return[()=>{return r(),a=++s,n=o,N((e=t)/D)+N(e/H)+N(e/x)+N(e/O)+N(e/E)+N(e/z)+N(e)+N(a/O)+N(a/E)+N(a/z)+N(a)+N(n/x)+N(n/O)+N(n/E)+N(n/z)+N(n);var e,a,n},r]})(e.getId()),k=v();o(((a,o,r,i)=>{0==r?s(w(k,o),(([e,t])=>n(e)||e==a?t(i,a):0)):2==r&&$.isAutoLoading()?V(a,i).then((e=>{W?.(void 0,(()=>e))})):3==r&&$.isAutoLoading()?W?.(void 0,(()=>i)):s(1==r&&$.isAutoSaving()?e.getMergeableContentHashes():4==r?e.getMergeableTableDiff(i):5==r?e.getMergeableRowDiff(i):6==r?e.getMergeableCellDiff(i):7==r?e.getMergeableValueDiff(i):void 0,(e=>{t(a,o,0,e)}))}));const J=async(e,a,n="")=>r(((s,o)=>{const r=j(),i=setTimeout((()=>{p(k,r),o(`No response from ${e??"anyone"} to '${a}'`)}),1e3*l);b(k,r,[e,(e,t)=>{clearTimeout(i),p(k,r),s([e,t])}]),t(e,r,a,n)})),R=(e,[t,a])=>{y(t,(([t,a],n)=>{const s=h(e[0],n,L);y(t,(([e,t],a)=>{const n=h(s[0],a,L);y(e,(([e,t],a)=>n[0][a]=C(e,t))),n[1]=M(n[1],t)})),s[1]=M(s[1],a)})),e[1]=M(e[1],a)},V=async(t=null,a)=>{n(a)&&([a,t]=await J(t,1));const[s,o]=a,[r,i]=e.getMergeableContentHashes();let c=L();if(r!=s){const[a,n]=(await J(t,4,e.getMergeableTableHashes()))[0];if(c=a,!f(n)){const[a,s]=(await J(t,5,e.getMergeableRowHashes(n)))[0];if(R(c,a),!f(s)){const a=(await J(t,6,e.getMergeableCellHashes(s)))[0];R(c,a)}}}return[c,i==o?L():(await J(t,7,e.getMergeableValuesHashes()))[0],1]},$=((e,t,a,o,r,i,c,l={},g=[])=>{let d,y,h,p=0;S(T,g,(()=>0)),S(m,g,(()=>[]));const[v,A,C,M,L]=((e,t)=>n(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!f(e)||!f(t),t.setContent]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!f(e)||!f(t),t.setDefaultContent])(0,e),D=async e=>(2!=p&&(p=1,await x.schedule((async()=>{await e(),p=0}))),x),H=t=>{var a;(v&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},x={load:async e=>await D((async()=>{try{H(await t())}catch(t){i?.(t),e&&L(e)}})),startAutoLoad:async e=>(await x.stopAutoLoad().load(e),y=o((async(e,a)=>{const n=a?.();await D((async()=>{try{H(n??e?.()??await t())}catch(e){i?.(e)}}))})),x),stopAutoLoad:()=>(y&&(r(y),y=void 0),x),isAutoLoading:()=>!n(y),save:async e=>(1!=p&&(p=2,await x.schedule((async()=>{try{await a(A,e)}catch(e){i?.(e)}p=0}))),x),startAutoSave:async()=>(await x.stopAutoSave().save(),h=e.addDidFinishTransactionListener((()=>{const e=C();M(e)&&x.save((()=>e))})),x),stopAutoSave:()=>(s(h,e.delListener),h=void 0,x),isAutoSaving:()=>!n(h),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(w(m,g),...e),await(async()=>{if(!w(T,g)){for(b(T,g,1);!n((e=w(m,g),d=e.shift()));)try{await d()}catch(e){i?.(e)}b(T,g,0)}var e})(),x),getStore:()=>e,destroy:()=>x.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...l};return u(x)})(e,(async()=>{const e=await V();return f(e[0][0])&&f(e[1][0])?void 0:e}),(async(a,n)=>{n?t(null,null,3,n()):t(null,null,2,e.getMergeableContentHashes())}),(e=>W=e),(()=>W=void 0),g,0,{startSync:async e=>await(await $.startAutoLoad(e)).startAutoSave(),stopSync:()=>$.stopAutoLoad().stopAutoSave(),destroy:()=>(c(),$.stopSync()),getSynchronizerStats:()=>({}),...d});return $})(e,((e,...a)=>{t.send((e??"")+"\n"+JSON.stringify(a,((e,t)=>void 0===t?"￼":t)))}),(e=>{g=e}),(()=>{t.close()}),c,l,{getWebSocket:()=>t});return d("message",(({data:e})=>{if(!n(g)){const a=e.toString("utf8").indexOf("\n");-1!==a&&g(o(e,0,a),...(t=o(e,a+1),JSON.parse(t,((e,t)=>"￼"===t?void 0:t))))}var t})),r(((e,a)=>{t.readyState!=t.OPEN?(d("error",a),d("open",(()=>e(W)))):e(W)}))}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerWsClient={});
