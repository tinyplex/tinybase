var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a="",n=t(a),s=Promise,o=Math.max,r=e=>null==e,i=(e,t,a)=>r(e)?a?.():t(e),c=(e,t,a)=>e.slice(t,a),l=e=>new s(e),g=Object,d=e=>g.getPrototypeOf(e),u=g.keys,y=g.freeze,h=e=>(e=>!r(e)&&i(d(e),(e=>e==g.prototype||r(d(e))),(()=>!0)))(e)&&0==(e=>u(e).length)(e),f=JSON.parse,p=(e,t)=>e?.delete(t),w=e=>new Map(e),b=(e,t)=>e?.get(t),v=(e,t,a)=>r(a)?(p(e,t),e):e?.set(t,a),S=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)?n?.(b(e,t)):v(e,t,a()),b(e,t)},C=w(),M=w(),A=new globalThis.TextEncoder,T=2**36,m=2**30,L=2**24,H=2**18,x=4096,O=64,z=e=>String.fromCharCode(48+(63&e)),D=(e,t)=>((e,t)=>e.charCodeAt(t))(e,t)-48;e.createWsSynchronizer=async(e,s,d,u)=>{let E;s.on("message",(e=>{if(!r(E)){const t=e.toString("utf8"),a=t.indexOf("\n");-1!==a&&E(c(t,0,a),...f(c(t,a+1)))}}));const N=((e,s,c,g,d=1,u)=>{let f;const[E]=(e=>{let t=0,a=-1;const n=(e=>{let t=2166136261;var a;return a=e=>{t^=e,t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24)},A.encode(e).forEach(a),t>>>0})(e),s=e=>{const n=t,[s,i]=r(e)||""==e?[0,0]:[D(c=e,0)*T+D(c,1)*m+D(c,2)*L+D(c,3)*H+D(c,4)*x+D(c,5)*O+D(c,6),D(c,7)*H+D(c,8)*x+D(c,9)*O+D(c,10),D(c,11)*L+D(c,12)*H+D(c,13)*x+D(c,14)*O+D(c,15)];var c;t=o(n,s,Date.now()),a=t==n?t==s?o(a,i):a:t==s?i:-1};return[()=>{return s(),o=++a,r=n,z((e=t)/T)+z(e/m)+z(e/L)+z(e/H)+z(e/x)+z(e/O)+z(e)+z(o/H)+z(o/x)+z(o/O)+z(o)+z(r/L)+z(r/H)+z(r/x)+z(r/O)+z(r);var e,o,r},s]})(e.getId()),N=w();c(((t,a,n,o)=>{0==n?i(b(N,a),(([e,a])=>r(e)||e==t?a(o,t):0)):1==n&&j.isAutoLoading()?P(t,o).then((e=>f?.(void 0,(()=>e)))):i(2==n&&j.isAutoSaving()?e.getMergeableContentHashes():3==n?e.getMergeableTableIdsDiff(o):4==n?e.getMergeableRowIdsDiff(o):5==n?e.getMergeableTablesChanges(o):6==n?e.getMergeableValuesChanges(o):void 0,(e=>{s(t,a,0,e)}))}));const I=async(e,t,a="")=>l(((n,o)=>{const r=E(),i=setTimeout((()=>{p(N,r),o(`No response from ${e??"anyone"} to '${t}'`)}),1e3*d);v(N,r,[e,(e,t)=>{clearTimeout(i),p(N,r),n([e,t])}]),s(e,r,t,a)})),P=async(t=null,n)=>{r(n)&&([n,t]=await I(t,2));const[s,[o,i]]=n,[,[c,l]]=e.getMergeableContentHashes(),g=[a,[[a,{}],[a,{}],1]];return c!=o&&(g[0]=s,g[1][0]=(await I(t,5,e.getMergeableCellHashes((await I(t,4,e.getMergeableRowHashes((await I(t,3,e.getMergeableTableHashes()))[0])))[0])))[0]),l!=i&&(g[0]=s,g[1][1]=(await I(t,6,e.getMergeableValuesHashes()))[0]),g},j=((e,a,s,o,c,l,g,d={},u=[])=>{let f,p,w,A=0;S(C,u,(()=>0)),S(M,u,(()=>[]));const[T,m,L,H]=((e,t)=>!e||r(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!h(e)||!h(t)]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!h(e)||!h(t)])(g,e),x=async e=>(2!=A&&(A=1,await z.schedule((async()=>{await e(),A=0}))),z),O=a=>{var s;(T&&(s=a?.[0],t(s)==n)?1===a?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===a?.[2]?e.applyChanges:e.setContent)(a)},z={load:async(t,n)=>await x((async()=>{try{O(await a())}catch(a){l?.(a),e.setContent([t,n])}})),startAutoLoad:async(e={},t={})=>(await z.stopAutoLoad().load(e,t),p=o((async(e,t)=>{const n=t?.();await x((async()=>{try{O(n??e?.()??await a())}catch(e){l?.(e)}}))})),z),stopAutoLoad:()=>(p&&(c(p),p=void 0),z),isAutoLoading:()=>!r(p),save:async e=>(1!=A&&(A=2,await z.schedule((async()=>{try{await s(m,e)}catch(e){l?.(e)}A=0}))),z),startAutoSave:async()=>(await z.stopAutoSave().save(),w=e.addDidFinishTransactionListener((()=>{const e=L();H(e)&&z.save((()=>e))})),z),stopAutoSave:()=>(i(w,e.delListener),w=void 0,z),isAutoSaving:()=>!r(w),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(b(M,u),...e),await(async()=>{if(!b(C,u)){for(v(C,u,1);!r((e=b(M,u),f=e.shift()));)try{await f()}catch(e){l?.(e)}v(C,u,0)}var e})(),z),getStore:()=>e,destroy:()=>z.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...d};return y(z)})(e,(async()=>{const e=await P();return e[0]!=a?e:void 0}),(async()=>{s(null,null,1,e.getMergeableContentHashes())}),(e=>f=e),(()=>f=void 0),u,!0,{startSync:async()=>await(await j.startAutoLoad()).startAutoSave(),stopSync:()=>j.stopAutoLoad().stopAutoSave(),destroy:()=>(g(),j.stopSync()),getSynchronizerStats:()=>({})});return j})(e,((e,...t)=>{s.send((e??a)+"\n"+JSON.stringify(t,((e,t)=>t instanceof Map?g.fromEntries([...t]):t)))}),(e=>{E=e}),(()=>{s.close()}),d,u);return l(((e,t)=>{s.readyState!=s.OPEN?(s.on("error",t),s.on("open",(()=>e(N)))):e(N)}))}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerWsClient={});
