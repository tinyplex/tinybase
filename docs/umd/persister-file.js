var e,t;e=this,t=function(e,t,a){"use strict";const s="utf8",n=e=>null==e,o=(e,t,a)=>n(e)?a?.():t(e),r=Object,i=e=>r.getPrototypeOf(e),c=r.keys,y=r.freeze,l=e=>(e=>!n(e)&&o(i(e),(e=>e==r.prototype||n(i(e))),(()=>!0)))(e)&&0==(e=>c(e).length)(e),d=e=>new Map(e),u=(e,t)=>e?.get(t),f=(e,t,a)=>{return n(a)?(s=e,o=t,s?.delete(o),e):e?.set(t,a);var s,o},p=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)||f(e,t,a()),u(e,t)},g=d(),h=d();e.createFilePersister=(e,r,i)=>((e,t,a,s,r,i,c,d={},v=[])=>{let w,A,C,b=0;p(g,v,(()=>0)),p(h,v,(()=>[]));const[S,L,F,M,T]=((e,t)=>n(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!l(e)||!l(t),t.setContent]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!l(e)||!l(t),t.setDefaultContent])(0,e),m=async e=>(2!=b&&(b=1,await P.schedule((async()=>{await e(),b=0}))),P),O=t=>{var a;(S&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},P={load:async e=>await m((async()=>{try{O(await t())}catch(t){i?.(t),e&&T(e)}})),startAutoLoad:async e=>(await P.stopAutoLoad().load(e),A=s((async(e,a)=>{const s=a?.();await m((async()=>{try{O(s??e?.()??await t())}catch(e){i?.(e)}}))})),P),stopAutoLoad:()=>(A&&(r(A),A=void 0),P),isAutoLoading:()=>!n(A),save:async e=>(1!=b&&(b=2,await P.schedule((async()=>{try{await a(L,e)}catch(e){i?.(e)}b=0}))),P),startAutoSave:async()=>(await P.stopAutoSave().save(),C=e.addDidFinishTransactionListener((()=>{const e=F();M(e)&&P.save((()=>e))})),P),stopAutoSave:()=>(o(C,e.delListener),C=void 0,P),isAutoSaving:()=>!n(C),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(u(h,v),...e),await(async()=>{if(!u(g,v)){for(f(g,v,1);!n((e=u(h,v),w=e.shift()));)try{await w()}catch(e){i?.(e)}f(g,v,0)}var e})(),P),getStore:()=>e,destroy:()=>P.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...d};return y(P)})(e,(async()=>{return e=await a.readFile(r,s),JSON.parse(e,((e,t)=>"￼"===t?void 0:t));var e}),(async e=>{return await a.writeFile(r,(t=e(),JSON.stringify(t,((e,t)=>void 0===t?"￼":t))),s);var t}),(e=>t.watch(r,(()=>e()))),(e=>e?.close()),i,0,{getFilePath:()=>r})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs"),require("fs/promises")):"function"==typeof define&&define.amd?define(["exports","fs","fs/promises"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterFile={},e.fs,e["fs/promises"]);
