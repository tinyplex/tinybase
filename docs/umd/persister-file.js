var e,t;e=this,t=function(e,t,a){"use strict";const s=e=>typeof e,n=s(""),o="utf8",i=e=>null==e,r=(e,t,a)=>i(e)?a?.():t(e),c=Object,y=e=>c.getPrototypeOf(e),l=c.keys,d=c.freeze,f=e=>(e=>!i(e)&&r(y(e),(e=>e==c.prototype||i(y(e))),(()=>!0)))(e)&&0==(e=>l(e).length)(e),p=JSON.parse,u=e=>new Map(e),g=(e,t)=>e?.get(t),h=(e,t,a)=>{return i(a)?(s=e,n=t,s?.delete(n),e):e?.set(t,a);var s,n},w=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)?s?.(g(e,t)):h(e,t,a()),g(e,t)},v=u(),A=u();e.createFilePersister=(e,y,l)=>((e,t,a,o,c,y,l,p={},u=[])=>{let C,b,S,L=0;w(v,u,(()=>0)),w(A,u,(()=>[]));const[M,m,F,T]=((e,t)=>!e||i(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!f(e)||!f(t)]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!f(e)||!f(t)])(l,e),O=async e=>(2!=L&&(L=1,await x.schedule((async()=>{await e(),L=0}))),x),P=t=>{var a;(M&&(a=t?.[0],s(a)==n)?1===t?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},x={load:async(a,s)=>await O((async()=>{try{P(await t())}catch(t){y?.(t),e.setContent([a,s])}})),startAutoLoad:async(e={},a={})=>(await x.stopAutoLoad().load(e,a),b=o((async(e,a)=>{const s=a?.();await O((async()=>{try{P(s??e?.()??await t())}catch(e){y?.(e)}}))})),x),stopAutoLoad:()=>(b&&(c(b),b=void 0),x),isAutoLoading:()=>!i(b),save:async e=>(1!=L&&(L=2,await x.schedule((async()=>{try{await a(m,e)}catch(e){y?.(e)}L=0}))),x),startAutoSave:async()=>(await x.stopAutoSave().save(),S=e.addDidFinishTransactionListener((()=>{const e=F();T(e)&&x.save((()=>e))})),x),stopAutoSave:()=>(r(S,e.delListener),S=void 0,x),isAutoSaving:()=>!i(S),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(g(A,u),...e),await(async()=>{if(!g(v,u)){for(h(v,u,1);!i((e=g(A,u),C=e.shift()));)try{await C()}catch(e){y?.(e)}h(v,u,0)}var e})(),x),getStore:()=>e,destroy:()=>x.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...p};return d(x)})(e,(async()=>p(await a.readFile(y,o))),(async e=>{return await a.writeFile(y,(t=e(),JSON.stringify(t,((e,t)=>t instanceof Map?c.fromEntries([...t]):t))),o);var t}),(e=>t.watch(y,(()=>e()))),(e=>e?.close()),l,!0,{getFilePath:()=>y})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs"),require("fs/promises")):"function"==typeof define&&define.amd?define(["exports","fs","fs/promises"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterFile={},e.fs,e["fs/promises"]);
