var e,t;e=this,t=function(e,t,a){"use strict";const s="utf8",r=e=>null==e,n=(e,t,a)=>r(e)?a?.():t(e),i=Object,o=e=>i.getPrototypeOf(e),c=i.keys,y=i.freeze,l=e=>(e=>!r(e)&&n(o(e),(e=>e==i.prototype||r(o(e))),(()=>!0)))(e)&&0==(e=>c(e).length)(e),d=e=>new Map(e),f=(e,t)=>e?.get(t),p=(e,t,a)=>{return r(a)?(s=e,n=t,s?.delete(n),e):e?.set(t,a);var s,n},u=(e,t,a,s)=>{var r,n;return r=e,n=t,r?.has(n)||p(e,t,a()),f(e,t)},g=d(),h=d();e.createFilePersister=(e,i,o)=>((e,t,a,s,i,o,c,d={},v=[])=>{let w,b,C,A=0;u(g,v,(()=>0)),u(h,v,(()=>[]));const[S,F,M,T,m]=((e=1,t)=>e>1&&t.isMergeable()?[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!l(e)||!l(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!l(e)||!l(t),t.setContent]:(e=>{throw Error("Store type not supported by this Persister")})())(c,e),L=t=>{var a;(S&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},P=async e=>(2!=A&&(A=1,await q((async()=>{try{L(await t())}catch(t){o?.(t),e&&m(e)}A=0}))),D),O=()=>(b&&(i(b),b=void 0),D),x=async e=>(1!=A&&(A=2,await q((async()=>{try{await a(F,e)}catch(e){o?.(e)}A=0}))),D),j=()=>(n(C,e.delListener),C=void 0,D),q=async(...e)=>(((e,...t)=>{e.push(...t)})(f(h,v),...e),await(async()=>{if(!f(g,v)){for(p(g,v,1);!r((e=f(h,v),w=e.shift()));)try{await w()}catch(e){o?.(e)}p(g,v,0)}var e})(),D),D={load:P,startAutoLoad:async e=>(await O().load(e),b=s((async(e,t)=>{t||e?2!=A&&(A=1,L(t??e),A=0):await P()})),D),stopAutoLoad:O,isAutoLoading:()=>!r(b),save:x,startAutoSave:async()=>(await j().save(),C=e.addDidFinishTransactionListener((()=>{const e=M();T(e)&&x(e)})),D),stopAutoSave:j,isAutoSaving:()=>!r(C),schedule:q,getStore:()=>e,destroy:()=>O().stopAutoSave(),getStats:()=>({}),...d};return y(D)})(e,(async()=>{return e=await a.readFile(i,s),JSON.parse(e,((e,t)=>"￼"===t?void 0:t));var e}),(async e=>{return await a.writeFile(i,(t=e(),JSON.stringify(t,((e,t)=>void 0===t?"￼":t))),s);var t}),(e=>t.watch(i,(()=>e()))),(e=>e?.close()),o,3,{getFilePath:()=>i})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs"),require("fs/promises")):"function"==typeof define&&define.amd?define(["exports","fs","fs/promises"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterFile={},e.fs,e["fs/promises"]);
