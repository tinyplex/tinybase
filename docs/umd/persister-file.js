var e,t;e=this,t=function(e,t,a){"use strict";const s=e=>typeof e,n=s(""),o="utf8",i=e=>null==e,r=(e,t,a)=>i(e)?a?.():t(e),c=Object,l=e=>c.getPrototypeOf(e),y=c.keys,f=c.freeze,u=e=>(e=>!i(e)&&r(l(e),(e=>e==c.prototype||i(l(e))),(()=>!0)))(e)&&0==(e=>y(e).length)(e),d=JSON.parse,p=e=>new Map(e),g=(e,t)=>e?.get(t),h=(e,t,a)=>{return i(a)?(s=e,n=t,s?.delete(n),e):e?.set(t,a);var s,n},w=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)||h(e,t,a()),g(e,t)},v=p(),C=p();e.createFilePersister=(e,l,y)=>((e,t,a,o,c,l,y,d={},p=[])=>{let A,b,S,L=0;w(v,p,(()=>0)),w(C,p,(()=>[]));const[M,m,F,T,O]=((e,t)=>i(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!u(e)||!u(t),t.setContent]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!u(e)||!u(t),t.setDefaultContent])(0,e),P=async e=>(2!=L&&(L=1,await j.schedule((async()=>{await e(),L=0}))),j),x=t=>{var a;(M&&(a=t?.[0],s(a)==n)?1===t?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},j={load:async e=>await P((async()=>{try{x(await t())}catch(t){l?.(t),e&&O(e)}})),startAutoLoad:async e=>(await j.stopAutoLoad().load(e),b=o((async(e,a)=>{const s=a?.();await P((async()=>{try{x(s??e?.()??await t())}catch(e){l?.(e)}}))})),j),stopAutoLoad:()=>(b&&(c(b),b=void 0),j),isAutoLoading:()=>!i(b),save:async e=>(1!=L&&(L=2,await j.schedule((async()=>{try{await a(m,e)}catch(e){l?.(e)}L=0}))),j),startAutoSave:async()=>(await j.stopAutoSave().save(),S=e.addDidFinishTransactionListener((()=>{const e=F();T(e)&&j.save((()=>e))})),j),stopAutoSave:()=>(r(S,e.delListener),S=void 0,j),isAutoSaving:()=>!i(S),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(g(C,p),...e),await(async()=>{if(!g(v,p)){for(h(v,p,1);!i((e=g(C,p),A=e.shift()));)try{await A()}catch(e){l?.(e)}h(v,p,0)}var e})(),j),getStore:()=>e,destroy:()=>j.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...d};return f(j)})(e,(async()=>d(await a.readFile(l,o))),(async e=>{return await a.writeFile(l,(t=e(),JSON.stringify(t,((e,t)=>t instanceof Map?c.fromEntries([...t]):t))),o);var t}),(e=>t.watch(l,(()=>e()))),(e=>e?.close()),y,0,{getFilePath:()=>l})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs"),require("fs/promises")):"function"==typeof define&&define.amd?define(["exports","fs","fs/promises"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterFile={},e.fs,e["fs/promises"]);
