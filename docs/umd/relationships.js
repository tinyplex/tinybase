var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="",s=t(n),o=(e,t)=>e.forEach(t),i=e=>e.length,r=(e,...t)=>e.push(...t),a=e=>null==e,d=(e,t,n)=>a(e)?n?.():t(e),l=e=>Array.isArray(e),c=(e,t)=>e?.has(t)??!1,f=e=>a(e)||0==(e=>e.size)(e),u=e=>[...e?.values()??[]],h=e=>e.clear(),R=(e,t)=>e?.forEach(t),p=(e,t)=>e?.delete(t),g=e=>new Map(e),L=(e,t)=>e?.get(t),w=(e,t)=>R(e,((e,n)=>t(n,e))),y=(e,t,n)=>a(n)?(p(e,t),e):e?.set(t,n),I=(e,t,n)=>(c(e,t)||y(e,t,n()),L(e,t)),b=(e,t,n,s,o=0)=>d((n?I:L)(e,t[o],o>i(t)-2?n:g),(r=>{if(o>i(t)-2)return s?.(r)&&y(e,t[o]),r;const a=b(r,t,n,s,o+1);return f(r)&&y(e,t[o]),a})),v=e=>new Set(l(e)||a(e)?e:[e]),T=(e,t)=>e?.add(t),m=(e,t,n)=>{const s=e.hasRow,r=g(),b=g(),m=g(),k=g(),E=g(),j=(t,n,...s)=>{const i=I(E,t,v);return o(s,(t=>T(i,t)&&n&&e.callListener(t))),s},x=(t,...n)=>d(L(E,t),(s=>{o(0==i(n)?u(s):n,(t=>{e.delListener(t),p(s,t)})),f(s)&&y(E,t)})),M=(e,n)=>{y(r,e,n),c(b,e)||(y(b,e,t()),y(m,e,g()),y(k,e,g()))},S=e=>{y(r,e),y(b,e),y(m,e),y(k,e),x(e)};return[()=>e,()=>[...r?.keys()??[]],e=>w(b,e),e=>c(b,e),e=>L(r,e),e=>L(b,e),(e,t)=>y(b,e,t),M,(t,r,d,f,u)=>{M(t,r);const p=g(),I=g(),b=L(m,t),v=L(k,t),T=t=>{const o=n=>e.getCell(r,t,n),d=L(b,t),c=s(r,t)?n(f(o,t)):void 0;var h,R,g;if(d===c||l(d)&&l(c)&&(R=c,i(h=d)===i(R)&&(g=(e,t)=>R[t]===e,h.every(g)))||y(p,t,[d,c]),!a(u)){const e=L(v,t),n=s(r,t)?u(o,t):void 0;e!=n&&y(I,t,n)}},E=e=>{d((()=>{R(p,(([,e],t)=>y(b,t,e))),R(I,((e,t)=>y(v,t,e)))}),p,I,b,v,e),h(p),h(I)};w(b,T),e.hasTable(r)&&o(e.getRowIds(r),(e=>{c(b,e)||T(e)})),E(!0),x(t),j(t,0,e.addRowListener(r,null,((e,t,n)=>T(n))),e.addTableListener(r,(()=>E())))},S,()=>w(E,S),j,x]},k=(e,o)=>t(e)==s?t=>t(e):e??(()=>o??n),E=/^\d+$/,j=e=>{let t;const[s,l]=(()=>{const e=[];let t=0;return[()=>e.shift()??n+t++,t=>{E.test(t)&&i(e)<1e3&&r(e,t)}]})(),c=g();return[(o,i,r)=>{t??=e();const a=s();return y(c,a,[o,i,r]),T(b(i,r??[n],v),a),a},(e,s,...a)=>o(((e,t=[n])=>{const s=[],a=(e,n)=>n==i(t)?r(s,e):null===t[n]?R(e,(e=>a(e,n+1))):o([t[n],null],(t=>a(L(e,t),n+1)));return a(e,0),s})(e,s),(e=>R(e,(e=>L(c,e)[0](t,...s??[],...a))))),e=>d(L(c,e),(([,t,s])=>(b(t,s??[n],void 0,(t=>(p(t,e),f(t)?1:0))),y(c,e),l(e),s))),(e,n,s)=>d(L(c,e),(([e,,r=[]])=>{const d=(...l)=>{const c=i(l);c==i(r)?e(t,...l,...s(l)):a(r[c])?o(n[c](...l),(e=>d(...l,e))):d(...l,r[c])};d()}))]},x=Object.freeze,M=(e=>{const t=new WeakMap;return n=>(t.has(n)||t.set(n,e(n)),t.get(n))})((e=>{const t=g(),s=g(),o=g(),i=g(),[r,l,h,I,b,E,,,M,S,z]=m(e,(()=>[g(),g(),g(),g()]),(e=>a(e)?void 0:e+n)),[A,D,O]=j((()=>P)),_=(e,t,n)=>d(E(e),(([s,,o])=>{if(!c(o,t)){const i=v();if(b(e)!=C(e))T(i,t);else{let e=t;for(;!a(e)&&!c(i,e);)T(i,e),e=L(s,e)}if(n)return i;y(o,t,i)}return L(o,t)})),B=(e,t)=>d(E(e),(([,,e])=>y(e,t))),C=e=>L(t,e),P={setRelationshipDefinition:(e,n,r,l)=>(y(t,e,r),M(e,n,((t,n)=>{const r=v(),l=v(),u=v(),[h,g]=E(e);R(n,(([t,n],s)=>{a(t)||(T(l,t),d(L(g,t),(e=>{p(e,s),f(e)&&y(g,t)}))),a(n)||(T(l,n),c(g,n)||y(g,n,v()),T(L(g,n),s)),T(r,s),y(h,s,n),w(L(i,e),(t=>{c(_(e,t),s)&&T(u,t)}))})),t(),R(r,(t=>D(s,[e,t]))),R(l,(t=>D(o,[e,t]))),R(u,(t=>{B(e,t),D(i,[e,t])}))}),k(l)),P),delRelationshipDefinition:e=>(y(t,e),S(e),P),getStore:r,getRelationshipIds:l,forEachRelationship:t=>h((n=>t(n,(t=>e.forEachRow(b(n),t))))),hasRelationship:I,getLocalTableId:b,getRemoteTableId:C,getRemoteRowId:(e,t)=>L(E(e)?.[0],t),getLocalRowIds:(e,t)=>u(L(E(e)?.[1],t)),getLinkedRowIds:(e,t)=>a(E(e))?[t]:u(_(e,t,!0)),addRemoteRowIdListener:(e,t,n)=>A(n,s,[e,t]),addLocalRowIdsListener:(e,t,n)=>A(n,o,[e,t]),addLinkedRowIdsListener:(e,t,n)=>(_(e,t),A(n,i,[e,t])),delListener:e=>(B(...O(e)),P),destroy:z,getListenerStats:()=>({})};return x(P)}));e.createRelationships=M,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseRelationships={});
