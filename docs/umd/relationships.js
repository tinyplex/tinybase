var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="",o=t(n),s=(e,t)=>e.forEach(t),i=e=>e.length,r=(e,...t)=>e.push(...t),d=e=>null==e,l=(e,t,n)=>d(e)?n?.():t(e),a=(e,t)=>e?.has(t)??!1,c=e=>d(e)||0==(e=>e.size)(e),f=e=>[...e?.values()??[]],u=e=>e.clear(),h=(e,t)=>e?.forEach(t),R=(e,t)=>e?.delete(t),p=e=>new Map(e),g=(e,t)=>e?.get(t),L=(e,t)=>h(e,((e,n)=>t(n,e))),w=(e,t,n)=>d(n)?(R(e,t),e):e?.set(t,n),I=(e,t,n)=>(a(e,t)||w(e,t,n()),g(e,t)),b=(e,t,n,o,s=0)=>l((n?I:g)(e,t[s],s>i(t)-2?n:p),(r=>{if(s>i(t)-2)return o?.(r)&&w(e,t[s]),r;const d=b(r,t,n,o,s+1);return c(r)&&w(e,t[s]),d})),y=e=>new Set(e),v=(e,t)=>e?.add(t),T=(e,t,n)=>{const o=e.hasRow,r=p(),b=p(),T=p(),m=p(),k=p(),E=(t,n,...o)=>{const i=I(k,t,y);return s(o,(t=>v(i,t)&&n&&e.callListener(t))),o},j=(t,...n)=>l(g(k,t),(o=>{s(0==i(n)?f(o):n,(t=>{e.delListener(t),R(o,t)})),c(o)&&w(k,t)})),x=(e,n)=>{w(r,e,n),a(b,e)||(w(b,e,t()),w(T,e,p()),w(m,e,p()))},M=e=>{w(r,e),w(b,e),w(T,e),w(m,e),j(e)};return[()=>e,()=>[...r?.keys()??[]],e=>L(b,e),e=>a(b,e),e=>g(r,e),e=>g(b,e),(e,t)=>w(b,e,t),x,(t,i,r,l,c)=>{x(t,i);const f=p(),R=p(),I=g(T,t),b=g(m,t),y=t=>{const s=n=>e.getCell(i,t,n),r=g(I,t),a=o(i,t)?n(l(s,t)):void 0;if(r!=a&&w(f,t,[r,a]),!d(c)){const e=g(b,t),n=o(i,t)?c(s,t):void 0;e!=n&&w(R,t,n)}},v=e=>{r((()=>{h(f,(([,e],t)=>w(I,t,e))),h(R,((e,t)=>w(b,t,e)))}),f,R,I,b,e),u(f),u(R)};L(I,y),e.hasTable(i)&&s(e.getRowIds(i),(e=>{a(I,e)||y(e)})),v(!0),j(t),E(t,0,e.addRowListener(i,null,((e,t,n)=>y(n))),e.addTableListener(i,(()=>v())))},M,()=>L(k,M),E,j]},m=(e,s)=>t(e)==o?t=>t(e):e??(()=>s??n),k=/^\d+$/,E=e=>{let t;const[o,a]=(()=>{const e=[];let t=0;return[()=>e.shift()??n+t++,t=>{k.test(t)&&i(e)<1e3&&r(e,t)}]})(),f=p();return[(s,i,r)=>{t??=e();const d=o();return w(f,d,[s,i,r]),v(b(i,r??[n],y),d),d},(e,o,...d)=>s(((e,t=[n])=>{const o=[],d=(e,n)=>n==i(t)?r(o,e):null===t[n]?h(e,(e=>d(e,n+1))):s([t[n],null],(t=>d(g(e,t),n+1)));return d(e,0),o})(e,o),(e=>h(e,(e=>g(f,e)[0](t,...o??[],...d))))),e=>l(g(f,e),(([,t,o])=>(b(t,o??[n],void 0,(t=>(R(t,e),c(t)?1:0))),w(f,e),a(e),o))),(e,n,o)=>l(g(f,e),(([e,,r=[]])=>{const l=(...a)=>{const c=i(a);c==i(r)?e(t,...a,...o(a)):d(r[c])?s(n[c](...a),(e=>l(...a,e))):l(...a,r[c])};l()}))]},j=Object.freeze,x=(e=>{const t=new WeakMap;return n=>(t.has(n)||t.set(n,e(n)),t.get(n))})((e=>{const t=p(),o=p(),s=p(),i=p(),[r,u,I,b,k,x,,,M,S,z]=T(e,(()=>[p(),p(),p(),p()]),(e=>d(e)?void 0:e+n)),[D,O,_]=E((()=>W)),B=(e,t,n)=>l(x(e),(([o,,s])=>{if(!a(s,t)){const i=y();if(k(e)!=P(e))v(i,t);else{let e=t;for(;!d(e)&&!a(i,e);)v(i,e),e=g(o,e)}if(n)return i;w(s,t,i)}return g(s,t)})),C=(e,t)=>l(x(e),(([,,e])=>w(e,t))),P=e=>g(t,e),W={setRelationshipDefinition:(e,n,r,f)=>(w(t,e,r),M(e,n,((t,n)=>{const r=y(),f=y(),u=y(),[p,I]=x(e);h(n,(([t,n],o)=>{d(t)||(v(f,t),l(g(I,t),(e=>{R(e,o),c(e)&&w(I,t)}))),d(n)||(v(f,n),a(I,n)||w(I,n,y()),v(g(I,n),o)),v(r,o),w(p,o,n),L(g(i,e),(t=>{a(B(e,t),o)&&v(u,t)}))})),t(),h(r,(t=>O(o,[e,t]))),h(f,(t=>O(s,[e,t]))),h(u,(t=>{C(e,t),O(i,[e,t])}))}),m(f)),W),delRelationshipDefinition:e=>(w(t,e),S(e),W),getStore:r,getRelationshipIds:u,forEachRelationship:t=>I((n=>t(n,(t=>e.forEachRow(k(n),t))))),hasRelationship:b,getLocalTableId:k,getRemoteTableId:P,getRemoteRowId:(e,t)=>g(x(e)?.[0],t),getLocalRowIds:(e,t)=>f(g(x(e)?.[1],t)),getLinkedRowIds:(e,t)=>d(x(e))?[t]:f(B(e,t,!0)),addRemoteRowIdListener:(e,t,n)=>D(n,o,[e,t]),addLocalRowIdsListener:(e,t,n)=>D(n,s,[e,t]),addLinkedRowIdsListener:(e,t,n)=>(B(e,t),D(n,i,[e,t])),delListener:e=>(C(..._(e)),W),destroy:z,getListenerStats:()=>({})};return j(W)}));e.createRelationships=x,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseRelationships={});
