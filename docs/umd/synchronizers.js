var e,t;e=this,t=function(e){"use strict";const t=Promise,a=Math.max,n=e=>null==e,o=(e,t,a)=>n(e)?a?.():t(e),s=(e,t)=>e.forEach(t),r=Object,i=e=>r.getPrototypeOf(e),l=r.entries,c=r.keys,g=r.freeze,u=(e,t)=>s(l(e),(([e,a])=>t(a,e))),d=e=>(e=>!n(e)&&o(i(e),(e=>e==r.prototype||n(i(e))),(()=>!0)))(e)&&0==(e=>c(e).length)(e),y=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),f=(e,t)=>e?.delete(t),h=e=>new Map(e),p=(e,t)=>e?.get(t),b=(e,t,a)=>n(a)?(f(e,t),e):e?.set(t,a),w=(e,t,a,n)=>{var o,s;return o=e,s=t,o?.has(s)||b(e,t,a()),p(e,t)},v=new globalThis.TextEncoder,C=(e,t)=>t?[e,t]:[e],M=(e,t)=>((e??"")>(t??"")?e:t)??"",A=(e="")=>C(((e=[])=>r.fromEntries(e))(),e),S=h(),T=h(),m=2**36,L=2**30,D=2**24,H=2**18,x=4096,z=64,E=e=>String.fromCharCode(48+(63&e)),j=(e,t)=>((e,t)=>e.charCodeAt(t))(e,t)-48;e.createCustomSynchronizer=(e,r,i,l,c,O,P={})=>{let R;const[V]=(e=>{let t=0,o=-1;const r=(e=>{let t=2166136261;return s(v.encode(e),(e=>{t^=e,t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24)})),t>>>0})(e),i=e=>{const s=t,[r,i]=n(e)||""==e?[0,0]:[j(l=e,0)*m+j(l,1)*L+j(l,2)*D+j(l,3)*H+j(l,4)*x+j(l,5)*z+j(l,6),j(l,7)*H+j(l,8)*x+j(l,9)*z+j(l,10),j(l,11)*D+j(l,12)*H+j(l,13)*x+j(l,14)*z+j(l,15)];var l;t=a(s,r,Date.now()),o=t==s?t==r?a(o,i):o:t==r?i:-1};return[()=>{return i(),a=++o,n=r,E((e=t)/m)+E(e/L)+E(e/D)+E(e/H)+E(e/x)+E(e/z)+E(e)+E(a/H)+E(a/x)+E(a/z)+E(a)+E(n/D)+E(n/H)+E(n/x)+E(n/z)+E(n);var e,a,n},i]})(e.getId()),$=h();i(((t,a,s,i)=>{0==s?o(p($,a),(([e,a])=>n(e)||e==t?a(i,t):0)):2==s&&I.isAutoLoading()?F(t,i).then((e=>{R?.(void 0,e)})):3==s&&I.isAutoLoading()?R?.(void 0,i):o(1==s&&I.isAutoSaving()?e.getMergeableContentHashes():4==s?e.getMergeableTableDiff(i):5==s?e.getMergeableRowDiff(i):6==s?e.getMergeableCellDiff(i):7==s?e.getMergeableValueDiff(i):void 0,(e=>{r(t,a,0,e)}))}));const k=async(e,a,n="")=>new t(((t,o)=>{const s=V(),i=setTimeout((()=>{f($,s),o(`No response from ${e??"anyone"} to '${a}'`)}),1e3*c);b($,s,[e,(e,a)=>{clearTimeout(i),f($,s),t([e,a])}]),r(e,s,a,n)})),B=(e,[t,a])=>{u(t,(([t,a],n)=>{const o=y(e[0],n,A);u(t,(([e,t],a)=>{const n=y(o[0],a,A);u(e,(([e,t],a)=>n[0][a]=C(e,t))),n[1]=M(n[1],t)})),o[1]=M(o[1],a)})),e[1]=M(e[1],a)},F=async(t=null,a)=>{n(a)&&([a,t]=await k(t,1));const[o,s]=a,[r,i]=e.getMergeableContentHashes();let l=A();if(r!=o){const[a,n]=(await k(t,4,e.getMergeableTableHashes()))[0];if(l=a,!d(n)){const[a,o]=(await k(t,5,e.getMergeableRowHashes(n)))[0];if(B(l,a),!d(o)){const a=(await k(t,6,e.getMergeableCellHashes(o)))[0];B(l,a)}}}return[l,i==s?A():(await k(t,7,e.getMergeableValuesHashes()))[0],1]},I=((e,t,a,s,r,i,l,c={},u=[])=>{let y,f,h,v=0;w(S,u,(()=>0)),w(T,u,(()=>[]));const[C,M,A,m,L]=((e=1,t)=>e>1&&"getMergeableContent"in t?[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!d(e)||!d(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!d(e)||!d(t),t.setContent]:0)(l,e),D=t=>{var a;(C&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},H=async e=>(2!=v&&(v=1,await j((async()=>{try{D(await t())}catch(t){i?.(t),e&&L(e)}v=0}))),O),x=()=>(f&&(r(f),f=void 0),O),z=async e=>(1!=v&&(v=2,await j((async()=>{try{await a(M,e)}catch(e){i?.(e)}v=0}))),O),E=()=>(o(h,e.delListener),h=void 0,O),j=async(...e)=>(((e,...t)=>{e.push(...t)})(p(T,u),...e),await(async()=>{if(!p(S,u)){for(b(S,u,1);!n((e=p(T,u),y=e.shift()));)try{await y()}catch(e){i?.(e)}b(S,u,0)}var e})(),O),O={load:H,startAutoLoad:async e=>(await x().load(e),f=s((async(e,t)=>{t||e?2!=v&&(v=1,D(t??e),v=0):await H()})),O),stopAutoLoad:x,isAutoLoading:()=>!n(f),save:z,startAutoSave:async()=>(await E().save(),h=e.addDidFinishTransactionListener((()=>{const e=A();m(e)&&z(e)})),O),stopAutoSave:E,isAutoSaving:()=>!n(h),schedule:j,getStore:()=>e,destroy:()=>x().stopAutoSave(),getStats:()=>({}),...c};return g(O)})(e,(async()=>{const e=await F();return d(e[0][0])&&d(e[1][0])?void 0:e}),(async(t,a)=>{a?r(null,null,3,a):r(null,null,2,e.getMergeableContentHashes())}),(e=>R=e),(()=>R=void 0),O,2,{startSync:async e=>await(await I.startAutoLoad(e)).startAutoSave(),stopSync:()=>I.stopAutoLoad().stopAutoSave(),destroy:()=>(l(),I.stopSync()),getSynchronizerStats:()=>({}),...P});return I}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizers={});
