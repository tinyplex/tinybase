var e,t;e=this,t=function(e){"use strict";const t=Promise,a=e=>null==e,s=(e,t,s)=>a(e)?s?.():t(e),n=Object,o=e=>n.getPrototypeOf(e),r=n.entries,i=n.keys,l=n.freeze,c=(e,t)=>((e,t)=>e.forEach(t))(r(e),(([e,a])=>t(a,e))),g=e=>(e=>!a(e)&&s(o(e),(e=>e==n.prototype||a(o(e))),(()=>!0)))(e)&&0==(e=>i(e).length)(e),u=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),y=(e,t)=>e?.delete(t),d=e=>new Map(e),f=(e,t)=>e?.get(t),h=(e,t,s)=>a(s)?(y(e,t),e):e?.set(t,s),p=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)||h(e,t,a()),f(e,t)};new globalThis.TextEncoder;const b=(e,t)=>t?[e,t]:[e],w=(e,t)=>((e??"")>(t??"")?e:t)??"",v=(e="")=>b(((e=[])=>n.fromEntries(e))(),e),A=d(),M=d(),S="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz".split("");var C;d((C=(e,t)=>[e,t],S.map(C)));e.createCustomSynchronizer=(e,n,o,r,i,C,T={})=>{let m;const L=d();o(((t,o,r,i)=>{0==r?s(f(L,o),(([e,s])=>a(e)||e==t?s(i,t):0)):2==r&&z.isAutoLoading()?x(t,i).then((e=>{m?.(void 0,e)})):3==r&&z.isAutoLoading()?m?.(void 0,i):s(1==r&&z.isAutoSaving()?e.getMergeableContentHashes():4==r?e.getMergeableTableDiff(i):5==r?e.getMergeableRowDiff(i):6==r?e.getMergeableCellDiff(i):7==r?e.getMergeableValueDiff(i):void 0,(e=>{n(t,o,0,e)}))}));const H=async(e,a,s="")=>new t(((t,o)=>{const r=((e=16)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+S[63&t]),""))(),l=setTimeout((()=>{y(L,r),o(`No response from ${e??"anyone"} to '${a}'`)}),1e3*i);h(L,r,[e,(e,a)=>{clearTimeout(l),y(L,r),t([e,a])}]),n(e,r,a,s)})),D=(e,[t,a])=>{c(t,(([t,a],s)=>{const n=u(e[0],s,v);c(t,(([e,t],a)=>{const s=u(n[0],a,v);c(e,(([e,t],a)=>s[0][a]=b(e,t))),s[1]=w(s[1],t)})),n[1]=w(n[1],a)})),e[1]=w(e[1],a)},x=async(t=null,s)=>{a(s)&&([s,t]=await H(t,1));const[n,o]=s,[r,i]=e.getMergeableContentHashes();let l=v();if(r!=n){const[a,s]=(await H(t,4,e.getMergeableTableHashes()))[0];if(l=a,!g(s)){const[a,n]=(await H(t,5,e.getMergeableRowHashes(s)))[0];if(D(l,a),!g(n)){const a=(await H(t,6,e.getMergeableCellHashes(n)))[0];D(l,a)}}}return[l,i==o?v():(await H(t,7,e.getMergeableValuesHashes()))[0],1]},z=((e,t,n,o,r,i,c,u={},y=[])=>{let d,b,w,v=0;p(A,y,(()=>0)),p(M,y,(()=>[]));const[S,C,T,m,L]=((e=1,t)=>e>1&&t.isMergeable()?[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!g(e)||!g(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!g(e)||!g(t),t.setContent]:(e=>{throw Error("Store type not supported by this Persister")})())(c,e),H=t=>{var a;(S&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},D=async e=>(2!=v&&(v=1,await P((async()=>{try{H(await t())}catch(t){i?.(t),e&&L(e)}v=0}))),R),x=()=>(b&&(r(b),b=void 0),R),z=async e=>(1!=v&&(v=2,await P((async()=>{try{await n(C,e)}catch(e){i?.(e)}v=0}))),R),E=()=>(s(w,e.delListener),w=void 0,R),P=async(...e)=>(((e,...t)=>{e.push(...t)})(f(M,y),...e),await(async()=>{if(!f(A,y)){for(h(A,y,1);!a((e=f(M,y),d=e.shift()));)try{await d()}catch(e){i?.(e)}h(A,y,0)}var e})(),R),R={load:D,startAutoLoad:async e=>(await x().load(e),b=o((async(e,t)=>{t||e?2!=v&&(v=1,H(t??e),v=0):await D()})),R),stopAutoLoad:x,isAutoLoading:()=>!a(b),save:z,startAutoSave:async()=>(await E().save(),w=e.addDidFinishTransactionListener((()=>{const e=T();m(e)&&z(e)})),R),stopAutoSave:E,isAutoSaving:()=>!a(w),schedule:P,getStore:()=>e,destroy:()=>x().stopAutoSave(),getStats:()=>({}),...u};return l(R)})(e,(async()=>{const e=await x();return g(e[0][0])&&g(e[1][0])?void 0:e}),(async(t,a)=>{a?n(null,null,3,a):n(null,null,2,e.getMergeableContentHashes())}),(e=>m=e),(()=>m=void 0),C,2,{startSync:async e=>await(await z.startAutoLoad(e)).startAutoSave(),stopSync:()=>z.stopAutoLoad().stopAutoSave(),destroy:()=>(r(),z.stopSync()),getSynchronizerStats:()=>({}),...T});return z}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizers={});
