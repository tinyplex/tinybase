var e,t;e=this,t=function(e){"use strict";const t=Promise,a=e=>null==e,n=(e,t,n)=>a(e)?n?.():t(e),s=Object,o=e=>s.getPrototypeOf(e),r=s.entries,i=s.keys,l=s.freeze,c=(e,t)=>((e,t)=>e.forEach(t))(r(e),(([e,a])=>t(a,e))),g=e=>(e=>!a(e)&&n(o(e),(e=>e==s.prototype||a(o(e))),(()=>!0)))(e)&&0==(e=>i(e).length)(e),u=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),y=(e,t)=>e?.delete(t),d=e=>new Map(e),f=(e,t)=>e?.get(t),h=(e,t,n)=>a(n)?(y(e,t),e):e?.set(t,n),p=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)||h(e,t,a()),f(e,t)};new globalThis.TextEncoder;const b=(e,t)=>t?[e,t]:[e],w=(e,t)=>((e??"")>(t??"")?e:t)??"",v=(e="")=>b(((e=[])=>s.fromEntries(e))(),e),A=d(),C=d(),M="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz".split("");var S;d((S=(e,t)=>[e,t],M.map(S)));e.createCustomSynchronizer=(e,s,o,r,i,S,T={})=>{let m;const L=d();o(((t,o,r,i)=>{0==r?n(f(L,o),(([e,n])=>a(e)||e==t?n(i,t):0)):2==r&&z.isAutoLoading()?x(t,i).then((e=>{m?.(void 0,e)})):3==r&&z.isAutoLoading()?m?.(void 0,i):n(1==r&&z.isAutoSaving()?e.getMergeableContentHashes():4==r?e.getMergeableTableDiff(i):5==r?e.getMergeableRowDiff(i):6==r?e.getMergeableCellDiff(i):7==r?e.getMergeableValueDiff(i):void 0,(e=>{s(t,o,0,e)}))}));const H=async(e,a,n="")=>new t(((t,o)=>{const r=((e=16)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+M[63&t]),""))(),l=setTimeout((()=>{y(L,r),o(`No response from ${e??"anyone"} to '${a}'`)}),1e3*i);h(L,r,[e,(e,a)=>{clearTimeout(l),y(L,r),t([e,a])}]),s(e,r,a,n)})),D=(e,[t,a])=>{c(t,(([t,a],n)=>{const s=u(e[0],n,v);c(t,(([e,t],a)=>{const n=u(s[0],a,v);c(e,(([e,t],a)=>n[0][a]=b(e,t))),n[1]=w(n[1],t)})),s[1]=w(s[1],a)})),e[1]=w(e[1],a)},x=async(t=null,n)=>{a(n)&&([n,t]=await H(t,1));const[s,o]=n,[r,i]=e.getMergeableContentHashes();let l=v();if(r!=s){const[a,n]=(await H(t,4,e.getMergeableTableHashes()))[0];if(l=a,!g(n)){const[a,s]=(await H(t,5,e.getMergeableRowHashes(n)))[0];if(D(l,a),!g(s)){const a=(await H(t,6,e.getMergeableCellHashes(s)))[0];D(l,a)}}}return[l,i==o?v():(await H(t,7,e.getMergeableValuesHashes()))[0],1]},z=((e,t,s,o,r,i,c,u={},y=[])=>{let d,b,w,v=0;p(A,y,(()=>0)),p(C,y,(()=>[]));const[M,S,T,m,L]=((e=1,t)=>e>1&&"getMergeableContent"in t?[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!g(e)||!g(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!g(e)||!g(t),t.setContent]:0)(c,e),H=t=>{var a;(M&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},D=async e=>(2!=v&&(v=1,await R((async()=>{try{H(await t())}catch(t){i?.(t),e&&L(e)}v=0}))),V),x=()=>(b&&(r(b),b=void 0),V),z=async e=>(1!=v&&(v=2,await R((async()=>{try{await s(S,e)}catch(e){i?.(e)}v=0}))),V),E=()=>(n(w,e.delListener),w=void 0,V),R=async(...e)=>(((e,...t)=>{e.push(...t)})(f(C,y),...e),await(async()=>{if(!f(A,y)){for(h(A,y,1);!a((e=f(C,y),d=e.shift()));)try{await d()}catch(e){i?.(e)}h(A,y,0)}var e})(),V),V={load:D,startAutoLoad:async e=>(await x().load(e),b=o((async(e,t)=>{t||e?2!=v&&(v=1,H(t??e),v=0):await D()})),V),stopAutoLoad:x,isAutoLoading:()=>!a(b),save:z,startAutoSave:async()=>(await E().save(),w=e.addDidFinishTransactionListener((()=>{const e=T();m(e)&&z(e)})),V),stopAutoSave:E,isAutoSaving:()=>!a(w),schedule:R,getStore:()=>e,destroy:()=>x().stopAutoSave(),getStats:()=>({}),...u};return l(V)})(e,(async()=>{const e=await x();return g(e[0][0])&&g(e[1][0])?void 0:e}),(async(t,a)=>{a?s(null,null,3,a):s(null,null,2,e.getMergeableContentHashes())}),(e=>m=e),(()=>m=void 0),S,2,{startSync:async e=>await(await z.startAutoLoad(e)).startAutoSave(),stopSync:()=>z.stopAutoLoad().stopAutoSave(),destroy:()=>(r(),z.stopSync()),getSynchronizerStats:()=>({}),...T});return z}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizers={});
