var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a=t(""),s=Promise,n=Math.max,o=e=>null==e,r=(e,t,a)=>o(e)?a?.():t(e),i=Object,c=e=>i.getPrototypeOf(e),l=i.keys,g=i.freeze,u=e=>(e=>!o(e)&&r(c(e),(e=>e==i.prototype||o(c(e))),(()=>!0)))(e)&&0==(e=>l(e).length)(e),d=(e,t)=>e?.delete(t),y=e=>new Map(e),h=(e,t)=>e?.get(t),p=(e,t,a)=>o(a)?(d(e,t),e):e?.set(t,a),w=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)||p(e,t,a()),h(e,t)},f=y(),b=y(),v=new globalThis.TextEncoder,C=2**36,M=2**30,S=2**24,A=2**18,T=4096,L=64,m=e=>String.fromCharCode(48+(63&e)),H=(e,t)=>((e,t)=>e.charCodeAt(t))(e,t)-48;e.createCustomSynchronizer=(e,i,c,l,x=1,z)=>{let D;const[I]=(e=>{let t=0,a=-1;const s=(e=>{let t=2166136261;var a;return a=e=>{t^=e,t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24)},v.encode(e).forEach(a),t>>>0})(e),r=e=>{const s=t,[r,i]=o(e)||""==e?[0,0]:[H(c=e,0)*C+H(c,1)*M+H(c,2)*S+H(c,3)*A+H(c,4)*T+H(c,5)*L+H(c,6),H(c,7)*A+H(c,8)*T+H(c,9)*L+H(c,10),H(c,11)*S+H(c,12)*A+H(c,13)*T+H(c,14)*L+H(c,15)];var c;t=n(s,r,Date.now()),a=t==s?t==r?n(a,i):a:t==r?i:-1};return[()=>{return r(),n=++a,o=s,m((e=t)/C)+m(e/M)+m(e/S)+m(e/A)+m(e/T)+m(e/L)+m(e)+m(n/A)+m(n/T)+m(n/L)+m(n)+m(o/S)+m(o/A)+m(o/T)+m(o/L)+m(o);var e,n,o},r]})(e.getId()),j=y();c(((t,a,s,n)=>{0==s?r(h(j,a),(([e,a])=>o(e)||e==t?a(n,t):0)):1==s&&P.isAutoLoading()?O(t,n).then((e=>D?.(void 0,(()=>e)))):r(2==s&&P.isAutoSaving()?e.getMergeableContentHashes():3==s?e.getMergeableTableIdsDiff(n):4==s?e.getMergeableRowIdsDiff(n):5==s?e.getMergeableTablesChanges(n):6==s?e.getMergeableValuesChanges(n):void 0,(e=>{i(t,a,0,e)}))}));const E=async(e,t,a="")=>new s(((s,n)=>{const o=I(),r=setTimeout((()=>{d(j,o),n(`No response from ${e??"anyone"} to '${t}'`)}),1e3*x);p(j,o,[e,(e,t)=>{clearTimeout(r),d(j,o),s([e,t])}]),i(e,o,t,a)})),O=async(t=null,a)=>{o(a)&&([a,t]=await E(t,2));const[s,[n,r]]=a,[,[i,c]]=e.getMergeableContentHashes(),l=["",[["",{}],["",{}],1]];return i!=n&&(l[0]=s,l[1][0]=(await E(t,5,e.getMergeableCellHashes((await E(t,4,e.getMergeableRowHashes((await E(t,3,e.getMergeableTableHashes()))[0])))[0])))[0]),c!=r&&(l[0]=s,l[1][1]=(await E(t,6,e.getMergeableValuesHashes()))[0]),l},P=((e,s,n,i,c,l,d,y={},v=[])=>{let C,M,S,A=0;w(f,v,(()=>0)),w(b,v,(()=>[]));const[T,L,m,H]=((e,t)=>o(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!u(e)||!u(t)]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!u(e)||!u(t)])(0,e),x=async e=>(2!=A&&(A=1,await D.schedule((async()=>{await e(),A=0}))),D),z=s=>{var n;(T&&(n=s?.[0],t(n)==a)?1===s?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===s?.[2]?e.applyChanges:e.setContent)(s)},D={load:async(t,a)=>await x((async()=>{try{z(await s())}catch(s){l?.(s),e.setContent([t,a])}})),startAutoLoad:async(e={},t={})=>(await D.stopAutoLoad().load(e,t),M=i((async(e,t)=>{const a=t?.();await x((async()=>{try{z(a??e?.()??await s())}catch(e){l?.(e)}}))})),D),stopAutoLoad:()=>(M&&(c(M),M=void 0),D),isAutoLoading:()=>!o(M),save:async e=>(1!=A&&(A=2,await D.schedule((async()=>{try{await n(L,e)}catch(e){l?.(e)}A=0}))),D),startAutoSave:async()=>(await D.stopAutoSave().save(),S=e.addDidFinishTransactionListener((()=>{const e=m();H(e)&&D.save((()=>e))})),D),stopAutoSave:()=>(r(S,e.delListener),S=void 0,D),isAutoSaving:()=>!o(S),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(h(b,v),...e),await(async()=>{if(!h(f,v)){for(p(f,v,1);!o((e=h(b,v),C=e.shift()));)try{await C()}catch(e){l?.(e)}p(f,v,0)}var e})(),D),getStore:()=>e,destroy:()=>D.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...y};return g(D)})(e,(async()=>{const e=await O();return""!=e[0]?e:void 0}),(async()=>{i(null,null,1,e.getMergeableContentHashes())}),(e=>D=e),(()=>D=void 0),z,0,{startSync:async()=>await(await P.startAutoLoad()).startAutoSave(),stopSync:()=>P.stopAutoLoad().stopAutoSave(),destroy:()=>(l(),P.stopSync()),getSynchronizerStats:()=>({})});return P}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizers={});
