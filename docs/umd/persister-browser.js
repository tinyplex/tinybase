var e,t;e=this,t=function(e){"use strict";const t=e=>null==e,a=(e,a,s)=>t(e)?s?.():a(e),s=Object,n=e=>s.getPrototypeOf(e),o=s.keys,r=s.freeze,i=e=>(e=>!t(e)&&a(n(e),(e=>e==s.prototype||t(n(e))),(()=>!0)))(e)&&0==(e=>o(e).length)(e),c=JSON.parse,y=e=>new Map(e),d=(e,t)=>e?.get(t),g=(e,a,s)=>{return t(s)?(n=e,o=a,n?.delete(o),e):e?.set(a,s);var n,o},l=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)||g(e,t,a()),d(e,t)},u=y(),p=y(),v="storage",h=globalThis.window,f=(e,s,n,o)=>((e,s,n,o,c,y,v,h={},f=[])=>{let w,S,A,C=0;l(u,f,(()=>0)),l(p,f,(()=>[]));const[b,L,T,m,M]=((e,a)=>t(a.getMergeableContent)?[0,a.getContent,a.getTransactionChanges,([e,t])=>!i(e)||!i(t),a.setContent]:[1,a.getMergeableContent,a.getTransactionMergeableChanges,([[e],[t]])=>!i(e)||!i(t),a.setDefaultContent])(0,e),O=async e=>(2!=C&&(C=1,await P.schedule((async()=>{await e(),C=0}))),P),N=t=>{var a;(b&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},P={load:async e=>await O((async()=>{try{N(await s())}catch(t){y?.(t),e&&M(e)}})),startAutoLoad:async e=>(await P.stopAutoLoad().load(e),S=o((async(e,t)=>{const a=t?.();await O((async()=>{try{N(a??e?.()??await s())}catch(e){y?.(e)}}))})),P),stopAutoLoad:()=>(S&&(c(S),S=void 0),P),isAutoLoading:()=>!t(S),save:async e=>(1!=C&&(C=2,await P.schedule((async()=>{try{await n(L,e)}catch(e){y?.(e)}C=0}))),P),startAutoSave:async()=>(await P.stopAutoSave().save(),A=e.addDidFinishTransactionListener((()=>{const e=T();m(e)&&P.save((()=>e))})),P),stopAutoSave:()=>(a(A,e.delListener),A=void 0,P),isAutoSaving:()=>!t(A),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(d(p,f),...e),await(async()=>{if(!d(u,f)){for(g(u,f,1);!t((e=d(p,f),w=e.shift()));)try{await w()}catch(e){y?.(e)}g(u,f,0)}var e})(),P),getStore:()=>e,destroy:()=>P.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...h};return r(P)})(e,(async()=>{return e=n.getItem(s),JSON.parse(e,((e,t)=>"￼"===t?void 0:t));var e}),(async e=>{return n.setItem(s,(t=e(),JSON.stringify(t,((e,t)=>void 0===t?"￼":t))));var t}),(e=>{const t=t=>{t.storageArea===n&&t.key===s&&e((()=>c(t.newValue)))};return h.addEventListener(v,t),t}),(e=>h.removeEventListener(v,e)),o,0,{getStorageName:()=>s});e.createLocalPersister=(e,t,a)=>f(e,t,localStorage,a),e.createSessionPersister=(e,t,a)=>f(e,t,sessionStorage,a)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterBrowser={});
