var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a=t(""),s=e=>null==e,n=(e,t,a)=>s(e)?a?.():t(e),o=Object,r=e=>o.getPrototypeOf(e),i=o.keys,c=o.freeze,g=e=>(e=>!s(e)&&n(r(e),(e=>e==o.prototype||s(r(e))),(()=>!0)))(e)&&0==(e=>i(e).length)(e),y=JSON.parse,d=e=>new Map(e),l=(e,t)=>e?.get(t),u=(e,t,a)=>{return s(a)?(n=e,o=t,n?.delete(o),e):e?.set(t,a);var n,o},p=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)||u(e,t,a()),l(e,t)},f=d(),h=d(),v="storage",w=globalThis.window,S=(e,r,i,d)=>((e,o,r,i,y,d,v,w={},S=[])=>{let A,b,C,L=0;p(f,S,(()=>0)),p(h,S,(()=>[]));const[m,M,T,O]=((e,t)=>s(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!g(e)||!g(t)]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!g(e)||!g(t)])(0,e),P=async e=>(2!=L&&(L=1,await E.schedule((async()=>{await e(),L=0}))),E),x=s=>{var n;(m&&(n=s?.[0],t(n)==a)?1===s?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===s?.[2]?e.applyChanges:e.setContent)(s)},E={load:async(t,a)=>await P((async()=>{try{x(await o())}catch(s){d?.(s),e.setContent([t,a])}})),startAutoLoad:async(e={},t={})=>(await E.stopAutoLoad().load(e,t),b=i((async(e,t)=>{const a=t?.();await P((async()=>{try{x(a??e?.()??await o())}catch(e){d?.(e)}}))})),E),stopAutoLoad:()=>(b&&(y(b),b=void 0),E),isAutoLoading:()=>!s(b),save:async e=>(1!=L&&(L=2,await E.schedule((async()=>{try{await r(M,e)}catch(e){d?.(e)}L=0}))),E),startAutoSave:async()=>(await E.stopAutoSave().save(),C=e.addDidFinishTransactionListener((()=>{const e=T();O(e)&&E.save((()=>e))})),E),stopAutoSave:()=>(n(C,e.delListener),C=void 0,E),isAutoSaving:()=>!s(C),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(l(h,S),...e),await(async()=>{if(!l(f,S)){for(u(f,S,1);!s((e=l(h,S),A=e.shift()));)try{await A()}catch(e){d?.(e)}u(f,S,0)}var e})(),E),getStore:()=>e,destroy:()=>E.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...w};return c(E)})(e,(async()=>y(i.getItem(r))),(async e=>{return i.setItem(r,(t=e(),JSON.stringify(t,((e,t)=>t instanceof Map?o.fromEntries([...t]):t))));var t}),(e=>{const t=t=>{t.storageArea===i&&t.key===r&&e((()=>y(t.newValue)))};return w.addEventListener(v,t),t}),(e=>w.removeEventListener(v,e)),d,0,{getStorageName:()=>r});e.createLocalPersister=(e,t,a)=>S(e,t,localStorage,a),e.createSessionPersister=(e,t,a)=>S(e,t,sessionStorage,a)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterBrowser={});
