var e,t;e=this,t=function(e){"use strict";const t=e=>null==e,a=(e,a,s)=>t(e)?s?.():a(e),s=Object,n=e=>s.getPrototypeOf(e),r=s.keys,o=s.freeze,i=e=>(e=>!t(e)&&a(n(e),(e=>e==s.prototype||t(n(e))),(()=>!0)))(e)&&0==(e=>r(e).length)(e),c=JSON.parse,g=e=>new Map(e),y=(e,t)=>e?.get(t),l=(e,a,s)=>{return t(s)?(n=e,r=a,n?.delete(r),e):e?.set(a,s);var n,r},d=(e,t,a,s)=>{var n,r;return n=e,r=t,n?.has(r)?s?.(y(e,t)):l(e,t,a()),y(e,t)},u=g(),p=g(),f="storage",v=globalThis.window,h=(e,s,n,r)=>((e,s,n,r,c,g,f,v={},h=[])=>{let w,S,C,b=0;d(u,h,(()=>0)),d(p,h,(()=>[]));const[A,L,T,m,M]=((e=1,t)=>e>1&&"getMergeableContent"in t?[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!i(e)||!i(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!i(e)||!i(t),t.setContent]:0)(f,e),O=t=>{var a;(A&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},N=async e=>(2!=b&&(b=1,await j((async()=>{try{O(await s())}catch(t){g?.(t),e&&M(e)}b=0}))),k),P=()=>(S&&(c(S),S=void 0),k),x=async e=>(1!=b&&(b=2,await j((async()=>{try{await n(L,e)}catch(e){g?.(e)}b=0}))),k),J=()=>(a(C,e.delListener),C=void 0,k),j=async(...e)=>(((e,...t)=>{e.push(...t)})(y(p,h),...e),await(async()=>{if(!y(u,h)){for(l(u,h,1);!t((e=y(p,h),w=e.shift()));)try{await w()}catch(e){g?.(e)}l(u,h,0)}var e})(),k),k={load:N,startAutoLoad:async e=>(await P().load(e),S=r((async(e,t)=>{t||e?2!=b&&(b=1,O(t??e),b=0):await N()})),k),stopAutoLoad:P,isAutoLoading:()=>!t(S),save:x,startAutoSave:async()=>(await J().save(),C=e.addDidFinishTransactionListener((()=>{const e=T();m(e)&&x(e)})),k),stopAutoSave:J,isAutoSaving:()=>!t(C),schedule:j,getStore:()=>e,destroy:()=>P().stopAutoSave(),getStats:()=>({}),...v};return o(k)})(e,(async()=>{return e=n.getItem(s),JSON.parse(e,((e,t)=>"￼"===t?void 0:t));var e}),(async e=>{return n.setItem(s,(t=e(),JSON.stringify(t,((e,t)=>void 0===t?"￼":t))));var t}),(e=>{const t=t=>{if(t.storageArea===n&&t.key===s)try{e(c(t.newValue))}catch{e()}};return v.addEventListener(f,t),t}),(e=>v.removeEventListener(f,e)),r,3,{getStorageName:()=>s});e.createLocalPersister=(e,t,a)=>h(e,t,localStorage,a),e.createSessionPersister=(e,t,a)=>h(e,t,sessionStorage,a)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterBrowser={});
