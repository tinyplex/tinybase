var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a=t(""),s=e=>null==e,n=(e,t,a)=>s(e)?a?.():t(e),o=Object,r=e=>o.getPrototypeOf(e),i=o.keys,c=o.freeze,g=e=>(e=>!s(e)&&n(r(e),(e=>e==o.prototype||s(r(e))),(()=>!0)))(e)&&0==(e=>i(e).length)(e),y=JSON.parse,l=e=>new Map(e),d=(e,t)=>e?.get(t),u=(e,t,a)=>{return s(a)?(n=e,o=t,n?.delete(o),e):e?.set(t,a);var n,o},p=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)?s?.(d(e,t)):u(e,t,a()),d(e,t)},f=l(),h=l(),v="storage",w=globalThis.window,S=(e,r,i,l)=>((e,o,r,i,y,l,v,w={},S=[])=>{let A,C,b,L=0;p(f,S,(()=>0)),p(h,S,(()=>[]));const[m,M,T,O,P]=((e,t)=>!e||s(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!g(e)||!g(t),t.setContent]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!g(e)||!g(t),t.setDefaultContent])(v,e),x=async e=>(2!=L&&(L=1,await N.schedule((async()=>{await e(),L=0}))),N),E=s=>{var n;(m&&(n=s?.[0],t(n)==a)?1===s?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===s?.[2]?e.applyChanges:e.setContent)(s)},N={load:async e=>await x((async()=>{try{E(await o())}catch(t){l?.(t),e&&P(e)}})),startAutoLoad:async e=>(await N.stopAutoLoad().load(e),C=i((async(e,t)=>{const a=t?.();await x((async()=>{try{E(a??e?.()??await o())}catch(e){l?.(e)}}))})),N),stopAutoLoad:()=>(C&&(y(C),C=void 0),N),isAutoLoading:()=>!s(C),save:async e=>(1!=L&&(L=2,await N.schedule((async()=>{try{await r(M,e)}catch(e){l?.(e)}L=0}))),N),startAutoSave:async()=>(await N.stopAutoSave().save(),b=e.addDidFinishTransactionListener((()=>{const e=T();O(e)&&N.save((()=>e))})),N),stopAutoSave:()=>(n(b,e.delListener),b=void 0,N),isAutoSaving:()=>!s(b),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(d(h,S),...e),await(async()=>{if(!d(f,S)){for(u(f,S,1);!s((e=d(h,S),A=e.shift()));)try{await A()}catch(e){l?.(e)}u(f,S,0)}var e})(),N),getStore:()=>e,destroy:()=>N.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...w};return c(N)})(e,(async()=>y(i.getItem(r))),(async e=>{return i.setItem(r,(t=e(),JSON.stringify(t,((e,t)=>t instanceof Map?o.fromEntries([...t]):t))));var t}),(e=>{const t=t=>{t.storageArea===i&&t.key===r&&e((()=>y(t.newValue)))};return w.addEventListener(v,t),t}),(e=>w.removeEventListener(v,e)),l,!0,{getStorageName:()=>r});e.createLocalPersister=(e,t,a)=>S(e,t,localStorage,a),e.createSessionPersister=(e,t,a)=>S(e,t,sessionStorage,a)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterBrowser={});
