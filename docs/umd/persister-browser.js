var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a=t(""),s=e=>null==e,n=(e,t,a)=>s(e)?a?.():t(e),o=Object,r=e=>o.getPrototypeOf(e),i=o.keys,c=o.freeze,y=e=>(e=>!s(e)&&n(r(e),(e=>e==o.prototype||s(r(e))),(()=>!0)))(e)&&0==(e=>i(e).length)(e),d=JSON.parse,l=e=>new Map(e),p=(e,t)=>e?.get(t),u=(e,t,a)=>{return s(a)?(n=e,o=t,n?.delete(o),e):e?.set(t,a);var n,o},f=(e,t,a)=>{var s,n;return s=e,n=t,s?.has(n)||u(e,t,a()),p(e,t)},g=l(),h=l(),w="storage",v=globalThis.window,S=(e,r,i,l)=>((e,o,r,i,d,l,w,[v,S]=[],A=[])=>{let L,m,C,b=0,T=0;f(g,A,(()=>0)),f(h,A,(()=>[]));const O=e.getContent,P=e.getTransactionChanges,x=async e=>(2!=b&&(b=1,await E.schedule((async()=>{await e(),b=0}))),E),E={load:async(s,n)=>await x((async()=>{try{const s=await o();(w&&(e=>t(e)==a)(s[0])?e.applyMergeableChanges:e.setContent)(s)}catch{e.setContent([s,n])}})),startAutoLoad:async(t={},a={})=>(E.stopAutoLoad(),await E.load(t,a),T=1,C=i((async(t,a)=>{if(a){const t=a();await x((async()=>e.applyChanges(t)))}else await x((async()=>{try{e.setContent(t?.()??await o())}catch(e){l?.(e)}}))})),E),stopAutoLoad:()=>(T&&(d(C),C=void 0,T=0),E),save:async e=>(1!=b&&(b=2,await E.schedule((async()=>{try{await r(O,e)}catch(e){l?.(e)}b=0}))),E),startAutoSave:async()=>(await E.stopAutoSave().save(),L=e.addDidFinishTransactionListener((()=>{const[e,t]=P();y(e)&&y(t)||E.save((()=>[e,t]))})),E),stopAutoSave:()=>(n(L,e.delListener),L=void 0,E),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(p(h,A),...e),await(async()=>{if(!p(g,A)){for(u(g,A,1);!s((e=p(h,A),m=e.shift()));)try{await m()}catch(e){l?.(e)}u(g,A,0)}var e})(),E),getStore:()=>e,destroy:()=>E.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return v&&(E[v]=()=>S),c(E)})(e,(async()=>d(i.getItem(r))),(async e=>{return i.setItem(r,(t=e(),JSON.stringify(t,((e,t)=>t instanceof Map?o.fromEntries([...t]):t))));var t}),(e=>{const t=t=>{t.storageArea===i&&t.key===r&&e((()=>d(t.newValue)))};return v.addEventListener(w,t),t}),(e=>v.removeEventListener(w,e)),l,!1,["getStorageName",r]);e.createLocalPersister=(e,t,a)=>S(e,t,localStorage,a),e.createSessionPersister=(e,t,a)=>S(e,t,sessionStorage,a)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterBrowser={});
