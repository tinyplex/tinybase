var t,e;t=this,e=function(t){"use strict";const e=t=>null==t,a=(t,a,s)=>e(t)?s?.():a(t),s=Object,n=t=>s.getPrototypeOf(t),o=s.entries,c=s.keys,i=s.freeze,r=(t,e)=>a(t,(t=>t[e])),d=(t,a)=>!e(r(t,a)),y=(t,e)=>(delete t[e],t),u=(t,e)=>((t,e)=>t.map(e))(o(t),(([t,a])=>e(a,t))),l=t=>c(t).length,f=t=>(t=>!e(t)&&a(n(t),(t=>t==s.prototype||e(n(t))),(()=>!0)))(t)&&0==l(t),h=t=>new Map(t),p=(t,e)=>t?.get(e),v=(t,a,s)=>{return e(s)?(n=t,o=a,n?.delete(o),t):t?.set(a,s);var n,o},g=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||v(t,e,a()),p(t,e)},w=h(),A=h(),L=(t,e)=>[t[e].t,t[e].v],m=(t,a,s,n)=>{const o=e(a)?t:((t,e,a)=>(d(t,e)||(t[e]={}),t[e]))(t,a);let c;return u(s,((t,e)=>{n(o,e,t)&&(c=1)})),u(o,((t,e)=>{d(s,e)||(y(o,e),c=1)})),!e(a)&&f(o)&&y(t,a),c};t.createAutomergePersister=(t,s,n="tinybase",o)=>(s.change((t=>t[n]={})),((t,s,n,o,c,r,[d,y]=[],u=[])=>{let l,h,L,m=0,S=0;g(w,u,(()=>0)),g(A,u,(()=>[]));const b=async t=>(2!=m&&(m=1,await C.schedule((async()=>{await t(),m=0}))),C),C={load:async(e,a)=>await b((async()=>{try{t.setContent(await s())}catch{t.setContent([e,a])}})),startAutoLoad:async(e={},a={})=>(C.stopAutoLoad(),await C.load(e,a),S=1,L=o((async(e,a)=>{if(a){const e=a();await b((async()=>t.setTransactionChanges(e)))}else await b((async()=>{try{t.setContent(e?.()??await s())}catch(t){r?.(t)}}))})),C),stopAutoLoad:()=>(S&&(c(L),L=void 0,S=0),C),save:async e=>(1!=m&&(m=2,await C.schedule((async()=>{try{await n(t.getContent,e)}catch(t){r?.(t)}m=0}))),C),startAutoSave:async()=>(await C.stopAutoSave().save(),l=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();f(a)&&f(s)||C.save((()=>[a,s]))})),C),stopAutoSave:()=>(a(l,t.delListener),l=void 0,C),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(p(A,u),...t),await(async()=>{if(!p(w,u)){for(v(w,u,1);!e((t=p(A,u),h=t.shift()));)try{await h()}catch(t){r?.(t)}v(w,u,0)}var t})(),C),getStore:()=>t,destroy:()=>C.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return d&&(C[d]=()=>y),i(C)})(t,(async()=>{const t=await s.doc();return 2==l(t[n])?L(t,n):void 0}),(async(t,o)=>s.change((s=>((t,s,n,o)=>{((t,e)=>{f(t[e])&&(t[e]={t:{},v:{}})})(t,s);const[c,i]=L(t,s),d=()=>{l=1};let l=1;if(a(o?.(),(([t,s])=>{l=0,u(t,((t,s)=>l?0:e(t)?y(c,s):a(c[s],(s=>u(t,((t,n)=>l?0:e(t)?y(s,n):a(r(s,n),(a=>u(t,((t,s)=>e(t)?y(a,s):a[s]=t))),d)))),d))),u(s,((t,a)=>l?0:e(t)?y(i,a):i[a]=t))})),l){const[t,e]=n();m(c,void 0,t,((t,e,a)=>m(c,e,a,((t,e,a)=>m(t,e,a,((t,e,a)=>{if(r(t,e)!==a)return t[e]=a,1})))))),m(i,void 0,e,((t,e,a)=>{r(i,e)!==a&&(i[e]=a)}))}})(s,n,t,o)))),(t=>{const e=({doc:e})=>t((()=>L(e,n)));return s.on("change",e),e}),(t=>{s.removeListener("change",t)}),o,["getDocHandle",s]))},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterAutomerge={});
