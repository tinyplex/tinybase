var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n=t(""),s=t(t),i=(e,t)=>e.forEach(t),r=e=>d(e,((e,t)=>e+t),0),o=e=>e.length,c=e=>0==o(e),d=(e,t,n)=>e.reduce(t,n),a=(e,t,n)=>e.slice(t,n),l=Math.max,u=Math.min,f=isFinite,h=e=>null==e,p=(e,t,n)=>h(e)?n?.():t(e),M=()=>{},g=e=>e.size,v=(e,t)=>e?.has(t)??!1,y=e=>h(e)||0==g(e),b=e=>[...e?.values()??[]],m=e=>e.clear(),L=(e,t)=>e?.forEach(t),w=(e,t)=>e?.delete(t),T=e=>new Map(e),x=(e,t)=>e?.get(t),j=(e,t)=>L(e,((e,n)=>t(n,e))),E=(e,t,n)=>h(n)?(w(e,t),e):e?.set(t,n),I=(e,t,n)=>(v(e,t)||e.set(t,n()),x(e,t)),R=T([["avg",[(e,t)=>r(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,s)=>e+(t-n)/s]],["max",[e=>l(...e),(e,t)=>l(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:l(t,e)]],["min",[e=>u(...e),(e,t)=>u(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:u(t,e)]],["sum",[e=>r(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),S=e=>new Set(e),k=(e,t)=>e?.add(t),z=(e,s)=>t(e)==n?t=>t(e):e??(()=>s??""),D=(e,t,n)=>o(n)<2?k(c(n)?e:I(e,n[0],S),t):D(I(e,n[0],T),t,a(n,1)),N=e=>{const t=(n,s,...r)=>p(n,(n=>c(r)?e(n,s):i([r[0],null],(e=>t(x(n,e),s,...a(r,1))))));return t},O=Object.freeze,_=(e=>{const t=new WeakMap;return n=>(t.has(n)||t.set(n,e(n)),t.get(n))})((e=>{const n=T(),[r,d,a,l,u,_,B,,C,F,P]=((e,t,n)=>{const s=e.hasRow,r=T(),o=T(),d=T(),a=T(),l=T(),u=(t,n,...s)=>{const r=I(l,t,S);return i(s,(t=>k(r,t)&&n&&e.callListener(t))),s},f=(t,...n)=>p(x(l,t),(s=>{i(c(n)?b(s):n,(t=>{e.delListener(t),w(s,t)})),y(s)&&E(l,t)})),M=(e,n)=>{E(r,e,n),v(o,e)||(E(o,e,t()),E(d,e,T()),E(a,e,T()))},g=e=>{E(r,e),E(o,e),E(d,e),E(a,e),f(e)};return[()=>e,()=>[...r?.keys()??[]],e=>j(o,e),e=>v(o,e),e=>x(r,e),e=>x(o,e),(e,t)=>E(o,e,t),M,(t,r,o,c,l)=>{M(t,r);const p=T(),g=T(),y=x(d,t),b=x(a,t),w=t=>{const i=n=>e.getCell(r,t,n),o=x(y,t),d=s(r,t)?n(c(i,t)):void 0;if(o!=d&&E(p,t,[o,d]),!h(l)){const e=x(b,t),n=s(r,t)?l(i,t):void 0;e!=n&&E(g,t,n)}},I=e=>{o((()=>{L(p,(([,e],t)=>E(y,t,e))),L(g,((e,t)=>E(b,t,e)))}),p,g,y,b,e),m(p),m(g)};j(y,w),e.hasTable(r)&&i(e.getRowIds(r),(e=>{v(y,e)||w(e)})),I(!0),f(t),u(t,0,e.addRowListener(r,null,((e,t,n)=>w(n))),e.addTableListener(r,(()=>I())))},g,()=>j(l,g),u,f]})(e,M,(e=>isNaN(e)||h(e)||!0===e||!1===e||""===e?void 0:1*e)),[W,q,A]=(e=>{let t,n=0;const s=[],r=T();return[(i,o,c=[])=>{t??=e();const d=s.pop()??""+n++;return E(r,d,[i,o,c]),D(o,d,c),d},(e,n=[],...s)=>N(L)(e,(e=>p(x(r,e),(([e])=>e(t,...n,...s)))),...n),e=>p(x(r,e),(([,t,n])=>(N(w)(t,e,...n),E(r,e),o(s)<1e3&&((e,...t)=>{e.push(...t)})(s,e),n)),(()=>[])),(e,n,s)=>p(x(r,e),(([e,,r])=>{const c=(...d)=>{const a=o(d);a==o(r)?e(t,...d,...s(d)):h(r[a])?i(n[a](...d),(e=>c(...d,e))):c(...d,r[a])};c()}))]})((()=>G)),G={setMetricDefinition:(e,i,r,o,c,d,a)=>{const l=t(r)==s?[r,c,d,a]:x(R,r)??x(R,"sum");return C(e,i,((t,s,i,r,o,c)=>{const d=_(e),a=g(r);c||=h(d),t();let u=((e,t,n,s,i,r=!1)=>{if(y(n))return;const[o,c,d,a]=i;return r||=h(e),L(s,(([n,s])=>{r||(e=h(n)?c?.(e,s,t++):h(s)?d?.(e,n,t--):a?.(e,s,n,t),r||=h(e))})),r?o(b(n),g(n)):e})(d,a,r,s,l,c);f(u)||(u=void 0),u!=d&&(B(e,u),q(n,[e],u,d))}),z(o,1)),G},delMetricDefinition:e=>(F(e),G),getStore:r,getMetricIds:d,forEachMetric:a,hasMetric:l,getTableId:u,getMetric:_,addMetricListener:(e,t)=>W(t,n,[e]),delListener:e=>(A(e),G),destroy:P,getListenerStats:()=>({})};return O(G)}));e.createMetrics=_,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseMetrics={});
