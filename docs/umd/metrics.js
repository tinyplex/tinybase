var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="",r=t(n),s=t(t),i=(e,t)=>e.forEach(t),o=e=>a(e,((e,t)=>e+t),0),c=e=>e.length,a=(e,t,n)=>e.reduce(t,n),d=(e,...t)=>e.push(...t),l=Math.max,u=Math.min,f=isFinite,h=e=>null==e,v=(e,t,n)=>h(e)?n?.():t(e),M=e=>Array.isArray(e),g=()=>{},p=e=>e.size,y=(e,t)=>e?.has(t)??!1,b=e=>h(e)||0==p(e),m=e=>[...e?.values()??[]],L=e=>e.clear(),w=(e,t)=>e?.forEach(t),T=(e,t)=>e?.delete(t),x=e=>new Map(e),j=(e,t)=>e?.get(t),E=(e,t)=>w(e,((e,n)=>t(n,e))),I=(e,t,n)=>h(n)?(T(e,t),e):e?.set(t,n),R=(e,t,n)=>(y(e,t)||I(e,t,n()),j(e,t)),S=(e,t,n,r,s=0)=>v((n?R:j)(e,t[s],s>c(t)-2?n:x),(i=>{if(s>c(t)-2)return r?.(i)&&I(e,t[s]),i;const o=S(i,t,n,r,s+1);return b(i)&&I(e,t[s]),o})),k=x([["avg",[(e,t)=>o(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,r)=>e+(t-n)/r]],["max",[e=>l(...e),(e,t)=>l(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:l(t,e)]],["min",[e=>u(...e),(e,t)=>u(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:u(t,e)]],["sum",[e=>o(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),z=e=>new Set(M(e)||h(e)?e:[e]),A=(e,t)=>e?.add(t),D=(e,t,n)=>{const r=e.hasRow,s=x(),o=x(),a=x(),d=x(),l=x(),u=(t,n,...r)=>{const s=R(l,t,z);return i(r,(t=>A(s,t)&&n&&e.callListener(t))),r},f=(t,...n)=>v(j(l,t),(r=>{i(0==c(n)?m(r):n,(t=>{e.delListener(t),T(r,t)})),b(r)&&I(l,t)})),g=(e,n)=>{I(s,e,n),y(o,e)||(I(o,e,t()),I(a,e,x()),I(d,e,x()))},p=e=>{I(s,e),I(o,e),I(a,e),I(d,e),f(e)};return[()=>e,()=>[...s?.keys()??[]],e=>E(o,e),e=>y(o,e),e=>j(s,e),e=>j(o,e),(e,t)=>I(o,e,t),g,(t,s,o,l,v)=>{g(t,s);const p=x(),b=x(),m=j(a,t),T=j(d,t),R=t=>{const i=n=>e.getCell(s,t,n),o=j(m,t),a=r(s,t)?n(l(i,t)):void 0;var d,u,f;if(o===a||M(o)&&M(a)&&(u=a,c(d=o)===c(u)&&(f=(e,t)=>u[t]===e,d.every(f)))||I(p,t,[o,a]),!h(v)){const e=j(T,t),n=r(s,t)?v(i,t):void 0;e!=n&&I(b,t,n)}},S=e=>{o((()=>{w(p,(([,e],t)=>I(m,t,e))),w(b,((e,t)=>I(T,t,e)))}),p,b,m,T,e),L(p),L(b)};E(m,R),e.hasTable(s)&&i(e.getRowIds(s),(e=>{y(m,e)||R(e)})),S(!0),f(t),u(t,0,e.addRowListener(s,null,((e,t,n)=>R(n))),e.addTableListener(s,(()=>S())))},p,()=>E(l,p),u,f]},N=(e,s)=>t(e)==r?t=>t(e):e??(()=>s??n),O=/^\d+$/,_=e=>{let t;const[r,s]=(()=>{const e=[];let t=0;return[()=>e.shift()??n+t++,t=>{O.test(t)&&c(e)<1e3&&d(e,t)}]})(),o=x();return[(s,i,c)=>{t??=e();const a=r();return I(o,a,[s,i,c]),A(S(i,c??[n],z),a),a},(e,r,...s)=>i(((e,t=[n])=>{const r=[],s=(e,n)=>n==c(t)?d(r,e):null===t[n]?w(e,(e=>s(e,n+1))):i([t[n],null],(t=>s(j(e,t),n+1)));return s(e,0),r})(e,r),(e=>w(e,(e=>j(o,e)[0](t,...r??[],...s))))),e=>v(j(o,e),(([,t,r])=>(S(t,r??[n],void 0,(t=>(T(t,e),b(t)?1:0))),I(o,e),s(e),r))),(e,n,r)=>v(j(o,e),(([e,,s=[]])=>{const o=(...a)=>{const d=c(a);d==c(s)?e(t,...a,...r(a)):h(s[d])?i(n[d](...a),(e=>o(...a,e))):o(...a,s[d])};o()}))]},B=Object.freeze,C=(e=>{const t=new WeakMap;return n=>(t.has(n)||t.set(n,e(n)),t.get(n))})((e=>{const r=x(),[i,o,c,a,d,l,u,,v,M,y]=D(e,g,(e=>isNaN(e)||h(e)||!0===e||!1===e||e===n?void 0:1*e)),[L,T,E]=_((()=>I)),I={setMetricDefinition:(e,n,i,o,c,a,d)=>{const M=t(i)==s?[i,c,a,d]:j(k,i)??j(k,"sum");return v(e,n,((t,n,s,i,o,c)=>{const a=l(e),d=p(i);c||=h(a),t();let v=((e,t,n,r,s,i=!1)=>{if(b(n))return;const[o,c,a,d]=s;return i||=h(e),w(r,(([n,r])=>{i||(e=h(n)?c?.(e,r,t++):h(r)?a?.(e,n,t--):d?.(e,r,n,t),i||=h(e))})),i?o(m(n),p(n)):e})(a,d,i,n,M,c);f(v)||(v=void 0),v!=a&&(u(e,v),T(r,[e],v,a))}),N(o,1)),I},delMetricDefinition:e=>(M(e),I),getStore:i,getMetricIds:o,forEachMetric:c,hasMetric:a,getTableId:d,getMetric:l,addMetricListener:(e,t)=>L(t,r,[e]),delListener:e=>(E(e),I),destroy:y,getListenerStats:()=>({})};return B(I)}));e.createMetrics=C,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseMetrics={});
