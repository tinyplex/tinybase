var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a=e(""),s=t=>null==t,n=(t,e,a)=>s(t)?a?.():e(t),o=Object,i=t=>o.getPrototypeOf(t),c=o.keys,r=o.freeze,y=t=>(t=>!s(t)&&n(i(t),(t=>t==o.prototype||s(i(t))),(()=>!0)))(t)&&0==(t=>c(t).length)(t),d=t=>new Map(t),l=(t,e)=>t?.get(e),u=(t,e,a)=>{return s(a)?(n=t,o=e,n?.delete(o),t):t?.set(e,a);var n,o},p=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||u(t,e,a()),l(t,e)},f=d(),h=d();t.createCustomPersister=(t,o,i,c,d,g,w,[v,C]=[],A=[])=>{let b,L,S,T=0,m=0;p(f,A,(()=>0)),p(h,A,(()=>[]));const x=(w?t.getMergeableContent:null)??t.getContent,M=t.getTransactionChanges,P=async t=>(2!=T&&(T=1,await j.schedule((async()=>{await t(),T=0}))),j),j={load:async(s,n)=>await P((async()=>{try{const s=await o();(w&&(t=>e(t)==a)(s[0])?t.applyMergeableChanges:t.setContent)(s)}catch{t.setContent([s,n])}})),startAutoLoad:async(e={},a={})=>(j.stopAutoLoad(),await j.load(e,a),m=1,S=c((async(e,a)=>{if(a){const e=a();await P((async()=>t.applyChanges(e)))}else await P((async()=>{try{t.setContent(e?.()??await o())}catch(t){g?.(t)}}))})),j),stopAutoLoad:()=>(m&&(d(S),S=void 0,m=0),j),save:async t=>(1!=T&&(T=2,await j.schedule((async()=>{try{await i(x,t)}catch(t){g?.(t)}T=0}))),j),startAutoSave:async()=>(await j.stopAutoSave().save(),b=t.addDidFinishTransactionListener((()=>{const[t,e]=M();y(t)&&y(e)||j.save((()=>[t,e]))})),j),stopAutoSave:()=>(n(b,t.delListener),b=void 0,j),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(l(h,A),...t),await(async()=>{if(!l(f,A)){for(u(f,A,1);!s((t=l(h,A),L=t.shift()));)try{await L()}catch(t){g?.(t)}u(f,A,0)}var t})(),j),getStore:()=>t,destroy:()=>j.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return v&&(j[v]=()=>C),r(j)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisters={});
