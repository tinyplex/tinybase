var e,t;e=this,t=function(e){"use strict";const t=e=>null==e,a=(e,a,n)=>t(e)?n?.():a(e),n=Object,s=e=>n.getPrototypeOf(e),o=n.keys,r=n.freeze,i=e=>(e=>!t(e)&&a(s(e),(e=>e==n.prototype||t(s(e))),(()=>!0)))(e)&&0==(e=>o(e).length)(e),c=e=>new Map(e),y=(e,t)=>e?.get(t),d=(e,a,n)=>{return t(n)?(s=e,o=a,s?.delete(o),e):e?.set(a,n);var s,o},g=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)||d(e,t,a()),y(e,t)},l=c(),u=c();e.createCustomPersister=(e,n,s,o,c,p,f,h={},v=[])=>{let C,w,b,A=0;g(l,v,(()=>0)),g(u,v,(()=>[]));const[M,S,T,L,m]=((e=1,t)=>e>1&&"getMergeableContent"in t?[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!i(e)||!i(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!i(e)||!i(t),t.setContent]:0)(f,e),x=t=>{var a;(M&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},P=async e=>(2!=A&&(A=1,await k((async()=>{try{x(await n())}catch(t){p?.(t),e&&m(e)}A=0}))),z),j=()=>(w&&(c(w),w=void 0),z),D=async e=>(1!=A&&(A=2,await k((async()=>{try{await s(S,e)}catch(e){p?.(e)}A=0}))),z),O=()=>(a(b,e.delListener),b=void 0,z),k=async(...e)=>(((e,...t)=>{e.push(...t)})(y(u,v),...e),await(async()=>{if(!y(l,v)){for(d(l,v,1);!t((e=y(u,v),C=e.shift()));)try{await C()}catch(e){p?.(e)}d(l,v,0)}var e})(),z),z={load:P,startAutoLoad:async e=>(await j().load(e),w=o((async(e,t)=>{t||e?2!=A&&(A=1,x(t??e),A=0):await P()})),z),stopAutoLoad:j,isAutoLoading:()=>!t(w),save:D,startAutoSave:async()=>(await O().save(),b=e.addDidFinishTransactionListener((()=>{const e=T();L(e)&&D(e)})),z),stopAutoSave:O,isAutoSaving:()=>!t(b),schedule:k,getStore:()=>e,destroy:()=>j().stopAutoSave(),getStats:()=>({}),...h};return r(z)}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisters={});
