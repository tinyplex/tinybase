var t,e;t=this,e=function(t){"use strict";const e=t=>null==t,a=(t,a,s)=>e(t)?s?.():a(t),s=Object,n=t=>s.getPrototypeOf(t),o=s.keys,r=s.freeze,i=t=>(t=>!e(t)&&a(n(t),(t=>t==s.prototype||e(n(t))),(()=>!0)))(t)&&0==(t=>o(t).length)(t),c=t=>new Map(t),y=(t,e)=>t?.get(e),d=(t,a,s)=>{return e(s)?(n=t,o=a,n?.delete(o),t):t?.set(a,s);var n,o},l=(t,e,a,s)=>{var n,o;return n=t,o=e,n?.has(o)||d(t,e,a()),y(t,e)},g=c(),p=c();t.createCustomPersister=(t,s,n,o,c,u,f,h={},v=[])=>{let w,C,b,A=0;l(g,v,(()=>0)),l(p,v,(()=>[]));const[S,M,T,L,P]=((t=1,e)=>t>1&&e.isMergeable()?[1,e.getMergeableContent,e.getTransactionMergeableChanges,([[t],[e]])=>!i(t)||!i(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!i(t)||!i(e),e.setContent]:(t=>{throw Error("Store type not supported by this Persister")})())(f,t),m=e=>{var a;(S&&(a=e?.[0],Array.isArray(a))?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},x=async t=>(2!=A&&(A=1,await k((async()=>{try{m(await s())}catch(e){u?.(e),t&&P(t)}A=0}))),z),j=()=>(C&&(c(C),C=void 0),z),D=async t=>(1!=A&&(A=2,await k((async()=>{try{await n(M,t)}catch(t){u?.(t)}A=0}))),z),O=()=>(a(b,t.delListener),b=void 0,z),k=async(...t)=>(((t,...e)=>{t.push(...e)})(y(p,v),...t),await(async()=>{if(!y(g,v)){for(d(g,v,1);!e((t=y(p,v),w=t.shift()));)try{await w()}catch(t){u?.(t)}d(g,v,0)}var t})(),z),z={load:x,startAutoLoad:async t=>(await j().load(t),C=o((async(t,e)=>{e||t?2!=A&&(A=1,m(e??t),A=0):await x()})),z),stopAutoLoad:j,isAutoLoading:()=>!e(C),save:D,startAutoSave:async()=>(await O().save(),b=t.addDidFinishTransactionListener((()=>{const t=T();L(t)&&D(t)})),z),stopAutoSave:O,isAutoSaving:()=>!e(b),schedule:k,getStore:()=>t,destroy:()=>j().stopAutoSave(),getStats:()=>({}),...h};return r(z)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisters={});
