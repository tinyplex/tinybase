var t,e;t=this,e=function(t){"use strict";const e=t=>null==t,a=(t,a,s)=>e(t)?s?.():a(t),s=Object,n=t=>s.getPrototypeOf(t),o=s.keys,r=s.freeze,i=t=>(t=>!e(t)&&a(n(t),(t=>t==s.prototype||e(n(t))),(()=>!0)))(t)&&0==(t=>o(t).length)(t),c=t=>new Map(t),y=(t,e)=>t?.get(e),d=(t,a,s)=>{return e(s)?(n=t,o=a,n?.delete(o),t):t?.set(a,s);var n,o},u=(t,e,a,s)=>{var n,o;return n=t,o=e,n?.has(o)||d(t,e,a()),y(t,e)},l=c(),g=c();t.createCustomPersister=(t,s,n,o,c,p,h,f={},v=[])=>{let w,A,C,b=0;u(l,v,(()=>0)),u(g,v,(()=>[]));const[L,S,M,T,m]=((t,a)=>!t||e(a.getMergeableContent)?[0,a.getContent,a.getTransactionChanges,([t,e])=>!i(t)||!i(e),a.setContent]:[1,a.getMergeableContent,a.getTransactionMergeableChanges,([[t],[e]])=>!i(t)||!i(e),a.setDefaultContent])(h,t),x=async t=>(2!=b&&(b=1,await j.schedule((async()=>{await t(),b=0}))),j),P=e=>{var a;(L&&(a=e?.[0],Array.isArray(a))?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},j={load:async t=>await x((async()=>{try{P(await s())}catch(e){p?.(e),t&&m(t)}})),startAutoLoad:async t=>(await j.stopAutoLoad().load(t),A=o((async(t,e)=>{const a=e?.();await x((async()=>{try{P(a??t?.()??await s())}catch(t){p?.(t)}}))})),j),stopAutoLoad:()=>(A&&(c(A),A=void 0),j),isAutoLoading:()=>!e(A),save:async t=>(1!=b&&(b=2,await j.schedule((async()=>{try{await n(S,t)}catch(t){p?.(t)}b=0}))),j),startAutoSave:async()=>(await j.stopAutoSave().save(),C=t.addDidFinishTransactionListener((()=>{const t=M();T(t)&&j.save((()=>t))})),j),stopAutoSave:()=>(a(C,t.delListener),C=void 0,j),isAutoSaving:()=>!e(C),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(y(g,v),...t),await(async()=>{if(!y(l,v)){for(d(l,v,1);!e((t=y(g,v),w=t.shift()));)try{await w()}catch(t){p?.(t)}d(l,v,0)}var t})(),j),getStore:()=>t,destroy:()=>j.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...f};return r(j)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisters={});
