var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a=e(""),s=t=>null==t,n=(t,e,a)=>s(t)?a?.():e(t),o=Object,r=t=>o.getPrototypeOf(t),i=o.keys,c=o.freeze,y=t=>(t=>!s(t)&&n(r(t),(t=>t==o.prototype||s(r(t))),(()=>!0)))(t)&&0==(t=>i(t).length)(t),d=t=>new Map(t),l=(t,e)=>t?.get(e),u=(t,e,a)=>{return s(a)?(n=t,o=e,n?.delete(o),t):t?.set(e,a);var n,o},p=(t,e,a,s)=>{var n,o;return n=t,o=e,n?.has(o)||u(t,e,a()),l(t,e)},g=d(),f=d(),h=t=>{return s=t?.[0],e(s)==a;var s};t.createCustomPersister=(t,e,a,o,r,i,d,[v,w]=[],C=[])=>{let b,A,M,L=0,S=0;p(g,C,(()=>0)),p(f,C,(()=>[]));const[T,m,x,P]=((t,e)=>!t||s(e.getMergeableContent)?[0,e.getContent,e.getTransactionChanges,([t,e])=>!y(t)||!y(e)]:[1,e.getMergeableContent,e.getTransactionMergeableChanges,([,[[,t],[,e]]])=>!y(t)||!y(e)])(d,t),j=async t=>(2!=L&&(L=1,await O.schedule((async()=>{await t(),L=0}))),O),O={load:async(a,s)=>await j((async()=>{try{const a=await e();(T&&h(a)?t.setMergeableContent:t.setContent)(a)}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},s={})=>(O.stopAutoLoad(),await O.load(a,s),S=1,M=o((async(a,s)=>{if(s){const e=s();await j((async()=>(T&&h(e)?t.applyMergeableChanges:t.applyChanges)(e)))}else await j((async()=>{try{const s=a?.()??await e();(T&&h(s)?t.setMergeableContent:t.setContent)(s)}catch(t){i?.(t)}}))})),O),stopAutoLoad:()=>(S&&(r(M),M=void 0,S=0),O),save:async t=>(1!=L&&(L=2,await O.schedule((async()=>{try{await a(m,t)}catch(t){i?.(t)}L=0}))),O),startAutoSave:async()=>(await O.stopAutoSave().save(),b=t.addDidFinishTransactionListener((()=>{const t=x();P(t)&&O.save((()=>t))})),O),stopAutoSave:()=>(n(b,t.delListener),b=void 0,O),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(l(f,C),...t),await(async()=>{if(!l(g,C)){for(u(g,C,1);!s((t=l(f,C),A=t.shift()));)try{await A()}catch(t){i?.(t)}u(g,C,0)}var t})(),O),getStore:()=>t,destroy:()=>O.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return v&&(O[v]=()=>w),c(O)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisters={});
