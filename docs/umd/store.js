var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="",s=t(n),r=t(!0),l=t(0),o=t(t),a="type",d="default",i=(e,t)=>e.every(t),c=(e,t)=>h(e)===h(t)&&i(e,((e,n)=>t[n]===e)),u=(e,t)=>e.forEach(t),f=(e,t)=>e.map(t),h=e=>e.length,T=(e,t,n)=>e.reduce(t,n),p=(e,...t)=>e.push(...t),b=e=>JSON.stringify(e,((e,t)=>y(t,Map)?T([...t],((e,[t,n])=>(e[t]=n,e)),{}):t)),v=JSON.parse,g=isFinite,y=(e,t)=>e instanceof t,w=e=>null==e,L=(e,t,n)=>w(e)?n?.():t(e),R=e=>e==s||e==r,S=e=>e.size,C=(I=S,e=>T(J(e),((e,t)=>e+I(t)),0));var I;const m=(e,t)=>e?.has(t)??!1,E=e=>w(e)||0==S(e),J=e=>[...e?.values()??[]],F=e=>e.clear(),O=(e,t)=>e?.forEach(t),j=(e,t)=>e?.delete(t),x=e=>new Map(e),z=e=>[...e?.keys()??[]],M=(e,t)=>e?.get(t),k=(e,t)=>O(e,((e,n)=>t(n,e))),N=(e,t,n)=>w(n)?(j(e,t),e):e?.set(t,n),P=(e,t,n)=>(m(e,t)||N(e,t,n()),M(e,t)),_=(e,t,n)=>{const s={},r=t??(e=>e);return O(e,((e,t)=>L(r(e),(e=>n?.(e)?0:s[t]=e)))),s},B=(e,t)=>{const n=x(),s=t??(e=>e);return O(e,((e,t)=>n.set(t,s(e)))),n},D=e=>B(e,B),W=(e,t,n,s,r=0)=>L((n?P:M)(e,t[r],r>h(t)-2?n:x),(l=>{if(r>h(t)-2)return s?.(l)&&N(e,t[r]),l;const o=W(l,t,n,s,r+1);return E(l)&&N(e,t[r]),o})),q=Object,A=q.keys,G=q.isFrozen,H=q.freeze,K=(e,t)=>!w(((e,t)=>L(e,(e=>e[t])))(e,t)),Q=(e,t)=>delete e[t],U=(e,t)=>u(q.entries(e),(([e,n])=>t(n,e))),V=e=>{return t=A(e),0==h(t);var t},X=e=>new Set(e),Y=(e,t)=>e?.add(t),Z=(e,t=[n])=>{const s=[],r=(e,n)=>n==h(t)?p(s,e):null===t[n]?O(e,(e=>r(e,n+1))):u([t[n],null],(t=>r(M(e,t),n+1)));return r(e,0),s},$=e=>[e,e],ee=e=>0==((e,t=C)=>t(e[0])+t(e[1]))(e),te=()=>[x(),x()],ne=()=>[te(),te()],se=e=>{const n=t(e);return R(n)||n==l&&g(e)?n:void 0},re=e=>n+e,le=(e,t,n,s=N)=>{const r=(l=z(e),o=e=>!K(t,e),l.filter(o));var l,o;return u(A(t),(s=>n(e,s,t[s]))),u(r,(t=>s(e,t))),e},oe=(e,t,n)=>w(e)||!(e=>y(e,q)&&e.constructor==q)(e)||V(e)||G(e)?(n?.(),!1):(U(e,((n,s)=>{t(n,s)||Q(e,s)})),!V(e)),ae=(e,t,n)=>N(e,t,M(e,t)==-n?void 0:n),de=()=>{let e,s,r=0,T=0;const g=x(),y=x(),C=x(),I=x(),J=x(),q=x(),A=x(),G=x(),ie=te(),ce=ne(),ue=te(),fe=ne(),he=te(),Te=te(),pe=ne(),be=te(),ve=te(),ge=te(),[ye,we,Le,Re,Se]=(e=>{let t,s=0;const r=[],l=x();return[(o,a,d)=>{t??=e();const i=r.pop()??n+s++;return N(l,i,[o,a,d]),Y(W(a,d??[n],X),i),i},(e,n,...s)=>u(Z(e,n),(e=>O(e,(e=>M(l,e)[0](t,...n??[],...s))))),e=>L(M(l,e),(([,t,s])=>(W(t,s??[n],void 0,(t=>(j(t,e),E(t)?1:0))),N(l,e),h(r)<1e3&&p(r,e),s))),(e,t)=>!i(Z(e,t),w),(e,n,s)=>L(M(l,e),(([e,,r=[]])=>{const l=(...o)=>{const a=h(o);a==h(r)?e(t,...o,...s(o)):w(r[a])?u(n[a](...o),(e=>l(...o,e))):l(...o,r[a])};l()}))]})((()=>ot)),Ce=(t,n)=>(!e||m(q,n)||Ae(n))&&oe(t,((e,t)=>Ie(n,t,e)),(()=>Ae(n))),Ie=(e,t,n,s)=>oe(s?n:Ee(n,e,t),((s,r)=>L(me(e,t,r,s),(e=>(n[r]=e,!0)),(()=>!1))),(()=>Ae(e,t))),me=(t,n,s,r)=>e?L(M(M(q,t),s),(e=>se(r)!=e.type?Ae(t,n,s,r,e.default):r),(()=>Ae(t,n,s,r))):w(se(r))?Ae(t,n,s,r):r,Ee=(e,t,n)=>(L(M(A,t),(([s,r])=>{O(s,((t,n)=>{K(e,n)||(e[n]=t)})),O(r,(s=>{K(e,s)||Ae(t,n,s)}))})),e),Je=e=>le(q,e,((e,t,n)=>{const s=x(),r=X();le(P(q,t,x),n,((e,t,n)=>{N(e,t,n),L(n.default,(e=>N(s,t,e)),(()=>Y(r,t)))})),N(A,t,[s,r])}),((e,t)=>{N(q,t),N(A,t)})),Fe=e=>le(G,e,((e,t,n)=>Oe(t,n)),((e,t)=>Ne(t))),Oe=(e,t)=>le(P(G,e,(()=>(Be(e,1),x()))),t,((t,n,s)=>je(e,t,n,s)),((t,n)=>Pe(e,t,n))),je=(e,t,n,s,r)=>le(P(t,n,(()=>(De(e,n,1),x()))),s,((t,s,r)=>xe(e,n,t,s,r)),((s,l)=>_e(e,t,n,s,l,r))),xe=(e,t,n,s,r)=>{m(n,s)||We(e,t,s,1);const l=M(n,s);r!==l&&(qe(e,t,s,l,r),N(n,s,r))},ze=(e,t,n,s,r)=>L(M(t,n),(t=>xe(e,n,t,s,r)),(()=>je(e,t,n,Ee({[s]:r},e,n)))),Me=e=>{const t=n+r++;return m(e,t)?Me(e):t},ke=e=>M(G,e)??Oe(e,{}),Ne=e=>Oe(e,{}),Pe=(e,t,n)=>je(e,t,n,{},!0),_e=(e,t,n,s,r,l)=>{const o=M(M(A,e)?.[0],r);if(!w(o)&&!l)return xe(e,n,s,r,o);const a=t=>{qe(e,n,t,M(s,t)),We(e,n,t,-1),N(s,t)};w(o)?a(r):k(s,a),E(s)&&(De(e,n,-1),E(N(t,n))&&(Be(e,-1),N(G,e)))},Be=(e,t)=>ae(E(g)?N(g,null,Re(ce[0][1])||Re(ce[1][1])?Xe():0):g,e,t),De=(e,t,n)=>ae(P(y,e,(()=>x([[null,Re(fe[0][1],[e])||Re(fe[1][1],[e])?Ye(e):0]]))),t,n),We=(e,t,n,s)=>ae(P(P(C,e,x),t,(()=>x([[null,Re(pe[0][1],[e,t])||Re(pe[1][1],[e,t])?$e(e,t):0]]))),n,s),qe=(e,t,n,s,r)=>P(P(P(I,e,x),t,x),n,(()=>[s,0]))[1]=r,Ae=(e,t,n,s,r)=>(p(P(P(P(J,e,x),t,x),n,(()=>[])),s),r),Ge=(e,t,n)=>L(M(M(M(I,e),t),n),(([e,t])=>[!0,e,t]),(()=>[!1,...$(et(e,t,n))])),He=e=>E(J)||E(ve[e])?0:O(e?B(J,D):J,((t,n)=>O(t,((t,s)=>O(t,((t,r)=>we(ve[e],[n,s,r],t))))))),Ke=(e,t,n,s)=>S(t)>1?(we(e[0],s),we(e[1],s),1):E(t)||0==M(t,null)||c(M(t,null),n(...s??[]))?void 0:(we(e[1],s),1),Qe=e=>{const t=E(he[e]),n=ee(pe[e])&&ee(fe[e])&&t&&ee(ce[e]),s=E(be[e])&&E(Te[e])&&E(ue[e])&&E(ie[e]);if(!n||!s){const r=e?[B(g),D(y),B(C,D),B(I,D)]:[g,y,C,I];if(!n){O(r[2],((t,n)=>O(t,((t,s)=>Ke(pe[e],t,$e,[n,s])))));const n=X();O(r[1],((s,r)=>{Ke(fe[e],s,Ye,[r])&&!t&&(we(he[e],[r,null]),Y(n,r))})),t||O(r[3],((t,s)=>{if(!m(n,s)){const n=X();O(t,(e=>O(e,(([t,s],r)=>s!==t?Y(n,r):j(e,r))))),O(n,(t=>we(he[e],[s,t])))}})),Ke(ce[e],r[0],Xe)}if(!s){let t;O(r[3],((n,s)=>{let r;O(n,((n,l)=>{let o;O(n,(([n,a],d)=>{a!==n&&(we(be[e],[s,l,d],a,n,Ge),t=r=o=1)})),o&&we(Te[e],[s,l],Ge)})),r&&we(ue[e],[s],Ge)})),t&&we(ie[e],void 0,Ge)}}},Ue=(e,...t)=>(st((()=>e(...f(t,re)))),ot),Ve=()=>_(G,(e=>_(e,_))),Xe=()=>z(G),Ye=e=>z(M(G,re(e))),Ze=(e,t,n)=>{const s=[];return k(M(G,re(e)),((e,n)=>p(s,[w(t)?e:M(n,re(t)),e]))),f(s.sort((([e],[t])=>(e<t?-1:1)*(n?-1:1))),(([,e])=>e))},$e=(e,t)=>z(M(M(G,re(e)),re(t))),et=(e,t,n)=>M(M(M(G,re(e)),re(t)),re(n)),tt=e=>Ue((()=>(e=>oe(e,Ce,Ae))(e)?Fe(e):0)),nt=()=>Ue((()=>Fe({}))),st=(e,t)=>{if(-1==T)return;rt();const n=e?.();return lt(t),n},rt=()=>(T++,ot),lt=e=>(T>0&&(T--,0==T&&(s=!E(I),T=1,He(1),s&&Qe(1),T=-1,e?.(_(I,(e=>_(e,(e=>_(e,(e=>[...e]),(([e,t])=>e===t))),V)),V),_(J,(e=>_(e,_))))&&(T=1,O(I,((e,t)=>O(e,((e,n)=>O(e,(([e],s)=>((e,t,n,s,r)=>w(r)?e.delCell(t,n,s,!0):e.setCell(t,n,s,r))(ot,t,n,s,e))))))),T=-1,s=!1),we(ge[0],void 0,s),He(0),s&&Qe(0),we(ge[1],void 0,s),T=0,u([I,J,g,y,C],F))),ot),ot={getTables:Ve,getTableIds:Xe,getTable:e=>_(M(G,re(e)),_),getRowIds:Ye,getSortedRowIds:Ze,getRow:(e,t)=>_(M(M(G,re(e)),re(t))),getCellIds:$e,getCell:et,hasTables:()=>!E(G),hasTable:e=>m(G,re(e)),hasRow:(e,t)=>m(M(G,re(e)),re(t)),hasCell:(e,t,n)=>m(M(M(G,re(e)),re(t)),re(n)),getJson:()=>b(G),getSchemaJson:()=>b(q),setTables:tt,setTable:(e,t)=>Ue((e=>Ce(t,e)?Oe(e,t):0),e),setRow:(e,t,n)=>Ue(((e,t)=>Ie(re(e),re(t),n)?je(re(e),ke(re(e)),re(t),n):0),e,t),addRow:(e,t,n)=>st((()=>{e=re(e);const s=Ie(e,void 0,t),r=s||n?Me(M(G,e)):void 0;return s&&je(e,ke(e),r,t),r})),setPartialRow:(e,t,n)=>Ue(((e,t)=>{if(Ie(e,t,n,1)){const s=ke(e);U(n,((n,r)=>ze(e,s,t,r,n)))}}),e,t),setCell:(e,n,s,r)=>Ue(((e,n,s)=>L(me(e,n,s,t(r)==o?r(et(e,n,s)):r),(t=>ze(e,ke(e),n,s,t)))),e,n,s),setJson:e=>{try{"{}"===e?nt():tt(v(e))}catch{}return ot},setSchema:t=>Ue((()=>{if((e=(e=>oe(e,(e=>oe(e,(e=>{if(!oe(e,((e,t)=>[a,d].includes(t))))return!1;const t=e.type;return!(!R(t)&&t!=l||(se(e.default)!=t&&Q(e,d),0))})))))(t))&&(Je(t),!E(G))){const e=Ve();nt(),tt(e)}})),delTables:nt,delTable:e=>Ue((e=>m(G,e)?Ne(e):0),e),delRow:(e,t)=>Ue(((e,t)=>L(M(G,e),(n=>m(n,t)?Pe(e,n,t):0))),e,t),delCell:(e,t,n,s)=>Ue(((e,t,n)=>L(M(G,e),(r=>L(M(r,t),(l=>m(l,n)?_e(e,r,t,l,n,s):0))))),e,t,n),delSchema:()=>Ue((()=>{Je({}),e=!1})),transaction:st,startTransaction:rt,finishTransaction:lt,forEachTable:e=>O(G,((t,n)=>e(n,(e=>O(t,((t,n)=>e(n,(e=>k(t,e))))))))),forEachRow:(e,t)=>O(M(G,re(e)),((e,n)=>t(n,(t=>k(e,t))))),forEachCell:(e,t,n)=>k(M(M(G,re(e)),re(t)),n),addTablesListener:(e,t)=>ye(e,ie[t?1:0]),addTableIdsListener:(e,t,n)=>ye(e,ce[n?1:0][t?1:0]),addTableListener:(e,t,n)=>ye(t,ue[n?1:0],[e]),addRowIdsListener:(e,t,n,s)=>ye(t,fe[s?1:0][n?1:0],[e]),addSortedRowIdsListener:(e,t,n,s,r)=>{let l=Ze(e,t,n);return ye((()=>{const r=Ze(e,t,n);c(r,l)||(l=r,s(ot,e,t,n,l))}),he[r?1:0],[e,t])},addRowListener:(e,t,n,s)=>ye(n,Te[s?1:0],[e,t]),addCellIdsListener:(e,t,n,s,r)=>ye(n,pe[r?1:0][s?1:0],[e,t]),addCellListener:(e,t,n,s,r)=>ye(s,be[r?1:0],[e,t,n]),addInvalidCellListener:(e,t,n,s,r)=>ye(s,ve[r?1:0],[e,t,n]),addWillFinishTransactionListener:e=>ye(e,ge[0]),addDidFinishTransactionListener:e=>ye(e,ge[1]),callListener:e=>(Se(e,[Xe,Ye,$e],(e=>w(e[2])?[]:$(et(...e)))),ot),delListener:e=>(Le(e),ot),getListenerStats:()=>({}),createStore:de};return H(ot)};e.createStore=de,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseStore={});
