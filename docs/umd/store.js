var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="",s=t(n),r=t(!0),l=t(0),o=t(t),a="type",i="default",d=(e,t)=>e.every(t),c=(e,t)=>e.forEach(t),u=e=>e.length,f=(e,t,n)=>e.reduce(t,n),h=(e,...t)=>e.push(...t),T=e=>JSON.stringify(e,((e,t)=>v(t,Map)?f([...t],((e,[t,n])=>(e[t]=n,e)),{}):t)),b=JSON.parse,p=isFinite,v=(e,t)=>e instanceof t,g=e=>null==e,y=(e,t,n)=>g(e)?n?.():t(e),L=e=>e==s||e==r,w=e=>e.size,R=(S=w,e=>f(m(e),((e,t)=>e+S(t)),0));var S;const C=(e,t)=>e?.has(t)??!1,I=e=>g(e)||0==w(e),m=e=>[...e?.values()??[]],E=e=>e.clear(),J=(e,t)=>e?.forEach(t),F=(e,t)=>e?.delete(t),O=e=>new Map(e),j=e=>[...e?.keys()??[]],x=(e,t)=>e?.get(t),z=(e,t)=>J(e,((e,n)=>t(n,e))),M=(e,t,n)=>g(n)?(F(e,t),e):e?.set(t,n),k=(e,t,n)=>(C(e,t)||e.set(t,n()),x(e,t)),N=(e,t,n)=>{const s={},r=t??(e=>e);return J(e,((e,t)=>y(r(e),(e=>n?.(e)?0:s[t]=e)))),s},P=(e,t)=>{const n=O(),s=t??(e=>e);return J(e,((e,t)=>n.set(t,s(e)))),n},_=e=>P(e,P),B=(e,t,n,s,r=0)=>y((n?k:x)(e,t[r],r>u(t)-2?n:O),(l=>{if(r>u(t)-2)return s?.(l)&&M(e,t[r]),l;const o=B(l,t,n,s,r+1);return I(l)&&M(e,t[r]),o})),D=Object,W=D.keys,q=D.isFrozen,A=D.freeze,G=(e,t)=>!g(((e,t)=>y(e,(e=>e[t])))(e,t)),H=(e,t)=>delete e[t],K=(e,t)=>c(D.entries(e),(([e,n])=>t(n,e))),Q=e=>{return t=W(e),0==u(t);var t},U=e=>new Set(e),V=(e,t)=>e?.add(t),X=(e,t=[n])=>{const s=[],r=(e,n)=>n==u(t)?h(s,e):c([t[n],null],(t=>r(x(e,t),n+1)));return r(e,0),s},Y=e=>[e,e],Z=e=>0==((e,t=R)=>t(e[0])+t(e[1]))(e),$=()=>[O(),O()],ee=()=>[$(),$()],te=e=>{const n=t(e);return L(n)||n==l&&p(e)?n:void 0},ne=(e,t,n,s=M)=>{const r=(l=j(e),o=e=>!G(t,e),l.filter(o));var l,o;return c(W(t),(s=>n(e,s,t[s]))),c(r,(t=>s(e,t))),e},se=(e,t,n)=>g(e)||!(e=>v(e,D)&&e.constructor==D)(e)||Q(e)||q(e)?(n?.(),!1):(K(e,((n,s)=>{t(n,s)||H(e,s)})),!Q(e)),re=(e,t,n)=>M(e,t,x(e,t)==-n?void 0:n),le=()=>{let e,s,r=0,f=0;const p=O(),v=O(),R=O(),S=O(),m=O(),D=O(),W=O(),q=O(),oe=$(),ae=ee(),ie=$(),de=ee(),ce=$(),ue=ee(),fe=$(),he=$(),Te=$(),[be,pe,ve,ge,ye]=(e=>{let t,s=0;const r=[],l=O();return[(o,a,i)=>{t??=e();const d=r.pop()??n+s++;return M(l,d,[o,a,i]),V(B(a,i??[n],U),d),d},(e,n,...s)=>c(X(e,n),(e=>J(e,(e=>y(x(l,e),(([e])=>e(t,...n??[],...s))))))),e=>y(x(l,e),(([,t,s])=>(B(t,s??[n],void 0,(t=>(F(t,e),I(t)?1:0))),M(l,e),u(r)<1e3&&h(r,e),s))),(e,t)=>!d(X(e,t),g),(e,n,s)=>y(x(l,e),(([e,,r=[]])=>{const l=(...o)=>{const a=u(o);a==u(r)?e(t,...o,...s(o)):g(r[a])?c(n[a](...o),(e=>l(...o,e))):l(...o,r[a])};l()}))]})((()=>st)),Le=(t,n)=>(!e||C(D,n)||Be(n))&&se(t,((e,t)=>we(n,t,e)),(()=>Be(n))),we=(e,t,n,s)=>se(s?n:Se(n,e,t),((s,r)=>y(Re(e,t,r,s),(e=>(n[r]=e,!0)),(()=>!1))),(()=>Be(e,t))),Re=(t,n,s,r)=>e?y(x(x(D,t),s),(e=>te(r)!=e.type?Be(t,n,s,r,e.default):r),(()=>Be(t,n,s,r))):g(te(r))?Be(t,n,s,r):r,Se=(e,t,n)=>(y(x(W,t),(([s,r])=>{J(s,((t,n)=>{G(e,n)||(e[n]=t)})),J(r,(s=>{G(e,s)||Be(t,n,s)}))})),e),Ce=e=>ne(D,e,((e,t,n)=>{const s=O(),r=U();ne(k(D,t,O),n,((e,t,n)=>{M(e,t,n),y(n.default,(e=>M(s,t,e)),(()=>V(r,t)))})),M(W,t,[s,r])}),((e,t)=>{M(D,t),M(W,t)})),Ie=e=>ne(q,e,((e,t,n)=>me(t,n)),((e,t)=>xe(t))),me=(e,t)=>ne(k(q,e,(()=>(ke(e,1),O()))),t,((t,n,s)=>Ee(e,t,n,s)),((t,n)=>ze(e,t,n))),Ee=(e,t,n,s,r)=>ne(k(t,n,(()=>(Ne(e,n,1),O()))),s,((t,s,r)=>Je(e,n,t,s,r)),((s,l)=>Me(e,t,n,s,l,r))),Je=(e,t,n,s,r)=>{C(n,s)||Pe(e,t,s,1);const l=x(n,s);r!==l&&(_e(e,t,s,l,r),M(n,s,r))},Fe=(e,t,n,s,r)=>y(x(t,n),(t=>Je(e,n,t,s,r)),(()=>Ee(e,t,n,Se({[s]:r},e,n)))),Oe=e=>{const t=n+r++;return C(e,t)?Oe(e):t},je=e=>x(q,e)??me(e,{}),xe=e=>me(e,{}),ze=(e,t,n)=>Ee(e,t,n,{},!0),Me=(e,t,n,s,r,l)=>{const o=x(x(W,e)?.[0],r);if(!g(o)&&!l)return Je(e,n,s,r,o);const a=t=>{_e(e,n,t,x(s,t)),Pe(e,n,t,-1),M(s,t)};g(o)?a(r):z(s,a),I(s)&&(Ne(e,n,-1),I(M(t,n))&&(ke(e,-1),M(q,e)))},ke=(e,t)=>re(I(p)?M(p,null,ge(ae[0][1])||ge(ae[1][1])?Ke():0):p,e,t),Ne=(e,t,n)=>re(k(v,e,(()=>O([[null,ge(de[0][1],[e])||ge(de[1][1],[e])?Qe(e):0]]))),t,n),Pe=(e,t,n,s)=>re(k(k(R,e,O),t,(()=>O([[null,ge(ue[0][1],[e,t])||ge(ue[1][1],[e,t])?Ue(e,t):0]]))),n,s),_e=(e,t,n,s,r)=>k(k(k(S,e,O),t,O),n,(()=>[s,0]))[1]=r,Be=(e,t,n,s,r)=>(h(k(k(k(m,e,O),t,O),n,(()=>[])),s),r),De=(e,t,n)=>y(x(x(x(S,e),t),n),(([e,t])=>[!0,e,t]),(()=>[!1,...Y(Ve(e,t,n))])),We=e=>I(m)||I(he[e])?0:J(e?P(m,_):m,((t,n)=>J(t,((t,s)=>J(t,((t,r)=>pe(he[e],[n,s,r],t))))))),qe=(e,t,n,s)=>{var r,l;w(t)>1?(pe(e[0],s),pe(e[1],s)):I(t)||0==x(t,null)||(r=x(t,null),l=n(...s??[]),u(r)===u(l)&&d(r,((e,t)=>l[t]===e)))||pe(e[1],s)},Ae=e=>{const t=Z(ue[e])&&Z(de[e])&&Z(ae[e]),n=I(fe[e])&&I(ce[e])&&I(ie[e])&&I(oe[e]);if(!t||!n){const s=e?[P(p),_(v),P(R,_),P(S,_)]:[p,v,R,S];if(t||(J(s[2],((t,n)=>J(t,((t,s)=>qe(ue[e],t,Ue,[n,s]))))),J(s[1],((t,n)=>qe(de[e],t,Qe,[n]))),qe(ae[e],s[0],Ke)),!n){let t;J(s[3],((n,s)=>{let r;J(n,((n,l)=>{let o;J(n,(([n,a],i)=>{a!==n&&(pe(fe[e],[s,l,i],a,n,De),t=r=o=1)})),o&&pe(ce[e],[s,l],De)})),r&&pe(ie[e],[s],De)})),t&&pe(oe[e],void 0,De)}}},Ge=e=>(et(e),st),He=()=>N(q,(e=>N(e,N))),Ke=()=>j(q),Qe=e=>j(x(q,e)),Ue=(e,t)=>j(x(x(q,e),t)),Ve=(e,t,n)=>x(x(x(q,e),t),n),Xe=e=>Ge((()=>(e=>se(e,Le,Be))(e)?Ie(e):0)),Ye=(e,n,s,r)=>Ge((()=>y(Re(e,n,s,t(r)==o?r(Ve(e,n,s)):r),(t=>Fe(e,je(e),n,s,t))))),Ze=()=>Ge((()=>Ie({}))),$e=(e,t,n,s)=>Ge((()=>y(x(q,e),(r=>y(x(r,t),(l=>C(l,n)?Me(e,r,t,l,n,s):0)))))),et=(e,t)=>{if(-1==f)return;tt();const n=e?.();return nt(t),n},tt=()=>(f++,st),nt=e=>(f>0&&(f--,0==f&&(s=!I(S),f=1,We(1),s&&Ae(1),f=-1,e?.(N(S,(e=>N(e,(e=>N(e,(e=>[...e]),(([e,t])=>e===t))),Q)),Q),N(m,(e=>N(e,N))))&&(f=1,J(S,((e,t)=>J(e,((e,n)=>J(e,(([e],s)=>g(e)?$e(t,n,s,!0):Ye(t,n,s,e))))))),f=-1,s=!1),pe(Te[0],void 0,s),We(0),s&&Ae(0),pe(Te[1],void 0,s),f=0,c([S,m,p,v,R],E))),st),st={getTables:He,getTableIds:Ke,getTable:e=>N(x(q,e),N),getRowIds:Qe,getRow:(e,t)=>N(x(x(q,e),t)),getCellIds:Ue,getCell:Ve,hasTables:()=>!I(q),hasTable:e=>C(q,e),hasRow:(e,t)=>C(x(q,e),t),hasCell:(e,t,n)=>C(x(x(q,e),t),n),getJson:()=>T(q),getSchemaJson:()=>T(D),setTables:Xe,setTable:(e,t)=>Ge((()=>Le(t,e)?me(e,t):0)),setRow:(e,t,n)=>Ge((()=>we(e,t,n)?Ee(e,je(e),t,n):0)),addRow:(e,t,n)=>et((()=>{const s=we(e,void 0,t),r=s||n?Oe(x(q,e)):void 0;return s&&Ee(e,je(e),r,t),r})),setPartialRow:(e,t,n)=>Ge((()=>{if(we(e,t,n,1)){const s=je(e);K(n,((n,r)=>Fe(e,s,t,r,n)))}})),setCell:Ye,setJson:e=>{try{"{}"===e?Ze():Xe(b(e))}catch{}return st},setSchema:t=>Ge((()=>{if((e=(e=>se(e,(e=>se(e,(e=>{if(!se(e,((e,t)=>[a,i].includes(t))))return!1;const t=e.type;return!(!L(t)&&t!=l||(te(e.default)!=t&&H(e,i),0))})))))(t))&&(Ce(t),!I(q))){const e=He();Ze(),Xe(e)}})),delTables:Ze,delTable:e=>Ge((()=>C(q,e)?xe(e):0)),delRow:(e,t)=>Ge((()=>y(x(q,e),(n=>C(n,t)?ze(e,n,t):0)))),delCell:$e,delSchema:()=>Ge((()=>{Ce({}),e=!1})),transaction:et,startTransaction:tt,finishTransaction:nt,forEachTable:e=>J(q,((t,n)=>e(n,(e=>J(t,((t,n)=>e(n,(e=>z(t,e))))))))),forEachRow:(e,t)=>J(x(q,e),((e,n)=>t(n,(t=>z(e,t))))),forEachCell:(e,t,n)=>z(x(x(q,e),t),n),addTablesListener:(e,t)=>be(e,oe[t?1:0]),addTableIdsListener:(e,t,n)=>be(e,ae[n?1:0][t?1:0]),addTableListener:(e,t,n)=>be(t,ie[n?1:0],[e]),addRowIdsListener:(e,t,n,s)=>be(t,de[s?1:0][n?1:0],[e]),addRowListener:(e,t,n,s)=>be(n,ce[s?1:0],[e,t]),addCellIdsListener:(e,t,n,s,r)=>be(n,ue[r?1:0][s?1:0],[e,t]),addCellListener:(e,t,n,s,r)=>be(s,fe[r?1:0],[e,t,n]),addInvalidCellListener:(e,t,n,s,r)=>be(s,he[r?1:0],[e,t,n]),addWillFinishTransactionListener:e=>be(e,Te[0]),addDidFinishTransactionListener:e=>be(e,Te[1]),callListener:e=>(ye(e,[Ke,Qe,Ue],(e=>g(e[2])?[]:Y(Ve(...e)))),st),delListener:e=>(ve(e),st),getListenerStats:()=>({}),createStore:le};return A(st)};e.createStore=le,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseStore={});
