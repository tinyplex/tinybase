var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="",s=t(n),r=t(!0),o=t(0),l=t(t),a="type",i="default",c=(e,t)=>e.forEach(t),d=(e,t)=>e.map(t),u=e=>e.length,f=(e,t,n)=>e.slice(t,n),h=(e,...t)=>e.push(...t),T=e=>JSON.stringify(e,((e,t)=>{return v(t,Map)?(n=[...t],s=(e,[t,n])=>(e[t]=n,e),r={},n.reduce(s,r)):t;var n,s,r})),p=JSON.parse,b=isFinite,v=(e,t)=>e instanceof t,g=e=>null==e,y=(e,t,n)=>g(e)?n?.():t(e),w=e=>e==s||e==r,R=(e,t)=>e?.has(t)??!1,S=e=>g(e)||0==(e=>e.size)(e),C=e=>e.clear(),I=(e,t)=>e?.forEach(t),L=(e,t)=>e?.delete(t),m=e=>new Map(e),E=e=>[...e?.keys()??[]],J=(e,t)=>e?.get(t),F=(e,t)=>I(e,((e,n)=>t(n,e))),O=(e,t,n)=>g(n)?(L(e,t),e):e?.set(t,n),j=(e,t,n)=>(R(e,t)||O(e,t,n()),J(e,t)),x=(e,t,n)=>{const s={},r=t??(e=>e);return I(e,((e,t)=>y(r(e),(e=>n?.(e)?0:s[t]=e)))),s},z=(e,t)=>{const n=m(),s=t??(e=>e);return I(e,((e,t)=>n.set(t,s(e)))),n},M=e=>z(e,z),k=(e,t,n,s,r=0)=>y((n?j:J)(e,t[r],r>u(t)-2?n:m),(o=>{if(r>u(t)-2)return s?.(o)&&O(e,t[r]),o;const l=k(o,t,n,s,r+1);return S(o)&&O(e,t[r]),l})),N=Object,P=N.keys,_=N.isFrozen,B=N.freeze,D=(e,t)=>!g(((e,t)=>y(e,(e=>e[t])))(e,t)),W=(e,t)=>delete e[t],q=(e,t)=>c(N.entries(e),(([e,n])=>t(n,e))),A=e=>{return t=P(e),0==u(t);var t},G=e=>new Set(e),H=(e,t)=>e?.add(t),K=e=>{let t,s=0;const r=[],o=m();return[(l,a,i)=>{t??=e();const c=r.pop()??n+s++;return O(o,c,[l,a,i]),H(k(a,i??[n],G),c),c},(e,s,...r)=>c(((e,t=[n])=>{const s=[],r=(e,n)=>n==u(t)?h(s,e):null===t[n]?I(e,(e=>r(e,n+1))):c([t[n],null],(t=>r(J(e,t),n+1)));return r(e,0),s})(e,s),(e=>I(e,(e=>J(o,e)[0](t,...s??[],...r))))),e=>y(J(o,e),(([,t,s])=>(k(t,s??[n],void 0,(t=>(L(t,e),S(t)?1:0))),O(o,e),u(r)<1e3&&h(r,e),s))),(e,n,s)=>y(J(o,e),(([e,,r=[]])=>{const o=(...l)=>{const a=u(l);a==u(r)?e(t,...l,...s(l)):g(r[a])?c(n[a](...l),(e=>o(...l,e))):o(...l,r[a])};o()}))]},Q=e=>[e,e],U=()=>[m(),m()],V=e=>{const n=t(e);return w(n)||n==o&&b(e)?n:void 0},X=e=>n+e,Y=(e,t,n,s=O)=>{const r=(o=E(e),l=e=>!D(t,e),o.filter(l));var o,l;return c(P(t),(s=>n(e,s,t[s]))),c(r,(t=>s(e,t))),e},Z=(e,t,n)=>g(e)||!(e=>v(e,N)&&e.constructor==N)(e)||A(e)||_(e)?(n?.(),!1):(q(e,((n,s)=>{t(n,s)||W(e,s)})),!A(e)),$=(e,t,n)=>O(e,t,J(e,t)==-n?void 0:n),ee=()=>{let e,s,r=0,b=0;const v=m(),k=m(),N=m(),P=m(),_=m(),te=m(),ne=m(),se=m(),re=U(),oe=U(),le=U(),ae=U(),ie=U(),ce=U(),de=U(),ue=U(),fe=U(),he=U(),[Te,pe,be,ve]=K((()=>et)),ge=(t,n)=>(!e||R(te,n)||Pe(n))&&Z(t,((e,t)=>ye(n,t,e)),(()=>Pe(n))),ye=(e,t,n,s)=>Z(s?n:Re(n,e,t),((s,r)=>y(we(e,t,r,s),(e=>(n[r]=e,!0)),(()=>!1))),(()=>Pe(e,t))),we=(t,n,s,r)=>e?y(J(J(te,t),s),(e=>V(r)!=e.type?Pe(t,n,s,r,e.default):r),(()=>Pe(t,n,s,r))):g(V(r))?Pe(t,n,s,r):r,Re=(e,t,n)=>(y(J(ne,t),(([s,r])=>{I(s,((t,n)=>{D(e,n)||(e[n]=t)})),I(r,(s=>{D(e,s)||Pe(t,n,s)}))})),e),Se=e=>Y(te,e,((e,t,n)=>{const s=m(),r=G();Y(j(te,t,m),n,((e,t,n)=>{O(e,t,n),y(n.default,(e=>O(s,t,e)),(()=>H(r,t)))})),O(ne,t,[s,r])}),((e,t)=>{O(te,t),O(ne,t)})),Ce=e=>Y(se,e,((e,t,n)=>Ie(t,n)),((e,t)=>Oe(t))),Ie=(e,t)=>Y(j(se,e,(()=>(ze(e,1),m()))),t,((t,n,s)=>Le(e,t,n,s)),((t,n)=>je(e,t,n))),Le=(e,t,n,s,r)=>Y(j(t,n,(()=>(Me(e,n,1),m()))),s,((t,s,r)=>me(e,n,t,s,r)),((s,o)=>xe(e,t,n,s,o,r))),me=(e,t,n,s,r)=>{R(n,s)||ke(e,t,s,1);const o=J(n,s);r!==o&&(Ne(e,t,s,o,r),O(n,s,r))},Ee=(e,t,n,s,r)=>y(J(t,n),(t=>me(e,n,t,s,r)),(()=>Le(e,t,n,Re({[s]:r},e,n)))),Je=e=>{const t=n+r++;return R(e,t)?Je(e):t},Fe=e=>J(se,e)??Ie(e,{}),Oe=e=>Ie(e,{}),je=(e,t,n)=>Le(e,t,n,{},!0),xe=(e,t,n,s,r,o)=>{const l=J(J(ne,e)?.[0],r);if(!g(l)&&!o)return me(e,n,s,r,l);const a=t=>{Ne(e,n,t,J(s,t)),ke(e,n,t,-1),O(s,t)};g(l)?a(r):F(s,a),S(s)&&(Me(e,n,-1),S(O(t,n))&&(ze(e,-1),O(se,e)))},ze=(e,t)=>$(v,e,t),Me=(e,t,n)=>$(j(k,e,m),t,n),ke=(e,t,n,s)=>$(j(j(N,e,m),t,m),n,s),Ne=(e,t,n,s,r)=>j(j(j(P,e,m),t,m),n,(()=>[s,0]))[1]=r,Pe=(e,t,n,s,r)=>(h(j(j(j(_,e,m),t,m),n,(()=>[])),s),r),_e=(e,t,n)=>y(J(J(J(P,e),t),n),(([e,t])=>[!0,e,t]),(()=>[!1,...Q(Ue(e,t,n))])),Be=e=>S(_)||S(fe[e])?0:I(e?z(_,M):_,((t,n)=>I(t,((t,s)=>I(t,((t,r)=>pe(fe[e],[n,s,r],t))))))),De=(e,t,n)=>{if(!S(t))return pe(e,n),1},We=e=>{const t=S(ie[e]),n=S(de[e])&&S(ae[e])&&t&&S(oe[e]),s=S(ue[e])&&S(ce[e])&&S(le[e])&&S(re[e]);if(!n||!s){const r=e?[z(v),M(k),z(N,M),z(P,M)]:[v,k,N,P];if(!n){I(r[2],((t,n)=>I(t,((t,s)=>De(de[e],t,[n,s])))));const n=G();I(r[1],((s,r)=>{De(ae[e],s,[r])&&!t&&(pe(ie[e],[r,null]),H(n,r))})),t||I(r[3],((t,s)=>{if(!R(n,s)){const n=G();I(t,(e=>I(e,(([t,s],r)=>s!==t?H(n,r):L(e,r))))),I(n,(t=>pe(ie[e],[s,t])))}})),De(oe[e],r[0])}if(!s){let t;I(r[3],((n,s)=>{let r;I(n,((n,o)=>{let l;I(n,(([n,a],i)=>{a!==n&&(pe(ue[e],[s,o,i],a,n,_e),t=r=l=1)})),l&&pe(ce[e],[s,o],_e)})),r&&pe(le[e],[s],_e)})),t&&pe(re[e],void 0,_e)}}},qe=(e,...t)=>(Ye((()=>e(...d(t,X)))),et),Ae=()=>x(se,(e=>x(e,x))),Ge=()=>E(se),He=e=>E(J(se,X(e))),Ke=(e,t,n,s=0,r)=>{const o=[];return F(J(se,X(e)),((e,n)=>h(o,[g(t)?e:J(n,X(t)),e]))),d(f(o.sort((([e],[t])=>(e<t?-1:1)*(n?-1:1))),s,g(r)?r:s+r),(([,e])=>e))},Qe=(e,t)=>E(J(J(se,X(e)),X(t))),Ue=(e,t,n)=>J(J(J(se,X(e)),X(t)),X(n)),Ve=e=>qe((()=>(e=>Z(e,ge,Pe))(e)?Ce(e):0)),Xe=()=>qe((()=>Ce({}))),Ye=(e,t)=>{if(-1==b)return;Ze();const n=e?.();return $e(t),n},Ze=()=>(b++,et),$e=e=>(b>0&&(b--,0==b&&(s=!S(P),b=1,Be(1),s&&We(1),b=-1,e?.(x(P,(e=>x(e,(e=>x(e,(e=>[...e]),(([e,t])=>e===t))),A)),A),x(_,(e=>x(e,x))))&&(b=1,I(P,((e,t)=>I(e,((e,n)=>I(e,(([e],s)=>((e,t,n,s,r)=>g(r)?e.delCell(t,n,s,!0):e.setCell(t,n,s,r))(et,t,n,s,e))))))),b=-1,s=!1),pe(he[0],void 0,s),Be(0),s&&We(0),pe(he[1],void 0,s),b=0,c([P,_,v,k,N],C))),et),et={getTables:Ae,getTableIds:Ge,getTable:e=>x(J(se,X(e)),x),getRowIds:He,getSortedRowIds:Ke,getRow:(e,t)=>x(J(J(se,X(e)),X(t))),getCellIds:Qe,getCell:Ue,hasTables:()=>!S(se),hasTable:e=>R(se,X(e)),hasRow:(e,t)=>R(J(se,X(e)),X(t)),hasCell:(e,t,n)=>R(J(J(se,X(e)),X(t)),X(n)),getJson:()=>T(se),getSchemaJson:()=>T(te),setTables:Ve,setTable:(e,t)=>qe((e=>ge(t,e)?Ie(e,t):0),e),setRow:(e,t,n)=>qe(((e,t)=>ye(X(e),X(t),n)?Le(X(e),Fe(X(e)),X(t),n):0),e,t),addRow:(e,t,n)=>Ye((()=>{e=X(e);const s=ye(e,void 0,t),r=s||n?Je(J(se,e)):void 0;return s&&Le(e,Fe(e),r,t),r})),setPartialRow:(e,t,n)=>qe(((e,t)=>{if(ye(e,t,n,1)){const s=Fe(e);q(n,((n,r)=>Ee(e,s,t,r,n)))}}),e,t),setCell:(e,n,s,r)=>qe(((e,n,s)=>y(we(e,n,s,t(r)==l?r(Ue(e,n,s)):r),(t=>Ee(e,Fe(e),n,s,t)))),e,n,s),setJson:e=>{try{"{}"===e?Xe():Ve(p(e))}catch{}return et},setSchema:t=>qe((()=>{if((e=(e=>Z(e,(e=>Z(e,(e=>{if(!Z(e,((e,t)=>[a,i].includes(t))))return!1;const t=e.type;return!(!w(t)&&t!=o||(V(e.default)!=t&&W(e,i),0))})))))(t))&&(Se(t),!S(se))){const e=Ae();Xe(),Ve(e)}})),delTables:Xe,delTable:e=>qe((e=>R(se,e)?Oe(e):0),e),delRow:(e,t)=>qe(((e,t)=>y(J(se,e),(n=>R(n,t)?je(e,n,t):0))),e,t),delCell:(e,t,n,s)=>qe(((e,t,n)=>y(J(se,e),(r=>y(J(r,t),(o=>R(o,n)?xe(e,r,t,o,n,s):0))))),e,t,n),delSchema:()=>qe((()=>{Se({}),e=!1})),transaction:Ye,startTransaction:Ze,finishTransaction:$e,forEachTable:e=>I(se,((t,n)=>e(n,(e=>I(t,((t,n)=>e(n,(e=>F(t,e))))))))),forEachRow:(e,t)=>I(J(se,X(e)),((e,n)=>t(n,(t=>F(e,t))))),forEachCell:(e,t,n)=>F(J(J(se,X(e)),X(t)),n),addSortedRowIdsListener:(e,t,n,s,r,o,l)=>{let a=Ke(e,t,n,s,r);return Te((()=>{const l=Ke(e,t,n,s,r);var i,c,d;c=a,u(i=l)===u(c)&&(d=(e,t)=>c[t]===e,i.every(d))||(a=l,o(et,e,t,n,s,r,a))}),ie[l?1:0],[e,t])},addWillFinishTransactionListener:e=>Te(e,he[0]),addDidFinishTransactionListener:e=>Te(e,he[1]),callListener:e=>(ve(e,[Ge,He,Qe],(e=>g(e[2])?[]:Q(Ue(...e)))),et),delListener:e=>(be(e),et),getListenerStats:()=>({}),createStore:ee};return q({Tables:[0,re],TableIds:[0,oe],Table:[1,le],RowIds:[1,ae],Row:[2,ce],CellIds:[2,de],Cell:[3,ue],InvalidCell:[3,fe]},(([e,t],n)=>{et["add"+n+"Listener"]=(...n)=>Te(n[e],t[n[e+1]?1:0],e>0?f(n,0,e):void 0)})),B(et)};e.createStore=ee,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseStore={});
