var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a="",s=e(a),n=t=>null==t,o=(t,e,a)=>n(t)?a?.():e(t),r=t=>e(t)==s,i=t=>t.length,c=Object,y=t=>c.getPrototypeOf(t),d=c.keys,g=c.freeze,l=t=>(t=>!n(t)&&o(y(t),(t=>t==c.prototype||n(y(t))),(()=>!0)))(t)&&0==(t=>i(d(t)))(t),p=t=>JSON.stringify(t,((t,e)=>e instanceof Map?c.fromEntries([...e]):e)),f=JSON.parse,h="/store",u=t=>new Map(t),v=(t,e)=>t?.get(e),w=(t,e,a)=>{return n(a)?(s=t,o=e,s?.delete(o),t):t?.set(e,a);var s,o},C=(t,e,a,s)=>{var n,o;return n=t,o=e,n?.has(o)||w(t,e,a()),v(t,e)},b=u(),m=u(),P="message";t.createPartyKitPersister=(t,e,s,c)=>{const{host:y,room:d}=e.partySocketOptions,{storeProtocol:u="https",storePath:A=h,messagePrefix:S=a}={...r(s)?{storeProtocol:s}:s},L=u+"://"+y+"/parties/"+e.name+"/"+d+A,M=async t=>await(await fetch(L,{...t?{method:"PUT",body:p(t)}:{},mode:"cors",cache:"no-store"})).json();return((t,e,a,s,r,i,c,y={},d=[])=>{let p,f,h,u=0;C(b,d,(()=>0)),C(m,d,(()=>[]));const[P,A,S,L,M]=((t=1,e)=>t>1&&"getMergeableContent"in e?[1,e.getMergeableContent,e.getTransactionMergeableChanges,([[t],[e]])=>!l(t)||!l(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!l(t)||!l(e),e.setContent]:0)(c,t),T=e=>{var a;(P&&(a=e?.[0],Array.isArray(a))?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},O=async t=>(2!=u&&(u=1,await k((async()=>{try{T(await e())}catch(e){i?.(e),t&&M(t)}u=0}))),D),x=()=>(f&&(r(f),f=void 0),D),j=async t=>(1!=u&&(u=2,await k((async()=>{try{await a(A,t)}catch(t){i?.(t)}u=0}))),D),E=()=>(o(h,t.delListener),h=void 0,D),k=async(...t)=>(((t,...e)=>{t.push(...e)})(v(m,d),...t),await(async()=>{if(!v(b,d)){for(w(b,d,1);!n((t=v(m,d),p=t.shift()));)try{await p()}catch(t){i?.(t)}w(b,d,0)}var t})(),D),D={load:O,startAutoLoad:async t=>(await x().load(t),f=s((async(t,e)=>{e||t?2!=u&&(u=1,T(e??t),u=0):await O()})),D),stopAutoLoad:x,isAutoLoading:()=>!n(f),save:j,startAutoSave:async()=>(await E().save(),h=t.addDidFinishTransactionListener((()=>{const t=S();L(t)&&j(t)})),D),stopAutoSave:E,isAutoSaving:()=>!n(h),schedule:k,getStore:()=>t,destroy:()=>x().stopAutoSave(),getStats:()=>({}),...y};return g(D)})(t,(async()=>await M()),(async(t,a)=>{var s;a?e.send(S+"s"+(r(s=a)?s:p(s))):await M(t())}),(t=>{const a=e=>o(((t,e,a)=>{const s=i(t);return((t,e)=>t.startsWith(e))(e,t)?[e[s],f((n=e,o=s+1,n.slice(o,void 0)))]:void 0;var n,o})(S,e.data),(([e,a])=>{"s"==e&&t(void 0,a)}));return e.addEventListener(P,a),a}),(t=>{e.removeEventListener(P,t)}),c,1,{getConnection:()=>e})}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPartyKitClient={});
