var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a="",s=e(a),o=t=>null==t,n=(t,e,a)=>o(t)?a?.():e(t),r=t=>e(t)==s,i=t=>t.length,c=Object,d=t=>c.getPrototypeOf(t),y=c.keys,p=c.freeze,u=t=>(t=>!o(t)&&n(d(t),(t=>t==c.prototype||o(d(t))),(()=>!0)))(t)&&0==(t=>i(y(t)))(t),h=t=>JSON.stringify(t,((t,e)=>e instanceof Map?c.fromEntries([...e]):e)),l=JSON.parse,f="/store",v=t=>new Map(t),g=(t,e)=>t?.get(e),w=(t,e,a)=>{return o(a)?(s=t,n=e,s?.delete(n),t):t?.set(e,a);var s,n},m=(t,e,a,s)=>{var o,n;return o=t,n=e,o?.has(n)||w(t,e,a()),g(t,e)},A=v(),P=v(),S="message";t.createPartyKitPersister=(t,e,s,c)=>{const{host:d,room:y}=e.partySocketOptions,{storeProtocol:v="https",storePath:C=f,messagePrefix:L=a}={...r(s)?{storeProtocol:s}:s},b=v+"://"+d+"/parties/"+e.name+"/"+y+C,T=async t=>await(await fetch(b,{...t?{method:"PUT",body:h(t)}:{},mode:"cors",cache:"no-store"})).json();return((t,e,a,s,i,c,d,y={},h=[])=>{let l,f,v,S=0;m(A,h,(()=>0)),m(P,h,(()=>[]));const[C,L,b,T,O]=((t,e)=>[0,e.getContent,e.getTransactionChanges,([t,e])=>!u(t)||!u(e),e.setContent])(0,t),x=async t=>(2!=S&&(S=1,await j.schedule((async()=>{await t(),S=0}))),j),M=e=>{(C&&r(e?.[0])?1===e?.[1][2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},j={load:async t=>await x((async()=>{try{M(await e())}catch(e){c?.(e),t&&O(t)}})),startAutoLoad:async t=>(await j.stopAutoLoad().load(t),f=s((async(t,a)=>{const s=a?.();await x((async()=>{try{M(s??t?.()??await e())}catch(t){c?.(t)}}))})),j),stopAutoLoad:()=>(f&&(i(f),f=void 0),j),isAutoLoading:()=>!o(f),save:async t=>(1!=S&&(S=2,await j.schedule((async()=>{try{await a(L,t)}catch(t){c?.(t)}S=0}))),j),startAutoSave:async()=>(await j.stopAutoSave().save(),v=t.addDidFinishTransactionListener((()=>{const t=b();T(t)&&j.save((()=>t))})),j),stopAutoSave:()=>(n(v,t.delListener),v=void 0,j),isAutoSaving:()=>!o(v),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(g(P,h),...t),await(async()=>{if(!g(A,h)){for(w(A,h,1);!o((t=g(P,h),l=t.shift()));)try{await l()}catch(t){c?.(t)}w(A,h,0)}var t})(),j),getStore:()=>t,destroy:()=>j.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...y};return p(j)})(t,(async()=>await T()),(async(t,a)=>{var s,o;a?e.send((s=L,o=a(),s+"s"+(r(o)?o:h(o)))):await T(t())}),(t=>{const a=e=>n(((t,e,a)=>{const s=i(t);return((t,e)=>t.startsWith(e))(e,t)?[e[s],l((o=e,n=s+1,o.slice(n,void 0)))]:void 0;var o,n})(L,e.data),(([e,a])=>{"s"==e&&t(void 0,(()=>a))}));return e.addEventListener(S,a),a}),(t=>{e.removeEventListener(S,t)}),c,0,{getConnection:()=>e})}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPartyKitClient={});
