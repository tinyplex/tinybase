var e,t;e=this,t=function(e){"use strict";const t=Promise,a=Math.max,n=e=>null==e,o=(e,t,a)=>n(e)?a?.():t(e),s=(e,t)=>e.forEach(t),r=Object,i=e=>r.getPrototypeOf(e),c=r.entries,l=r.keys,g=r.freeze,u=(e,t)=>s(c(e),(([e,a])=>t(a,e))),d=e=>(e=>!n(e)&&o(i(e),(e=>e==r.prototype||n(i(e))),(()=>!0)))(e)&&0==(e=>l(e).length)(e),y=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),h=(e,t)=>e?.delete(t),f=e=>new Map(e),p=(e,t)=>e?.get(t),w=(e,t,a)=>n(a)?(h(e,t),e):e?.set(t,a),v=(e,t,a,n)=>{var o,s;return o=e,s=t,o?.has(s)||w(e,t,a()),p(e,t)},b=new globalThis.TextEncoder,A=(e,t)=>t?[e,t]:[e],C=(e,t)=>((e??"")>(t??"")?e:t)??"",M=(e="")=>A(((e=[])=>r.fromEntries(e))(),e),S=f(),L=f(),T=2**36,m=2**30,D=2**24,H=2**18,x=4096,z=64,E=e=>String.fromCharCode(48+(63&e)),j=(e,t)=>((e,t)=>e.charCodeAt(t))(e,t)-48,O=f();e.createLocalSynchronizer=(e,r)=>{const i=""+Math.random();return((e,r,i,c,l,O,P={})=>{let R;const[V]=(e=>{let t=0,o=-1;const r=(e=>{let t=2166136261;return s(b.encode(e),(e=>{t^=e,t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24)})),t>>>0})(e),i=e=>{const s=t,[r,i]=n(e)||""==e?[0,0]:[j(c=e,0)*T+j(c,1)*m+j(c,2)*D+j(c,3)*H+j(c,4)*x+j(c,5)*z+j(c,6),j(c,7)*H+j(c,8)*x+j(c,9)*z+j(c,10),j(c,11)*D+j(c,12)*H+j(c,13)*x+j(c,14)*z+j(c,15)];var c;t=a(s,r,Date.now()),o=t==s?t==r?a(o,i):o:t==r?i:-1};return[()=>{return i(),a=++o,n=r,E((e=t)/T)+E(e/m)+E(e/D)+E(e/H)+E(e/x)+E(e/z)+E(e)+E(a/H)+E(a/x)+E(a/z)+E(a)+E(n/D)+E(n/H)+E(n/x)+E(n/z)+E(n);var e,a,n},i]})(e.getId()),$=f();i(((t,a,s,i)=>{0==s?o(p($,a),(([e,a])=>n(e)||e==t?a(i,t):0)):2==s&&I.isAutoLoading()?F(t,i).then((e=>{R?.(void 0,(()=>e))})):3==s&&I.isAutoLoading()?R?.(void 0,(()=>i)):o(1==s&&I.isAutoSaving()?e.getMergeableContentHashes():4==s?e.getMergeableTableDiff(i):5==s?e.getMergeableRowDiff(i):6==s?e.getMergeableCellDiff(i):7==s?e.getMergeableValueDiff(i):void 0,(e=>{r(t,a,0,e)}))}));const k=async(e,a,n="")=>new t(((t,o)=>{const s=V(),i=setTimeout((()=>{h($,s),o(`No response from ${e??"anyone"} to '${a}'`)}),1e3*l);w($,s,[e,(e,a)=>{clearTimeout(i),h($,s),t([e,a])}]),r(e,s,a,n)})),B=(e,[t,a])=>{u(t,(([t,a],n)=>{const o=y(e[0],n,M);u(t,(([e,t],a)=>{const n=y(o[0],a,M);u(e,(([e,t],a)=>n[0][a]=A(e,t))),n[1]=C(n[1],t)})),o[1]=C(o[1],a)})),e[1]=C(e[1],a)},F=async(t=null,a)=>{n(a)&&([a,t]=await k(t,1));const[o,s]=a,[r,i]=e.getMergeableContentHashes();let c=M();if(r!=o){const[a,n]=(await k(t,4,e.getMergeableTableHashes()))[0];if(c=a,!d(n)){const[a,o]=(await k(t,5,e.getMergeableRowHashes(n)))[0];if(B(c,a),!d(o)){const a=(await k(t,6,e.getMergeableCellHashes(o)))[0];B(c,a)}}}return[c,i==s?M():(await k(t,7,e.getMergeableValuesHashes()))[0],1]},I=((e,t,a,s,r,i,c,l={},u=[])=>{let y,h,f,b=0;v(S,u,(()=>0)),v(L,u,(()=>[]));const[A,C,M,T,m]=((e,t)=>n(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!d(e)||!d(t),t.setContent]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!d(e)||!d(t),t.setDefaultContent])(0,e),D=async e=>(2!=b&&(b=1,await x.schedule((async()=>{await e(),b=0}))),x),H=t=>{var a;(A&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},x={load:async e=>await D((async()=>{try{H(await t())}catch(t){i?.(t),e&&m(e)}})),startAutoLoad:async e=>(await x.stopAutoLoad().load(e),h=s((async(e,a)=>{const n=a?.();await D((async()=>{try{H(n??e?.()??await t())}catch(e){i?.(e)}}))})),x),stopAutoLoad:()=>(h&&(r(h),h=void 0),x),isAutoLoading:()=>!n(h),save:async e=>(1!=b&&(b=2,await x.schedule((async()=>{try{await a(C,e)}catch(e){i?.(e)}b=0}))),x),startAutoSave:async()=>(await x.stopAutoSave().save(),f=e.addDidFinishTransactionListener((()=>{const e=M();T(e)&&x.save((()=>e))})),x),stopAutoSave:()=>(o(f,e.delListener),f=void 0,x),isAutoSaving:()=>!n(f),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(p(L,u),...e),await(async()=>{if(!p(S,u)){for(w(S,u,1);!n((e=p(L,u),y=e.shift()));)try{await y()}catch(e){i?.(e)}w(S,u,0)}var e})(),x),getStore:()=>e,destroy:()=>x.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...l};return g(x)})(e,(async()=>{const e=await F();return d(e[0][0])&&d(e[1][0])?void 0:e}),(async(t,a)=>{a?r(null,null,3,a()):r(null,null,2,e.getMergeableContentHashes())}),(e=>R=e),(()=>R=void 0),O,0,{startSync:async e=>await(await I.startAutoLoad(e)).startAutoSave(),stopSync:()=>I.stopAutoLoad().stopAutoSave(),destroy:()=>(c(),I.stopSync()),getSynchronizerStats:()=>({}),...P});return I})(e,((e,t,a,o)=>{setTimeout((()=>{return n(e)?(s=(e,n)=>e!=i?n(i,t,a,o):0,((e,t)=>e?.forEach(t))(O,((e,t)=>s(t,e)))):p(O,e)?.(i,t,a,o);var s}),0)}),(e=>{w(O,i,e)}),(()=>{h(O,i)}),.05,r)}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerLocal={});
