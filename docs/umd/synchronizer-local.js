var e,t;e=this,t=function(e){"use strict";const t=Promise,a=e=>null==e,n=(e,t,n)=>a(e)?n?.():t(e),o=Object,s=e=>o.getPrototypeOf(e),r=o.entries,i=o.keys,l=o.freeze,c=(e,t)=>((e,t)=>e.forEach(t))(r(e),(([e,a])=>t(a,e))),g=e=>(e=>!a(e)&&n(s(e),(e=>e==o.prototype||a(s(e))),(()=>!0)))(e)&&0==(e=>i(e).length)(e),u=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),y=(e,t)=>e?.delete(t),d=e=>new Map(e),f=(e,t)=>e?.get(t),h=(e,t,n)=>a(n)?(y(e,t),e):e?.set(t,n),p=(e,t,a,n)=>{var o,s;return o=e,s=t,o?.has(s)||h(e,t,a()),f(e,t)};new globalThis.TextEncoder;const b=(e,t)=>t?[e,t]:[e],v=(e,t)=>((e??"")>(t??"")?e:t)??"",w=(e="")=>b(((e=[])=>o.fromEntries(e))(),e),A=d(),M=d(),C="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz".split("");var S;d((S=(e,t)=>[e,t],C.map(S)));const T=(e=16)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+C[63&t]),""),L=d();e.createLocalSynchronizer=(e,o)=>{const s=T();return((e,o,s,r,i,C,S={})=>{let L;const m=d();s(((t,s,r,i)=>{0==r?n(f(m,s),(([e,n])=>a(e)||e==t?n(i,t):0)):2==r&&z.isAutoLoading()?x(t,i).then((e=>{L?.(void 0,e)})):3==r&&z.isAutoLoading()?L?.(void 0,i):n(1==r&&z.isAutoSaving()?e.getMergeableContentHashes():4==r?e.getMergeableTableDiff(i):5==r?e.getMergeableRowDiff(i):6==r?e.getMergeableCellDiff(i):7==r?e.getMergeableValueDiff(i):void 0,(e=>{o(t,s,0,e)}))}));const H=async(e,a,n="")=>new t(((t,s)=>{const r=T(),l=setTimeout((()=>{y(m,r),s(`No response from ${e??"anyone"} to '${a}'`)}),1e3*i);h(m,r,[e,(e,a)=>{clearTimeout(l),y(m,r),t([e,a])}]),o(e,r,a,n)})),D=(e,[t,a])=>{c(t,(([t,a],n)=>{const o=u(e[0],n,w);c(t,(([e,t],a)=>{const n=u(o[0],a,w);c(e,(([e,t],a)=>n[0][a]=b(e,t))),n[1]=v(n[1],t)})),o[1]=v(o[1],a)})),e[1]=v(e[1],a)},x=async(t=null,n)=>{a(n)&&([n,t]=await H(t,1));const[o,s]=n,[r,i]=e.getMergeableContentHashes();let l=w();if(r!=o){const[a,n]=(await H(t,4,e.getMergeableTableHashes()))[0];if(l=a,!g(n)){const[a,o]=(await H(t,5,e.getMergeableRowHashes(n)))[0];if(D(l,a),!g(o)){const a=(await H(t,6,e.getMergeableCellHashes(o)))[0];D(l,a)}}}return[l,i==s?w():(await H(t,7,e.getMergeableValuesHashes()))[0],1]},z=((e,t,o,s,r,i,c,u={},y=[])=>{let d,b,v,w=0;p(A,y,(()=>0)),p(M,y,(()=>[]));const[C,S,T,L,m]=((e=1,t)=>e>1&&"getMergeableContent"in t?[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!g(e)||!g(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!g(e)||!g(t),t.setContent]:0)(c,e),H=t=>{var a;(C&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},D=async e=>(2!=w&&(w=1,await R((async()=>{try{H(await t())}catch(t){i?.(t),e&&m(e)}w=0}))),V),x=()=>(b&&(r(b),b=void 0),V),z=async e=>(1!=w&&(w=2,await R((async()=>{try{await o(S,e)}catch(e){i?.(e)}w=0}))),V),E=()=>(n(v,e.delListener),v=void 0,V),R=async(...e)=>(((e,...t)=>{e.push(...t)})(f(M,y),...e),await(async()=>{if(!f(A,y)){for(h(A,y,1);!a((e=f(M,y),d=e.shift()));)try{await d()}catch(e){i?.(e)}h(A,y,0)}var e})(),V),V={load:D,startAutoLoad:async e=>(await x().load(e),b=s((async(e,t)=>{t||e?2!=w&&(w=1,H(t??e),w=0):await D()})),V),stopAutoLoad:x,isAutoLoading:()=>!a(b),save:z,startAutoSave:async()=>(await E().save(),v=e.addDidFinishTransactionListener((()=>{const e=T();L(e)&&z(e)})),V),stopAutoSave:E,isAutoSaving:()=>!a(v),schedule:R,getStore:()=>e,destroy:()=>x().stopAutoSave(),getStats:()=>({}),...u};return l(V)})(e,(async()=>{const e=await x();return g(e[0][0])&&g(e[1][0])?void 0:e}),(async(t,a)=>{a?o(null,null,3,a):o(null,null,2,e.getMergeableContentHashes())}),(e=>L=e),(()=>L=void 0),C,2,{startSync:async e=>await(await z.startAutoLoad(e)).startAutoSave(),stopSync:()=>z.stopAutoLoad().stopAutoSave(),destroy:()=>(r(),z.stopSync()),getSynchronizerStats:()=>({}),...S});return z})(e,((e,t,n,o)=>{setTimeout((()=>{return a(e)?(r=L,r?.forEach(((e,a)=>{return r=e,a!=s?r(s,t,n,o):0;var r}))):f(L,e)?.(s,t,n,o);var r}),0)}),(e=>{h(L,s,e)}),(()=>{y(L,s)}),.01,o)}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerLocal={});
