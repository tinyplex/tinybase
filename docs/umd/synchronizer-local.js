var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a=t(""),n=Promise,o=Math.max,s=e=>null==e,r=(e,t,a)=>s(e)?a?.():t(e),i=Object,c=e=>i.getPrototypeOf(e),l=i.keys,g=i.freeze,u=e=>(e=>!s(e)&&r(c(e),(e=>e==i.prototype||s(c(e))),(()=>!0)))(e)&&0==(e=>l(e).length)(e),d=(e,t)=>e?.delete(t),y=e=>new Map(e),h=(e,t)=>e?.get(t),p=(e,t,a)=>s(a)?(d(e,t),e):e?.set(t,a),f=(e,t,a,n)=>{var o,s;return o=e,s=t,o?.has(s)||p(e,t,a()),h(e,t)},w=y(),v=y(),b=new globalThis.TextEncoder,C=2**36,M=2**30,S=2**24,A=2**18,T=4096,L=64,m=e=>String.fromCharCode(48+(63&e)),H=(e,t)=>((e,t)=>e.charCodeAt(t))(e,t)-48,x=y();e.createLocalSynchronizer=(e,i)=>{const c=""+Math.random();return((e,i,c,l,x,D,z={})=>{let E;const[I]=(e=>{let t=0,a=-1;const n=(e=>{let t=2166136261;var a;return a=e=>{t^=e,t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24)},b.encode(e).forEach(a),t>>>0})(e),r=e=>{const n=t,[r,i]=s(e)||""==e?[0,0]:[H(c=e,0)*C+H(c,1)*M+H(c,2)*S+H(c,3)*A+H(c,4)*T+H(c,5)*L+H(c,6),H(c,7)*A+H(c,8)*T+H(c,9)*L+H(c,10),H(c,11)*S+H(c,12)*A+H(c,13)*T+H(c,14)*L+H(c,15)];var c;t=o(n,r,Date.now()),a=t==n?t==r?o(a,i):a:t==r?i:-1};return[()=>{return r(),o=++a,s=n,m((e=t)/C)+m(e/M)+m(e/S)+m(e/A)+m(e/T)+m(e/L)+m(e)+m(o/A)+m(o/T)+m(o/L)+m(o)+m(s/S)+m(s/A)+m(s/T)+m(s/L)+m(s);var e,o,s},r]})(e.getId()),j=y();c(((t,a,n,o)=>{0==n?r(h(j,a),(([e,a])=>s(e)||e==t?a(o,t):0)):1==n&&R.isAutoLoading()?P(t,o).then((e=>E?.(void 0,(()=>e)))):r(2==n&&R.isAutoSaving()?e.getMergeableContentHashes():3==n?e.getMergeableTableIdsDiff(o):4==n?e.getMergeableRowIdsDiff(o):5==n?e.getMergeableTablesChanges(o):6==n?e.getMergeableValuesChanges(o):void 0,(e=>{i(t,a,0,e)}))}));const O=async(e,t,a="")=>new n(((n,o)=>{const s=I(),r=setTimeout((()=>{d(j,s),o(`No response from ${e??"anyone"} to '${t}'`)}),1e3*x);p(j,s,[e,(e,t)=>{clearTimeout(r),d(j,s),n([e,t])}]),i(e,s,t,a)})),P=async(t=null,a)=>{s(a)&&([a,t]=await O(t,2));const[n,[o,r]]=a,[,[i,c]]=e.getMergeableContentHashes(),l=["",[["",{}],["",{}],1]];return i!=o&&(l[0]=n,l[1][0]=(await O(t,5,e.getMergeableCellHashes((await O(t,4,e.getMergeableRowHashes((await O(t,3,e.getMergeableTableHashes()))[0])))[0])))[0]),c!=r&&(l[0]=n,l[1][1]=(await O(t,6,e.getMergeableValuesHashes()))[0]),l},R=((e,n,o,i,c,l,d,y={},b=[])=>{let C,M,S,A=0;f(w,b,(()=>0)),f(v,b,(()=>[]));const[T,L,m,H,x]=((e,t)=>s(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!u(e)||!u(t),t.setContent]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!u(e)||!u(t),t.setDefaultContent])(0,e),D=async e=>(2!=A&&(A=1,await E.schedule((async()=>{await e(),A=0}))),E),z=n=>{var o;(T&&(o=n?.[0],t(o)==a)?1===n?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===n?.[2]?e.applyChanges:e.setContent)(n)},E={load:async e=>await D((async()=>{try{z(await n())}catch(t){l?.(t),e&&x(e)}})),startAutoLoad:async e=>(await E.stopAutoLoad().load(e),M=i((async(e,t)=>{const a=t?.();await D((async()=>{try{z(a??e?.()??await n())}catch(e){l?.(e)}}))})),E),stopAutoLoad:()=>(M&&(c(M),M=void 0),E),isAutoLoading:()=>!s(M),save:async e=>(1!=A&&(A=2,await E.schedule((async()=>{try{await o(L,e)}catch(e){l?.(e)}A=0}))),E),startAutoSave:async()=>(await E.stopAutoSave().save(),S=e.addDidFinishTransactionListener((()=>{const e=m();H(e)&&E.save((()=>e))})),E),stopAutoSave:()=>(r(S,e.delListener),S=void 0,E),isAutoSaving:()=>!s(S),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(h(v,b),...e),await(async()=>{if(!h(w,b)){for(p(w,b,1);!s((e=h(v,b),C=e.shift()));)try{await C()}catch(e){l?.(e)}p(w,b,0)}var e})(),E),getStore:()=>e,destroy:()=>E.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...y};return g(E)})(e,(async()=>{const e=await P();return""!=e[0]?e:void 0}),(async()=>{i(null,null,1,e.getMergeableContentHashes())}),(e=>E=e),(()=>E=void 0),D,0,{startSync:async e=>await(await R.startAutoLoad(e)).startAutoSave(),stopSync:()=>R.stopAutoLoad().stopAutoSave(),destroy:()=>(l(),R.stopSync()),getSynchronizerStats:()=>({}),...z});return R})(e,((e,t,a,n)=>{var o;s(e)?(o=(e,o)=>e!=c?o(c,t,a,n):0,((e,t)=>{e?.forEach(t)})(x,((e,t)=>o(t,e)))):h(x,e)?.(c,t,a,n)}),(e=>{p(x,c,e)}),(()=>{d(x,c)}),.001,i)}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerLocal={});
