var e,t;e=this,t=function(e){"use strict";const t=clearInterval,a=e=>null==e,s=(e,t,s)=>a(e)?s?.():t(e),n=Object,r=e=>n.getPrototypeOf(e),o=n.keys,i=n.freeze,c=e=>(e=>!a(e)&&s(r(e),(e=>e==n.prototype||a(r(e))),(()=>!0)))(e)&&0==(e=>o(e).length)(e),y=JSON.parse,d=e=>new Map(e),l=(e,t)=>e?.get(t),p=(e,t,s)=>{return a(s)?(n=e,r=t,n?.delete(r),e):e?.set(t,s);var n,r},g=(e,t,a,s)=>{var n,r;return n=e,r=t,n?.has(r)||p(e,t,a()),l(e,t)},h=d(),f=d(),u=e=>e.headers.get("ETag");e.createRemotePersister=(e,r,o,d=5,v)=>{let w;return((e,t,n,r,o,y,d,u={},v=[])=>{let w,b,C,A=0;g(h,v,(()=>0)),g(f,v,(()=>[]));const[S,T,m,M,L]=((e=1,t)=>e>1&&t.isMergeable()?[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!c(e)||!c(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!c(e)||!c(t),t.setContent]:(e=>{throw Error("Store type not supported by this Persister")})())(d,e),O=t=>{var a;(S&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},P=async e=>(2!=A&&(A=1,await D((async()=>{try{O(await t())}catch(t){y?.(t),e&&L(e)}A=0}))),I),x=()=>(b&&(o(b),b=void 0),I),E=async e=>(1!=A&&(A=2,await D((async()=>{try{await n(T,e)}catch(e){y?.(e)}A=0}))),I),j=()=>(s(C,e.delListener),C=void 0,I),D=async(...e)=>(((e,...t)=>{e.push(...t)})(l(f,v),...e),await(async()=>{if(!l(h,v)){for(p(h,v,1);!a((e=l(f,v),w=e.shift()));)try{await w()}catch(e){y?.(e)}p(h,v,0)}var e})(),I),I={load:P,startAutoLoad:async e=>(await x().load(e),b=r((async(e,t)=>{t||e?2!=A&&(A=1,O(t??e),A=0):await P()})),I),stopAutoLoad:x,isAutoLoading:()=>!a(b),save:E,startAutoSave:async()=>(await j().save(),C=e.addDidFinishTransactionListener((()=>{const e=m();M(e)&&E(e)})),I),stopAutoSave:j,isAutoSaving:()=>!a(C),schedule:D,getStore:()=>e,destroy:()=>x().stopAutoSave(),getStats:()=>({}),...u};return i(I)})(e,(async()=>{const e=await fetch(r);return w=u(e),y(await e.text())}),(async e=>{return await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:(t=e(),JSON.stringify(t,((e,t)=>t instanceof Map?n.fromEntries([...t]):t)))});var t}),(e=>setInterval((async()=>{const t=await fetch(r,{method:"HEAD"}),s=u(t);a(w)||a(s)||s==w||(w=s,e())}),1e3*d)),(e=>t(e)),v,1,{getUrls:()=>[r,o]})}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterRemote={});
