var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a=e(""),s=clearInterval,n=t=>null==t,o=(t,e,a)=>n(t)?a?.():e(t),r=Object,i=t=>r.getPrototypeOf(t),c=r.keys,y=r.freeze,d=t=>(t=>!n(t)&&o(i(t),(t=>t==r.prototype||n(i(t))),(()=>!0)))(t)&&0==(t=>c(t).length)(t),p=JSON.parse,l=t=>new Map(t),u=(t,e)=>t?.get(e),h=(t,e,a)=>{return n(a)?(s=t,o=e,s?.delete(o),t):t?.set(e,a);var s,o},f=(t,e,a,s)=>{var n,o;return n=t,o=e,n?.has(o)||h(t,e,a()),u(t,e)},g=l(),v=l(),w=t=>t.headers.get("ETag");t.createRemotePersister=(t,i,c,l=5,A)=>{let S;return((t,s,r,i,c,p,l,w={},A=[])=>{let S,C,T,b=0;f(g,A,(()=>0)),f(v,A,(()=>[]));const[m,L,O,x,M]=((t,e)=>[0,e.getContent,e.getTransactionChanges,([t,e])=>!d(t)||!d(e),e.setContent])(0,t),P=async t=>(2!=b&&(b=1,await E.schedule((async()=>{await t(),b=0}))),E),j=s=>{var n;(m&&(n=s?.[0],e(n)==a)?1===s?.[1][2]?t.applyMergeableChanges:t.setMergeableContent:1===s?.[2]?t.applyChanges:t.setContent)(s)},E={load:async t=>await P((async()=>{try{j(await s())}catch(e){p?.(e),t&&M(t)}})),startAutoLoad:async t=>(await E.stopAutoLoad().load(t),C=i((async(t,e)=>{const a=e?.();await P((async()=>{try{j(a??t?.()??await s())}catch(t){p?.(t)}}))})),E),stopAutoLoad:()=>(C&&(c(C),C=void 0),E),isAutoLoading:()=>!n(C),save:async t=>(1!=b&&(b=2,await E.schedule((async()=>{try{await r(L,t)}catch(t){p?.(t)}b=0}))),E),startAutoSave:async()=>(await E.stopAutoSave().save(),T=t.addDidFinishTransactionListener((()=>{const t=O();x(t)&&E.save((()=>t))})),E),stopAutoSave:()=>(o(T,t.delListener),T=void 0,E),isAutoSaving:()=>!n(T),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(u(v,A),...t),await(async()=>{if(!u(g,A)){for(h(g,A,1);!n((t=u(v,A),S=t.shift()));)try{await S()}catch(t){p?.(t)}h(g,A,0)}var t})(),E),getStore:()=>t,destroy:()=>E.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...w};return y(E)})(t,(async()=>{const t=await fetch(i);return S=w(t),p(await t.text())}),(async t=>{return await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:(e=t(),JSON.stringify(e,((t,e)=>e instanceof Map?r.fromEntries([...e]):e)))});var e}),(t=>setInterval((async()=>{const e=await fetch(i,{method:"HEAD"}),a=w(e);n(S)||n(a)||a==S||(S=a,t())}),1e3*l)),(t=>s(t)),A,0,{getUrls:()=>[i,c]})}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterRemote={});
