var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a=e(""),s=clearInterval,n=t=>null==t,o=(t,e,a)=>n(t)?a?.():e(t),r=Object,i=t=>r.getPrototypeOf(t),c=r.keys,y=r.freeze,d=t=>(t=>!n(t)&&o(i(t),(t=>t==r.prototype||n(i(t))),(()=>!0)))(t)&&0==(t=>c(t).length)(t),p=JSON.parse,l=t=>new Map(t),f=(t,e)=>t?.get(e),h=(t,e,a)=>{return n(a)?(s=t,o=e,s?.delete(o),t):t?.set(e,a);var s,o},u=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||h(t,e,a()),f(t,e)},w=l(),g=l(),v=t=>t.headers.get("ETag");t.createRemotePersister=(t,i,c,l=5,A)=>{let S;return((t,s,r,i,c,p,l,[v,A]=[],S=[])=>{let C,T,m,b=0,L=0;u(w,S,(()=>0)),u(g,S,(()=>[]));const O=t.getContent,x=t.getTransactionChanges,P=async t=>(2!=b&&(b=1,await j.schedule((async()=>{await t(),b=0}))),j),j={load:async(n,o)=>await P((async()=>{try{const n=await s();(l&&(t=>e(t)==a)(n[0])?t.applyMergeableChanges:t.setContent)(n)}catch{t.setContent([n,o])}})),startAutoLoad:async(e={},a={})=>(j.stopAutoLoad(),await j.load(e,a),L=1,m=i((async(e,a)=>{if(a){const e=a();await P((async()=>t.applyChanges(e)))}else await P((async()=>{try{t.setContent(e?.()??await s())}catch(t){p?.(t)}}))})),j),stopAutoLoad:()=>(L&&(c(m),m=void 0,L=0),j),save:async t=>(1!=b&&(b=2,await j.schedule((async()=>{try{await r(O,t)}catch(t){p?.(t)}b=0}))),j),startAutoSave:async()=>(await j.stopAutoSave().save(),C=t.addDidFinishTransactionListener((()=>{const[t,e]=x();d(t)&&d(e)||j.save((()=>[t,e]))})),j),stopAutoSave:()=>(o(C,t.delListener),C=void 0,j),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(f(g,S),...t),await(async()=>{if(!f(w,S)){for(h(w,S,1);!n((t=f(g,S),T=t.shift()));)try{await T()}catch(t){p?.(t)}h(w,S,0)}var t})(),j),getStore:()=>t,destroy:()=>j.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return v&&(j[v]=()=>A),y(j)})(t,(async()=>{const t=await fetch(i);return S=v(t),p(await t.text())}),(async t=>{return await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:(e=t(),JSON.stringify(e,((t,e)=>e instanceof Map?r.fromEntries([...e]):e)))});var e}),(t=>setInterval((async()=>{const e=await fetch(i,{method:"HEAD"}),a=v(e);n(S)||n(a)||a==S||(S=a,t())}),1e3*l)),(t=>s(t)),A,!1,["getUrls",[i,c]])}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterRemote={});
