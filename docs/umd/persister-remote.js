var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a=e(""),s=clearInterval,n=t=>null==t,o=(t,e,a)=>n(t)?a?.():e(t),r=Object,c=t=>r.getPrototypeOf(t),i=r.keys,y=r.freeze,d=t=>(t=>!n(t)&&o(c(t),(t=>t==r.prototype||n(c(t))),(()=>!0)))(t)&&0==(t=>i(t).length)(t),l=JSON.parse,p=t=>new Map(t),u=(t,e)=>t?.get(e),f=(t,e,a)=>{return n(a)?(s=t,o=e,s?.delete(o),t):t?.set(e,a);var s,o},h=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||f(t,e,a()),u(t,e)},g=p(),w=p(),v=t=>{return s=t?.[0],e(s)==a;var s},C=t=>t.headers.get("ETag");t.createRemotePersister=(t,e,a,c=5,i)=>{let p;return((t,e,a,s,r,c,i,[l,p]=[],C=[])=>{let A,S,b,T=0,m=0;h(g,C,(()=>0)),h(w,C,(()=>[]));const[L,M,O,x]=((t,e)=>[0,e.getContent,e.getTransactionChanges,([t,e])=>!d(t)||!d(e)])(0,t),P=async t=>(2!=T&&(T=1,await j.schedule((async()=>{await t(),T=0}))),j),j={load:async(a,s)=>await P((async()=>{try{const a=await e();(L&&v(a)?t.setMergeableContent:t.setContent)(a)}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},n={})=>(j.stopAutoLoad(),await j.load(a,n),m=1,b=s((async(a,s)=>{if(s){const e=s();await P((async()=>(L&&v(e)?t.applyMergeableChanges:t.applyChanges)(e)))}else await P((async()=>{try{const s=a?.()??await e();(L&&v(s)?t.setMergeableContent:t.setContent)(s)}catch(t){c?.(t)}}))})),j),stopAutoLoad:()=>(m&&(r(b),b=void 0,m=0),j),save:async t=>(1!=T&&(T=2,await j.schedule((async()=>{try{await a(M,t)}catch(t){c?.(t)}T=0}))),j),startAutoSave:async()=>(await j.stopAutoSave().save(),A=t.addDidFinishTransactionListener((()=>{const t=O();x(t)&&j.save((()=>t))})),j),stopAutoSave:()=>(o(A,t.delListener),A=void 0,j),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(u(w,C),...t),await(async()=>{if(!u(g,C)){for(f(g,C,1);!n((t=u(w,C),S=t.shift()));)try{await S()}catch(t){c?.(t)}f(g,C,0)}var t})(),j),getStore:()=>t,destroy:()=>j.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return l&&(j[l]=()=>p),y(j)})(t,(async()=>{const t=await fetch(e);return p=C(t),l(await t.text())}),(async t=>{return await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:(e=t(),JSON.stringify(e,((t,e)=>e instanceof Map?r.fromEntries([...e]):e)))});var e}),(t=>setInterval((async()=>{const a=await fetch(e,{method:"HEAD"}),s=C(a);n(p)||n(s)||s==p||(p=s,t())}),1e3*c)),(t=>s(t)),i,0,["getUrls",[e,a]])}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterRemote={});
