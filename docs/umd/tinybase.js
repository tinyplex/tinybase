var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",n=t(s),a=t(!0),o=t(0),r=t(t),i="type",l="default",c="Listener",d="Result",u="add",h="Has",g="Ids",f="Table",L=f+"s",w=f+g,v="Row",I=v+"Count",S=v+g,y="Sorted"+v+g,T="Cell",R=T+g,p="Value",C=p+"s",b=p+g,m=e=>s+e,V=Math.max,E=Math.min,k=isFinite,M=e=>null==e,x=(e,t,s)=>M(e)?s?.():t(e),D=e=>e==n||e==a,J=e=>t(e)==r,A=e=>Array.isArray(e),F=(e,t,s)=>e.slice(t,s),Q=e=>e.length,z=()=>{},N=(e,t)=>e.includes(t),O=(e,t)=>e.every(t),P=(e,t)=>Q(e)===Q(t)&&O(e,((e,s)=>t[s]===e)),j=(e,t)=>O(e,((s,n)=>0==n||t(e[n-1],s)<=0)),B=(e,t)=>e.sort(t),W=(e,t)=>e.forEach(t),_=(e,t)=>e.map(t),H=e=>q(e,((e,t)=>e+t),0),$=e=>0==Q(e),q=(e,t,s)=>e.reduce(t,s),G=(e,...t)=>e.push(...t),K=e=>e.pop(),U=e=>e.shift(),X=Object,Y=e=>X.getPrototypeOf(e),Z=X.entries,ee=X.keys,te=X.isFrozen,se=X.freeze,ne=e=>!M(e)&&x(Y(e),(e=>e==X.prototype||M(Y(e))),(()=>!0)),ae=(e,t)=>!M(((e,t)=>x(e,(e=>e[t])))(e,t)),oe=(e,t)=>(delete e[t],e),re=(e,t)=>_(Z(e),(([e,s])=>t(s,e))),ie=e=>ne(e)&&0==(e=>Q(ee(e)))(e),le=e=>e?.size??0,ce=(e,t)=>e?.has(t)??!1,de=e=>M(e)||0==le(e),ue=e=>[...e?.values()??[]],he=e=>e.clear(),ge=(e,t)=>e?.forEach(t),fe=(e,t)=>e?.delete(t),Le=e=>new Map(e),we=e=>[...e?.keys()??[]],ve=(e,t)=>e?.get(t),Ie=(e,t)=>ge(e,((e,s)=>t(s,e))),Se=(e,t,s)=>M(s)?(fe(e,t),e):e?.set(t,s),ye=(e,t,s)=>(ce(e,t)||Se(e,t,s()),ve(e,t)),Te=(e,t,s,n=Se)=>(re(t,((t,n)=>s(e,n,t))),Ie(e,(s=>ae(t,s)?0:n(e,s))),e),Re=(e,t,s)=>{const n={};return ge(e,((e,a)=>{const o=t?t(e,a):e;!s?.(o,e)&&(n[a]=o)})),n},pe=(e,t,s)=>Re(e,(e=>Re(e,t,s)),ie),Ce=(e,t,s)=>Re(e,(e=>pe(e,t,s)),ie),be=(e,t)=>{const s=Le();return ge(e,((e,n)=>s.set(n,t?.(e)??e))),s},me=e=>be(e,be),Ve=e=>be(e,me),Ee=(e,t,s,n,a=0)=>x((s?ye:ve)(e,t[a],a>Q(t)-2?s:Le),(o=>{if(a>Q(t)-2)return n?.(o)&&Se(e,t[a]),o;const r=Ee(o,t,s,n,a+1);return de(o)&&Se(e,t[a]),r})),ke=e=>{const s=t(e);return D(s)||s==o&&k(e)?s:void 0},Me=(e,t,s,n,a)=>M(a)?e.delCell(t,s,n,!0):e.setCell(t,s,n,a),xe=(e,t,s)=>M(s)?e.delValue(t):e.setValue(t,s),De=e=>new Set(A(e)||M(e)?e:[e]),Je=(e,t)=>e?.add(t),Ae=(e,t,s,n,a)=>{const o=e.hasRow,r=Le(),i=Le(),l=Le(),c=Le(),d=Le(),u=Le(),h=(t,s,...n)=>{const a=ye(u,t,De);return W(n,(t=>Je(a,t)&&s&&e.callListener(t))),n},g=(t,...s)=>x(ve(u,t),(n=>{W($(s)?ue(n):s,(t=>{e.delListener(t),fe(n,t)})),de(n)&&Se(u,t)})),f=(e,s)=>{Se(r,e,s),ce(i,e)||(Se(i,e,t()),Se(c,e,Le()),Se(d,e,Le()),a(l))},L=e=>{Se(r,e),Se(i,e),Se(c,e),Se(d,e),g(e),a(l)};return[()=>e,()=>we(r),e=>Ie(i,e),e=>ce(i,e),e=>ve(r,e),e=>ve(i,e),(e,t)=>Se(i,e,t),f,(t,n,a,r,i)=>{f(t,n);const l=Le(),u=Le(),L=ve(c,t),w=ve(d,t),v=t=>{const a=s=>e.getCell(n,t,s),c=ve(L,t),d=o(n,t)?s(r(a,t)):void 0;if(c===d||A(c)&&A(d)&&P(c,d)||Se(l,t,[c,d]),!M(i)){const e=ve(w,t),s=o(n,t)?i(a,t):void 0;e!=s&&Se(u,t,s)}},I=e=>{a((()=>{ge(l,(([,e],t)=>Se(L,t,e))),ge(u,((e,t)=>Se(w,t,e)))}),l,u,L,w,e),he(l),he(u)};Ie(L,v),e.hasTable(n)&&W(e.getRowIds(n),(e=>{ce(L,e)||v(e)})),I(!0),g(t),h(t,0,e.addRowListener(n,null,((e,t,s)=>v(s))),e.addTableListener(n,(()=>I())))},L,e=>n(e,l),()=>Ie(u,L),h,g]},Fe=(e,a)=>t(e)==n?t=>t(e):e??(()=>a??s),Qe=(e,t)=>{const s=new WeakMap;return n=>{s.has(n)||s.set(n,e(n));const a=s.get(n);return t?.(a),a}},ze=/^\d+$/,Ne=()=>{const e=[];let t=0;return[n=>(n?U(e):null)??s+t++,t=>{ze.test(t)&&Q(e)<1e3&&G(e,t)}]},Oe=e=>{let t;const[n,a]=Ne(),o=Le();return[(a,r,i,l=[],c=(()=>[]))=>{t??=e();const d=n(1);return Se(o,d,[a,r,i,l,c]),Je(Ee(r,i??[s],De),d),d},(e,n,...a)=>W(((e,t=[s])=>{const n=[],a=(e,s)=>s==Q(t)?G(n,e):null===t[s]?ge(e,(e=>a(e,s+1))):W([t[s],null],(t=>a(ve(e,t),s+1)));return a(e,0),n})(e,n),(e=>ge(e,(e=>ve(o,e)[0](t,...n??[],...a))))),e=>x(ve(o,e),(([,t,n])=>(Ee(t,n??[s],void 0,(t=>(fe(t,e),de(t)?1:0))),Se(o,e),a(e),n))),e=>x(ve(o,e),(([e,,s=[],n,a])=>{const o=(...r)=>{const i=Q(r);i==Q(s)?e(t,...r,...a(r)):M(s[i])?W(n[i]?.(...r)??[],(e=>o(...r,e))):o(...r,s[i])};o()}))]},Pe=Qe((e=>{let t,n,a,o=100,r=Le(),i=Le(),l=1;const c=Le(),d=Le(),[u,h,g]=Oe((()=>F)),f=Le(),L=Le(),w=[],v=[],I=(t,s)=>{l=0,e.transaction((()=>{const[n,a]=ve(f,s);ge(n,((s,n)=>ge(s,((s,a)=>ge(s,((s,o)=>Me(e,n,a,o,s[t]))))))),ge(a,((s,n)=>xe(e,n,s[t])))})),l=1},S=e=>{Se(f,e),Se(L,e),h(d,[e])},y=(e,t)=>W(((e,t)=>e.splice(0,t))(e,t??Q(e)),S),T=()=>y(w,Q(w)-o),R=()=>x(t,(()=>{G(w,t),T(),y(v),t=void 0,a=1})),p=()=>{t=K(w),a=1};let C,b;const m=(e="")=>(M(t)&&(t=s+n++,Se(f,t,[r,i]),J(t,e),r=Le(),i=Le(),a=1),t),V=()=>{$(w)||(((e,...t)=>{e.unshift(...t)})(v,m()),I(0,t),t=K(w),a=1)},E=()=>{$(v)||(G(w,t),t=U(v),I(1,t),a=1)},k=()=>{a&&(h(c),a=0)},D=e=>{const t=m(e);return k(),t},J=(e,t)=>(A(e)&&ve(L,e)!==t&&(Se(L,e,t),h(d,[e])),F),A=e=>ce(f,e),F={setSize:e=>(o=e,T(),F),addCheckpoint:D,setCheckpoint:J,getStore:()=>e,getCheckpointIds:()=>[[...w],t,[...v]],forEachCheckpoint:e=>Ie(L,e),hasCheckpoint:A,getCheckpoint:e=>ve(L,e),goBackward:()=>(V(),k(),F),goForward:()=>(E(),k(),F),goTo:e=>{const s=N(w,e)?V:N(v,e)?E:null;for(;!M(s)&&e!=t;)s();return k(),F},addCheckpointIdsListener:e=>u(e,c),addCheckpointListener:(e,t)=>u(t,d,[e]),delListener:e=>(g(e),F),clear:()=>(y(w),y(v),M(t)||S(t),t=void 0,n=0,D(),F),clearForward:()=>($(v)||(y(v),h(c)),F),destroy:()=>{e.delListener(C),e.delListener(b)},getListenerStats:()=>({}),_registerListeners:()=>{C=e.addCellListener(null,null,null,((e,t,s,n,a,o)=>{if(l){R();const e=ye(r,t,Le),i=ye(e,s,Le),l=ye(i,n,(()=>[o,void 0]));l[1]=a,l[0]===a&&de(Se(i,n))&&de(Se(e,s))&&de(Se(r,t))&&p(),k()}})),b=e.addValueListener(null,((e,t,s,n)=>{if(l){R();const e=ye(i,t,(()=>[n,void 0]));e[1]=s,e[0]===s&&de(Se(i,t))&&p(),k()}}))}};return se(F.clear())}),(e=>e._registerListeners())),je=(e,t)=>(e??0)<(t??0)?-1:1,Be=Qe((e=>{const t=Le(),n=Le(),[a,o,r]=Oe((()=>S)),[i,l,c,d,u,h,g,,f,L,w,v]=Ae(e,Le,(e=>M(e)?s:A(e)?_(e,m):m(e)),a,o),I=(t,s,n)=>{const a=u(t);ge(n,((t,n)=>s(n,(s=>ge(t,(t=>s(t,(s=>e.forEachCell(a,t,s)))))))))},S={setIndexDefinition:(e,s,a,r,i,l=je)=>{const c=M(i)?void 0:([e],[t])=>i(e,t);return f(e,s,((s,a,i,d,u,f)=>{let L=0;const w=De(),v=De(),I=h(e);if(ge(a,(([e,t],s)=>{const n=De(e),a=De(t);ge(n,(e=>fe(a,e)?fe(n,e):0)),ge(n,(e=>{Je(w,e),x(ve(I,e),(t=>{fe(t,s),de(t)&&(Se(I,e),L=1)}))})),ge(a,(e=>{Je(w,e),ce(I,e)||(Se(I,e,De()),L=1),Je(ve(I,e),s),M(r)||Je(v,e)}))})),s(),de(u)||(f?Ie(I,(e=>Je(v,e))):Ie(i,(e=>x(ve(d,e),(e=>Je(v,e))))),ge(v,(e=>{const t=(t,s)=>l(ve(u,t),ve(u,s),e),s=[...ve(I,e)];j(s,t)||(Se(I,e,De(B(s,t))),Je(w,e))}))),(L||f)&&!M(c)){const t=[...I];j(t,c)||(g(e,Le(B(t,c))),L=1)}L&&o(t,[e]),ge(w,(t=>o(n,[e,t])))}),Fe(a),x(r,Fe)),S},delIndexDefinition:e=>(L(e),S),getStore:i,getIndexIds:l,forEachIndex:e=>c(((t,s)=>e(t,(e=>I(t,e,s))))),forEachSlice:(e,t)=>I(e,t,h(e)),hasIndex:d,hasSlice:(e,t)=>ce(h(e),t),getTableId:u,getSliceIds:e=>we(h(e)),getSliceRowIds:(e,t)=>ue(ve(h(e),t)),addIndexIdsListener:w,addSliceIdsListener:(e,s)=>a(s,t,[e]),addSliceRowIdsListener:(e,t,s)=>a(s,n,[e,t]),delListener:e=>(r(e),S),destroy:v,getListenerStats:()=>({})};return se(S)})),We=Le([["avg",[(e,t)=>H(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>V(...e),(e,t)=>V(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:V(t,e)]],["min",[e=>E(...e),(e,t)=>E(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:E(t,e)]],["sum",[e=>H(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),_e=(e,t,s,n,a,o=!1)=>{if(de(s))return;const[r,i,l,c]=a;return o||=M(e),ge(n,(([s,n])=>{o||(e=M(s)?i?.(e,n,t++):M(n)?l?.(e,s,t--):c?.(e,n,s,t),o||=M(e))})),o?r(ue(s),le(s)):e},He=Qe((e=>{const t=Le(),[n,a,o]=Oe((()=>v)),[r,i,l,c,d,u,h,,g,f,L,w]=Ae(e,z,(e=>isNaN(e)||M(e)||!0===e||!1===e||e===s?void 0:1*e),n,a),v={setMetricDefinition:(e,s,n,o,r,i,l)=>{const c=J(n)?[n,r,i,l]:ve(We,n)??ve(We,"sum");return g(e,s,((s,n,o,r,i,l)=>{const d=u(e),g=le(r);l||=M(d),s();let f=_e(d,g,r,n,c,l);k(f)||(f=void 0),f!=d&&(h(e,f),a(t,[e],f,d))}),Fe(o,1)),v},delMetricDefinition:e=>(f(e),v),getStore:r,getMetricIds:i,forEachMetric:l,hasMetric:c,getTableId:d,getMetric:u,addMetricIdsListener:L,addMetricListener:(e,s)=>n(s,t,[e]),delListener:e=>(o(e),v),destroy:w,getListenerStats:()=>({})};return se(v)})),$e=Le(),qe=Le(),Ge=Qe((e=>{const t=e.createStore,n=t(),a=t(),o=Le(),{addListener:r,callListeners:i,delListener:l}=a,[h,g,L,w,p,,,C,,b,m,V,E,k]=Ae(e,(()=>!0),z,r,i),D=(e,t,...s)=>W(s,(s=>Je(ye(ye(o,t,Le),e,De),s))),A=e=>{x(ve(o,e),(e=>{Ie(e,((e,t)=>ge(t,(t=>e.delListener(t))))),he(e)})),W([a,n],(t=>t.delTable(e)))},N=(e,t,s)=>D(t,e,t.addStartTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),P={setQueryDefinition:(t,o,r)=>{C(t,o),A(t);const i=[],l=[[null,[o,null,null,[],Le()]]],c=[],d=[],u=[];r({select:(e,t)=>{const n=J(e)?[Q(i)+s,e]:[M(t)?e:t,s=>s(e,t)];return G(i,n),{as:e=>n[0]=e}},join:(e,t,s)=>{const n=M(s)||J(t)?null:t,a=M(n)?t:s,o=[e,[e,n,J(a)?a:e=>e(a),[],Le()]];return G(l,o),{as:e=>o[0]=e}},where:(e,t,s)=>G(c,J(e)?e:M(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,a)=>{const o=[e,[e,J(t)?[t,s,n,a]:ve(We,t)??[(e,t)=>t]]];return G(d,o),{as:e=>o[0]=e}},having:(e,t)=>G(u,J(e)?e:s=>s(e)===t)});const h=Le(i);if(de(h))return P;const g=Le(l);Ie(g,((e,[,t])=>x(ve(g,t),(({3:t})=>M(e)?0:G(t,e)))));const f=Le(d);let L=n;if(de(f)&&$(u))L=a;else{N(t,L,a);const e=Le();Ie(f,((t,[s,n])=>Je(ye(e,s,De),[t,n])));const s=De();Ie(h,(t=>ce(e,t)?0:Je(s,t)));const n=Le(),o=(s,n,o,r)=>x(s,(([i,l,c,d])=>{Ie(n,((t,[s])=>{const n=ye(i,t,Le),a=ve(n,o),l=r?void 0:s;if(a!==l){const s=De([[a,l]]),r=le(n);Se(n,o,l),ge(ve(e,t),(([e,t])=>{const a=_e(d[e],r,n,s,t);d[e]=M(ke(a))?null:a}))}})),de(l)||!O(u,(e=>e((e=>d[e]))))?a.delRow(t,c):M(c)?s[2]=a.addRow(t,d):a.setRow(t,c,d)}));D(L,t,L.addRowListener(t,null,((a,r,i,l)=>{const c=[],d=[],u=Le(),h=L.hasRow(t,i);let g=!h;ge(s,(e=>{const[s,n,a]=l(t,i,e);G(c,n),G(d,a),g||=s})),Ie(e,(e=>{const[s,,n]=l(t,i,e);(g||s)&&Se(u,e,[n])})),g&&o(Ee(n,c,void 0,(([,e])=>(fe(e,i),de(e)))),u,i,1),h&&o(Ee(n,d,(()=>{const e={};return ge(s,(s=>e[s]=L.getCell(t,i,s))),[Le(),De(),void 0,e]}),(([,e])=>{Je(e,i)})),u,i)})))}N(t,e,L);const w=(s,n,a,r)=>{const i=t=>e.getCell(n,a,t);W(r,(n=>{const[a,,o,r,l]=ve(g,n),c=o?.(i,s),[d,u]=ve(l,s)??[];c!=d&&(M(u)||k(t,u),Se(l,s,M(c)?null:[c,...E(t,1,e.addRowListener(a,c,(()=>w(s,a,c,r))))]))})),(s=>{const n=(t,n)=>e.getCell(...M(n)?[o,s,t]:t===o?[o,s,n]:[ve(g,t)?.[0],ve(ve(g,t)?.[4],s)?.[0],n]);L.transaction((()=>O(c,(e=>e(n)))?Ie(h,((e,a)=>Me(L,t,s,e,a(n,s)))):L.delRow(t,s)))})(s)},{3:v}=ve(g,null);return L.transaction((()=>E(t,1,e.addRowListener(o,null,((s,n,a)=>{e.hasRow(o,a)?w(a,o,a,v):(L.delRow(t,a),ge(g,(({4:e})=>x(ve(e,a),(([,s])=>{k(t,s),Se(e,a)})))))}))))),P},delQueryDefinition:e=>(A(e),b(e),P),getStore:h,getQueryIds:g,forEachQuery:L,hasQuery:w,getTableId:p,addQueryIdsListener:e=>m((()=>e(P))),delListener:e=>(l(e),P),destroy:V,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=a.getListenerStats();return n}};return re({[f]:[1,1],[f+R]:[0,1],[I]:[0,1],[S]:[0,1],[y]:[0,5],[v]:[1,2],[R]:[0,2],[T]:[1,3]},(([e,t],s)=>{W(e?["get","has","forEach"]:["get"],(e=>P[e+d+s]=(...t)=>a[e+s](...t))),P[u+d+s+c]=(...e)=>a[u+s+c](...F(e,0,t),((s,...n)=>e[t](P,...n)),!0)})),se(P)})),Ke=Qe((e=>{const t=Le(),n=Le(),a=Le(),o=Le(),[r,i,l]=Oe((()=>R)),[c,d,u,h,g,f,,,L,w,v,I]=Ae(e,(()=>[Le(),Le(),Le(),Le()]),(e=>M(e)?void 0:e+s),r,i),S=(e,t,s)=>x(f(e),(([n,,a])=>{if(!ce(a,t)){const o=De();if(g(e)!=T(e))Je(o,t);else{let e=t;for(;!M(e)&&!ce(o,e);)Je(o,e),e=ve(n,e)}if(s)return o;Se(a,t,o)}return ve(a,t)})),y=(e,t)=>x(f(e),(([,,e])=>Se(e,t))),T=e=>ve(t,e),R={setRelationshipDefinition:(e,s,r,l)=>(Se(t,e,r),L(e,s,((t,s)=>{const r=De(),l=De(),c=De(),[d,u]=f(e);ge(s,(([t,s],n)=>{M(t)||(Je(l,t),x(ve(u,t),(e=>{fe(e,n),de(e)&&Se(u,t)}))),M(s)||(Je(l,s),ce(u,s)||Se(u,s,De()),Je(ve(u,s),n)),Je(r,n),Se(d,n,s),Ie(ve(o,e),(t=>{ce(S(e,t),n)&&Je(c,t)}))})),t(),ge(r,(t=>i(n,[e,t]))),ge(l,(t=>i(a,[e,t]))),ge(c,(t=>{y(e,t),i(o,[e,t])}))}),Fe(l)),R),delRelationshipDefinition:e=>(Se(t,e),w(e),R),getStore:c,getRelationshipIds:d,forEachRelationship:t=>u((s=>t(s,(t=>e.forEachRow(g(s),t))))),hasRelationship:h,getLocalTableId:g,getRemoteTableId:T,getRemoteRowId:(e,t)=>ve(f(e)?.[0],t),getLocalRowIds:(e,t)=>ue(ve(f(e)?.[1],t)),getLinkedRowIds:(e,t)=>M(f(e))?[t]:ue(S(e,t,!0)),addRelationshipIdsListener:v,addRemoteRowIdListener:(e,t,s)=>r(s,n,[e,t]),addLocalRowIdsListener:(e,t,s)=>r(s,a,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(S(e,t),r(s,o,[e,t])),delListener:e=>(y(...l(e)??[]),R),destroy:I,getListenerStats:()=>({})};return se(R)})),Ue=e=>[e,e],Xe=()=>[Le(),Le()],Ye=e=>[...e],Ze=([e,t])=>e===t,et=e=>JSON.stringify(e,((e,t)=>t instanceof Map?X.fromEntries([...t]):t)),tt=JSON.parse,st=(e,t,s)=>M(e)||!ne(e)||ie(e)||te(e)?(s?.(),!1):(re(e,((s,n)=>{t(s,n)||oe(e,n)})),!ie(e)),nt=(e,t,s)=>Se(e,t,ve(e,t)==-s?void 0:s),at=()=>{let e,t,s=!1,n=!1,a=!1,r=!1,d=0;const g=Le(),y=Le(),V=Le(),E=Le(),k=Le(),A=Le(),Q=Le(),z=Le(),O=Le(),j=Le(),H=Le(),$=Le(),q=Le(),K=Le(),U=De(),X=Le(),Y=Le(),Z=Le(),ee=Le(),te=Xe(),ne=Xe(),ue=Xe(),Ee=Xe(),Ae=Xe(),Fe=Xe(),Qe=Xe(),ze=Xe(),Pe=Xe(),Be=Xe(),We=Xe(),_e=Xe(),He=Xe(),$e=Xe(),qe=Xe(),Ge=Xe(),Ke=Xe(),ot=Xe(),rt=Xe(),it=Xe(),lt=Xe(),ct=Xe(),dt=Le(),ut=Xe(),[ht,gt,ft,Lt]=Oe((()=>zs)),wt=e=>{if(!st(e,((e,t)=>N([i,l],t))))return!1;const t=e[i];return!(!D(t)&&t!=o||(ke(e[l])!=t&&oe(e,l),0))},vt=(t,s)=>(!e||ce(H,s)||qt(s))&&st(t,((e,t)=>It(s,t,e)),(()=>qt(s))),It=(e,t,s,n)=>st(n?s:Rt(s,e,t),((n,a)=>x(St(e,t,a,n),(e=>(s[a]=e,!0)),(()=>!1))),(()=>qt(e,t))),St=(t,s,n,a)=>e?x(ve(ve(H,t),n),(e=>ke(a)!=e[i]?qt(t,s,n,a,e[l]):a),(()=>qt(t,s,n,a))):M(ke(a))?qt(t,s,n,a):a,yt=(e,t)=>st(t?e:pt(e),((t,s)=>x(Tt(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>Gt())),Tt=(e,s)=>t?x(ve(q,e),(t=>ke(s)!=t[i]?Gt(e,s,t[l]):s),(()=>Gt(e,s))):M(ke(s))?Gt(e,s):s,Rt=(e,t,s)=>(x(ve($,t),(([n,a])=>{ge(n,((t,s)=>{ae(e,s)||(e[s]=t)})),ge(a,(n=>{ae(e,n)||qt(t,s,n)}))})),e),pt=e=>(t&&(ge(K,((t,s)=>{ae(e,s)||(e[s]=t)})),ge(U,(t=>{ae(e,t)||Gt(t)}))),e),Ct=e=>Te(H,e,((e,t,s)=>{const n=Le(),a=De();Te(ye(H,t,Le),s,((e,t,s)=>{Se(e,t,s),x(s[l],(e=>Se(n,t,e)),(()=>Je(a,t)))})),Se($,t,[n,a])}),((e,t)=>{Se(H,t),Se($,t)})),bt=e=>Te(q,e,((e,t,s)=>{Se(q,t,s),x(s[l],(e=>Se(K,t,e)),(()=>Je(U,t)))}),((e,t)=>{Se(q,t),Se(K,t),fe(U,t)})),mt=e=>ie(e)?Es():ps(e),Vt=e=>Te(Z,e,((e,t,s)=>Et(t,s)),((e,t)=>zt(t))),Et=(e,t)=>Te(ye(Z,e,(()=>(jt(e,1),Se(X,e,Ne()),Se(Y,e,Le()),Le()))),t,((t,s,n)=>kt(e,t,s,n)),((t,s)=>Nt(e,t,s))),kt=(e,t,s,n,a)=>Te(ye(t,s,(()=>(Bt(e,s,1),Le()))),n,((t,n,a)=>Mt(e,s,t,n,a)),((n,o)=>Ot(e,t,s,n,o,a))),Mt=(e,t,s,n,a)=>{ce(s,n)||Wt(e,t,n,1);const o=ve(s,n);a!==o&&(_t(e,t,n,o,a),Se(s,n,a))},xt=(e,t,s,n,a)=>x(ve(t,s),(t=>Mt(e,s,t,n,a)),(()=>kt(e,t,s,Rt({[n]:a},e,s)))),Dt=e=>ie(e)?xs():Cs(e),Jt=e=>Te(ee,e,((e,t,s)=>At(t,s)),((e,t)=>Pt(t))),At=(e,t)=>{ce(ee,e)||Ht(e,1);const s=ve(ee,e);t!==s&&($t(e,s,t),Se(ee,e,t))},Ft=(e,t)=>{const[s]=ve(X,e),n=s(t);return ce(ve(Z,e),n)?Ft(e,t):n},Qt=e=>ve(Z,e)??Et(e,{}),zt=e=>Et(e,{}),Nt=(e,t,s)=>{const[,n]=ve(X,e);n(s),kt(e,t,s,{},!0)},Ot=(e,t,s,n,a,o)=>{const r=ve(ve($,e)?.[0],a);if(!M(r)&&!o)return Mt(e,s,n,a,r);const i=t=>{_t(e,s,t,ve(n,t)),Wt(e,s,t,-1),Se(n,t)};M(r)?i(a):Ie(n,i),de(n)&&(Bt(e,s,-1),de(Se(t,s))&&(jt(e,-1),Se(Z,e),Se(X,e),Se(Y,e)))},Pt=e=>{const t=ve(K,e);if(!M(t))return At(e,t);$t(e,ve(ee,e)),Ht(e,-1),Se(ee,e)},jt=(e,t)=>nt(g,e,t),Bt=(e,t,s)=>nt(ye(E,e,Le),t,s)&&Se(V,e,ye(V,e,(()=>0))+s),Wt=(e,t,s,n)=>{const a=ve(Y,e),o=ve(a,s)??0;(0==o&&1==n||1==o&&-1==n)&&nt(ye(y,e,Le),s,n),Se(a,s,o!=-n?o+n:null),nt(ye(ye(k,e,Le),t,Le),s,n)},_t=(e,t,s,n,a)=>ye(ye(ye(A,e,Le),t,Le),s,(()=>[n,0]))[1]=a,Ht=(e,t)=>nt(Q,e,t),$t=(e,t,s)=>ye(z,e,(()=>[t,0]))[1]=s,qt=(e,t,s,n,a)=>(G(ye(ye(ye(O,e,Le),t,Le),s,(()=>[])),n),a),Gt=(e,t,s)=>(G(ye(j,e,(()=>[])),t),s),Kt=(e,t,s)=>x(ve(ve(ve(A,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...Ue(hs(e,t,s))])),Ut=e=>x(ve(z,e),(([e,t])=>[!0,e,t]),(()=>[!1,...Ue(Ls(e))])),Xt=e=>de(O)||de(Ge[e])?0:ge(e?Ve(O):O,((t,s)=>ge(t,((t,n)=>ge(t,((t,a)=>gt(Ge[e],[s,n,a],t))))))),Yt=e=>de(j)||de(Ke[e])?0:ge(e?be(j):j,((t,s)=>gt(Ke[e],[s],t))),Zt=(e,t,s,n)=>{if(!de(e))return gt(t,n,(()=>Re(e))),Ie(e,((e,t)=>gt(s,[...n??[],e],1==t))),1},es=e=>{const t=ws();t!=a&&gt(te[e],void 0,t);const s=de(Be[e]),n=de(He[e])&&de($e[e])&&de(Pe[e])&&de(We[e])&&de(Fe[e])&&de(Qe[e])&&de(ze[e])&&s&&de(ue[e])&&de(Ee[e]),o=de(qe[e])&&de(_e[e])&&de(Ae[e])&&de(ne[e]);if(!n||!o){const t=e?[be(g),me(y),be(V),me(E),Ve(k),Ve(A)]:[g,y,V,E,k,A];if(!n){Zt(t[0],ue[e],Ee[e]),ge(t[1],((t,s)=>Zt(t,Fe[e],Qe[e],[s]))),ge(t[2],((t,s)=>{0!=t&&gt(ze[e],[s],ls(s))}));const n=De();ge(t[3],((t,a)=>{Zt(t,Pe[e],We[e],[a])&&!s&&(gt(Be[e],[a,null]),Je(n,a))})),s||ge(t[5],((t,s)=>{if(!ce(n,s)){const n=De();ge(t,(e=>ge(e,(([t,s],a)=>s!==t?Je(n,a):fe(e,a))))),ge(n,(t=>gt(Be[e],[s,t])))}})),ge(t[4],((t,s)=>ge(t,((t,n)=>Zt(t,He[e],$e[e],[s,n])))))}if(!o){let s;ge(t[5],((t,n)=>{let a;ge(t,((t,o)=>{let r;ge(t,(([t,i],l)=>{i!==t&&(gt(qe[e],[n,o,l],i,t,Kt),s=a=r=1)})),r&&gt(_e[e],[n,o],Kt)})),a&&gt(Ae[e],[n],Kt)})),s&&gt(ne[e],void 0,Kt)}}},ts=e=>{const t=Ts();t!=r&&gt(ot[e],void 0,t);const s=de(it[e])&&de(lt[e]),n=de(ct[e])&&de(rt[e]);if(!s||!n){const t=e?[be(Q),be(z)]:[Q,z];if(s||Zt(t[0],it[e],lt[e]),!n){let s;ge(t[1],(([t,n],a)=>{n!==t&&(gt(ct[e],[a],n,t,Ut),s=1)})),s&&gt(rt[e],void 0,Ut)}}},ss=(e,...t)=>(As((()=>e(..._(t,m)))),zs),ns=()=>[Re(A,((e,t)=>-1===ve(g,t)?null:Re(e,((e,s)=>-1===ve(ve(E,t),s)?null:Re(e,(([,e])=>e??null),((e,t)=>Ze(t)))),ie)),ie),Re(z,(([,e])=>e??null),((e,t)=>Ze(t)))],as=()=>({cellsTouched:s,valuesTouched:n,changedCells:Ce(A,Ye,Ze),invalidCells:Ce(O),changedValues:Re(z,Ye,Ze),invalidValues:Re(j),changedTableIds:Re(g),changedRowIds:pe(E),changedCellIds:Ce(k),changedValueIds:Re(Q)}),os=()=>Ce(Z),rs=()=>we(Z),is=e=>we(ve(Y,m(e))),ls=e=>le(ve(Z,m(e))),cs=e=>we(ve(Z,m(e))),ds=(e,t,s,n=0,a)=>{return _(F(B((o=ve(Z,m(e)),r=(e,s)=>[M(t)?s:ve(e,m(t)),s],_([...o?.entries()??[]],(([e,t])=>r(t,e)))),(([e],[t])=>je(e,t)*(s?-1:1))),n,M(a)?a:n+a),(([,e])=>e));var o,r},us=(e,t)=>we(ve(ve(Z,m(e)),m(t))),hs=(e,t,s)=>ve(ve(ve(Z,m(e)),m(t)),m(s)),gs=()=>Re(ee),fs=()=>we(ee),Ls=e=>ve(ee,m(e)),ws=()=>!de(Z),vs=e=>ce(Z,m(e)),Is=(e,t)=>ce(ve(Y,m(e)),m(t)),Ss=(e,t)=>ce(ve(Z,m(e)),m(t)),ys=(e,t,s)=>ce(ve(ve(Z,m(e)),m(t)),m(s)),Ts=()=>!de(ee),Rs=e=>ce(ee,m(e)),ps=e=>ss((()=>(e=>st(e,vt,qt))(e)?Vt(e):0)),Cs=e=>ss((()=>yt(e)?Jt(e):0)),bs=e=>{try{mt(tt(e))}catch{}return zs},ms=t=>ss((()=>{if((e=st(t,(e=>st(e,wt))))&&(Ct(t),!de(Z))){const e=os();Es(),ps(e)}})),Vs=e=>ss((()=>{if(t=(e=>st(e,wt))(e)){const s=gs();Js(),xs(),t=!0,bt(e),Cs(s)}})),Es=()=>ss((()=>Vt({}))),ks=e=>ss((e=>ce(Z,e)?zt(e):0),e),Ms=(e,t)=>ss(((e,t)=>x(ve(Z,e),(s=>ce(s,t)?Nt(e,s,t):0))),e,t),xs=()=>ss((()=>Jt({}))),Ds=()=>ss((()=>{Ct({}),e=!1})),Js=()=>ss((()=>{bt({}),t=!1})),As=(e,t)=>{if(-1!=d){Fs();const s=e();return Qs(t),s}},Fs=()=>(-1!=d&&d++,1==d&&gt(dt,void 0,ns,as),zs),Qs=e=>(d>0&&(d--,0==d&&(s=!de(A),n=!de(z),d=1,Xt(1),s&&es(1),Yt(1),n&&ts(1),e?.(ns,as)&&(ge(A,((e,t)=>ge(e,((e,s)=>ge(e,(([e],n)=>Me(zs,t,s,n,e))))))),ge(z,(([e],t)=>xe(zs,t,e))),s=n=!1),gt(ut[0],void 0,ns,as),d=-1,Xt(0),s&&es(0),Yt(0),n&&ts(0),gt(ut[1],void 0,ns,as),d=0,s=n=!1,a=ws(),r=Ts(),W([g,y,V,E,k,A,O,Q,z,j],he))),zs),zs={getContent:()=>[os(),gs()],getTables:os,getTableIds:rs,getTable:e=>pe(ve(Z,m(e))),getTableCellIds:is,getRowCount:ls,getRowIds:cs,getSortedRowIds:ds,getRow:(e,t)=>Re(ve(ve(Z,m(e)),m(t))),getCellIds:us,getCell:hs,getValues:gs,getValueIds:fs,getValue:Ls,hasTables:ws,hasTable:vs,hasTableCell:Is,hasRow:Ss,hasCell:ys,hasValues:Ts,hasValue:Rs,getTablesJson:()=>et(Z),getValuesJson:()=>et(ee),getJson:()=>et([Z,ee]),getTablesSchemaJson:()=>et(H),getValuesSchemaJson:()=>et(q),getSchemaJson:()=>et([H,q]),hasTablesSchema:()=>e,hasValuesSchema:()=>t,setContent:([e,t])=>ss((()=>{(ie(e)?Es:ps)(e),(ie(t)?xs:Cs)(t)})),setTables:ps,setTable:(e,t)=>ss((e=>vt(t,e)?Et(e,t):0),e),setRow:(e,t,s)=>ss(((e,t)=>It(e,t,s)?kt(e,Qt(e),t,s):0),e,t),addRow:(e,t,s=!0)=>As((()=>{let n;return It(e,n,t)&&(e=m(e),kt(e,Qt(e),n=Ft(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>ss(((e,t)=>{if(It(e,t,s,1)){const n=Qt(e);re(s,((s,a)=>xt(e,n,t,a,s)))}}),e,t),setCell:(e,t,s,n)=>ss(((e,t,s)=>x(St(e,t,s,J(n)?n(hs(e,t,s)):n),(n=>xt(e,Qt(e),t,s,n)))),e,t,s),setValues:Cs,setPartialValues:e=>ss((()=>yt(e,1)?re(e,((e,t)=>At(t,e))):0)),setValue:(e,t)=>ss((e=>x(Tt(e,J(t)?t(Ls(e)):t),(t=>At(e,t)))),e),setTransactionChanges:e=>ss((()=>{re(e[0],((e,t)=>M(e)?ks(t):re(e,((e,s)=>M(e)?Ms(t,s):re(e,((e,n)=>Me(zs,t,s,n,e))))))),re(e[1],((e,t)=>xe(zs,t,e)))})),setTablesJson:bs,setValuesJson:e=>{try{Dt(tt(e))}catch{}return zs},setJson:e=>ss((()=>{try{const[t,s]=tt(e);mt(t),Dt(s)}catch{bs(e)}})),setTablesSchema:ms,setValuesSchema:Vs,setSchema:(e,t)=>ss((()=>{ms(e),Vs(t)})),delTables:Es,delTable:ks,delRow:Ms,delCell:(e,t,s,n)=>ss(((e,t,s)=>x(ve(Z,e),(a=>x(ve(a,t),(o=>ce(o,s)?Ot(e,a,t,o,s,n):0))))),e,t,s),delValues:xs,delValue:e=>ss((e=>ce(ee,e)?Pt(e):0),e),delTablesSchema:Ds,delValuesSchema:Js,delSchema:()=>ss((()=>{Ds(),Js()})),transaction:As,startTransaction:Fs,finishTransaction:Qs,forEachTable:e=>ge(Z,((t,s)=>e(s,(e=>ge(t,((t,s)=>e(s,(e=>Ie(t,e))))))))),forEachTableCell:(e,t)=>Ie(ve(Y,m(e)),t),forEachRow:(e,t)=>ge(ve(Z,m(e)),((e,s)=>t(s,(t=>Ie(e,t))))),forEachCell:(e,t,s)=>Ie(ve(ve(Z,m(e)),m(t)),s),forEachValue:e=>Ie(ee,e),addSortedRowIdsListener:(e,t,s,n,a,o,r)=>{let i=ds(e,t,s,n,a);return ht((()=>{const r=ds(e,t,s,n,a);P(r,i)||(i=r,o(zs,e,t,s,n,a,i))}),Be[r?1:0],[e,t],[rs])},addStartTransactionListener:e=>ht(e,dt),addWillFinishTransactionListener:e=>ht(e,ut[0]),addDidFinishTransactionListener:e=>ht(e,ut[1]),callListener:e=>(Lt(e),zs),delListener:e=>(ft(e),zs),getListenerStats:()=>({}),createStore:at,addListener:ht,callListeners:gt};return re({[h+L]:[0,te,[],()=>[ws()]],[L]:[0,ne],[w]:[0,ue],[h+f]:[1,Ee,[rs],e=>[vs(...e)]],[f]:[1,Ae,[rs]],[f+R]:[1,Fe,[rs]],[h+f+T]:[2,Qe,[rs,is],e=>[Is(...e)]],[I]:[1,ze,[rs]],[S]:[1,Pe,[rs]],[h+v]:[2,We,[rs,cs],e=>[Ss(...e)]],[v]:[2,_e,[rs,cs]],[R]:[2,He,[rs,cs]],[h+T]:[3,$e,[rs,cs,us],e=>[ys(...e)]],[T]:[3,qe,[rs,cs,us],e=>Ue(hs(...e))],InvalidCell:[3,Ge],[h+C]:[0,ot,[],()=>[Ts()]],[C]:[0,rt],[b]:[0,it],[h+p]:[1,lt,[fs],e=>[Rs(...e)]],[p]:[1,ct,[fs],e=>Ue(Ls(e[0]))],InvalidValue:[1,Ke]},(([e,t,s,n],a)=>{zs[u+a+c]=(...a)=>ht(a[e],t[a[e+1]?1:0],e>0?F(a,0,e):void 0,s,n)})),se(zs)};e.createCheckpoints=Pe,e.createCustomPersister=(e,t,s,n,a,o,[r,i]=[],l=[])=>{let c,d,u,h=0,g=0;ye($e,l,(()=>0)),ye(qe,l,(()=>[]));const f=async e=>(2!=h&&(h=1,await L.schedule((async()=>{await e(),h=0}))),L),L={load:async(s,n)=>await f((async()=>{try{e.setContent(await t())}catch{e.setContent([s,n])}})),startAutoLoad:async(s={},a={})=>(L.stopAutoLoad(),await L.load(s,a),g=1,u=n((async(s,n)=>{if(n){const t=n();await f((async()=>e.setTransactionChanges(t)))}else await f((async()=>{try{e.setContent(s?.()??await t())}catch(e){o?.(e)}}))})),L),stopAutoLoad:()=>(g&&(a(u),u=void 0,g=0),L),save:async t=>(1!=h&&(h=2,await L.schedule((async()=>{try{await s(e.getContent,t)}catch(e){o?.(e)}h=0}))),L),startAutoSave:async()=>(await L.stopAutoSave().save(),c=e.addDidFinishTransactionListener(((e,t)=>{const[s,n]=t();ie(s)&&ie(n)||L.save((()=>[s,n]))})),L),stopAutoSave:()=>(x(c,e.delListener),c=void 0,L),schedule:async(...e)=>(G(ve(qe,l),...e),await(async()=>{if(!ve($e,l)){for(Se($e,l,1);!M(d=U(ve(qe,l)));)try{await d()}catch(e){o?.(e)}Se($e,l,0)}})(),L),getStore:()=>e,destroy:()=>L.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return r&&(L[r]=()=>i),se(L)},e.createIndexes=Be,e.createMetrics=He,e.createQueries=Ge,e.createRelationships=Ke,e.createStore=at,e.defaultSorter=je},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={});
