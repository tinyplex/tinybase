var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",n=t(s),a=t(!0),o=t(0),r=t(t),l="type",i="default",c="Listener",d="Result",u="add",h="Has",g="Ids",f="Table",L=f+"s",w=f+g,C="Row",p=C+"Count",y=C+g,T="Sorted"+C+g,v="Cell",S=v+g,I="Value",R=I+"s",b=I+g,m=e=>s+e,V=(e,t)=>e.startsWith(t),M=(e,t)=>e.endsWith(t),E=(e,t=0)=>e.charCodeAt(t),k=Math.max,x=Math.min,D=isFinite,A=e=>null==e,J=(e,t,s)=>A(e)?s?.():t(e),F=e=>e==n||e==a,Q=e=>t(e)==n,H=e=>t(e)==r,P=e=>Array.isArray(e),z=(e,t,s)=>e.slice(t,s),N=e=>e.length,O=()=>{},W=(e,t)=>e.includes(t),j=(e,t)=>e.every(t),B=(e,t)=>N(e)===N(t)&&j(e,((e,s)=>t[s]===e)),_=(e,t)=>j(e,((s,n)=>0==n||t(e[n-1],s)<=0)),$=(e,t)=>e.sort(t),q=(e,t)=>e.forEach(t),G=(e,t)=>e.map(t),K=e=>X(e,((e,t)=>e+t),0),U=e=>0==N(e),X=(e,t,s)=>e.reduce(t,s),Y=(e,...t)=>e.push(...t),Z=e=>e.pop(),ee=e=>e.shift(),te=Object,se=e=>te.getPrototypeOf(e),ne=te.entries,ae=te.keys,oe=te.isFrozen,re=te.freeze,le=e=>!A(e)&&J(se(e),(e=>e==te.prototype||A(se(e))),(()=>!0)),ie=(e,t)=>t in e,ce=(e,t)=>(delete e[t],e),de=(e,t)=>q(ne(e),(([e,s])=>t(s,e))),ue=(e,t)=>G(ne(e),(([e,s])=>t(s,e))),he=e=>le(e)&&0==(e=>N(ae(e)))(e),ge=e=>e?.size??0,fe=(e,t)=>e?.has(t)??!1,Le=e=>A(e)||0==ge(e),we=e=>[...e?.values()??[]],Ce=e=>e.clear(),pe=(e,t)=>e?.forEach(t),ye=(e,t)=>e?.delete(t),Te=e=>new Map(e),ve=e=>[...e?.keys()??[]],Se=(e,t)=>e?.get(t),Ie=(e,t)=>pe(e,((e,s)=>t(s,e))),Re=(e,t,s)=>A(s)?(ye(e,t),e):e?.set(t,s),be=(e,t,s)=>(fe(e,t)||Re(e,t,s()),Se(e,t)),me=(e,t,s,n=Re)=>(ue(t,((t,n)=>s(e,n,t))),Ie(e,(s=>ie(t,s)?0:n(e,s))),e),Ve=(e,t,s)=>{const n={};return pe(e,((e,a)=>{const o=t?t(e,a):e;!s?.(o,e)&&(n[a]=o)})),n},Me=(e,t,s)=>Ve(e,(e=>Ve(e,t,s)),he),Ee=(e,t,s)=>Ve(e,(e=>Me(e,t,s)),he),ke=(e,t)=>{const s=Te();return pe(e,((e,n)=>s.set(n,t?.(e)??e))),s},xe=e=>ke(e,ke),De=e=>ke(e,xe),Ae=(e,t,s,n,a=0)=>J((s?be:Se)(e,t[a],a>N(t)-2?s:Te),(o=>{if(a>N(t)-2)return n?.(o)&&Re(e,t[a]),o;const r=Ae(o,t,s,n,a+1);return Le(o)&&Re(e,t[a]),r})),Je=e=>{const s=t(e);return F(s)||s==o&&D(e)?s:void 0},Fe=(e,t,s,n,a)=>A(a)?e.delCell(t,s,n,!0):e.setCell(t,s,n,a),Qe=(e,t,s)=>A(s)?e.delValue(t):e.setValue(t,s),He=e=>new Set(P(e)||A(e)?e:[e]),Pe=(e,t)=>e?.add(t),ze=(e,t,s,n,a)=>{const o=e.hasRow,r=Te(),l=Te(),i=Te(),c=Te(),d=Te(),u=Te(),h=(t,s,...n)=>{const a=be(u,t,He);return q(n,(t=>Pe(a,t)&&s&&e.callListener(t))),n},g=(t,...s)=>J(Se(u,t),(n=>{q(U(s)?we(n):s,(t=>{e.delListener(t),ye(n,t)})),Le(n)&&Re(u,t)})),f=(e,s)=>{Re(r,e,s),fe(l,e)||(Re(l,e,t()),Re(c,e,Te()),Re(d,e,Te()),a(i))},L=e=>{Re(r,e),Re(l,e),Re(c,e),Re(d,e),g(e),a(i)};return[()=>e,()=>ve(r),e=>Ie(l,e),e=>fe(l,e),e=>Se(r,e),e=>Se(l,e),(e,t)=>Re(l,e,t),f,(t,n,a,r,l)=>{f(t,n);const i=Te(),u=Te(),L=Se(c,t),w=Se(d,t),C=t=>{const a=s=>e.getCell(n,t,s),c=Se(L,t),d=o(n,t)?s(r(a,t)):void 0;if(c===d||P(c)&&P(d)&&B(c,d)||Re(i,t,[c,d]),!A(l)){const e=Se(w,t),s=o(n,t)?l(a,t):void 0;e!=s&&Re(u,t,s)}},p=e=>{a((()=>{pe(i,(([,e],t)=>Re(L,t,e))),pe(u,((e,t)=>Re(w,t,e)))}),i,u,L,w,e),Ce(i),Ce(u)};Ie(L,C),e.hasTable(n)&&q(e.getRowIds(n),(e=>{fe(L,e)||C(e)})),p(!0),g(t),h(t,0,e.addRowListener(n,null,((e,t,s)=>C(s))),e.addTableListener(n,(()=>p())))},L,e=>n(e,i),()=>Ie(u,L),h,g]},Ne=(e,t)=>Q(e)?t=>t(e):e??(()=>t??s),Oe=(e,t)=>{const s=new WeakMap;return n=>{s.has(n)||s.set(n,e(n));const a=s.get(n);return t?.(a),a}},We=/^\d+$/,je=()=>{const e=[];let t=0;return[n=>(n?ee(e):null)??s+t++,t=>{We.test(t)&&N(e)<1e3&&Y(e,t)}]},Be=e=>{let t;const[n,a]=je(),o=Te();return[(a,r,l,i=[],c=(()=>[]))=>{t??=e();const d=n(1);return Re(o,d,[a,r,l,i,c]),Pe(Ae(r,l??[s],He),d),d},(e,n,...a)=>q(((e,t=[s])=>{const n=[],a=(e,s)=>s==N(t)?Y(n,e):null===t[s]?pe(e,(e=>a(e,s+1))):q([t[s],null],(t=>a(Se(e,t),s+1)));return a(e,0),n})(e,n),(e=>pe(e,(e=>Se(o,e)[0](t,...n??[],...a))))),e=>J(Se(o,e),(([,t,n])=>(Ae(t,n??[s],void 0,(t=>(ye(t,e),Le(t)?1:0))),Re(o,e),a(e),n))),e=>J(Se(o,e),(([e,,s=[],n,a])=>{const o=(...r)=>{const l=N(r);l==N(s)?e(t,...r,...a(r)):A(s[l])?q(n[l]?.(...r)??[],(e=>o(...r,e))):o(...r,s[l])};o()}))]},_e=Oe((e=>{let t,n,a,o=100,r=Te(),l=Te(),i=1;const c=Te(),d=Te(),[u,h,g]=Be((()=>F)),f=Te(),L=Te(),w=[],C=[],p=(t,s)=>{i=0,e.transaction((()=>{const[n,a]=Se(f,s);pe(n,((s,n)=>pe(s,((s,a)=>pe(s,((s,o)=>Fe(e,n,a,o,s[t]))))))),pe(a,((s,n)=>Qe(e,n,s[t])))})),i=1},y=e=>{Re(f,e),Re(L,e),h(d,[e])},T=(e,t)=>q(((e,t)=>e.splice(0,t))(e,t??N(e)),y),v=()=>T(w,N(w)-o),S=()=>J(t,(()=>{Y(w,t),v(),T(C),t=void 0,a=1})),I=()=>{t=Z(w),a=1};let R,b;const m=(e="")=>(A(t)&&(t=s+n++,Re(f,t,[r,l]),x(t,e),r=Te(),l=Te(),a=1),t),V=()=>{U(w)||(((e,...t)=>{e.unshift(...t)})(C,m()),p(0,t),t=Z(w),a=1)},M=()=>{U(C)||(Y(w,t),t=ee(C),p(1,t),a=1)},E=()=>{a&&(h(c),a=0)},k=e=>{const t=m(e);return E(),t},x=(e,t)=>(D(e)&&Se(L,e)!==t&&(Re(L,e,t),h(d,[e])),F),D=e=>fe(f,e),F={setSize:e=>(o=e,v(),F),addCheckpoint:k,setCheckpoint:x,getStore:()=>e,getCheckpointIds:()=>[[...w],t,[...C]],forEachCheckpoint:e=>Ie(L,e),hasCheckpoint:D,getCheckpoint:e=>Se(L,e),goBackward:()=>(V(),E(),F),goForward:()=>(M(),E(),F),goTo:e=>{const s=W(w,e)?V:W(C,e)?M:null;for(;!A(s)&&e!=t;)s();return E(),F},addCheckpointIdsListener:e=>u(e,c),addCheckpointListener:(e,t)=>u(t,d,[e]),delListener:e=>(g(e),F),clear:()=>(T(w),T(C),A(t)||y(t),t=void 0,n=0,k(),F),clearForward:()=>(U(C)||(T(C),h(c)),F),destroy:()=>{e.delListener(R),e.delListener(b)},getListenerStats:()=>({}),_registerListeners:()=>{R=e.addCellListener(null,null,null,((e,t,s,n,a,o)=>{if(i){S();const e=be(r,t,Te),l=be(e,s,Te),i=be(l,n,(()=>[o,void 0]));i[1]=a,i[0]===a&&Le(Re(l,n))&&Le(Re(e,s))&&Le(Re(r,t))&&I(),E()}})),b=e.addValueListener(null,((e,t,s,n)=>{if(i){S();const e=be(l,t,(()=>[n,void 0]));e[1]=s,e[0]===s&&Le(Re(l,t))&&I(),E()}}))}};return re(F.clear())}),(e=>e._registerListeners())),$e=(e,t)=>(e??0)<(t??0)?-1:1,qe=Oe((e=>{const t=Te(),n=Te(),[a,o,r]=Be((()=>y)),[l,i,c,d,u,h,g,,f,L,w,C]=ze(e,Te,(e=>A(e)?s:P(e)?G(e,m):m(e)),a,o),p=(t,s,n)=>{const a=u(t);pe(n,((t,n)=>s(n,(s=>pe(t,(t=>s(t,(s=>e.forEachCell(a,t,s)))))))))},y={setIndexDefinition:(e,s,a,r,l,i=$e)=>{const c=A(l)?void 0:([e],[t])=>l(e,t);return f(e,s,((s,a,l,d,u,f)=>{let L=0;const w=He(),C=He(),p=h(e);if(pe(a,(([e,t],s)=>{const n=He(e),a=He(t);pe(n,(e=>ye(a,e)?ye(n,e):0)),pe(n,(e=>{Pe(w,e),J(Se(p,e),(t=>{ye(t,s),Le(t)&&(Re(p,e),L=1)}))})),pe(a,(e=>{Pe(w,e),fe(p,e)||(Re(p,e,He()),L=1),Pe(Se(p,e),s),A(r)||Pe(C,e)}))})),s(),Le(u)||(f?Ie(p,(e=>Pe(C,e))):Ie(l,(e=>J(Se(d,e),(e=>Pe(C,e))))),pe(C,(e=>{const t=(t,s)=>i(Se(u,t),Se(u,s),e),s=[...Se(p,e)];_(s,t)||(Re(p,e,He($(s,t))),Pe(w,e))}))),(L||f)&&!A(c)){const t=[...p];_(t,c)||(g(e,Te($(t,c))),L=1)}L&&o(t,[e]),pe(w,(t=>o(n,[e,t])))}),Ne(a),J(r,Ne)),y},delIndexDefinition:e=>(L(e),y),getStore:l,getIndexIds:i,forEachIndex:e=>c(((t,s)=>e(t,(e=>p(t,e,s))))),forEachSlice:(e,t)=>p(e,t,h(e)),hasIndex:d,hasSlice:(e,t)=>fe(h(e),t),getTableId:u,getSliceIds:e=>ve(h(e)),getSliceRowIds:(e,t)=>we(Se(h(e),t)),addIndexIdsListener:w,addSliceIdsListener:(e,s)=>a(s,t,[e]),addSliceRowIdsListener:(e,t,s)=>a(s,n,[e,t]),delListener:e=>(r(e),y),destroy:C,getListenerStats:()=>({})};return re(y)})),Ge=Te([["avg",[(e,t)=>K(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>k(...e),(e,t)=>k(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:k(t,e)]],["min",[e=>x(...e),(e,t)=>x(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:x(t,e)]],["sum",[e=>K(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),Ke=(e,t,s,n,a,o=!1)=>{if(Le(s))return;const[r,l,i,c]=a;return o||=A(e),pe(n,(([s,n])=>{o||(e=A(s)?l?.(e,n,t++):A(n)?i?.(e,s,t--):c?.(e,n,s,t),o||=A(e))})),o?r(we(s),ge(s)):e},Ue=Oe((e=>{const t=Te(),[n,a,o]=Be((()=>C)),[r,l,i,c,d,u,h,,g,f,L,w]=ze(e,O,(e=>isNaN(e)||A(e)||!0===e||!1===e||e===s?void 0:1*e),n,a),C={setMetricDefinition:(e,s,n,o,r,l,i)=>{const c=H(n)?[n,r,l,i]:Se(Ge,n)??Se(Ge,"sum");return g(e,s,((s,n,o,r,l,i)=>{const d=u(e),g=ge(r);i||=A(d),s();let f=Ke(d,g,r,n,c,i);D(f)||(f=void 0),f!=d&&(h(e,f),a(t,[e],f,d))}),Ne(o,1)),C},delMetricDefinition:e=>(f(e),C),getStore:r,getMetricIds:l,forEachMetric:i,hasMetric:c,getTableId:d,getMetric:u,addMetricIdsListener:L,addMetricListener:(e,s)=>n(s,t,[e]),delListener:e=>(o(e),C),destroy:w,getListenerStats:()=>({})};return re(C)})),Xe=Te(),Ye=Te(),Ze=Oe((e=>{const t=e.createStore,n=t(),a=t(),o=Te(),{addListener:r,callListeners:l,delListener:i}=a,[h,g,L,w,I,,,R,,b,m,V,M,E]=ze(e,(()=>!0),O,r,l),k=(e,t,...s)=>q(s,(s=>Pe(be(be(o,t,Te),e,He),s))),x=e=>{J(Se(o,e),(e=>{Ie(e,((e,t)=>pe(t,(t=>e.delListener(t))))),Ce(e)})),q([a,n],(t=>t.delTable(e)))},D=(e,t,s)=>k(t,e,t.addStartTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),F={setQueryDefinition:(t,o,r)=>{R(t,o),x(t);const l=[],i=[[null,[o,null,null,[],Te()]]],c=[],d=[],u=[];r({select:(e,t)=>{const n=H(e)?[N(l)+s,e]:[A(t)?e:t,s=>s(e,t)];return Y(l,n),{as:e=>n[0]=e}},join:(e,t,s)=>{const n=A(s)||H(t)?null:t,a=A(n)?t:s,o=[e,[e,n,H(a)?a:e=>e(a),[],Te()]];return Y(i,o),{as:e=>o[0]=e}},where:(e,t,s)=>Y(c,H(e)?e:A(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,a)=>{const o=[e,[e,H(t)?[t,s,n,a]:Se(Ge,t)??[(e,t)=>t]]];return Y(d,o),{as:e=>o[0]=e}},having:(e,t)=>Y(u,H(e)?e:s=>s(e)===t)});const h=Te(l);if(Le(h))return F;const g=Te(i);Ie(g,((e,[,t])=>J(Se(g,t),(({3:t})=>A(e)?0:Y(t,e)))));const f=Te(d);let L=n;if(Le(f)&&U(u))L=a;else{D(t,L,a);const e=Te();Ie(f,((t,[s,n])=>Pe(be(e,s,He),[t,n])));const s=He();Ie(h,(t=>fe(e,t)?0:Pe(s,t)));const n=Te(),o=(s,n,o,r)=>J(s,(([l,i,c,d])=>{Ie(n,((t,[s])=>{const n=be(l,t,Te),a=Se(n,o),i=r?void 0:s;if(a!==i){const s=He([[a,i]]),r=ge(n);Re(n,o,i),pe(Se(e,t),(([e,t])=>{const a=Ke(d[e],r,n,s,t);d[e]=A(Je(a))?null:a}))}})),Le(i)||!j(u,(e=>e((e=>d[e]))))?a.delRow(t,c):A(c)?s[2]=a.addRow(t,d):a.setRow(t,c,d)}));k(L,t,L.addRowListener(t,null,((a,r,l,i)=>{const c=[],d=[],u=Te(),h=L.hasRow(t,l);let g=!h;pe(s,(e=>{const[s,n,a]=i(t,l,e);Y(c,n),Y(d,a),g||=s})),Ie(e,(e=>{const[s,,n]=i(t,l,e);(g||s)&&Re(u,e,[n])})),g&&o(Ae(n,c,void 0,(([,e])=>(ye(e,l),Le(e)))),u,l,1),h&&o(Ae(n,d,(()=>{const e={};return pe(s,(s=>e[s]=L.getCell(t,l,s))),[Te(),He(),void 0,e]}),(([,e])=>{Pe(e,l)})),u,l)})))}D(t,e,L);const w=(s,n,a,r)=>{const l=t=>e.getCell(n,a,t);q(r,(n=>{const[a,,o,r,i]=Se(g,n),c=o?.(l,s),[d,u]=Se(i,s)??[];c!=d&&(A(u)||E(t,u),Re(i,s,A(c)?null:[c,...M(t,1,e.addRowListener(a,c,(()=>w(s,a,c,r))))]))})),(s=>{const n=(t,n)=>e.getCell(...A(n)?[o,s,t]:t===o?[o,s,n]:[Se(g,t)?.[0],Se(Se(g,t)?.[4],s)?.[0],n]);L.transaction((()=>j(c,(e=>e(n)))?Ie(h,((e,a)=>Fe(L,t,s,e,a(n,s)))):L.delRow(t,s)))})(s)},{3:C}=Se(g,null);return L.transaction((()=>M(t,1,e.addRowListener(o,null,((s,n,a)=>{e.hasRow(o,a)?w(a,o,a,C):(L.delRow(t,a),pe(g,(({4:e})=>J(Se(e,a),(([,s])=>{E(t,s),Re(e,a)})))))}))))),F},delQueryDefinition:e=>(x(e),b(e),F),getStore:h,getQueryIds:g,forEachQuery:L,hasQuery:w,getTableId:I,addQueryIdsListener:e=>m((()=>e(F))),delListener:e=>(i(e),F),destroy:V,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=a.getListenerStats();return n}};return ue({[f]:[1,1],[f+S]:[0,1],[p]:[0,1],[y]:[0,1],[T]:[0,5],[C]:[1,2],[S]:[0,2],[v]:[1,3]},(([e,t],s)=>{q(e?["get","has","forEach"]:["get"],(e=>F[e+d+s]=(...t)=>a[e+s](...t))),F[u+d+s+c]=(...e)=>a[u+s+c](...z(e,0,t),((s,...n)=>e[t](F,...n)),!0)})),re(F)})),et=Oe((e=>{const t=Te(),n=Te(),a=Te(),o=Te(),[r,l,i]=Be((()=>S)),[c,d,u,h,g,f,,,L,w,C,p]=ze(e,(()=>[Te(),Te(),Te(),Te()]),(e=>A(e)?void 0:e+s),r,l),y=(e,t,s)=>J(f(e),(([n,,a])=>{if(!fe(a,t)){const o=He();if(g(e)!=v(e))Pe(o,t);else{let e=t;for(;!A(e)&&!fe(o,e);)Pe(o,e),e=Se(n,e)}if(s)return o;Re(a,t,o)}return Se(a,t)})),T=(e,t)=>J(f(e),(([,,e])=>Re(e,t))),v=e=>Se(t,e),S={setRelationshipDefinition:(e,s,r,i)=>(Re(t,e,r),L(e,s,((t,s)=>{const r=He(),i=He(),c=He(),[d,u]=f(e);pe(s,(([t,s],n)=>{A(t)||(Pe(i,t),J(Se(u,t),(e=>{ye(e,n),Le(e)&&Re(u,t)}))),A(s)||(Pe(i,s),fe(u,s)||Re(u,s,He()),Pe(Se(u,s),n)),Pe(r,n),Re(d,n,s),Ie(Se(o,e),(t=>{fe(y(e,t),n)&&Pe(c,t)}))})),t(),pe(r,(t=>l(n,[e,t]))),pe(i,(t=>l(a,[e,t]))),pe(c,(t=>{T(e,t),l(o,[e,t])}))}),Ne(i)),S),delRelationshipDefinition:e=>(Re(t,e),w(e),S),getStore:c,getRelationshipIds:d,forEachRelationship:t=>u((s=>t(s,(t=>e.forEachRow(g(s),t))))),hasRelationship:h,getLocalTableId:g,getRemoteTableId:v,getRemoteRowId:(e,t)=>Se(f(e)?.[0],t),getLocalRowIds:(e,t)=>we(Se(f(e)?.[1],t)),getLinkedRowIds:(e,t)=>A(f(e))?[t]:we(y(e,t,!0)),addRelationshipIdsListener:C,addRemoteRowIdListener:(e,t,s)=>r(s,n,[e,t]),addLocalRowIdsListener:(e,t,s)=>r(s,a,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(y(e,t),r(s,o,[e,t])),delListener:e=>(T(...i(e)??[]),S),destroy:p,getListenerStats:()=>({})};return re(S)})),tt=()=>[s,void 0],st=()=>[s,Te()],nt=([e,t],s)=>[e,s(t,e)],at=(e,t)=>nt(e,(e=>Ve(e,t))),ot=(e,t,s,n)=>de(e,((e,a)=>rt(e,be(t,a,st),s[a]=((e=[])=>te.fromEntries(e))(),n))),rt=([e,t],s,n,a)=>{e>s[0]&&(s[0]=e),a(t,s[1],n)},lt=(e,t,s)=>de(e,(([e,n],a)=>{const o=be(t,a,tt);e>o[0]&&(o[0]=e,o[1]=s[a]=n)})),it=e=>[e,e],ct=()=>[Te(),Te()],dt=e=>[...e],ut=([e,t])=>e===t,ht=e=>JSON.stringify(e,((e,t)=>t instanceof Map?te.fromEntries([...t]):t)),gt=JSON.parse,ft=(e,t,s)=>A(e)||!le(e)||he(e)||oe(e)?(s?.(),!1):(ue(e,((s,n)=>{t(s,n)||ce(e,n)})),!he(e)),Lt=(e,t,s)=>Re(e,t,Se(e,t)==-s?void 0:s),wt=()=>{let e,t,s,n=!1,a=!1,r=!1,d=!1,g=0;const T=Te(),V=Te(),M=Te(),E=Te(),k=Te(),x=Te(),D=Te(),Q=Te(),P=Te(),N=Te(),O=Te(),j=Te(),_=Te(),K=Te(),U=He(),X=Te(),Z=Te(),ee=Te(),te=Te(),se=ct(),ne=ct(),ae=ct(),oe=ct(),le=ct(),de=ct(),we=ct(),Ae=ct(),ze=ct(),Ne=ct(),Oe=ct(),We=ct(),_e=ct(),qe=ct(),Ge=ct(),Ke=ct(),Ue=ct(),Xe=ct(),Ye=ct(),Ze=ct(),et=ct(),tt=ct(),st=Te(),nt=ct(),[at,ot,rt,lt]=Be((()=>Qs)),Ct=e=>{if(!ft(e,((e,t)=>W([l,i],t))))return!1;const t=e[l];return!(!F(t)&&t!=o||(Je(e[i])!=t&&ce(e,i),0))},pt=(t,s)=>(!e||fe(O,s)||Gt(s))&&ft(t,((e,t)=>yt(s,t,e)),(()=>Gt(s))),yt=(e,t,s,n)=>ft(n?s:It(s,e,t),((n,a)=>J(Tt(e,t,a,n),(e=>(s[a]=e,!0)),(()=>!1))),(()=>Gt(e,t))),Tt=(t,s,n,a)=>e?J(Se(Se(O,t),n),(e=>Je(a)!=e[l]?Gt(t,s,n,a,e[i]):a),(()=>Gt(t,s,n,a))):A(Je(a))?Gt(t,s,n,a):a,vt=(e,t)=>ft(t?e:Rt(e),((t,s)=>J(St(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>Kt())),St=(e,s)=>t?J(Se(_,e),(t=>Je(s)!=t[l]?Kt(e,s,t[i]):s),(()=>Kt(e,s))):A(Je(s))?Kt(e,s):s,It=(e,t,s)=>(J(Se(j,t),(([n,a])=>{pe(n,((t,s)=>{ie(e,s)||(e[s]=t)})),pe(a,(n=>{ie(e,n)||Gt(t,s,n)}))})),e),Rt=e=>(t&&(pe(K,((t,s)=>{ie(e,s)||(e[s]=t)})),pe(U,(t=>{ie(e,t)||Kt(t)}))),e),bt=e=>me(O,e,((e,t,s)=>{const n=Te(),a=He();me(be(O,t,Te),s,((e,t,s)=>{Re(e,t,s),J(s[i],(e=>Re(n,t,e)),(()=>Pe(a,t)))})),Re(j,t,[n,a])}),((e,t)=>{Re(O,t),Re(j,t)})),mt=e=>me(_,e,((e,t,s)=>{Re(_,t,s),J(s[i],(e=>Re(K,t,e)),(()=>Pe(U,t)))}),((e,t)=>{Re(_,t),Re(K,t),ye(U,t)})),Vt=e=>he(e)?Vs():Ss(e),Mt=e=>me(ee,e,((e,t,s)=>Et(t,s)),((e,t)=>Pt(t))),Et=(e,t)=>me(be(ee,e,(()=>(Wt(e,1),Re(X,e,je()),Re(Z,e,Te()),Te()))),t,((t,s,n)=>kt(e,t,s,n)),((t,s)=>zt(e,t,s))),kt=(e,t,s,n,a)=>me(be(t,s,(()=>(jt(e,s,1),Te()))),n,((t,n,a)=>xt(e,s,t,n,a)),((n,o)=>Nt(e,t,s,n,o,a))),xt=(e,t,s,n,a)=>{fe(s,n)||Bt(e,t,n,1);const o=Se(s,n);a!==o&&(_t(e,t,n,o,a),Re(s,n,a))},Dt=(e,t,s,n,a)=>J(Se(t,s),(t=>xt(e,s,t,n,a)),(()=>kt(e,t,s,It({[n]:a},e,s)))),At=e=>he(e)?ks():Is(e),Jt=e=>me(te,e,((e,t,s)=>Ft(t,s)),((e,t)=>Ot(t))),Ft=(e,t)=>{fe(te,e)||$t(e,1);const s=Se(te,e);t!==s&&(qt(e,s,t),Re(te,e,t))},Qt=(e,t)=>{const[s]=Se(X,e),n=s(t);return fe(Se(ee,e),n)?Qt(e,t):n},Ht=e=>Se(ee,e)??Et(e,{}),Pt=e=>Et(e,{}),zt=(e,t,s)=>{const[,n]=Se(X,e);n(s),kt(e,t,s,{},!0)},Nt=(e,t,s,n,a,o)=>{const r=Se(Se(j,e)?.[0],a);if(!A(r)&&!o)return xt(e,s,n,a,r);const l=t=>{_t(e,s,t,Se(n,t)),Bt(e,s,t,-1),Re(n,t)};A(r)?l(a):Ie(n,l),Le(n)&&(jt(e,s,-1),Le(Re(t,s))&&(Wt(e,-1),Re(ee,e),Re(X,e),Re(Z,e)))},Ot=e=>{const t=Se(K,e);if(!A(t))return Ft(e,t);qt(e,Se(te,e)),$t(e,-1),Re(te,e)},Wt=(e,t)=>Lt(T,e,t),jt=(e,t,s)=>Lt(be(E,e,Te),t,s)&&Re(M,e,be(M,e,(()=>0))+s),Bt=(e,t,s,n)=>{const a=Se(Z,e),o=Se(a,s)??0;(0==o&&1==n||1==o&&-1==n)&&Lt(be(V,e,Te),s,n),Re(a,s,o!=-n?o+n:null),Lt(be(be(k,e,Te),t,Te),s,n)},_t=(e,t,s,n,a)=>be(be(be(x,e,Te),t,Te),s,(()=>[n,0]))[1]=a,$t=(e,t)=>Lt(D,e,t),qt=(e,t,s)=>be(Q,e,(()=>[t,0]))[1]=s,Gt=(e,t,s,n,a)=>(Y(be(be(be(P,e,Te),t,Te),s,(()=>[])),n),a),Kt=(e,t,s)=>(Y(be(N,e,(()=>[])),t),s),Ut=(e,t,s)=>J(Se(Se(Se(x,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...it(us(e,t,s))])),Xt=e=>J(Se(Q,e),(([e,t])=>[!0,e,t]),(()=>[!1,...it(fs(e))])),Yt=e=>Le(P)||Le(Ke[e])?0:pe(e?De(P):P,((t,s)=>pe(t,((t,n)=>pe(t,((t,a)=>ot(Ke[e],[s,n,a],t))))))),Zt=e=>Le(N)||Le(Ue[e])?0:pe(e?ke(N):N,((t,s)=>ot(Ue[e],[s],t))),es=(e,t,s,n)=>{if(!Le(e))return ot(t,n,(()=>Ve(e))),Ie(e,((e,t)=>ot(s,[...n??[],e],1==t))),1},ts=e=>{const t=Ls();t!=r&&ot(se[e],void 0,t);const s=Le(Ne[e]),n=Le(_e[e])&&Le(qe[e])&&Le(ze[e])&&Le(Oe[e])&&Le(de[e])&&Le(we[e])&&Le(Ae[e])&&s&&Le(ae[e])&&Le(oe[e]),a=Le(Ge[e])&&Le(We[e])&&Le(le[e])&&Le(ne[e]);if(!n||!a){const t=e?[ke(T),xe(V),ke(M),xe(E),De(k),De(x)]:[T,V,M,E,k,x];if(!n){es(t[0],ae[e],oe[e]),pe(t[1],((t,s)=>es(t,de[e],we[e],[s]))),pe(t[2],((t,s)=>{0!=t&&ot(Ae[e],[s],ls(s))}));const n=He();pe(t[3],((t,a)=>{es(t,ze[e],Oe[e],[a])&&!s&&(ot(Ne[e],[a,null]),Pe(n,a))})),s||pe(t[5],((t,s)=>{if(!fe(n,s)){const n=He();pe(t,(e=>pe(e,(([t,s],a)=>s!==t?Pe(n,a):ye(e,a))))),pe(n,(t=>ot(Ne[e],[s,t])))}})),pe(t[4],((t,s)=>pe(t,((t,n)=>es(t,_e[e],qe[e],[s,n])))))}if(!a){let s;pe(t[5],((t,n)=>{let a;pe(t,((t,o)=>{let r;pe(t,(([t,l],i)=>{l!==t&&(ot(Ge[e],[n,o,i],l,t,Ut),s=a=r=1)})),r&&ot(We[e],[n,o],Ut)})),a&&ot(le[e],[n],Ut)})),s&&ot(ne[e],void 0,Ut)}}},ss=e=>{const t=Ts();t!=d&&ot(Xe[e],void 0,t);const s=Le(Ze[e])&&Le(et[e]),n=Le(tt[e])&&Le(Ye[e]);if(!s||!n){const t=e?[ke(D),ke(Q)]:[D,Q];if(s||es(t[0],Ze[e],et[e]),!n){let s;pe(t[1],(([t,n],a)=>{n!==t&&(ot(tt[e],[a],n,t,Xt),s=1)})),s&&ot(Ye[e],void 0,Xt)}}},ns=(e,...t)=>(As((()=>e(...G(t,m)))),Qs),as=()=>Ee(ee),os=()=>ve(ee),rs=e=>ve(Se(Z,m(e))),ls=e=>ge(Se(ee,m(e))),is=e=>ve(Se(ee,m(e))),cs=(e,t,s,n=0,a)=>{return G(z($((o=Se(ee,m(e)),r=(e,s)=>[A(t)?s:Se(e,m(t)),s],G([...o?.entries()??[]],(([e,t])=>r(t,e)))),(([e],[t])=>$e(e,t)*(s?-1:1))),n,A(a)?a:n+a),(([,e])=>e));var o,r},ds=(e,t)=>ve(Se(Se(ee,m(e)),m(t))),us=(e,t,s)=>Se(Se(Se(ee,m(e)),m(t)),m(s)),hs=()=>Ve(te),gs=()=>ve(te),fs=e=>Se(te,m(e)),Ls=()=>!Le(ee),ws=e=>fe(ee,m(e)),Cs=(e,t)=>fe(Se(Z,m(e)),m(t)),ps=(e,t)=>fe(Se(ee,m(e)),m(t)),ys=(e,t,s)=>fe(Se(Se(ee,m(e)),m(t)),m(s)),Ts=()=>!Le(te),vs=e=>fe(te,m(e)),Ss=e=>ns((()=>(e=>ft(e,pt,Gt))(e)?Mt(e):0)),Is=e=>ns((()=>vt(e)?Jt(e):0)),Rs=e=>{try{Vt(gt(e))}catch{}return Qs},bs=t=>ns((()=>{if((e=ft(t,(e=>ft(e,Ct))))&&(bt(t),!Le(ee))){const e=as();Vs(),Ss(e)}})),ms=e=>ns((()=>{if(t=(e=>ft(e,Ct))(e)){const s=hs();Ds(),ks(),t=!0,mt(e),Is(s)}})),Vs=()=>ns((()=>Mt({}))),Ms=e=>ns((e=>fe(ee,e)?Pt(e):0),e),Es=(e,t)=>ns(((e,t)=>J(Se(ee,e),(s=>fe(s,t)?zt(e,s,t):0))),e,t),ks=()=>ns((()=>Jt({}))),xs=()=>ns((()=>{bt({}),e=!1})),Ds=()=>ns((()=>{mt({}),t=!1})),As=(e,t)=>{if(-1!=g){Js();const s=e();return Fs(t),s}},Js=()=>(-1!=g&&g++,1==g&&ot(st,void 0),Qs),Fs=e=>(g>0&&(g--,0==g&&(n=!Le(x),a=!Le(Q),g=1,Yt(1),n&&ts(1),Zt(1),a&&ss(1),e?.(Qs)&&(pe(x,((e,t)=>pe(e,((e,s)=>pe(e,(([e],n)=>Fe(Qs,t,s,n,e))))))),pe(Q,(([e],t)=>Qe(Qs,t,e))),n=a=!1),ot(nt[0],void 0),g=-1,Yt(0),n&&ts(0),Zt(0),a&&ss(0),s?.(Qs),ot(nt[1],void 0),g=0,n=a=!1,r=Ls(),d=Ts(),q([T,V,M,E,k,x,P,D,Q,N],Ce))),Qs),Qs={getContent:()=>[as(),hs()],getTables:as,getTableIds:os,getTable:e=>Me(Se(ee,m(e))),getTableCellIds:rs,getRowCount:ls,getRowIds:is,getSortedRowIds:cs,getRow:(e,t)=>Ve(Se(Se(ee,m(e)),m(t))),getCellIds:ds,getCell:us,getValues:hs,getValueIds:gs,getValue:fs,hasTables:Ls,hasTable:ws,hasTableCell:Cs,hasRow:ps,hasCell:ys,hasValues:Ts,hasValue:vs,getTablesJson:()=>ht(ee),getValuesJson:()=>ht(te),getJson:()=>ht([ee,te]),getTablesSchemaJson:()=>ht(O),getValuesSchemaJson:()=>ht(_),getSchemaJson:()=>ht([O,_]),hasTablesSchema:()=>e,hasValuesSchema:()=>t,setContent:([e,t])=>ns((()=>{(he(e)?Vs:Ss)(e),(he(t)?ks:Is)(t)})),setTables:Ss,setTable:(e,t)=>ns((e=>pt(t,e)?Et(e,t):0),e),setRow:(e,t,s)=>ns(((e,t)=>yt(e,t,s)?kt(e,Ht(e),t,s):0),e,t),addRow:(e,t,s=!0)=>As((()=>{let n;return yt(e,n,t)&&(e=m(e),kt(e,Ht(e),n=Qt(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>ns(((e,t)=>{if(yt(e,t,s,1)){const n=Ht(e);ue(s,((s,a)=>Dt(e,n,t,a,s)))}}),e,t),setCell:(e,t,s,n)=>ns(((e,t,s)=>J(Tt(e,t,s,H(n)?n(us(e,t,s)):n),(n=>Dt(e,Ht(e),t,s,n)))),e,t,s),setValues:Is,setPartialValues:e=>ns((()=>vt(e,1)?ue(e,((e,t)=>Ft(t,e))):0)),setValue:(e,t)=>ns((e=>J(St(e,H(t)?t(fs(e)):t),(t=>Ft(e,t)))),e),applyChanges:e=>ns((()=>{ue(e[0],((e,t)=>A(e)?Ms(t):ue(e,((e,s)=>A(e)?Es(t,s):ue(e,((e,n)=>Fe(Qs,t,s,n,e))))))),ue(e[1],((e,t)=>Qe(Qs,t,e)))})),setTablesJson:Rs,setValuesJson:e=>{try{At(gt(e))}catch{}return Qs},setJson:e=>ns((()=>{try{const[t,s]=gt(e);Vt(t),At(s)}catch{Rs(e)}})),setTablesSchema:bs,setValuesSchema:ms,setSchema:(e,t)=>ns((()=>{bs(e),ms(t)})),delTables:Vs,delTable:Ms,delRow:Es,delCell:(e,t,s,n)=>ns(((e,t,s)=>J(Se(ee,e),(a=>J(Se(a,t),(o=>fe(o,s)?Nt(e,a,t,o,s,n):0))))),e,t,s),delValues:ks,delValue:e=>ns((e=>fe(te,e)?Ot(e):0),e),delTablesSchema:xs,delValuesSchema:Ds,delSchema:()=>ns((()=>{xs(),Ds()})),transaction:As,startTransaction:Js,getTransactionChanges:()=>[Ve(x,((e,t)=>-1===Se(T,t)?void 0:Ve(e,((e,s)=>-1===Se(Se(E,t),s)?void 0:Ve(e,(([,e])=>e),((e,t)=>ut(t)))),he)),he),Ve(Q,(([,e])=>e),((e,t)=>ut(t)))],getTransactionLog:()=>[n,a,Ee(x,dt,ut),Ee(P),Ve(Q,dt,ut),Ve(N),Ve(T),Me(E),Ee(k),Ve(D)],finishTransaction:Fs,forEachTable:e=>pe(ee,((t,s)=>e(s,(e=>pe(t,((t,s)=>e(s,(e=>Ie(t,e))))))))),forEachTableCell:(e,t)=>Ie(Se(Z,m(e)),t),forEachRow:(e,t)=>pe(Se(ee,m(e)),((e,s)=>t(s,(t=>Ie(e,t))))),forEachCell:(e,t,s)=>Ie(Se(Se(ee,m(e)),m(t)),s),forEachValue:e=>Ie(te,e),addSortedRowIdsListener:(e,t,s,n,a,o,r)=>{let l=cs(e,t,s,n,a);return at((()=>{const r=cs(e,t,s,n,a);B(r,l)||(l=r,o(Qs,e,t,s,n,a,l))}),Ne[r?1:0],[e,t],[os])},addStartTransactionListener:e=>at(e,st),addWillFinishTransactionListener:e=>at(e,nt[0]),addDidFinishTransactionListener:e=>at(e,nt[1]),callListener:e=>(lt(e),Qs),delListener:e=>(rt(e),Qs),getListenerStats:()=>({}),createStore:wt,addListener:at,callListeners:ot,addPostTransactionListener:e=>{s=e}};return ue({[h+L]:[0,se,[],()=>[Ls()]],[L]:[0,ne],[w]:[0,ae],[h+f]:[1,oe,[os],e=>[ws(...e)]],[f]:[1,le,[os]],[f+S]:[1,de,[os]],[h+f+v]:[2,we,[os,rs],e=>[Cs(...e)]],[p]:[1,Ae,[os]],[y]:[1,ze,[os]],[h+C]:[2,Oe,[os,is],e=>[ps(...e)]],[C]:[2,We,[os,is]],[S]:[2,_e,[os,is]],[h+v]:[3,qe,[os,is,ds],e=>[ys(...e)]],[v]:[3,Ge,[os,is,ds],e=>it(us(...e))],InvalidCell:[3,Ke],[h+R]:[0,Xe,[],()=>[Ts()]],[R]:[0,Ye],[b]:[0,Ze],[h+I]:[1,et,[gs],e=>[vs(...e)]],[I]:[1,tt,[gs],e=>it(fs(e[0]))],InvalidValue:[1,Ue]},(([e,t,s,n],a)=>{Qs[u+a+c]=(...a)=>at(a[e],t[a[e+1]?1:0],e>0?z(a,0,e):void 0,s,n)})),re(Qs)},Ct=2**36,pt=2**30,yt=2**24,Tt=2**18,vt=4096,St=64,It=e=>String.fromCharCode(48+(63&e)),Rt=(e,t)=>E(e,t)-48,bt={HasTable:1,Table:1,TableCellIds:1,HasTableCell:2,RowCount:1,RowIds:1,SortedRowIds:5,HasRow:2,Row:2,CellIds:2,HasCell:3,Cell:3,HasValue:1,Value:1,InvalidCell:3,InvalidValue:1},mt=()=>[s,[st(),st()]];e.createCheckpoints=_e,e.createCustomPersister=(e,t,s,n,a,o,r,[l,i]=[],c=[])=>{let d,u,h,g=0,f=0;be(Xe,c,(()=>0)),be(Ye,c,(()=>[]));const L=(r?e.getMergeableContent:null)??e.getContent,w=e.getTransactionChanges,C=async e=>(2!=g&&(g=1,await p.schedule((async()=>{await e(),g=0}))),p),p={load:async(s,n)=>await C((async()=>{try{const s=await t();(r&&Q(s[0])?e.applyMergeableChanges:e.setContent)(s)}catch{e.setContent([s,n])}})),startAutoLoad:async(s={},a={})=>(p.stopAutoLoad(),await p.load(s,a),f=1,h=n((async(s,n)=>{if(n){const t=n();await C((async()=>e.applyChanges(t)))}else await C((async()=>{try{e.setContent(s?.()??await t())}catch(e){o?.(e)}}))})),p),stopAutoLoad:()=>(f&&(a(h),h=void 0,f=0),p),save:async e=>(1!=g&&(g=2,await p.schedule((async()=>{try{await s(L,e)}catch(e){o?.(e)}g=0}))),p),startAutoSave:async()=>(await p.stopAutoSave().save(),d=e.addDidFinishTransactionListener((()=>{const[e,t]=w();he(e)&&he(t)||p.save((()=>[e,t]))})),p),stopAutoSave:()=>(J(d,e.delListener),d=void 0,p),schedule:async(...e)=>(Y(Se(Ye,c),...e),await(async()=>{if(!Se(Xe,c)){for(Re(Xe,c,1);!A(u=ee(Se(Ye,c)));)try{await u()}catch(e){o?.(e)}Re(Xe,c,0)}})(),p),getStore:()=>e,destroy:()=>p.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return l&&(p[l]=()=>i),re(p)},e.createIndexes=qe,e.createMergeableStore=e=>{let t=1,s=mt();const[n,a]=(e=>{let t=0,s=0;const n=X(((e,t="",s)=>e.split(t,s))(e),((e,t)=>(e<<5)+e^E(t)),5381)>>>0,a=e=>{const n=t,[a,o]=A(e)?[0,0]:[Rt(r=e,0)*Ct+Rt(r,1)*pt+Rt(r,2)*yt+Rt(r,3)*Tt+Rt(r,4)*vt+Rt(r,5)*St+Rt(r,6),Rt(r,7)*Tt+Rt(r,8)*vt+Rt(r,9)*St+Rt(r,10),Rt(r,11)*yt+Rt(r,12)*Tt+Rt(r,13)*vt+Rt(r,14)*St+Rt(r,15)];var r;t=Math.max(n,a,Date.now()),s=t==n?t==a?Math.max(s,o):s:t==a?o:-1};return[()=>{return a(),o=++s,r=n,It((e=t)/Ct)+It(e/pt)+It(e/yt)+It(e/Tt)+It(e/vt)+It(e/St)+It(e)+It(o/Tt)+It(o/vt)+It(o/St)+It(o)+It(r/yt)+It(r/Tt)+It(r/vt)+It(r/St)+It(r);var e,o,r},a]})(e),o=wt(),r=e=>{const s=t;t=0,e(),t=s},l=e=>{const t=[{},{}];return a(e[0]),rt(e,s,t,(([e,t],[s,n],[a,o])=>{rt(e,s,a,((e,t,s)=>ot(e,t,s,((e,t,s)=>ot(e,t,s,lt))))),rt(t,n,o,lt)})),r((()=>o.applyChanges(t))),i},i={getMergeableContent:()=>nt(s,(([e,t])=>[at(e,(e=>at(e,(e=>at(e,dt))))),at(t,dt)])),setMergeableContent:e=>(r((()=>o.transaction((()=>{o.delTables().delValues(),s=mt()})))),l(e),i),applyMergeableChanges:l,merge:e=>{const t=i.getMergeableContent(),s=e.getMergeableContent();return e.applyMergeableChanges(t),l(s)}};return o.addPostTransactionListener((()=>{if(t){const e=n(),[t,a,r,,l]=o.getTransactionLog(),[i,c]=s[1];s[0]=e,t&&(i[0]=e,ue(r,((t,s)=>{const n=be(i[1],s,tt),a=n[1]??=Te();n[0]=e,ue(t,((t,s)=>{const n=be(a,s,tt),o=n[1]??=Te();n[0]=e,ue(t,(([,t],s)=>Re(o,s,[e,t])))}))}))),a&&(c[0]=e,ue(l,(([,t],s)=>{Re(c[1],s,[e,t])})))}})),ue(o,((e,t)=>i[t]=V(t,"set")||V(t,"del")||V(t,"apply")||M(t,"Transaction")||"callListener"==t?(...t)=>(e(...t),i):V(t,"add")&&M(t,"Listener")?(...s)=>{const n=bt[z(t,3,-8)]??0,a=s[n];return s[n]=(e,...t)=>a(i,...t),e(...s)}:e)),re(i)},e.createMetrics=Ue,e.createQueries=Ze,e.createRelationships=et,e.createStore=wt,e.defaultSorter=$e},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={});
