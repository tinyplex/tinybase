var e,t;e=this,t=function(e,t){"use strict";const s=e=>typeof e,n="",o=s(n),r=s(!0),a=s(0),l=s(s),i="type",d="default",c="utf8",u=e=>[e,e],h=(e,t)=>e.includes(t),f=(e,t)=>e.every(t),g=(e,t)=>I(e)===I(t)&&f(e,((e,s)=>t[s]===e)),R=(e,t)=>f(e,((s,n)=>0==n||t(e[n-1],s)<=0)),L=(e,t)=>e.sort(t),w=(e,t)=>e.forEach(t),T=e=>b(e,((e,t)=>e+t),0),I=e=>e.length,p=e=>0==I(e),b=(e,t,s)=>e.reduce(t,s),v=(e,t,s)=>e.slice(t,s),y=(e,...t)=>e.push(...t),S=e=>e.pop(),C=e=>JSON.stringify(e,((e,t)=>x(t,Map)?b([...t],((e,[t,s])=>(e[t]=s,e)),{}):t)),m=JSON.parse,E=Math.max,k=Math.min,M=isFinite,x=(e,t)=>e instanceof t,D=e=>null==e,A=(e,t,s)=>D(e)?s?.():t(e),F=e=>e==o||e==r,P=e=>s(e)==l,J=()=>{},Q=e=>e.size,j=(e,t)=>e?.has(t)??!1,O=e=>D(e)||0==Q(e),z=e=>[...e?.values()??[]],N=e=>e.clear(),W=(e,t)=>e?.forEach(t),B=(e,t)=>e?.delete(t),_=e=>new Map(e),q=(e=_)=>[e(),e()],H=e=>[...e?.keys()??[]],G=(e,t)=>e?.get(t),K=(e,t)=>W(e,((e,s)=>t(s,e))),U=(e,t,s)=>D(s)?(B(e,t),e):e?.set(t,s),V=(e,t,s)=>(j(e,t)||e.set(t,s()),G(e,t)),X=(e,t,s)=>{const n={},o=t??(e=>e);return W(e,((e,t)=>A(o(e),(e=>s?.(e)?0:n[t]=e)))),n},Y=(e,t)=>{const s=_(),n=t??(e=>e);return W(e,((e,t)=>s.set(t,n(e)))),s},Z=e=>Y(e,Y),$=(e,t,s,n,o=0)=>A((s?V:G)(e,t[o],o>I(t)-2?s:_),(r=>{if(o>I(t)-2)return n?.(r)&&U(e,t[o]),r;const a=$(r,t,s,n,o+1);return O(r)&&U(e,t[o]),a})),ee=e=>new Set(e),te=(e,t)=>e?.add(t),se=(e,t,s)=>{const n=e.hasRow,o=_(),r=_(),a=_(),l=_(),i=_(),d=(t,s,...n)=>{const o=V(i,t,ee);return w(n,(t=>te(o,t)&&s&&e.callListener(t))),n},c=(t,...s)=>A(G(i,t),(n=>{w(p(s)?z(n):s,(t=>{e.delListener(t),B(n,t)})),O(n)&&U(i,t)})),u=(e,s)=>{U(o,e,s),j(r,e)||(U(r,e,t()),U(a,e,_()),U(l,e,_()))},h=e=>{U(o,e),U(r,e),U(a,e),U(l,e),c(e)};return[()=>e,()=>H(o),e=>K(r,e),e=>j(r,e),e=>G(o,e),e=>G(r,e),(e,t)=>U(r,e,t),u,(t,o,r,i,h)=>{u(t,o);const f=_(),g=_(),R=G(a,t),L=G(l,t),T=t=>{const r=s=>e.getCell(o,t,s),a=G(R,t),l=n(o,t)?s(i(r,t)):void 0;if(a!=l&&U(f,t,[a,l]),!D(h)){const e=G(L,t),s=n(o,t)?h(r,t):void 0;e!=s&&U(g,t,s)}},I=e=>{r((()=>{W(f,(([,e],t)=>U(R,t,e))),W(g,((e,t)=>U(L,t,e)))}),f,g,R,L,e),N(f),N(g)};K(R,T),e.hasTable(o)&&w(e.getRowIds(o),(e=>{j(R,e)||T(e)})),I(!0),c(t),d(t,0,e.addRowListener(o,null,((e,t,s)=>T(s))),e.addTableListener(o,(()=>I())))},h,()=>K(i,h),d,c]},ne=(e,t)=>s(e)==o?t=>t(e):e??(()=>t??n),oe=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},re=(e,t,s)=>I(s)<2?te(p(s)?e:V(e,s[0],ee),t):re(V(e,s[0],_),t,v(s,1)),ae=e=>{const t=(s,n,...o)=>A(s,(s=>p(o)?e(s,n):w([o[0],null],(e=>t(G(s,e),n,...v(o,1))))));return t},le=e=>{let t,s=0;const n=[],o=_();return[(r,a,l=[])=>{t??=e();const i=S(n)??""+s++;return U(o,i,[r,a,l]),re(a,i,l),i},(e,s=[],...n)=>ae(W)(e,(e=>A(G(o,e),(([e])=>e(t,...s,...n)))),...s),e=>A(G(o,e),(([,t,s])=>(ae(B)(t,e,...s),U(o,e),I(n)<1e3&&y(n,e),s)),(()=>[])),(e,s,n)=>A(G(o,e),(([e,,o])=>{const r=(...a)=>{const l=I(a);l==I(o)?e(t,...a,...n(a)):D(o[l])?w(s[l](...a),(e=>r(...a,e))):r(...a,o[l])};r()}))]},ie=Object,de=ie.keys,ce=ie.isFrozen,ue=ie.freeze,he=(e,t)=>!D(((e,t)=>A(e,(e=>e[t])))(e,t)),fe=(e,t)=>delete e[t],ge=(e,t)=>w(ie.entries(e),(([e,s])=>t(s,e))),Re=e=>p(de(e)),Le=e=>{const t=s(e);return F(t)||t==a&&M(e)?t:void 0},we=(e,t,s,n,o)=>D(o)?e.delCell(t,s,n,!0):e.setCell(t,s,n,o),Te=oe((e=>{let t,s,n,o=100,r=_(),a=1;const l=ee(),i=_(),[d,c,u]=le((()=>Q)),f=_(),g=_(),R=[],L=[],T=(t,s)=>{a=0,e.transaction((()=>W(G(f,s),((s,n)=>W(s,((s,o)=>W(s,((s,r)=>we(e,n,o,r,s[t]))))))))),a=1},b=e=>{U(f,e),U(g,e),c(i,[e])},v=(e,t)=>w(((e,t)=>e.splice(0,t))(e,t??I(e)),b),C=()=>v(R,I(R)-o),m=e.addCellListener(null,null,null,((e,s,o,l,i,d)=>{if(a){A(t,(()=>{y(R,t),C(),v(L),t=void 0,n=1}));const e=V(r,s,_),a=V(e,o,_),c=V(a,l,(()=>[d,void 0]));c[1]=i,c[0]===i&&O(U(a,l))&&O(U(e,o))&&O(U(r,s))&&(t=S(R),n=1),x()}})),E=(e="")=>(D(t)&&(t=""+s++,U(f,t,r),P(t,e),r=_(),n=1),t),k=()=>{p(R)||(L.unshift(E()),T(0,t),t=S(R),n=1)},M=()=>{p(L)||(y(R,t),t=L.shift(),T(1,t),n=1)},x=()=>{n&&(c(l),n=0)},F=e=>{const t=E(e);return x(),t},P=(e,t)=>(J(e)&&G(g,e)!==t&&(U(g,e,t),c(i,[e])),Q),J=e=>j(f,e),Q={setSize:e=>(o=e,C(),Q),addCheckpoint:F,setCheckpoint:P,getStore:()=>e,getCheckpointIds:()=>[[...R],t,[...L]],forEachCheckpoint:e=>K(g,e),hasCheckpoint:J,getCheckpoint:e=>G(g,e),goBackward:()=>(k(),x(),Q),goForward:()=>(M(),x(),Q),goTo:e=>{const s=h(R,e)?k:h(L,e)?M:null;for(;!D(s)&&e!=t;)s();return x(),Q},addCheckpointIdsListener:e=>d(e,l),addCheckpointListener:(e,t)=>d(t,i,[e]),delListener:e=>(u(e),Q),clear:()=>(v(R),v(L),D(t)||b(t),t=void 0,s=0,F(),Q),destroy:()=>{e.delListener(m)},getListenerStats:()=>({})};return ue(Q.clear())})),Ie=(e,t)=>e<t?-1:1,pe=oe((e=>{const t=_(),s=_(),[o,r,a,l,i,d,c,,u,h,f]=se(e,_,(e=>D(e)?n:e+n)),[g,w,T]=le((()=>p)),I=(t,s,n)=>{const o=i(t);W(n,((t,n)=>s(n,(s=>W(t,(t=>s(t,(s=>e.forEachCell(o,t,s)))))))))},p={setIndexDefinition:(e,n,o,r,a,l=Ie)=>{const i=D(a)?void 0:([e],[t])=>a(e,t);return u(e,n,((n,o,a,u,h,f)=>{let g=0;const T=ee(),I=ee(),p=d(e);if(W(o,(([e,t],s)=>{D(e)||(te(T,e),A(G(p,e),(t=>{B(t,s),O(t)&&(U(p,e),g=1)}))),D(t)||(te(T,t),j(p,t)||(U(p,t,ee()),g=1),te(G(p,t),s),D(r)||te(I,t))})),n(),O(h)||(f?K(p,(e=>te(I,e))):K(a,(e=>A(G(u,e),(e=>te(I,e))))),W(I,(e=>{const t=(t,s)=>l(G(h,t),G(h,s),e),s=[...G(p,e)];R(s,t)||(U(p,e,ee(L(s,t))),te(T,e))}))),(g||f)&&!D(i)){const t=[...p];R(t,i)||(c(e,_(L(t,i))),g=1)}g&&w(t,[e]),W(T,(t=>w(s,[e,t])))}),ne(o),A(r,ne)),p},delIndexDefinition:e=>(h(e),p),getStore:o,getIndexIds:r,forEachIndex:e=>a(((t,s)=>e(t,(e=>I(t,e,s))))),forEachSlice:(e,t)=>I(e,t,d(e)),hasIndex:l,hasSlice:(e,t)=>j(d(e),t),getTableId:i,getSliceIds:e=>H(d(e)),getSliceRowIds:(e,t)=>z(G(d(e),t)),addSliceIdsListener:(e,s)=>g(s,t,[e]),addSliceRowIdsListener:(e,t,n)=>g(n,s,[e,t]),delListener:e=>(T(e),p),destroy:f,getListenerStats:()=>({})};return ue(p)})),be=_([["avg",[(e,t)=>T(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>E(...e),(e,t)=>E(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:E(t,e)]],["min",[e=>k(...e),(e,t)=>k(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:k(t,e)]],["sum",[e=>T(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),ve=(e,t,s,n,o,r=!1)=>{if(O(s))return;const[a,l,i,d]=o;return r||=D(e),W(n,(([s,n])=>{r||(e=D(s)?l?.(e,n,t++):D(n)?i?.(e,s,t--):d?.(e,n,s,t),r||=D(e))})),r?a(z(s),Q(s)):e},ye=oe((e=>{const t=_(),[s,o,r,a,l,i,d,,c,u,h]=se(e,J,(e=>isNaN(e)||D(e)||!0===e||!1===e||e===n?void 0:1*e)),[f,g,R]=le((()=>L)),L={setMetricDefinition:(e,s,n,o,r,a,l)=>{const u=P(n)?[n,r,a,l]:G(be,n)??G(be,"sum");return c(e,s,((s,n,o,r,a,l)=>{const c=i(e),h=Q(r);l||=D(c),s();let f=ve(c,h,r,n,u,l);M(f)||(f=void 0),f!=c&&(d(e,f),g(t,[e],f,c))}),ne(o,1)),L},delMetricDefinition:e=>(u(e),L),getStore:s,getMetricIds:o,forEachMetric:r,hasMetric:a,getTableId:l,getMetric:i,addMetricListener:(e,s)=>f(s,t,[e]),delListener:e=>(R(e),L),destroy:h,getListenerStats:()=>({})};return ue(L)})),Se=(e,t,s,n,o)=>{let r,a=0;const l={load:async s=>{if(2!=a){a=1;const n=await t();D(n)||""==n?e.setTables(s):e.setJson(n),a=0}return l},startAutoLoad:async e=>(l.stopAutoLoad(),await l.load(e),n(l.load),l),stopAutoLoad:()=>(o(),l),save:async()=>(1!=a&&(a=2,await s(e.getJson()),a=0),l),startAutoSave:async()=>(await l.stopAutoSave().save(),r=e.addTablesListener((()=>l.save())),l),stopAutoSave:()=>(A(r,e.delListener),l),getStore:()=>e,destroy:()=>l.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return ue(l)},Ce="storage",me=globalThis.window,Ee=(e,t,s)=>{let n;return Se(e,(async()=>s.getItem(t)),(async e=>s.setItem(t,e)),(e=>{n=n=>{n.storageArea===s&&n.key===t&&e()},me.addEventListener(Ce,n)}),(()=>{me.removeEventListener(Ce,n),n=void 0}))},ke=e=>e.headers.get("ETag"),Me=oe((e=>{const[t,s,o,r,a,,,l,,i,d,c,u]=se(e,(()=>!0),J),h=e.createStore(),R=e.createStore(),T=e.createStore(),b=_(),S=(e,t,...s)=>w(s,(s=>te(V(V(b,t,_),e,ee),s))),C=(e,t,s)=>c(e,0,t.addWillFinishTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),m={setQueryDefinition:(t,s,o)=>{let r;l(t,s),h.delTable(t),R.delTable(t),T.delTable(t);const a=[],i=[[null,[s,null,null,[],_()]]],d=[],b=[],E=[],k=[];o({select:(e,t)=>{const s=P(e)?[I(a)+n,e]:[D(t)?e:t,s=>s(e,t)];return y(a,s),{as:e=>s[0]=e}},join:(e,t,s)=>{const n=D(s)||P(t)?null:t,o=D(n)?t:s,r=[e,[e,n,P(o)?o:e=>e(o),[],_()]];return y(i,r),{as:e=>r[0]=e}},where:(e,t,s)=>y(d,P(e)?e:D(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,o)=>{const r=[e,[e,P(t)?[t,s,n,o]:G(be,t)??[(e,t)=>t]]];return y(b,r),{as:e=>r[0]=e}},having:(e,t)=>y(E,P(e)?e:s=>s(e)===t),order:(e,t)=>y(k,[P(e)?e:t=>t(e)??0,t]),limit:(e,t)=>{r=D(t)?[0,e]:[e,t]}});const M=_(a);if(O(M))return m;const x=_(i);K(x,((e,[,t])=>A(G(x,t),(({3:t})=>D(e)?0:y(t,e)))));const F=_(b);let J=h,z=R;if(p(k)&&D(r))z=T;else{C(t,z,T);const e=(e,t)=>{const n=G(s,e)??[],o=G(s,t)??[],r=k.findIndex(((e,t)=>n[t]!==o[t]));return r<0?0:Ie(n[r],o[r])*(k[r][1]?-1:1)},s=_(),n=_();S(z,t,p(k)?z.addRowIdsListener(t,(()=>N(n))):z.addRowListener(t,null,((e,o,r)=>{let a=null;if(z.hasRow(t,r)){const e=G(s,r)??[],o=z.getRow(t,r),i=e=>o[e];if(l=([e])=>e(i,r),a=k.map(l),g(e,a))return void(G(n,r)&&T.setRow(t,r,o))}var l;U(s,r,a),N(n)})),z.addTableListener(t,(()=>{if(O(n)&&(T.delTable(t),z.hasTable(t))){const s=z.getTable(t);w(L(de(s),e),(e=>U(n,e,0))),w(A(r,(([e,t])=>v(H(n),e,e+t)),(()=>H(n))),(e=>{T.setRow(t,e,s[e]),U(n,e,1)}))}})))}if(O(F)&&p(E))J=z;else{C(t,J,z);const e=_();K(F,((t,[s,n])=>te(V(e,s,ee),[t,n])));const s=ee();K(M,(t=>j(e,t)?0:te(s,t)));const n=_(),o=(s,n,o,r)=>A(s,(([s,a,l,i])=>{K(n,((t,[n])=>{const a=V(s,t,_),l=G(a,o),d=r?void 0:n;if(l!==d){const s=ee([[l,d]]),n=Q(a);U(a,o,d),W(G(e,t),(([e,t])=>{const o=ve(i[e],n,a,s,t);i[e]=D(Le(o))?null:o}))}})),(O(a)||!f(E,(e=>e((e=>i[e]))))?z.delRow:z.setRow)(t,l,i)}));S(J,t,J.addRowListener(t,null,((r,a,l,i)=>{const d=[],c=[],u=_(),h=J.hasRow(t,l);let f=!h;W(s,(e=>{const[s,n,o]=i(t,l,e);y(d,n),y(c,o),f||=s})),K(e,(e=>{const[s,,n]=i(t,l,e);(f||s)&&U(u,e,[n])})),f&&o($(n,d,void 0,(([,e,s])=>{if(B(e,l),O(e))return z.delRow(t,s),1})),u,l,1),h&&o($(n,c,(()=>{const e={};return W(s,(s=>e[s]=J.getCell(t,l,s))),[_(),ee(),z.addRow(t,e,1),e]}),(([,e])=>{te(e,l)})),u,l)})))}C(t,e,J);const q=(n,o,r,a)=>{const l=t=>e.getCell(o,r,t);w(a,(s=>{const[o,,r,a,i]=G(x,s),d=r?.(l,n),[h,f]=G(i,n)??[];d!=h&&(D(f)||u(t,f),U(i,n,D(d)?null:[d,...c(t,1,e.addRowListener(o,d,(()=>q(n,o,d,a))))]))})),(n=>{const o=(t,o)=>e.getCell(...D(o)?[s,n,t]:t===s?[s,n,o]:[G(x,t)?.[0],G(G(x,t)?.[4],n)?.[0],o]);J.transaction((()=>f(d,(e=>e(o)))?K(M,((e,s)=>we(J,t,n,e,s(o,n)))):J.delRow(t,n)))})(n)},{3:X}=G(x,null);return J.transaction((()=>c(t,1,e.addRowListener(s,null,((n,o,r)=>{e.hasRow(s,r)?q(r,s,r,X):(J.delRow(t,r),W(x,(({4:e})=>A(G(e,r),(([,s])=>{u(t,s),U(e,r)})))))}))))),m},delQueryDefinition:e=>(K(G(b,e),((e,t)=>W(t,(t=>e.delListener(t))))),i(e),m),getStore:t,getQueryIds:s,forEachQuery:o,hasQuery:r,getTableId:a,getResultTable:e=>T.getTable(e),getResultRowIds:e=>T.getRowIds(e),getResultRow:(e,t)=>T.getRow(e,t),getResultCellIds:(e,t)=>T.getCellIds(e,t),getResultCell:(e,t,s)=>T.getCell(e,t,s),hasResultTable:e=>T.hasTable(e),hasResultRow:(e,t)=>T.hasRow(e,t),hasResultCell:(e,t,s)=>T.hasCell(e,t,s),forEachResultTable:e=>T.forEachTable(e),forEachResultRow:(e,t)=>T.forEachRow(e,t),forEachResultCell:(e,t,s)=>T.forEachCell(e,t,s),addResultTableListener:(e,t)=>T.addTableListener(e,((e,...s)=>t(m,...s))),addResultRowIdsListener:(e,t)=>T.addRowIdsListener(e,((e,...s)=>t(m,...s))),addResultRowListener:(e,t,s)=>T.addRowListener(e,t,((e,...t)=>s(m,...t))),addResultCellIdsListener:(e,t,s)=>T.addCellIdsListener(e,t,((e,...t)=>s(m,...t))),addResultCellListener:(e,t,s,n)=>T.addCellListener(e,t,s,((e,...t)=>n(m,...t))),delListener:e=>(T.delListener(e),m),destroy:d,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=T.getListenerStats();return n}};return ue(m)})),xe=oe((e=>{const t=_(),s=_(),o=_(),r=_(),[a,l,i,d,c,u,,,h,f,g]=se(e,(()=>[_(),_(),_(),_()]),(e=>D(e)?void 0:e+n)),[R,L,w]=le((()=>b)),T=(e,t,s)=>A(u(e),(([n,,o])=>{if(!j(o,t)){const r=ee();if(c(e)!=p(e))te(r,t);else{let e=t;for(;!D(e)&&!j(r,e);)te(r,e),e=G(n,e)}if(s)return r;U(o,t,r)}return G(o,t)})),I=(e,t)=>A(u(e),(([,,e])=>U(e,t))),p=e=>G(t,e),b={setRelationshipDefinition:(e,n,a,l)=>(U(t,e,a),h(e,n,((t,n)=>{const a=ee(),l=ee(),i=ee(),[d,c]=u(e);W(n,(([t,s],n)=>{D(t)||(te(l,t),A(G(c,t),(e=>{B(e,n),O(e)&&U(c,t)}))),D(s)||(te(l,s),j(c,s)||U(c,s,ee()),te(G(c,s),n)),te(a,n),U(d,n,s),K(G(r,e),(t=>{j(T(e,t),n)&&te(i,t)}))})),t(),W(a,(t=>L(s,[e,t]))),W(l,(t=>L(o,[e,t]))),W(i,(t=>{I(e,t),L(r,[e,t])}))}),ne(l)),b),delRelationshipDefinition:e=>(U(t,e),f(e),b),getStore:a,getRelationshipIds:l,forEachRelationship:t=>i((s=>t(s,(t=>e.forEachRow(c(s),t))))),hasRelationship:d,getLocalTableId:c,getRemoteTableId:p,getRemoteRowId:(e,t)=>G(u(e)?.[0],t),getLocalRowIds:(e,t)=>z(G(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>D(u(e))?[t]:z(T(e,t,!0)),addRemoteRowIdListener:(e,t,n)=>R(n,s,[e,t]),addLocalRowIdsListener:(e,t,s)=>R(s,o,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(T(e,t),R(s,r,[e,t])),delListener:e=>(I(...w(e)),b),destroy:g,getListenerStats:()=>({})};return ue(b)})),De=(e,t,s,n=U)=>{const o=(r=H(e),a=e=>!he(t,e),r.filter(a));var r,a;return w(de(t),(n=>s(e,n,t[n]))),w(o,(t=>n(e,t))),e},Ae=(e,t,s)=>D(e)||!(e=>x(e,ie)&&e.constructor==ie)(e)||Re(e)||ce(e)?(s?.(),!1):(ge(e,((s,n)=>{t(s,n)||fe(e,n)})),!Re(e)),Fe=(e,t,s)=>U(e,t,G(e,t)==-s?void 0:s),Pe=()=>{let e,t,s=0,n=0;const o=_(),r=_(),l=_(),c=_(),f=_(),R=_(),L=_(),T=_(),I=q(ee),p=q(ee),b=q(),v=q(),S=q(),E=q(),k=q(),M=q(),x=q(ee),[J,z,B,$]=le((()=>Xe)),se=(t,s)=>(!e||j(R,s)||ke(s))&&Ae(t,((e,t)=>ne(s,t,e)),(()=>ke(s))),ne=(e,t,s,n)=>Ae(n?s:re(s,e,t),((n,o)=>A(oe(e,t,o,n),(e=>(s[o]=e,!0)),(()=>!1))),(()=>ke(e,t))),oe=(t,s,n,o)=>e?A(G(G(R,t),n),(e=>Le(o)!=e.type?ke(t,s,n,o,e.default):o),(()=>ke(t,s,n,o))):D(Le(o))?ke(t,s,n,o):o,re=(e,t,s)=>(A(G(L,t),(([n,o])=>{W(n,((t,s)=>{he(e,s)||(e[s]=t)})),W(o,(n=>{he(e,n)||ke(t,s,n)}))})),e),ae=e=>De(R,e,((e,t,s)=>{const n=_(),o=ee();De(V(R,t,_),s,((e,t,s)=>{U(e,t,s),A(s.default,(e=>U(n,t,e)),(()=>te(o,t)))})),U(L,t,[n,o])}),((e,t)=>{U(R,t),U(L,t)})),ie=e=>De(T,e,((e,t,s)=>de(t,s)),((e,t)=>be(t))),de=(e,t)=>De(V(T,e,(()=>(Se(e,1),_()))),t,((t,s,n)=>ce(e,t,s,n)),((t,s)=>ve(e,t,s))),ce=(e,t,s,n,o)=>De(V(t,s,(()=>(Ce(e,s,1),_()))),n,((t,n,o)=>we(e,s,t,n,o)),((n,r)=>ye(e,t,s,n,r,o))),we=(e,t,s,n,o)=>{j(s,n)||me(e,t,n,1);const r=G(s,n);o!==r&&(Ee(e,t,n,r,o),U(s,n,o))},Te=(e,t,s,n,o)=>A(G(t,s),(t=>we(e,s,t,n,o)),(()=>ce(e,t,s,re({[n]:o},e,s)))),Ie=e=>{const t=""+s++;return j(e,t)?Ie(e):t},pe=e=>G(T,e)??de(e,{}),be=e=>de(e,{}),ve=(e,t,s)=>ce(e,t,s,{},!0),ye=(e,t,s,n,o,r)=>{const a=G(G(L,e)?.[0],o);if(!D(a)&&!r)return we(e,s,n,o,a);const l=t=>{Ee(e,s,t,G(n,t)),me(e,s,t,-1),U(n,t)};D(a)?l(o):K(n,l),O(n)&&(Ce(e,s,-1),O(U(t,s))&&(Se(e,-1),U(T,e)))},Se=(e,t)=>Fe(O(o)?U(o,null,ze()):o,e,t),Ce=(e,t,s)=>Fe(V(r,e,(()=>_([[null,Ne(e)]]))),t,s),me=(e,t,s,n)=>Fe(V(V(l,e,_),t,(()=>_([[null,We(e,t)]]))),s,n),Ee=(e,t,s,n,o)=>V(V(V(c,e,_),t,_),s,(()=>[n,0]))[1]=o,ke=(e,t,s,n,o)=>(y(V(V(V(f,e,_),t,_),s,(()=>[])),n),o),Me=(e,t,s)=>A(G(G(G(c,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...u(Be(e,t,s))])),xe=e=>O(f)||O(M[e])?0:W(e?Y(f,Z):f,((t,s)=>W(t,((t,n)=>W(t,((t,o)=>z(M[e],[s,n,o],t))))))),Je=(e,t,s,n)=>{(Q(t)>1||!O(t)&&!g(G(t,null),s(...n)))&&z(e,n)},Qe=e=>{const t=O(E[e])&&O(v[e])&&O(p[e]),s=O(k[e])&&O(S[e])&&O(b[e])&&O(I[e]);if(!t||!s){const n=e?[Y(o),Z(r),Y(l,Z),Y(c,Z)]:[o,r,l,c];if(t||(W(n[2],((t,s)=>W(t,((t,n)=>Je(E[e],t,We,[s,n]))))),W(n[1],((t,s)=>Je(v[e],t,Ne,[s]))),Je(p[e],n[0],ze,[])),!s){let t;W(n[3],((s,n)=>{let o;W(s,((s,r)=>{let a;W(s,(([s,l],i)=>{l!==s&&(z(k[e],[n,r,i],l,s,Me),t=o=a=1)})),a&&z(S[e],[n,r],Me)})),o&&z(b[e],[n],Me)})),t&&z(I[e],[],Me)}}},je=e=>(Ke(e),Xe),Oe=()=>X(T,(e=>X(e,X))),ze=()=>H(T),Ne=e=>H(G(T,e)),We=(e,t)=>H(G(G(T,e),t)),Be=(e,t,s)=>G(G(G(T,e),t),s),_e=e=>je((()=>(e=>Ae(e,se,ke))(e)?ie(e):0)),qe=(e,t,s,n)=>je((()=>A(oe(e,t,s,P(n)?n(Be(e,t,s)):n),(n=>Te(e,pe(e),t,s,n))))),He=()=>je((()=>ie({}))),Ge=(e,t,s,n)=>je((()=>A(G(T,e),(o=>A(G(o,t),(r=>j(r,s)?ye(e,o,t,r,s,n):0)))))),Ke=(e,t)=>{if(-1==n)return;Ue();const s=e?.();return Ve(t),s},Ue=()=>(n++,Xe),Ve=e=>(n>0&&(n--,0==n&&(t=!O(c),n=1,xe(1),t&&Qe(1),n=-1,e?.(X(c,(e=>X(e,(e=>X(e,(e=>[...e]),(([e,t])=>e===t))),Re)),Re),X(f,(e=>X(e,X))))&&(n=1,W(c,((e,t)=>W(e,((e,s)=>W(e,(([e],n)=>D(e)?Ge(t,s,n,!0):qe(t,s,n,e))))))),n=-1,t=!1),z(x[0],[],t),xe(0),t&&Qe(0),z(x[1],[],t),n=0,w([c,f,o,r,l],N))),Xe),Xe={getTables:Oe,getTableIds:ze,getTable:e=>X(G(T,e),X),getRowIds:Ne,getRow:(e,t)=>X(G(G(T,e),t)),getCellIds:We,getCell:Be,hasTables:()=>!O(T),hasTable:e=>j(T,e),hasRow:(e,t)=>j(G(T,e),t),hasCell:(e,t,s)=>j(G(G(T,e),t),s),getJson:()=>C(T),getSchemaJson:()=>C(R),setTables:_e,setTable:(e,t)=>je((()=>se(t,e)?de(e,t):0)),setRow:(e,t,s)=>je((()=>ne(e,t,s)?ce(e,pe(e),t,s):0)),addRow:(e,t,s)=>Ke((()=>{const n=ne(e,void 0,t),o=n||s?Ie(G(T,e)):void 0;return n&&ce(e,pe(e),o,t),o})),setPartialRow:(e,t,s)=>je((()=>{if(ne(e,t,s,1)){const n=pe(e);ge(s,((s,o)=>Te(e,n,t,o,s)))}})),setCell:qe,setJson:e=>{try{"{}"===e?He():_e(m(e))}catch{}return Xe},setSchema:t=>je((()=>{if((e=(e=>Ae(e,(e=>Ae(e,(e=>{if(!Ae(e,((e,t)=>h([i,d],t))))return!1;const t=e.type;return!(!F(t)&&t!=a||(Le(e.default)!=t&&fe(e,d),0))})))))(t))&&(ae(t),!O(T))){const e=Oe();He(),_e(e)}})),delTables:He,delTable:e=>je((()=>j(T,e)?be(e):0)),delRow:(e,t)=>je((()=>A(G(T,e),(s=>j(s,t)?ve(e,s,t):0)))),delCell:Ge,delSchema:()=>je((()=>{ae({}),e=!1})),transaction:Ke,startTransaction:Ue,finishTransaction:Ve,forEachTable:e=>W(T,((t,s)=>e(s,(e=>W(t,((t,s)=>e(s,(e=>K(t,e))))))))),forEachRow:(e,t)=>W(G(T,e),((e,s)=>t(s,(t=>K(e,t))))),forEachCell:(e,t,s)=>K(G(G(T,e),t),s),addTablesListener:(e,t)=>J(e,I[t?1:0]),addTableIdsListener:(e,t)=>J(e,p[t?1:0]),addTableListener:(e,t,s)=>J(t,b[s?1:0],[e]),addRowIdsListener:(e,t,s)=>J(t,v[s?1:0],[e]),addRowListener:(e,t,s,n)=>J(s,S[n?1:0],[e,t]),addCellIdsListener:(e,t,s,n)=>J(s,E[n?1:0],[e,t]),addCellListener:(e,t,s,n,o)=>J(n,k[o?1:0],[e,t,s]),addInvalidCellListener:(e,t,s,n,o)=>J(n,M[o?1:0],[e,t,s]),addWillFinishTransactionListener:e=>J(e,x[0]),addDidFinishTransactionListener:e=>J(e,x[1]),callListener:e=>($(e,[ze,Ne,We],(e=>D(e[2])?[]:u(Be(...e)))),Xe),delListener:e=>(B(e),Xe),getListenerStats:()=>({}),createStore:Pe};return ue(Xe)};e.createCheckpoints=Te,e.createCustomPersister=Se,e.createFilePersister=(e,s)=>{let n;return Se(e,(async()=>{try{return await t.promises.readFile(s,c)}catch{}}),(async e=>{try{await t.promises.writeFile(s,e,c)}catch{}}),(e=>{n=t.watch(s,e)}),(()=>{n?.close(),n=void 0}))},e.createIndexes=pe,e.createLocalPersister=(e,t)=>Ee(e,t,localStorage),e.createMetrics=ye,e.createQueries=Me,e.createRelationships=xe,e.createRemotePersister=(e,t,s,n)=>{let o,r;return Se(e,(async()=>{const e=await fetch(t);return r=ke(e),e.text()}),(async e=>await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:e})),(e=>{o=setInterval((async()=>{const s=await fetch(t,{method:"HEAD"}),n=ke(s);D(r)||D(n)||n==r||(r=n,e())}),1e3*n)}),(()=>{A(o,clearInterval),o=void 0}))},e.createSessionPersister=(e,t)=>Ee(e,t,sessionStorage),e.createStore=Pe,e.defaultSorter=Ie,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs")):"function"==typeof define&&define.amd?define(["exports","fs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={},e.fs);
