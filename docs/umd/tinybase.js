var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",n=t(s),a=t(!0),o=t(0),r=t(t),l="type",i="default",c="Listener",d="Result",u="add",h="Has",g="Ids",f="Table",L=f+"s",w=f+g,C="Row",T=C+"Count",I=C+g,v="Sorted"+C+g,R="Cell",S=R+g,p="Value",y=p+"s",b=p+g,m=e=>s+e,V=(e,t)=>e.startsWith(t),M=(e,t)=>e.endsWith(t),E=(e,t=0)=>e.charCodeAt(t),k=Math.max,x=Math.min,D=isFinite,A=e=>null==e,J=(e,t,s)=>A(e)?s?.():t(e),F=e=>e==n||e==a,Q=e=>t(e)==r,H=e=>Array.isArray(e),P=(e,t,s)=>e.slice(t,s),z=e=>e.length,N=()=>{},O=(e,t)=>e.includes(t),W=(e,t)=>e.every(t),j=(e,t)=>z(e)===z(t)&&W(e,((e,s)=>t[s]===e)),B=(e,t)=>W(e,((s,n)=>0==n||t(e[n-1],s)<=0)),_=(e,t)=>e.sort(t),$=(e,t)=>e.forEach(t),q=(e,t)=>e.map(t),G=e=>U(e,((e,t)=>e+t),0),K=e=>0==z(e),U=(e,t,s)=>e.reduce(t,s),X=(e,...t)=>e.push(...t),Y=e=>e.pop(),Z=e=>e.shift(),ee=Object,te=e=>ee.getPrototypeOf(e),se=ee.entries,ne=ee.keys,ae=ee.isFrozen,oe=ee.freeze,re=e=>!A(e)&&J(te(e),(e=>e==ee.prototype||A(te(e))),(()=>!0)),le=(e,t)=>!A(((e,t)=>J(e,(e=>e[t])))(e,t)),ie=(e,t)=>(delete e[t],e),ce=(e,t)=>q(se(e),(([e,s])=>t(s,e))),de=e=>re(e)&&0==(e=>z(ne(e)))(e),ue=e=>e?.size??0,he=(e,t)=>e?.has(t)??!1,ge=e=>A(e)||0==ue(e),fe=e=>[...e?.values()??[]],Le=e=>e.clear(),we=(e,t)=>e?.forEach(t),Ce=(e,t)=>e?.delete(t),Te=e=>new Map(e),Ie=e=>[...e?.keys()??[]],ve=(e,t)=>e?.get(t),Re=(e,t)=>we(e,((e,s)=>t(s,e))),Se=(e,t,s)=>A(s)?(Ce(e,t),e):e?.set(t,s),pe=(e,t,s)=>(he(e,t)||Se(e,t,s()),ve(e,t)),ye=(e,t,s,n=Se)=>(ce(t,((t,n)=>s(e,n,t))),Re(e,(s=>le(t,s)?0:n(e,s))),e),be=(e,t,s)=>{const n={};return we(e,((e,a)=>{const o=t?t(e,a):e;!s?.(o,e)&&(n[a]=o)})),n},me=(e,t,s)=>be(e,(e=>be(e,t,s)),de),Ve=(e,t,s)=>be(e,(e=>me(e,t,s)),de),Me=(e,t)=>{const s=Te();return we(e,((e,n)=>s.set(n,t?.(e)??e))),s},Ee=e=>Me(e,Me),ke=e=>Me(e,Ee),xe=(e,t,s,n,a=0)=>J((s?pe:ve)(e,t[a],a>z(t)-2?s:Te),(o=>{if(a>z(t)-2)return n?.(o)&&Se(e,t[a]),o;const r=xe(o,t,s,n,a+1);return ge(o)&&Se(e,t[a]),r})),De=e=>{const s=t(e);return F(s)||s==o&&D(e)?s:void 0},Ae=(e,t,s,n,a)=>A(a)?e.delCell(t,s,n,!0):e.setCell(t,s,n,a),Je=(e,t,s)=>A(s)?e.delValue(t):e.setValue(t,s),Fe=e=>new Set(H(e)||A(e)?e:[e]),Qe=(e,t)=>e?.add(t),He=(e,t,s,n,a)=>{const o=e.hasRow,r=Te(),l=Te(),i=Te(),c=Te(),d=Te(),u=Te(),h=(t,s,...n)=>{const a=pe(u,t,Fe);return $(n,(t=>Qe(a,t)&&s&&e.callListener(t))),n},g=(t,...s)=>J(ve(u,t),(n=>{$(K(s)?fe(n):s,(t=>{e.delListener(t),Ce(n,t)})),ge(n)&&Se(u,t)})),f=(e,s)=>{Se(r,e,s),he(l,e)||(Se(l,e,t()),Se(c,e,Te()),Se(d,e,Te()),a(i))},L=e=>{Se(r,e),Se(l,e),Se(c,e),Se(d,e),g(e),a(i)};return[()=>e,()=>Ie(r),e=>Re(l,e),e=>he(l,e),e=>ve(r,e),e=>ve(l,e),(e,t)=>Se(l,e,t),f,(t,n,a,r,l)=>{f(t,n);const i=Te(),u=Te(),L=ve(c,t),w=ve(d,t),C=t=>{const a=s=>e.getCell(n,t,s),c=ve(L,t),d=o(n,t)?s(r(a,t)):void 0;if(c===d||H(c)&&H(d)&&j(c,d)||Se(i,t,[c,d]),!A(l)){const e=ve(w,t),s=o(n,t)?l(a,t):void 0;e!=s&&Se(u,t,s)}},T=e=>{a((()=>{we(i,(([,e],t)=>Se(L,t,e))),we(u,((e,t)=>Se(w,t,e)))}),i,u,L,w,e),Le(i),Le(u)};Re(L,C),e.hasTable(n)&&$(e.getRowIds(n),(e=>{he(L,e)||C(e)})),T(!0),g(t),h(t,0,e.addRowListener(n,null,((e,t,s)=>C(s))),e.addTableListener(n,(()=>T())))},L,e=>n(e,i),()=>Re(u,L),h,g]},Pe=(e,a)=>t(e)==n?t=>t(e):e??(()=>a??s),ze=(e,t)=>{const s=new WeakMap;return n=>{s.has(n)||s.set(n,e(n));const a=s.get(n);return t?.(a),a}},Ne=/^\d+$/,Oe=()=>{const e=[];let t=0;return[n=>(n?Z(e):null)??s+t++,t=>{Ne.test(t)&&z(e)<1e3&&X(e,t)}]},We=e=>{let t;const[n,a]=Oe(),o=Te();return[(a,r,l,i=[],c=(()=>[]))=>{t??=e();const d=n(1);return Se(o,d,[a,r,l,i,c]),Qe(xe(r,l??[s],Fe),d),d},(e,n,...a)=>$(((e,t=[s])=>{const n=[],a=(e,s)=>s==z(t)?X(n,e):null===t[s]?we(e,(e=>a(e,s+1))):$([t[s],null],(t=>a(ve(e,t),s+1)));return a(e,0),n})(e,n),(e=>we(e,(e=>ve(o,e)[0](t,...n??[],...a))))),e=>J(ve(o,e),(([,t,n])=>(xe(t,n??[s],void 0,(t=>(Ce(t,e),ge(t)?1:0))),Se(o,e),a(e),n))),e=>J(ve(o,e),(([e,,s=[],n,a])=>{const o=(...r)=>{const l=z(r);l==z(s)?e(t,...r,...a(r)):A(s[l])?$(n[l]?.(...r)??[],(e=>o(...r,e))):o(...r,s[l])};o()}))]},je=ze((e=>{let t,n,a,o=100,r=Te(),l=Te(),i=1;const c=Te(),d=Te(),[u,h,g]=We((()=>F)),f=Te(),L=Te(),w=[],C=[],T=(t,s)=>{i=0,e.transaction((()=>{const[n,a]=ve(f,s);we(n,((s,n)=>we(s,((s,a)=>we(s,((s,o)=>Ae(e,n,a,o,s[t]))))))),we(a,((s,n)=>Je(e,n,s[t])))})),i=1},I=e=>{Se(f,e),Se(L,e),h(d,[e])},v=(e,t)=>$(((e,t)=>e.splice(0,t))(e,t??z(e)),I),R=()=>v(w,z(w)-o),S=()=>J(t,(()=>{X(w,t),R(),v(C),t=void 0,a=1})),p=()=>{t=Y(w),a=1};let y,b;const m=(e="")=>(A(t)&&(t=s+n++,Se(f,t,[r,l]),x(t,e),r=Te(),l=Te(),a=1),t),V=()=>{K(w)||(((e,...t)=>{e.unshift(...t)})(C,m()),T(0,t),t=Y(w),a=1)},M=()=>{K(C)||(X(w,t),t=Z(C),T(1,t),a=1)},E=()=>{a&&(h(c),a=0)},k=e=>{const t=m(e);return E(),t},x=(e,t)=>(D(e)&&ve(L,e)!==t&&(Se(L,e,t),h(d,[e])),F),D=e=>he(f,e),F={setSize:e=>(o=e,R(),F),addCheckpoint:k,setCheckpoint:x,getStore:()=>e,getCheckpointIds:()=>[[...w],t,[...C]],forEachCheckpoint:e=>Re(L,e),hasCheckpoint:D,getCheckpoint:e=>ve(L,e),goBackward:()=>(V(),E(),F),goForward:()=>(M(),E(),F),goTo:e=>{const s=O(w,e)?V:O(C,e)?M:null;for(;!A(s)&&e!=t;)s();return E(),F},addCheckpointIdsListener:e=>u(e,c),addCheckpointListener:(e,t)=>u(t,d,[e]),delListener:e=>(g(e),F),clear:()=>(v(w),v(C),A(t)||I(t),t=void 0,n=0,k(),F),clearForward:()=>(K(C)||(v(C),h(c)),F),destroy:()=>{e.delListener(y),e.delListener(b)},getListenerStats:()=>({}),_registerListeners:()=>{y=e.addCellListener(null,null,null,((e,t,s,n,a,o)=>{if(i){S();const e=pe(r,t,Te),l=pe(e,s,Te),i=pe(l,n,(()=>[o,void 0]));i[1]=a,i[0]===a&&ge(Se(l,n))&&ge(Se(e,s))&&ge(Se(r,t))&&p(),E()}})),b=e.addValueListener(null,((e,t,s,n)=>{if(i){S();const e=pe(l,t,(()=>[n,void 0]));e[1]=s,e[0]===s&&ge(Se(l,t))&&p(),E()}}))}};return oe(F.clear())}),(e=>e._registerListeners())),Be=(e,t)=>(e??0)<(t??0)?-1:1,_e=ze((e=>{const t=Te(),n=Te(),[a,o,r]=We((()=>I)),[l,i,c,d,u,h,g,,f,L,w,C]=He(e,Te,(e=>A(e)?s:H(e)?q(e,m):m(e)),a,o),T=(t,s,n)=>{const a=u(t);we(n,((t,n)=>s(n,(s=>we(t,(t=>s(t,(s=>e.forEachCell(a,t,s)))))))))},I={setIndexDefinition:(e,s,a,r,l,i=Be)=>{const c=A(l)?void 0:([e],[t])=>l(e,t);return f(e,s,((s,a,l,d,u,f)=>{let L=0;const w=Fe(),C=Fe(),T=h(e);if(we(a,(([e,t],s)=>{const n=Fe(e),a=Fe(t);we(n,(e=>Ce(a,e)?Ce(n,e):0)),we(n,(e=>{Qe(w,e),J(ve(T,e),(t=>{Ce(t,s),ge(t)&&(Se(T,e),L=1)}))})),we(a,(e=>{Qe(w,e),he(T,e)||(Se(T,e,Fe()),L=1),Qe(ve(T,e),s),A(r)||Qe(C,e)}))})),s(),ge(u)||(f?Re(T,(e=>Qe(C,e))):Re(l,(e=>J(ve(d,e),(e=>Qe(C,e))))),we(C,(e=>{const t=(t,s)=>i(ve(u,t),ve(u,s),e),s=[...ve(T,e)];B(s,t)||(Se(T,e,Fe(_(s,t))),Qe(w,e))}))),(L||f)&&!A(c)){const t=[...T];B(t,c)||(g(e,Te(_(t,c))),L=1)}L&&o(t,[e]),we(w,(t=>o(n,[e,t])))}),Pe(a),J(r,Pe)),I},delIndexDefinition:e=>(L(e),I),getStore:l,getIndexIds:i,forEachIndex:e=>c(((t,s)=>e(t,(e=>T(t,e,s))))),forEachSlice:(e,t)=>T(e,t,h(e)),hasIndex:d,hasSlice:(e,t)=>he(h(e),t),getTableId:u,getSliceIds:e=>Ie(h(e)),getSliceRowIds:(e,t)=>fe(ve(h(e),t)),addIndexIdsListener:w,addSliceIdsListener:(e,s)=>a(s,t,[e]),addSliceRowIdsListener:(e,t,s)=>a(s,n,[e,t]),delListener:e=>(r(e),I),destroy:C,getListenerStats:()=>({})};return oe(I)})),$e=Te([["avg",[(e,t)=>G(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>k(...e),(e,t)=>k(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:k(t,e)]],["min",[e=>x(...e),(e,t)=>x(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:x(t,e)]],["sum",[e=>G(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),qe=(e,t,s,n,a,o=!1)=>{if(ge(s))return;const[r,l,i,c]=a;return o||=A(e),we(n,(([s,n])=>{o||(e=A(s)?l?.(e,n,t++):A(n)?i?.(e,s,t--):c?.(e,n,s,t),o||=A(e))})),o?r(fe(s),ue(s)):e},Ge=ze((e=>{const t=Te(),[n,a,o]=We((()=>C)),[r,l,i,c,d,u,h,,g,f,L,w]=He(e,N,(e=>isNaN(e)||A(e)||!0===e||!1===e||e===s?void 0:1*e),n,a),C={setMetricDefinition:(e,s,n,o,r,l,i)=>{const c=Q(n)?[n,r,l,i]:ve($e,n)??ve($e,"sum");return g(e,s,((s,n,o,r,l,i)=>{const d=u(e),g=ue(r);i||=A(d),s();let f=qe(d,g,r,n,c,i);D(f)||(f=void 0),f!=d&&(h(e,f),a(t,[e],f,d))}),Pe(o,1)),C},delMetricDefinition:e=>(f(e),C),getStore:r,getMetricIds:l,forEachMetric:i,hasMetric:c,getTableId:d,getMetric:u,addMetricIdsListener:L,addMetricListener:(e,s)=>n(s,t,[e]),delListener:e=>(o(e),C),destroy:w,getListenerStats:()=>({})};return oe(C)})),Ke=Te(),Ue=Te(),Xe=ze((e=>{const t=e.createStore,n=t(),a=t(),o=Te(),{addListener:r,callListeners:l,delListener:i}=a,[h,g,L,w,p,,,y,,b,m,V,M,E]=He(e,(()=>!0),N,r,l),k=(e,t,...s)=>$(s,(s=>Qe(pe(pe(o,t,Te),e,Fe),s))),x=e=>{J(ve(o,e),(e=>{Re(e,((e,t)=>we(t,(t=>e.delListener(t))))),Le(e)})),$([a,n],(t=>t.delTable(e)))},D=(e,t,s)=>k(t,e,t.addStartTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),F={setQueryDefinition:(t,o,r)=>{y(t,o),x(t);const l=[],i=[[null,[o,null,null,[],Te()]]],c=[],d=[],u=[];r({select:(e,t)=>{const n=Q(e)?[z(l)+s,e]:[A(t)?e:t,s=>s(e,t)];return X(l,n),{as:e=>n[0]=e}},join:(e,t,s)=>{const n=A(s)||Q(t)?null:t,a=A(n)?t:s,o=[e,[e,n,Q(a)?a:e=>e(a),[],Te()]];return X(i,o),{as:e=>o[0]=e}},where:(e,t,s)=>X(c,Q(e)?e:A(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,a)=>{const o=[e,[e,Q(t)?[t,s,n,a]:ve($e,t)??[(e,t)=>t]]];return X(d,o),{as:e=>o[0]=e}},having:(e,t)=>X(u,Q(e)?e:s=>s(e)===t)});const h=Te(l);if(ge(h))return F;const g=Te(i);Re(g,((e,[,t])=>J(ve(g,t),(({3:t})=>A(e)?0:X(t,e)))));const f=Te(d);let L=n;if(ge(f)&&K(u))L=a;else{D(t,L,a);const e=Te();Re(f,((t,[s,n])=>Qe(pe(e,s,Fe),[t,n])));const s=Fe();Re(h,(t=>he(e,t)?0:Qe(s,t)));const n=Te(),o=(s,n,o,r)=>J(s,(([l,i,c,d])=>{Re(n,((t,[s])=>{const n=pe(l,t,Te),a=ve(n,o),i=r?void 0:s;if(a!==i){const s=Fe([[a,i]]),r=ue(n);Se(n,o,i),we(ve(e,t),(([e,t])=>{const a=qe(d[e],r,n,s,t);d[e]=A(De(a))?null:a}))}})),ge(i)||!W(u,(e=>e((e=>d[e]))))?a.delRow(t,c):A(c)?s[2]=a.addRow(t,d):a.setRow(t,c,d)}));k(L,t,L.addRowListener(t,null,((a,r,l,i)=>{const c=[],d=[],u=Te(),h=L.hasRow(t,l);let g=!h;we(s,(e=>{const[s,n,a]=i(t,l,e);X(c,n),X(d,a),g||=s})),Re(e,(e=>{const[s,,n]=i(t,l,e);(g||s)&&Se(u,e,[n])})),g&&o(xe(n,c,void 0,(([,e])=>(Ce(e,l),ge(e)))),u,l,1),h&&o(xe(n,d,(()=>{const e={};return we(s,(s=>e[s]=L.getCell(t,l,s))),[Te(),Fe(),void 0,e]}),(([,e])=>{Qe(e,l)})),u,l)})))}D(t,e,L);const w=(s,n,a,r)=>{const l=t=>e.getCell(n,a,t);$(r,(n=>{const[a,,o,r,i]=ve(g,n),c=o?.(l,s),[d,u]=ve(i,s)??[];c!=d&&(A(u)||E(t,u),Se(i,s,A(c)?null:[c,...M(t,1,e.addRowListener(a,c,(()=>w(s,a,c,r))))]))})),(s=>{const n=(t,n)=>e.getCell(...A(n)?[o,s,t]:t===o?[o,s,n]:[ve(g,t)?.[0],ve(ve(g,t)?.[4],s)?.[0],n]);L.transaction((()=>W(c,(e=>e(n)))?Re(h,((e,a)=>Ae(L,t,s,e,a(n,s)))):L.delRow(t,s)))})(s)},{3:C}=ve(g,null);return L.transaction((()=>M(t,1,e.addRowListener(o,null,((s,n,a)=>{e.hasRow(o,a)?w(a,o,a,C):(L.delRow(t,a),we(g,(({4:e})=>J(ve(e,a),(([,s])=>{E(t,s),Se(e,a)})))))}))))),F},delQueryDefinition:e=>(x(e),b(e),F),getStore:h,getQueryIds:g,forEachQuery:L,hasQuery:w,getTableId:p,addQueryIdsListener:e=>m((()=>e(F))),delListener:e=>(i(e),F),destroy:V,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=a.getListenerStats();return n}};return ce({[f]:[1,1],[f+S]:[0,1],[T]:[0,1],[I]:[0,1],[v]:[0,5],[C]:[1,2],[S]:[0,2],[R]:[1,3]},(([e,t],s)=>{$(e?["get","has","forEach"]:["get"],(e=>F[e+d+s]=(...t)=>a[e+s](...t))),F[u+d+s+c]=(...e)=>a[u+s+c](...P(e,0,t),((s,...n)=>e[t](F,...n)),!0)})),oe(F)})),Ye=ze((e=>{const t=Te(),n=Te(),a=Te(),o=Te(),[r,l,i]=We((()=>S)),[c,d,u,h,g,f,,,L,w,C,T]=He(e,(()=>[Te(),Te(),Te(),Te()]),(e=>A(e)?void 0:e+s),r,l),I=(e,t,s)=>J(f(e),(([n,,a])=>{if(!he(a,t)){const o=Fe();if(g(e)!=R(e))Qe(o,t);else{let e=t;for(;!A(e)&&!he(o,e);)Qe(o,e),e=ve(n,e)}if(s)return o;Se(a,t,o)}return ve(a,t)})),v=(e,t)=>J(f(e),(([,,e])=>Se(e,t))),R=e=>ve(t,e),S={setRelationshipDefinition:(e,s,r,i)=>(Se(t,e,r),L(e,s,((t,s)=>{const r=Fe(),i=Fe(),c=Fe(),[d,u]=f(e);we(s,(([t,s],n)=>{A(t)||(Qe(i,t),J(ve(u,t),(e=>{Ce(e,n),ge(e)&&Se(u,t)}))),A(s)||(Qe(i,s),he(u,s)||Se(u,s,Fe()),Qe(ve(u,s),n)),Qe(r,n),Se(d,n,s),Re(ve(o,e),(t=>{he(I(e,t),n)&&Qe(c,t)}))})),t(),we(r,(t=>l(n,[e,t]))),we(i,(t=>l(a,[e,t]))),we(c,(t=>{v(e,t),l(o,[e,t])}))}),Pe(i)),S),delRelationshipDefinition:e=>(Se(t,e),w(e),S),getStore:c,getRelationshipIds:d,forEachRelationship:t=>u((s=>t(s,(t=>e.forEachRow(g(s),t))))),hasRelationship:h,getLocalTableId:g,getRemoteTableId:R,getRemoteRowId:(e,t)=>ve(f(e)?.[0],t),getLocalRowIds:(e,t)=>fe(ve(f(e)?.[1],t)),getLinkedRowIds:(e,t)=>A(f(e))?[t]:fe(I(e,t,!0)),addRelationshipIdsListener:C,addRemoteRowIdListener:(e,t,s)=>r(s,n,[e,t]),addLocalRowIdsListener:(e,t,s)=>r(s,a,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(I(e,t),r(s,o,[e,t])),delListener:e=>(v(...i(e)??[]),S),destroy:T,getListenerStats:()=>({})};return oe(S)})),Ze=()=>[s,null],et=()=>[s,Te()],tt=(e,t)=>st(e,((e,s)=>[s,A(e)?null:be(e,t)])),st=([e,t],s)=>s(t,e),nt=([e,t],s,n,a=0)=>{const o=e>s[0];return(!a&&null!==s[1]||o)&&(s[1]=n(t,s[1])),o&&(s[0]=e),s},at=(e,t,s,n)=>{var a;return a=(e,a)=>nt(e,pe(t,a,Ze),((e,t)=>!n||A(e)?s[a]=e??null:(t??=Te(),s[a]={},n(e,t,a),t)),n?0:1),$(se(e),(([e,t])=>a(t,e))),t},ot=e=>[e,e],rt=()=>[Te(),Te()],lt=e=>[...e],it=([e,t])=>e===t,ct=e=>JSON.stringify(e,((e,t)=>t instanceof Map?ee.fromEntries([...t]):t)),dt=JSON.parse,ut=(e,t,s)=>A(e)||!re(e)||de(e)||ae(e)?(s?.(),!1):(ce(e,((s,n)=>{t(s,n)||ie(e,n)})),!de(e)),ht=(e,t,s)=>Se(e,t,ve(e,t)==-s?void 0:s),gt=()=>{let e,t,s,n=!1,a=!1,r=!1,d=!1,g=0;const v=Te(),V=Te(),M=Te(),E=Te(),k=Te(),x=Te(),D=Te(),H=Te(),z=Te(),N=Te(),W=Te(),B=Te(),G=Te(),K=Te(),U=Fe(),Y=Te(),Z=Te(),ee=Te(),te=Te(),se=rt(),ne=rt(),ae=rt(),re=rt(),fe=rt(),xe=rt(),He=rt(),Pe=rt(),ze=rt(),Ne=rt(),je=rt(),_e=rt(),$e=rt(),qe=rt(),Ge=rt(),Ke=rt(),Ue=rt(),Xe=rt(),Ye=rt(),Ze=rt(),et=rt(),tt=rt(),st=Te(),nt=rt(),[at,ft,Lt,wt]=We((()=>Ps)),Ct=e=>{if(!ut(e,((e,t)=>O([l,i],t))))return!1;const t=e[l];return!(!F(t)&&t!=o||(De(e[i])!=t&&ie(e,i),0))},Tt=(t,s)=>(!e||he(W,s)||Gt(s))&&ut(t,((e,t)=>It(s,t,e)),(()=>Gt(s))),It=(e,t,s,n)=>ut(n?s:pt(s,e,t),((n,a)=>J(vt(e,t,a,n),(e=>(s[a]=e,!0)),(()=>!1))),(()=>Gt(e,t))),vt=(t,s,n,a)=>e?J(ve(ve(W,t),n),(e=>De(a)!=e[l]?Gt(t,s,n,a,e[i]):a),(()=>Gt(t,s,n,a))):A(De(a))?Gt(t,s,n,a):a,Rt=(e,t)=>ut(t?e:yt(e),((t,s)=>J(St(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>Kt())),St=(e,s)=>t?J(ve(G,e),(t=>De(s)!=t[l]?Kt(e,s,t[i]):s),(()=>Kt(e,s))):A(De(s))?Kt(e,s):s,pt=(e,t,s)=>(J(ve(B,t),(([n,a])=>{we(n,((t,s)=>{le(e,s)||(e[s]=t)})),we(a,(n=>{le(e,n)||Gt(t,s,n)}))})),e),yt=e=>(t&&(we(K,((t,s)=>{le(e,s)||(e[s]=t)})),we(U,(t=>{le(e,t)||Kt(t)}))),e),bt=e=>ye(W,e,((e,t,s)=>{const n=Te(),a=Fe();ye(pe(W,t,Te),s,((e,t,s)=>{Se(e,t,s),J(s[i],(e=>Se(n,t,e)),(()=>Qe(a,t)))})),Se(B,t,[n,a])}),((e,t)=>{Se(W,t),Se(B,t)})),mt=e=>ye(G,e,((e,t,s)=>{Se(G,t,s),J(s[i],(e=>Se(K,t,e)),(()=>Qe(U,t)))}),((e,t)=>{Se(G,t),Se(K,t),Ce(U,t)})),Vt=e=>de(e)?Es():ys(e),Mt=e=>ye(ee,e,((e,t,s)=>Et(t,s)),((e,t)=>Pt(t))),Et=(e,t)=>ye(pe(ee,e,(()=>(Wt(e,1),Se(Y,e,Oe()),Se(Z,e,Te()),Te()))),t,((t,s,n)=>kt(e,t,s,n)),((t,s)=>zt(e,t,s))),kt=(e,t,s,n,a)=>ye(pe(t,s,(()=>(jt(e,s,1),Te()))),n,((t,n,a)=>xt(e,s,t,n,a)),((n,o)=>Nt(e,t,s,n,o,a))),xt=(e,t,s,n,a)=>{he(s,n)||Bt(e,t,n,1);const o=ve(s,n);a!==o&&(_t(e,t,n,o,a),Se(s,n,a))},Dt=(e,t,s,n,a)=>J(ve(t,s),(t=>xt(e,s,t,n,a)),(()=>kt(e,t,s,pt({[n]:a},e,s)))),At=e=>de(e)?Ds():bs(e),Jt=e=>ye(te,e,((e,t,s)=>Ft(t,s)),((e,t)=>Ot(t))),Ft=(e,t)=>{he(te,e)||$t(e,1);const s=ve(te,e);t!==s&&(qt(e,s,t),Se(te,e,t))},Qt=(e,t)=>{const[s]=ve(Y,e),n=s(t);return he(ve(ee,e),n)?Qt(e,t):n},Ht=e=>ve(ee,e)??Et(e,{}),Pt=e=>Et(e,{}),zt=(e,t,s)=>{const[,n]=ve(Y,e);n(s),kt(e,t,s,{},!0)},Nt=(e,t,s,n,a,o)=>{const r=ve(ve(B,e)?.[0],a);if(!A(r)&&!o)return xt(e,s,n,a,r);const l=t=>{_t(e,s,t,ve(n,t)),Bt(e,s,t,-1),Se(n,t)};A(r)?l(a):Re(n,l),ge(n)&&(jt(e,s,-1),ge(Se(t,s))&&(Wt(e,-1),Se(ee,e),Se(Y,e),Se(Z,e)))},Ot=e=>{const t=ve(K,e);if(!A(t))return Ft(e,t);qt(e,ve(te,e)),$t(e,-1),Se(te,e)},Wt=(e,t)=>ht(v,e,t),jt=(e,t,s)=>ht(pe(E,e,Te),t,s)&&Se(M,e,pe(M,e,(()=>0))+s),Bt=(e,t,s,n)=>{const a=ve(Z,e),o=ve(a,s)??0;(0==o&&1==n||1==o&&-1==n)&&ht(pe(V,e,Te),s,n),Se(a,s,o!=-n?o+n:null),ht(pe(pe(k,e,Te),t,Te),s,n)},_t=(e,t,s,n,a)=>pe(pe(pe(x,e,Te),t,Te),s,(()=>[n,0]))[1]=a,$t=(e,t)=>ht(D,e,t),qt=(e,t,s)=>pe(H,e,(()=>[t,0]))[1]=s,Gt=(e,t,s,n,a)=>(X(pe(pe(pe(z,e,Te),t,Te),s,(()=>[])),n),a),Kt=(e,t,s)=>(X(pe(N,e,(()=>[])),t),s),Ut=(e,t,s)=>J(ve(ve(ve(x,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...ot(gs(e,t,s))])),Xt=e=>J(ve(H,e),(([e,t])=>[!0,e,t]),(()=>[!1,...ot(ws(e))])),Yt=e=>ge(z)||ge(Ke[e])?0:we(e?ke(z):z,((t,s)=>we(t,((t,n)=>we(t,((t,a)=>ft(Ke[e],[s,n,a],t))))))),Zt=e=>ge(N)||ge(Ue[e])?0:we(e?Me(N):N,((t,s)=>ft(Ue[e],[s],t))),es=(e,t,s,n)=>{if(!ge(e))return ft(t,n,(()=>be(e))),Re(e,((e,t)=>ft(s,[...n??[],e],1==t))),1},ts=e=>{const t=Cs();t!=r&&ft(se[e],void 0,t);const s=ge(Ne[e]),n=ge($e[e])&&ge(qe[e])&&ge(ze[e])&&ge(je[e])&&ge(xe[e])&&ge(He[e])&&ge(Pe[e])&&s&&ge(ae[e])&&ge(re[e]),a=ge(Ge[e])&&ge(_e[e])&&ge(fe[e])&&ge(ne[e]);if(!n||!a){const t=e?[Me(v),Ee(V),Me(M),Ee(E),ke(k),ke(x)]:[v,V,M,E,k,x];if(!n){es(t[0],ae[e],re[e]),we(t[1],((t,s)=>es(t,xe[e],He[e],[s]))),we(t[2],((t,s)=>{0!=t&&ft(Pe[e],[s],cs(s))}));const n=Fe();we(t[3],((t,a)=>{es(t,ze[e],je[e],[a])&&!s&&(ft(Ne[e],[a,null]),Qe(n,a))})),s||we(t[5],((t,s)=>{if(!he(n,s)){const n=Fe();we(t,(e=>we(e,(([t,s],a)=>s!==t?Qe(n,a):Ce(e,a))))),we(n,(t=>ft(Ne[e],[s,t])))}})),we(t[4],((t,s)=>we(t,((t,n)=>es(t,$e[e],qe[e],[s,n])))))}if(!a){let s;we(t[5],((t,n)=>{let a;we(t,((t,o)=>{let r;we(t,(([t,l],i)=>{l!==t&&(ft(Ge[e],[n,o,i],l,t,Ut),s=a=r=1)})),r&&ft(_e[e],[n,o],Ut)})),a&&ft(fe[e],[n],Ut)})),s&&ft(ne[e],void 0,Ut)}}},ss=e=>{const t=Ss();t!=d&&ft(Xe[e],void 0,t);const s=ge(Ze[e])&&ge(et[e]),n=ge(tt[e])&&ge(Ye[e]);if(!s||!n){const t=e?[Me(D),Me(H)]:[D,H];if(s||es(t[0],Ze[e],et[e]),!n){let s;we(t[1],(([t,n],a)=>{n!==t&&(ft(tt[e],[a],n,t,Xt),s=1)})),s&&ft(Ye[e],void 0,Xt)}}},ns=(e,...t)=>(Fs((()=>e(...q(t,m)))),Ps),as=()=>[be(x,((e,t)=>-1===ve(v,t)?null:be(e,((e,s)=>-1===ve(ve(E,t),s)?null:be(e,(([,e])=>e??null),((e,t)=>it(t)))),de)),de),be(H,(([,e])=>e??null),((e,t)=>it(t)))],os=()=>({cellsTouched:n,valuesTouched:a,changedCells:Ve(x,lt,it),invalidCells:Ve(z),changedValues:be(H,lt,it),invalidValues:be(N),changedTableIds:be(v),changedRowIds:me(E),changedCellIds:Ve(k),changedValueIds:be(D)}),rs=()=>Ve(ee),ls=()=>Ie(ee),is=e=>Ie(ve(Z,m(e))),cs=e=>ue(ve(ee,m(e))),ds=e=>Ie(ve(ee,m(e))),us=(e,t,s,n=0,a)=>{return q(P(_((o=ve(ee,m(e)),r=(e,s)=>[A(t)?s:ve(e,m(t)),s],q([...o?.entries()??[]],(([e,t])=>r(t,e)))),(([e],[t])=>Be(e,t)*(s?-1:1))),n,A(a)?a:n+a),(([,e])=>e));var o,r},hs=(e,t)=>Ie(ve(ve(ee,m(e)),m(t))),gs=(e,t,s)=>ve(ve(ve(ee,m(e)),m(t)),m(s)),fs=()=>be(te),Ls=()=>Ie(te),ws=e=>ve(te,m(e)),Cs=()=>!ge(ee),Ts=e=>he(ee,m(e)),Is=(e,t)=>he(ve(Z,m(e)),m(t)),vs=(e,t)=>he(ve(ee,m(e)),m(t)),Rs=(e,t,s)=>he(ve(ve(ee,m(e)),m(t)),m(s)),Ss=()=>!ge(te),ps=e=>he(te,m(e)),ys=e=>ns((()=>(e=>ut(e,Tt,Gt))(e)?Mt(e):0)),bs=e=>ns((()=>Rt(e)?Jt(e):0)),ms=e=>{try{Vt(dt(e))}catch{}return Ps},Vs=t=>ns((()=>{if((e=ut(t,(e=>ut(e,Ct))))&&(bt(t),!ge(ee))){const e=rs();Es(),ys(e)}})),Ms=e=>ns((()=>{if(t=(e=>ut(e,Ct))(e)){const s=fs();Js(),Ds(),t=!0,mt(e),bs(s)}})),Es=()=>ns((()=>Mt({}))),ks=e=>ns((e=>he(ee,e)?Pt(e):0),e),xs=(e,t)=>ns(((e,t)=>J(ve(ee,e),(s=>he(s,t)?zt(e,s,t):0))),e,t),Ds=()=>ns((()=>Jt({}))),As=()=>ns((()=>{bt({}),e=!1})),Js=()=>ns((()=>{mt({}),t=!1})),Fs=(e,t)=>{if(-1!=g){Qs();const s=e();return Hs(t),s}},Qs=()=>(-1!=g&&g++,1==g&&ft(st,void 0,as,os),Ps),Hs=e=>(g>0&&(g--,0==g&&(n=!ge(x),a=!ge(H),g=1,Yt(1),n&&ts(1),Zt(1),a&&ss(1),e?.(as,os)&&(we(x,((e,t)=>we(e,((e,s)=>we(e,(([e],n)=>Ae(Ps,t,s,n,e))))))),we(H,(([e],t)=>Je(Ps,t,e))),n=a=!1),ft(nt[0],void 0,as,os),g=-1,Yt(0),n&&ts(0),Zt(0),a&&ss(0),ft(nt[1],void 0,as,os),s?.(Ps,as,os),g=0,n=a=!1,r=Cs(),d=Ss(),$([v,V,M,E,k,x,z,D,H,N],Le))),Ps),Ps={getContent:()=>[rs(),fs()],getTables:rs,getTableIds:ls,getTable:e=>me(ve(ee,m(e))),getTableCellIds:is,getRowCount:cs,getRowIds:ds,getSortedRowIds:us,getRow:(e,t)=>be(ve(ve(ee,m(e)),m(t))),getCellIds:hs,getCell:gs,getValues:fs,getValueIds:Ls,getValue:ws,hasTables:Cs,hasTable:Ts,hasTableCell:Is,hasRow:vs,hasCell:Rs,hasValues:Ss,hasValue:ps,getTablesJson:()=>ct(ee),getValuesJson:()=>ct(te),getJson:()=>ct([ee,te]),getTablesSchemaJson:()=>ct(W),getValuesSchemaJson:()=>ct(G),getSchemaJson:()=>ct([W,G]),hasTablesSchema:()=>e,hasValuesSchema:()=>t,setContent:([e,t])=>ns((()=>{(de(e)?Es:ys)(e),(de(t)?Ds:bs)(t)})),setTables:ys,setTable:(e,t)=>ns((e=>Tt(t,e)?Et(e,t):0),e),setRow:(e,t,s)=>ns(((e,t)=>It(e,t,s)?kt(e,Ht(e),t,s):0),e,t),addRow:(e,t,s=!0)=>Fs((()=>{let n;return It(e,n,t)&&(e=m(e),kt(e,Ht(e),n=Qt(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>ns(((e,t)=>{if(It(e,t,s,1)){const n=Ht(e);ce(s,((s,a)=>Dt(e,n,t,a,s)))}}),e,t),setCell:(e,t,s,n)=>ns(((e,t,s)=>J(vt(e,t,s,Q(n)?n(gs(e,t,s)):n),(n=>Dt(e,Ht(e),t,s,n)))),e,t,s),setValues:bs,setPartialValues:e=>ns((()=>Rt(e,1)?ce(e,((e,t)=>Ft(t,e))):0)),setValue:(e,t)=>ns((e=>J(St(e,Q(t)?t(ws(e)):t),(t=>Ft(e,t)))),e),setTransactionChanges:e=>ns((()=>{ce(e[0],((e,t)=>A(e)?ks(t):ce(e,((e,s)=>A(e)?xs(t,s):ce(e,((e,n)=>Ae(Ps,t,s,n,e))))))),ce(e[1],((e,t)=>Je(Ps,t,e)))})),setTablesJson:ms,setValuesJson:e=>{try{At(dt(e))}catch{}return Ps},setJson:e=>ns((()=>{try{const[t,s]=dt(e);Vt(t),At(s)}catch{ms(e)}})),setTablesSchema:Vs,setValuesSchema:Ms,setSchema:(e,t)=>ns((()=>{Vs(e),Ms(t)})),delTables:Es,delTable:ks,delRow:xs,delCell:(e,t,s,n)=>ns(((e,t,s)=>J(ve(ee,e),(a=>J(ve(a,t),(o=>he(o,s)?Nt(e,a,t,o,s,n):0))))),e,t,s),delValues:Ds,delValue:e=>ns((e=>he(te,e)?Ot(e):0),e),delTablesSchema:As,delValuesSchema:Js,delSchema:()=>ns((()=>{As(),Js()})),transaction:Fs,startTransaction:Qs,finishTransaction:Hs,forEachTable:e=>we(ee,((t,s)=>e(s,(e=>we(t,((t,s)=>e(s,(e=>Re(t,e))))))))),forEachTableCell:(e,t)=>Re(ve(Z,m(e)),t),forEachRow:(e,t)=>we(ve(ee,m(e)),((e,s)=>t(s,(t=>Re(e,t))))),forEachCell:(e,t,s)=>Re(ve(ve(ee,m(e)),m(t)),s),forEachValue:e=>Re(te,e),addSortedRowIdsListener:(e,t,s,n,a,o,r)=>{let l=us(e,t,s,n,a);return at((()=>{const r=us(e,t,s,n,a);j(r,l)||(l=r,o(Ps,e,t,s,n,a,l))}),Ne[r?1:0],[e,t],[ls])},addStartTransactionListener:e=>at(e,st),addWillFinishTransactionListener:e=>at(e,nt[0]),addDidFinishTransactionListener:e=>at(e,nt[1]),callListener:e=>(wt(e),Ps),delListener:e=>(Lt(e),Ps),getListenerStats:()=>({}),createStore:gt,addListener:at,callListeners:ft,addPostTransactionListener:e=>{s=e}};return ce({[h+L]:[0,se,[],()=>[Cs()]],[L]:[0,ne],[w]:[0,ae],[h+f]:[1,re,[ls],e=>[Ts(...e)]],[f]:[1,fe,[ls]],[f+S]:[1,xe,[ls]],[h+f+R]:[2,He,[ls,is],e=>[Is(...e)]],[T]:[1,Pe,[ls]],[I]:[1,ze,[ls]],[h+C]:[2,je,[ls,ds],e=>[vs(...e)]],[C]:[2,_e,[ls,ds]],[S]:[2,$e,[ls,ds]],[h+R]:[3,qe,[ls,ds,hs],e=>[Rs(...e)]],[R]:[3,Ge,[ls,ds,hs],e=>ot(gs(...e))],InvalidCell:[3,Ke],[h+y]:[0,Xe,[],()=>[Ss()]],[y]:[0,Ye],[b]:[0,Ze],[h+p]:[1,et,[Ls],e=>[ps(...e)]],[p]:[1,tt,[Ls],e=>ot(ws(e[0]))],InvalidValue:[1,Ue]},(([e,t,s,n],a)=>{Ps[u+a+c]=(...a)=>at(a[e],t[a[e+1]?1:0],e>0?P(a,0,e):void 0,s,n)})),oe(Ps)},ft=2**36,Lt=2**30,wt=2**24,Ct=2**18,Tt=4096,It=64,vt=e=>String.fromCharCode(48+(63&e)),Rt=(e,t)=>E(e,t)-48,St={HasTable:1,Table:1,TableCellIds:1,HasTableCell:2,RowCount:1,RowIds:1,SortedRowIds:5,HasRow:2,Row:2,CellIds:2,HasCell:3,Cell:3,HasValue:1,Value:1,InvalidCell:3,InvalidValue:1};e.createCheckpoints=je,e.createCustomPersister=(e,t,s,n,a,o,[r,l]=[],i=[])=>{let c,d,u,h=0,g=0;pe(Ke,i,(()=>0)),pe(Ue,i,(()=>[]));const f=async e=>(2!=h&&(h=1,await L.schedule((async()=>{await e(),h=0}))),L),L={load:async(s,n)=>await f((async()=>{try{e.setContent(await t())}catch{e.setContent([s,n])}})),startAutoLoad:async(s={},a={})=>(L.stopAutoLoad(),await L.load(s,a),g=1,u=n((async(s,n)=>{if(n){const t=n();await f((async()=>e.setTransactionChanges(t)))}else await f((async()=>{try{e.setContent(s?.()??await t())}catch(e){o?.(e)}}))})),L),stopAutoLoad:()=>(g&&(a(u),u=void 0,g=0),L),save:async t=>(1!=h&&(h=2,await L.schedule((async()=>{try{await s(e.getContent,t)}catch(e){o?.(e)}h=0}))),L),startAutoSave:async()=>(await L.stopAutoSave().save(),c=e.addDidFinishTransactionListener(((e,t)=>{const[s,n]=t();de(s)&&de(n)||L.save((()=>[s,n]))})),L),stopAutoSave:()=>(J(c,e.delListener),c=void 0,L),schedule:async(...e)=>(X(ve(Ue,i),...e),await(async()=>{if(!ve(Ke,i)){for(Se(Ke,i,1);!A(d=Z(ve(Ue,i)));)try{await d()}catch(e){o?.(e)}Se(Ke,i,0)}})(),L),getStore:()=>e,destroy:()=>L.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return r&&(L[r]=()=>l),oe(L)},e.createIndexes=_e,e.createMergeableStore=e=>{let t=1;const[n,a]=(e=>{let t=0,s=0;const n=U(((e,t="",s)=>e.split(t,s))(e),((e,t)=>(e<<5)+e^E(t)),5381)>>>0,a=e=>{const n=t,[a,o]=A(e)?[0,0]:[Rt(r=e,0)*ft+Rt(r,1)*Lt+Rt(r,2)*wt+Rt(r,3)*Ct+Rt(r,4)*Tt+Rt(r,5)*It+Rt(r,6),Rt(r,7)*Ct+Rt(r,8)*Tt+Rt(r,9)*It+Rt(r,10),Rt(r,11)*wt+Rt(r,12)*Ct+Rt(r,13)*Tt+Rt(r,14)*It+Rt(r,15)];var r;t=Math.max(n,a,Date.now()),s=t==n?t==a?Math.max(s,o):s:t==a?o:-1};return[()=>{return a(),o=++s,r=n,vt((e=t)/ft)+vt(e/Lt)+vt(e/wt)+vt(e/Ct)+vt(e/Tt)+vt(e/It)+vt(e)+vt(o/Ct)+vt(o/Tt)+vt(o/It)+vt(o)+vt(r/wt)+vt(r/Ct)+vt(r/Tt)+vt(r/It)+vt(r);var e,o,r},a]})(e),o=gt(),r=[s,[et(),et()]],l=e=>{const s=[{},{}];return a(e[0]),nt(e,r,(([e,t],[n,a])=>[nt(e,n,((e,t)=>at(e,t,s[0],((e,t,n)=>at(e,t,s[0][n],((e,t,a)=>at(e,t,s[0][n][a]))))))),nt(t,a,((e,t)=>at(e,t,s[1])))])),t=0,o.setTransactionChanges(s),t=1,i},i={getMergeableContent:()=>st(r,(([e,t],s)=>[s,[tt(e,(e=>tt(e,(e=>tt(e,lt))))),tt(t,lt)]])),applyMergeableContent:l,merge:e=>{const t=i.getMergeableContent(),s=e.getMergeableContent();return e.applyMergeableContent(t),l(s)}};return o.addPostTransactionListener(((e,s)=>{if(t){const e=n(),[t,a]=s(),[o,l]=r[1];r[0]=e,de(t)||(o[0]=e,ce(t,((t,s)=>{const n=pe(o[1],s,Ze);if(n[0]=e,A(t))n[1]=null;else{const s=n[1]??=Te();ce(t,((t,n)=>{const a=pe(s,n,Ze);if(a[0]=e,A(t))a[1]=null;else{const s=a[1]??=Te();ce(t,((t,n)=>Se(s,n,[e,t])))}}))}}))),de(a)||(l[0]=e,ce(a,((t,s)=>{Se(l[1],s,[e,t])})))}})),ce(o,((e,t)=>i[t]=V(t,"set")||V(t,"del")||M(t,"Transaction")||"callListener"==t?(...t)=>(e(...t),i):V(t,"add")&&M(t,"Listener")?(...s)=>{const n=St[P(t,3,-8)]??0,a=s[n];return s[n]=(e,...t)=>a(i,...t),e(...s)}:e)),oe(i)},e.createMetrics=Ge,e.createQueries=Xe,e.createRelationships=Ye,e.createStore=gt,e.defaultSorter=Be},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={});
