var e,t;e=this,t=function(e,t){"use strict";const s=e=>typeof e,n="",o=s(n),r=s(!0),a=s(0),i=s(s),l="type",c="default",d="utf8",u="Listener",f="Result",h="add",g="Table",w="RowIds",L="CellIds",p="Cell",v=(e,t)=>e.includes(t),R=(e,t)=>e.every(t),I=(e,t)=>R(e,((s,n)=>0==n||t(e[n-1],s)<=0)),y=(e,t)=>e.sort(t),S=(e,t)=>e.forEach(t),T=(e,t)=>e.map(t),b=e=>E(e,((e,t)=>e+t),0),C=e=>e.length,m=e=>0==C(e),E=(e,t,s)=>e.reduce(t,s),k=(e,t,s)=>e.slice(t,s),M=(e,...t)=>e.push(...t),x=e=>e.pop(),D=e=>e.shift(),A=e=>JSON.stringify(e,((e,t)=>j(t,Map)?E([...t],((e,[t,s])=>(e[t]=s,e)),{}):t)),F=JSON.parse,P=Math.max,J=Math.min,Q=isFinite,j=(e,t)=>e instanceof t,O=e=>null==e,z=(e,t,s)=>O(e)?s?.():t(e),N=e=>e==o||e==r,W=e=>s(e)==i,B=()=>{},_=e=>e.size,q=(e,t)=>e?.has(t)??!1,H=e=>O(e)||0==_(e),$=e=>[...e?.values()??[]],G=e=>e.clear(),K=(e,t)=>e?.forEach(t),U=(e,t)=>e?.delete(t),V=e=>new Map(e),X=e=>[...e?.keys()??[]],Y=(e,t)=>e?.get(t),Z=(e,t)=>K(e,((e,s)=>t(s,e))),ee=(e,t,s)=>O(s)?(U(e,t),e):e?.set(t,s),te=(e,t,s)=>(q(e,t)||ee(e,t,s()),Y(e,t)),se=(e,t,s)=>{const n={},o=t??(e=>e);return K(e,((e,t)=>z(o(e),(e=>s?.(e)?0:n[t]=e)))),n},ne=(e,t)=>{const s=V(),n=t??(e=>e);return K(e,((e,t)=>s.set(t,n(e)))),s},oe=e=>ne(e,ne),re=(e,t,s,n,o=0)=>z((s?te:Y)(e,t[o],o>C(t)-2?s:V),(r=>{if(o>C(t)-2)return n?.(r)&&ee(e,t[o]),r;const a=re(r,t,s,n,o+1);return H(r)&&ee(e,t[o]),a})),ae=e=>new Set(e),ie=(e,t)=>e?.add(t),le=(e,t,s)=>{const n=e.hasRow,o=V(),r=V(),a=V(),i=V(),l=V(),c=(t,s,...n)=>{const o=te(l,t,ae);return S(n,(t=>ie(o,t)&&s&&e.callListener(t))),n},d=(t,...s)=>z(Y(l,t),(n=>{S(m(s)?$(n):s,(t=>{e.delListener(t),U(n,t)})),H(n)&&ee(l,t)})),u=(e,s)=>{ee(o,e,s),q(r,e)||(ee(r,e,t()),ee(a,e,V()),ee(i,e,V()))},f=e=>{ee(o,e),ee(r,e),ee(a,e),ee(i,e),d(e)};return[()=>e,()=>X(o),e=>Z(r,e),e=>q(r,e),e=>Y(o,e),e=>Y(r,e),(e,t)=>ee(r,e,t),u,(t,o,r,l,f)=>{u(t,o);const h=V(),g=V(),w=Y(a,t),L=Y(i,t),p=t=>{const r=s=>e.getCell(o,t,s),a=Y(w,t),i=n(o,t)?s(l(r,t)):void 0;if(a!=i&&ee(h,t,[a,i]),!O(f)){const e=Y(L,t),s=n(o,t)?f(r,t):void 0;e!=s&&ee(g,t,s)}},v=e=>{r((()=>{K(h,(([,e],t)=>ee(w,t,e))),K(g,((e,t)=>ee(L,t,e)))}),h,g,w,L,e),G(h),G(g)};Z(w,p),e.hasTable(o)&&S(e.getRowIds(o),(e=>{q(w,e)||p(e)})),v(!0),d(t),c(t,0,e.addRowListener(o,null,((e,t,s)=>p(s))),e.addTableListener(o,(()=>v())))},f,()=>Z(l,f),c,d]},ce=(e,t)=>s(e)==o?t=>t(e):e??(()=>t??n),de=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},ue=/^\d+$/,fe=()=>{const e=[];let t=0;return[()=>D(e)??n+t++,t=>{ue.test(t)&&C(e)<1e3&&M(e,t)}]},he=e=>{let t;const[s,o]=fe(),r=V();return[(o,a,i)=>{t??=e();const l=s();return ee(r,l,[o,a,i]),ie(re(a,i??[n],ae),l),l},(e,s,...o)=>S(((e,t=[n])=>{const s=[],o=(e,n)=>n==C(t)?M(s,e):null===t[n]?K(e,(e=>o(e,n+1))):S([t[n],null],(t=>o(Y(e,t),n+1)));return o(e,0),s})(e,s),(e=>K(e,(e=>Y(r,e)[0](t,...s??[],...o))))),e=>z(Y(r,e),(([,t,s])=>(re(t,s??[n],void 0,(t=>(U(t,e),H(t)?1:0))),ee(r,e),o(e),s))),(e,s,n)=>z(Y(r,e),(([e,,o=[]])=>{const r=(...a)=>{const i=C(a);i==C(o)?e(t,...a,...n(a)):O(o[i])?S(s[i](...a),(e=>r(...a,e))):r(...a,o[i])};r()}))]},ge=Object,we=ge.keys,Le=ge.isFrozen,pe=ge.freeze,ve=(e,t)=>!O(((e,t)=>z(e,(e=>e[t])))(e,t)),Re=(e,t)=>delete e[t],Ie=(e,t)=>S(ge.entries(e),(([e,s])=>t(s,e))),ye=e=>m(we(e)),Se=e=>{const t=s(e);return N(t)||t==a&&Q(e)?t:void 0},Te=(e,t,s,n,o)=>O(o)?e.delCell(t,s,n,!0):e.setCell(t,s,n,o),be=de((e=>{let t,s,o,r=100,a=V(),i=1;const l=V(),c=V(),[d,u,f]=he((()=>Q)),h=V(),g=V(),w=[],L=[],p=(t,s)=>{i=0,e.transaction((()=>K(Y(h,s),((s,n)=>K(s,((s,o)=>K(s,((s,r)=>Te(e,n,o,r,s[t]))))))))),i=1},R=e=>{ee(h,e),ee(g,e),u(c,[e])},I=(e,t)=>S(((e,t)=>e.splice(0,t))(e,t??C(e)),R),y=()=>I(w,C(w)-r),T=e.addCellListener(null,null,null,((e,s,n,r,l,c)=>{if(i){z(t,(()=>{M(w,t),y(),I(L),t=void 0,o=1}));const e=te(a,s,V),i=te(e,n,V),d=te(i,r,(()=>[c,void 0]));d[1]=l,d[0]===l&&H(ee(i,r))&&H(ee(e,n))&&H(ee(a,s))&&(t=x(w),o=1),A()}})),b=(e="")=>(O(t)&&(t=n+s++,ee(h,t,a),P(t,e),a=V(),o=1),t),E=()=>{m(w)||(L.unshift(b()),p(0,t),t=x(w),o=1)},k=()=>{m(L)||(M(w,t),t=D(L),p(1,t),o=1)},A=()=>{o&&(u(l),o=0)},F=e=>{const t=b(e);return A(),t},P=(e,t)=>(J(e)&&Y(g,e)!==t&&(ee(g,e,t),u(c,[e])),Q),J=e=>q(h,e),Q={setSize:e=>(r=e,y(),Q),addCheckpoint:F,setCheckpoint:P,getStore:()=>e,getCheckpointIds:()=>[[...w],t,[...L]],forEachCheckpoint:e=>Z(g,e),hasCheckpoint:J,getCheckpoint:e=>Y(g,e),goBackward:()=>(E(),A(),Q),goForward:()=>(k(),A(),Q),goTo:e=>{const s=v(w,e)?E:v(L,e)?k:null;for(;!O(s)&&e!=t;)s();return A(),Q},addCheckpointIdsListener:e=>d(e,l),addCheckpointListener:(e,t)=>d(t,c,[e]),delListener:e=>(f(e),Q),clear:()=>(I(w),I(L),O(t)||R(t),t=void 0,s=0,F(),Q),destroy:()=>{e.delListener(T)},getListenerStats:()=>({})};return pe(Q.clear())})),Ce=(e,t)=>e<t?-1:1,me=e=>n+e,Ee=de((e=>{const t=V(),s=V(),[o,r,a,i,l,c,d,,u,f,h]=le(e,V,(e=>O(e)?n:e+n)),[g,w,L]=he((()=>v)),p=(t,s,n)=>{const o=l(t);K(n,((t,n)=>s(n,(s=>K(t,(t=>s(t,(s=>e.forEachCell(o,t,s)))))))))},v={setIndexDefinition:(e,n,o,r,a,i=Ce)=>{const l=O(a)?void 0:([e],[t])=>a(e,t);return u(e,n,((n,o,a,u,f,h)=>{let g=0;const L=ae(),p=ae(),v=c(e);if(K(o,(([e,t],s)=>{O(e)||(ie(L,e),z(Y(v,e),(t=>{U(t,s),H(t)&&(ee(v,e),g=1)}))),O(t)||(ie(L,t),q(v,t)||(ee(v,t,ae()),g=1),ie(Y(v,t),s),O(r)||ie(p,t))})),n(),H(f)||(h?Z(v,(e=>ie(p,e))):Z(a,(e=>z(Y(u,e),(e=>ie(p,e))))),K(p,(e=>{const t=(t,s)=>i(Y(f,t),Y(f,s),e),s=[...Y(v,e)];I(s,t)||(ee(v,e,ae(y(s,t))),ie(L,e))}))),(g||h)&&!O(l)){const t=[...v];I(t,l)||(d(e,V(y(t,l))),g=1)}g&&w(t,[e]),K(L,(t=>w(s,[e,t])))}),ce(o),z(r,ce)),v},delIndexDefinition:e=>(f(e),v),getStore:o,getIndexIds:r,forEachIndex:e=>a(((t,s)=>e(t,(e=>p(t,e,s))))),forEachSlice:(e,t)=>p(e,t,c(e)),hasIndex:i,hasSlice:(e,t)=>q(c(e),t),getTableId:l,getSliceIds:e=>X(c(e)),getSliceRowIds:(e,t)=>$(Y(c(e),t)),addSliceIdsListener:(e,s)=>g(s,t,[e]),addSliceRowIdsListener:(e,t,n)=>g(n,s,[e,t]),delListener:e=>(L(e),v),destroy:h,getListenerStats:()=>({})};return pe(v)})),ke=V([["avg",[(e,t)=>b(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>P(...e),(e,t)=>P(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:P(t,e)]],["min",[e=>J(...e),(e,t)=>J(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:J(t,e)]],["sum",[e=>b(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),Me=(e,t,s,n,o,r=!1)=>{if(H(s))return;const[a,i,l,c]=o;return r||=O(e),K(n,(([s,n])=>{r||(e=O(s)?i?.(e,n,t++):O(n)?l?.(e,s,t--):c?.(e,n,s,t),r||=O(e))})),r?a($(s),_(s)):e},xe=de((e=>{const t=V(),[s,o,r,a,i,l,c,,d,u,f]=le(e,B,(e=>isNaN(e)||O(e)||!0===e||!1===e||e===n?void 0:1*e)),[h,g,w]=he((()=>L)),L={setMetricDefinition:(e,s,n,o,r,a,i)=>{const u=W(n)?[n,r,a,i]:Y(ke,n)??Y(ke,"sum");return d(e,s,((s,n,o,r,a,i)=>{const d=l(e),f=_(r);i||=O(d),s();let h=Me(d,f,r,n,u,i);Q(h)||(h=void 0),h!=d&&(c(e,h),g(t,[e],h,d))}),ce(o,1)),L},delMetricDefinition:e=>(u(e),L),getStore:s,getMetricIds:o,forEachMetric:r,hasMetric:a,getTableId:i,getMetric:l,addMetricListener:(e,s)=>h(s,t,[e]),delListener:e=>(w(e),L),destroy:f,getListenerStats:()=>({})};return pe(L)})),De=(e,t,s,o,r)=>{let a,i=0;const l={load:async s=>{if(2!=i){i=1;const o=await t();O(o)||o==n?e.setTables(s):e.setJson(o),i=0}return l},startAutoLoad:async e=>(l.stopAutoLoad(),await l.load(e),o(l.load),l),stopAutoLoad:()=>(r(),l),save:async()=>(1!=i&&(i=2,await s(e.getJson()),i=0),l),startAutoSave:async()=>(await l.stopAutoSave().save(),a=e.addTablesListener((()=>l.save())),l),stopAutoSave:()=>(z(a,e.delListener),l),getStore:()=>e,destroy:()=>l.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return pe(l)},Ae="storage",Fe=globalThis.window,Pe=(e,t,s)=>{let n;return De(e,(async()=>s.getItem(t)),(async e=>s.setItem(t,e)),(e=>{n=n=>{n.storageArea===s&&n.key===t&&e()},Fe.addEventListener(Ae,n)}),(()=>{Fe.removeEventListener(Ae,n),n=void 0}))},Je=e=>e.headers.get("ETag"),Qe=de((e=>{const t=e.createStore,[s,o,r,a,i,,,l,,c,d,v,I]=le(e,(()=>!0),B),y=t(),T=t(),b=V(),E=(e,t,...s)=>S(s,(s=>ie(te(te(b,t,V),e,ae),s))),x=e=>{z(Y(b,e),(e=>{Z(e,((e,t)=>K(t,(t=>e.delListener(t))))),G(e)})),S([T,y],(t=>t.delTable(e)))},D=(e,t,s)=>E(t,e,t.addWillFinishTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),A={setQueryDefinition:(t,s,o)=>{l(t,s),x(t);const r=[],a=[[null,[s,null,null,[],V()]]],i=[],c=[],d=[];o({select:(e,t)=>{const s=W(e)?[C(r)+n,e]:[O(t)?e:t,s=>s(e,t)];return M(r,s),{as:e=>s[0]=e}},join:(e,t,s)=>{const n=O(s)||W(t)?null:t,o=O(n)?t:s,r=[e,[e,n,W(o)?o:e=>e(o),[],V()]];return M(a,r),{as:e=>r[0]=e}},where:(e,t,s)=>M(i,W(e)?e:O(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,o)=>{const r=[e,[e,W(t)?[t,s,n,o]:Y(ke,t)??[(e,t)=>t]]];return M(c,r),{as:e=>r[0]=e}},having:(e,t)=>M(d,W(e)?e:s=>s(e)===t)});const u=V(r);if(H(u))return A;const f=V(a);Z(f,((e,[,t])=>z(Y(f,t),(({3:t})=>O(e)?0:M(t,e)))));const h=V(c);let g=y;if(H(h)&&m(d))g=T;else{D(t,g,T);const e=V();Z(h,((t,[s,n])=>ie(te(e,s,ae),[t,n])));const s=ae();Z(u,(t=>q(e,t)?0:ie(s,t)));const n=V(),o=(s,n,o,r)=>z(s,(([a,i,l,c])=>{Z(n,((t,[s])=>{const n=te(a,t,V),i=Y(n,o),l=r?void 0:s;if(i!==l){const s=ae([[i,l]]),r=_(n);ee(n,o,l),K(Y(e,t),(([e,t])=>{const o=Me(c[e],r,n,s,t);c[e]=O(Se(o))?null:o}))}})),H(i)||!R(d,(e=>e((e=>c[e]))))?T.delRow(t,l):O(l)?s[2]=T.addRow(t,c):T.setRow(t,l,c)}));E(g,t,g.addRowListener(t,null,((r,a,i,l)=>{const c=[],d=[],u=V(),f=g.hasRow(t,i);let h=!f;K(s,(e=>{const[s,n,o]=l(t,i,e);M(c,n),M(d,o),h||=s})),Z(e,(e=>{const[s,,n]=l(t,i,e);(h||s)&&ee(u,e,[n])})),h&&o(re(n,c,void 0,(([,e])=>(U(e,i),H(e)))),u,i,1),f&&o(re(n,d,(()=>{const e={};return K(s,(s=>e[s]=g.getCell(t,i,s))),[V(),ae(),void 0,e]}),(([,e])=>{ie(e,i)})),u,i)})))}D(t,e,g);const w=(n,o,r,a)=>{const l=t=>e.getCell(o,r,t);S(a,(s=>{const[o,,r,a,i]=Y(f,s),c=r?.(l,n),[d,u]=Y(i,n)??[];c!=d&&(O(u)||I(t,u),ee(i,n,O(c)?null:[c,...v(t,1,e.addRowListener(o,c,(()=>w(n,o,c,a))))]))})),(n=>{const o=(t,o)=>e.getCell(...O(o)?[s,n,t]:t===s?[s,n,o]:[Y(f,t)?.[0],Y(Y(f,t)?.[4],n)?.[0],o]);g.transaction((()=>R(i,(e=>e(o)))?Z(u,((e,s)=>Te(g,t,n,e,s(o,n)))):g.delRow(t,n)))})(n)},{3:L}=Y(f,null);return g.transaction((()=>v(t,1,e.addRowListener(s,null,((n,o,r)=>{e.hasRow(s,r)?w(r,s,r,L):(g.delRow(t,r),K(f,(({4:e})=>z(Y(e,r),(([,s])=>{I(t,s),ee(e,r)})))))}))))),A},delQueryDefinition:e=>(x(e),c(e),A),getStore:s,getQueryIds:o,forEachQuery:r,hasQuery:a,getTableId:i,delListener:e=>(T.delListener(e),A),destroy:d,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=T.getListenerStats();return n}};return Ie({[g]:[1,1],[w]:[0,1],SortedRowIds:[0,5],Row:[1,2],[L]:[0,2],[p]:[1,3]},(([e,t],s)=>{S(e?["get","has","forEach"]:["get"],(e=>A[e+f+s]=(...t)=>T[e+s](...t))),A[h+f+s+u]=(...e)=>T[h+s+u](...k(e,0,t),((s,...n)=>e[t](A,...n)))})),pe(A)})),je=de((e=>{const t=V(),s=V(),o=V(),r=V(),[a,i,l,c,d,u,,,f,h,g]=le(e,(()=>[V(),V(),V(),V()]),(e=>O(e)?void 0:e+n)),[w,L,p]=he((()=>y)),v=(e,t,s)=>z(u(e),(([n,,o])=>{if(!q(o,t)){const r=ae();if(d(e)!=I(e))ie(r,t);else{let e=t;for(;!O(e)&&!q(r,e);)ie(r,e),e=Y(n,e)}if(s)return r;ee(o,t,r)}return Y(o,t)})),R=(e,t)=>z(u(e),(([,,e])=>ee(e,t))),I=e=>Y(t,e),y={setRelationshipDefinition:(e,n,a,i)=>(ee(t,e,a),f(e,n,((t,n)=>{const a=ae(),i=ae(),l=ae(),[c,d]=u(e);K(n,(([t,s],n)=>{O(t)||(ie(i,t),z(Y(d,t),(e=>{U(e,n),H(e)&&ee(d,t)}))),O(s)||(ie(i,s),q(d,s)||ee(d,s,ae()),ie(Y(d,s),n)),ie(a,n),ee(c,n,s),Z(Y(r,e),(t=>{q(v(e,t),n)&&ie(l,t)}))})),t(),K(a,(t=>L(s,[e,t]))),K(i,(t=>L(o,[e,t]))),K(l,(t=>{R(e,t),L(r,[e,t])}))}),ce(i)),y),delRelationshipDefinition:e=>(ee(t,e),h(e),y),getStore:a,getRelationshipIds:i,forEachRelationship:t=>l((s=>t(s,(t=>e.forEachRow(d(s),t))))),hasRelationship:c,getLocalTableId:d,getRemoteTableId:I,getRemoteRowId:(e,t)=>Y(u(e)?.[0],t),getLocalRowIds:(e,t)=>$(Y(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>O(u(e))?[t]:$(v(e,t,!0)),addRemoteRowIdListener:(e,t,n)=>w(n,s,[e,t]),addLocalRowIdsListener:(e,t,s)=>w(s,o,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(v(e,t),w(s,r,[e,t])),delListener:e=>(R(...p(e)),y),destroy:g,getListenerStats:()=>({})};return pe(y)})),Oe=e=>[e,e],ze=()=>[V(),V()],Ne=(e,t,s,n=ee)=>{const o=(r=X(e),a=e=>!ve(t,e),r.filter(a));var r,a;return S(we(t),(n=>s(e,n,t[n]))),S(o,(t=>n(e,t))),e},We=(e,t,s)=>O(e)||!(e=>j(e,ge)&&e.constructor==ge)(e)||ye(e)||Le(e)?(s?.(),!1):(Ie(e,((s,n)=>{t(s,n)||Re(e,n)})),!ye(e)),Be=(e,t,s)=>ee(e,t,Y(e,t)==-s?void 0:s),_e=()=>{let e,t,s=0;const n=V(),o=V(),r=V(),i=V(),d=V(),f=V(),I=V(),b=V(),m=V(),E=ze(),x=ze(),D=ze(),P=ze(),J=ze(),Q=ze(),j=ze(),B=ze(),_=ze(),$=ze(),[re,le,ce,de]=he((()=>dt)),ue=(t,s)=>(!e||q(f,s)||Ge(s))&&We(t,((e,t)=>ge(s,t,e)),(()=>Ge(s))),ge=(e,t,s,n)=>We(n?s:Le(s,e,t),((n,o)=>z(we(e,t,o,n),(e=>(s[o]=e,!0)),(()=>!1))),(()=>Ge(e,t))),we=(t,s,n,o)=>e?z(Y(Y(f,t),n),(e=>Se(o)!=e.type?Ge(t,s,n,o,e.default):o),(()=>Ge(t,s,n,o))):O(Se(o))?Ge(t,s,n,o):o,Le=(e,t,s)=>(z(Y(I,t),(([n,o])=>{K(n,((t,s)=>{ve(e,s)||(e[s]=t)})),K(o,(n=>{ve(e,n)||Ge(t,s,n)}))})),e),be=e=>Ne(f,e,((e,t,s)=>{const n=V(),o=ae();Ne(te(f,t,V),s,((e,t,s)=>{ee(e,t,s),z(s.default,(e=>ee(n,t,e)),(()=>ie(o,t)))})),ee(I,t,[n,o])}),((e,t)=>{ee(f,t),ee(I,t)})),Ee=e=>Ne(m,e,((e,t,s)=>ke(t,s)),((e,t)=>Pe(t))),ke=(e,t)=>Ne(te(m,e,(()=>(je(e,1),V()))),t,((t,s,n)=>Me(e,t,s,n)),((t,s)=>Je(e,t,s))),Me=(e,t,s,n,o)=>Ne(te(t,s,(()=>(qe(e,s,1),V()))),n,((t,n,o)=>xe(e,s,t,n,o)),((n,r)=>Qe(e,t,s,n,r,o))),xe=(e,t,s,n,o)=>{q(s,n)||He(e,t,n,1);const r=Y(s,n);o!==r&&($e(e,t,n,r,o),ee(s,n,o))},De=(e,t,s,n,o)=>z(Y(t,s),(t=>xe(e,s,t,n,o)),(()=>Me(e,t,s,Le({[n]:o},e,s)))),Ae=e=>{const[t]=te(b,e,fe),s=t();return q(Y(m,e),s)?Ae(e):s},Fe=e=>Y(m,e)??ke(e,{}),Pe=e=>ke(e,{}),Je=(e,t,s)=>{const[,n]=te(b,e,fe);n(s),Me(e,t,s,{},!0)},Qe=(e,t,s,n,o,r)=>{const a=Y(Y(I,e)?.[0],o);if(!O(a)&&!r)return xe(e,s,n,o,a);const i=t=>{$e(e,s,t,Y(n,t)),He(e,s,t,-1),ee(n,t)};O(a)?i(o):Z(n,i),H(n)&&(qe(e,s,-1),H(ee(t,s))&&(je(e,-1),ee(m,e)))},je=(e,t)=>Be(n,e,t),qe=(e,t,s)=>Be(te(o,e,V),t,s),He=(e,t,s,n)=>Be(te(te(r,e,V),t,V),s,n),$e=(e,t,s,n,o)=>te(te(te(i,e,V),t,V),s,(()=>[n,0]))[1]=o,Ge=(e,t,s,n,o)=>(M(te(te(te(d,e,V),t,V),s,(()=>[])),n),o),Ke=(e,t,s)=>z(Y(Y(Y(i,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...Oe(ot(e,t,s))])),Ue=e=>H(d)||H(_[e])?0:K(e?ne(d,oe):d,((t,s)=>K(t,((t,n)=>K(t,((t,o)=>le(_[e],[s,n,o],t))))))),Ve=(e,t,s)=>{if(!H(t))return le(e,s),1},Xe=e=>{const t=H(J[e]),s=H(j[e])&&H(P[e])&&t&&H(x[e]),a=H(B[e])&&H(Q[e])&&H(D[e])&&H(E[e]);if(!s||!a){const l=e?[ne(n),oe(o),ne(r,oe),ne(i,oe)]:[n,o,r,i];if(!s){K(l[2],((t,s)=>K(t,((t,n)=>Ve(j[e],t,[s,n])))));const s=ae();K(l[1],((n,o)=>{Ve(P[e],n,[o])&&!t&&(le(J[e],[o,null]),ie(s,o))})),t||K(l[3],((t,n)=>{if(!q(s,n)){const s=ae();K(t,(e=>K(e,(([t,n],o)=>n!==t?ie(s,o):U(e,o))))),K(s,(t=>le(J[e],[n,t])))}})),Ve(x[e],l[0])}if(!a){let t;K(l[3],((s,n)=>{let o;K(s,((s,r)=>{let a;K(s,(([s,i],l)=>{i!==s&&(le(B[e],[n,r,l],i,s,Ke),t=o=a=1)})),a&&le(Q[e],[n,r],Ke)})),o&&le(D[e],[n],Ke)})),t&&le(E[e],void 0,Ke)}}},Ye=(e,...t)=>(it((()=>e(...T(t,me)))),dt),Ze=()=>se(m,(e=>se(e,se))),et=()=>X(m),tt=e=>X(Y(m,me(e))),st=(e,t,s,n=0,o)=>{const r=[];return Z(Y(m,me(e)),((e,s)=>M(r,[O(t)?e:Y(s,me(t)),e]))),T(k(y(r,(([e],[t])=>Ce(e,t)*(s?-1:1))),n,O(o)?o:n+o),(([,e])=>e))},nt=(e,t)=>X(Y(Y(m,me(e)),me(t))),ot=(e,t,s)=>Y(Y(Y(m,me(e)),me(t)),me(s)),rt=e=>Ye((()=>(e=>We(e,ue,Ge))(e)?Ee(e):0)),at=()=>Ye((()=>Ee({}))),it=(e,t)=>{if(-1==s)return;lt();const n=e?.();return ct(t),n},lt=()=>(s++,dt),ct=e=>(s>0&&(s--,0==s&&(t=!H(i),s=1,Ue(1),t&&Xe(1),s=-1,e?.(se(i,(e=>se(e,(e=>se(e,(e=>[...e]),(([e,t])=>e===t))),ye)),ye),se(d,(e=>se(e,se))))&&(s=1,K(i,((e,t)=>K(e,((e,s)=>K(e,(([e],n)=>Te(dt,t,s,n,e))))))),s=-1,t=!1),le($[0],void 0,t),Ue(0),t&&Xe(0),le($[1],void 0,t),s=0,S([i,d,n,o,r],G))),dt),dt={getTables:Ze,getTableIds:et,getTable:e=>se(Y(m,me(e)),se),getRowIds:tt,getSortedRowIds:st,getRow:(e,t)=>se(Y(Y(m,me(e)),me(t))),getCellIds:nt,getCell:ot,hasTables:()=>!H(m),hasTable:e=>q(m,me(e)),hasRow:(e,t)=>q(Y(m,me(e)),me(t)),hasCell:(e,t,s)=>q(Y(Y(m,me(e)),me(t)),me(s)),getJson:()=>A(m),getSchemaJson:()=>A(f),setTables:rt,setTable:(e,t)=>Ye((e=>ue(t,e)?ke(e,t):0),e),setRow:(e,t,s)=>Ye(((e,t)=>ge(me(e),me(t),s)?Me(me(e),Fe(me(e)),me(t),s):0),e,t),addRow:(e,t)=>it((()=>{let s;return ge(e,s,t)&&(e=me(e),Me(e,Fe(e),s=Ae(e),t)),s})),setPartialRow:(e,t,s)=>Ye(((e,t)=>{if(ge(e,t,s,1)){const n=Fe(e);Ie(s,((s,o)=>De(e,n,t,o,s)))}}),e,t),setCell:(e,t,s,n)=>Ye(((e,t,s)=>z(we(e,t,s,W(n)?n(ot(e,t,s)):n),(n=>De(e,Fe(e),t,s,n)))),e,t,s),setJson:e=>{try{"{}"===e?at():rt(F(e))}catch{}return dt},setSchema:t=>Ye((()=>{if((e=(e=>We(e,(e=>We(e,(e=>{if(!We(e,((e,t)=>v([l,c],t))))return!1;const t=e.type;return!(!N(t)&&t!=a||(Se(e.default)!=t&&Re(e,c),0))})))))(t))&&(be(t),!H(m))){const e=Ze();at(),rt(e)}})),delTables:at,delTable:e=>Ye((e=>q(m,e)?Pe(e):0),e),delRow:(e,t)=>Ye(((e,t)=>z(Y(m,e),(s=>q(s,t)?Je(e,s,t):0))),e,t),delCell:(e,t,s,n)=>Ye(((e,t,s)=>z(Y(m,e),(o=>z(Y(o,t),(r=>q(r,s)?Qe(e,o,t,r,s,n):0))))),e,t,s),delSchema:()=>Ye((()=>{be({}),e=!1})),transaction:it,startTransaction:lt,finishTransaction:ct,forEachTable:e=>K(m,((t,s)=>e(s,(e=>K(t,((t,s)=>e(s,(e=>Z(t,e))))))))),forEachRow:(e,t)=>K(Y(m,me(e)),((e,s)=>t(s,(t=>Z(e,t))))),forEachCell:(e,t,s)=>Z(Y(Y(m,me(e)),me(t)),s),addSortedRowIdsListener:(e,t,s,n,o,r,a)=>{let i=st(e,t,s,n,o);return re((()=>{const a=st(e,t,s,n,o);var l,c;c=i,C(l=a)===C(c)&&R(l,((e,t)=>c[t]===e))||(i=a,r(dt,e,t,s,n,o,i))}),J[a?1:0],[e,t])},addWillFinishTransactionListener:e=>re(e,$[0]),addDidFinishTransactionListener:e=>re(e,$[1]),callListener:e=>(de(e,[et,tt,nt],(e=>O(e[2])?[]:Oe(ot(...e)))),dt),delListener:e=>(ce(e),dt),getListenerStats:()=>({}),createStore:_e};return Ie({Tables:[0,E],TableIds:[0,x],[g]:[1,D],[w]:[1,P],Row:[2,Q],[L]:[2,j],[p]:[3,B],InvalidCell:[3,_]},(([e,t],s)=>{dt[h+s+u]=(...s)=>re(s[e],t[s[e+1]?1:0],e>0?k(s,0,e):void 0)})),pe(dt)};e.createCheckpoints=be,e.createCustomPersister=De,e.createFilePersister=(e,s)=>{let n;return De(e,(async()=>{try{return await t.promises.readFile(s,d)}catch{}}),(async e=>{try{await t.promises.writeFile(s,e,d)}catch{}}),(e=>{n=t.watch(s,e)}),(()=>{n?.close(),n=void 0}))},e.createIndexes=Ee,e.createLocalPersister=(e,t)=>Pe(e,t,localStorage),e.createMetrics=xe,e.createQueries=Qe,e.createRelationships=je,e.createRemotePersister=(e,t,s,n)=>{let o,r;return De(e,(async()=>{const e=await fetch(t);return r=Je(e),e.text()}),(async e=>await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:e})),(e=>{o=setInterval((async()=>{const s=await fetch(t,{method:"HEAD"}),n=Je(s);O(r)||O(n)||n==r||(r=n,e())}),1e3*n)}),(()=>{z(o,clearInterval),o=void 0}))},e.createSessionPersister=(e,t)=>Pe(e,t,sessionStorage),e.createStore=_e,e.defaultSorter=Ce,e.id=me,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs")):"function"==typeof define&&define.amd?define(["exports","fs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={},e.fs);
