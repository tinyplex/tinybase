var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a="",s=t(a),n="utf8",o=Promise,r=Math.max,c=e=>null==e,i=(e,t,a)=>c(e)?a?.():t(e),l=(e,t,a)=>e.slice(t,a),g=e=>new o(e),d=Object,y=e=>d.getPrototypeOf(e),u=d.keys,f=d.freeze,h=(e=[])=>d.fromEntries(e),p=e=>(e=>!c(e)&&i(y(e),(e=>e==d.prototype||c(y(e))),(()=>!0)))(e)&&0==(e=>u(e).length)(e),v=(e,t)=>e?.delete(t),w=e=>new Map(e),S=(e,t)=>e?.get(t),b=(e,t)=>((e,t)=>e?.forEach(t))(e,((e,a)=>t(a,e))),C=(e,t,a)=>c(a)?(v(e,t),e):e?.set(t,a),M=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)||C(e,t,a()),S(e,t)},A=w(),m=w(),T=new globalThis.TextEncoder,L=2**36,x=2**30,H=2**24,O=2**18,E=4096,P=64,R=e=>String.fromCharCode(48+(63&e)),k=(e,t)=>((e,t)=>e.charCodeAt(t))(e,t)-48,D=w();h(),h();const N=JSON.parse,I="\n";e.createLocalClient=()=>{const e=""+Math.random();return{send:(t,a,s,n)=>{c(t)?b(D,((t,o)=>t!=e?o(e,a,s,n):0)):S(D,t)?.(e,a,s,n)},onReceive:t=>{C(D,e,t)},destroy:()=>{v(D,e)},getStats:()=>({})}},e.createSyncPersister=(e,n,o=1,l)=>{let d;const{send:y,onReceive:u,destroy:h}=n,[b]=(e=>{let t=0,a=-1;const s=(e=>{let t=2166136261;var a;return a=e=>{t^=e,t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24)},T.encode(e).forEach(a),t>>>0})(e),n=e=>{const s=t,[n,o]=c(e)||""==e?[0,0]:[k(i=e,0)*L+k(i,1)*x+k(i,2)*H+k(i,3)*O+k(i,4)*E+k(i,5)*P+k(i,6),k(i,7)*O+k(i,8)*E+k(i,9)*P+k(i,10),k(i,11)*H+k(i,12)*O+k(i,13)*E+k(i,14)*P+k(i,15)];var i;t=r(s,n,Date.now()),a=t==s?t==n?r(a,o):a:t==n?o:-1};return[()=>{return n(),o=++a,r=s,R((e=t)/L)+R(e/x)+R(e/H)+R(e/O)+R(e/E)+R(e/P)+R(e)+R(o/O)+R(o/E)+R(o/P)+R(o)+R(r/H)+R(r/O)+R(r/E)+R(r/P)+R(r);var e,o,r},n]})(e.getId()),D=w();u(((t,a,s,n)=>{if(0==s)i(S(D,a),(([e,a])=>c(e)||e==t?a(n,t):0));else if(1==s&&W.isAutoLoading())I(t,n).then((e=>d?.(void 0,(()=>e))));else{const o=2==s&&W.isAutoSaving()?e.getMergeableContentHashes():3==s?e.getMergeableTableIdsDiff(n):4==s?e.getMergeableRowIdsDiff(n):5==s?e.getMergeableTablesChanges(n):6==s?e.getMergeableValuesChanges(n):0;0!==o&&y(t,a,0,o)}}));const N=async(e,t,a="")=>g(((s,n)=>{const r=b(),c=setTimeout((()=>{v(D,r),n(`No response from ${e??"anyone"} to '${t}'`)}),1e3*o);C(D,r,[e,(e,t)=>{clearTimeout(c),v(D,r),s([e,t])}]),y(e,r,t,a)})),I=async(t=null,s)=>{c(s)&&([s,t]=await N(t,2));const[n,[o,r]]=s,[,[i,l]]=e.getMergeableContentHashes(),g=[a,[[a,{}],[a,{}],1]];return i!=o&&(g[0]=n,g[1][0]=(await N(t,5,e.getMergeableCellHashes((await N(t,4,e.getMergeableRowHashes((await N(t,3,e.getMergeableTableHashes()))[0])))[0])))[0]),l!=r&&(g[0]=n,g[1][1]=(await N(t,6,e.getMergeableValuesHashes()))[0]),g},W=((e,a,n,o,r,l,g,d={},y=[])=>{let u,h,v,w=0;M(A,y,(()=>0)),M(m,y,(()=>[]));const[b,T,L,x]=((e,t)=>c(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!p(e)||!p(t)]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!p(e)||!p(t)])(0,e),H=async e=>(2!=w&&(w=1,await E.schedule((async()=>{await e(),w=0}))),E),O=a=>{var n;(b&&(n=a?.[0],t(n)==s)?1===a?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===a?.[2]?e.applyChanges:e.setContent)(a)},E={load:async(t,s)=>await H((async()=>{try{O(await a())}catch(a){l?.(a),e.setContent([t,s])}})),startAutoLoad:async(e={},t={})=>(await E.stopAutoLoad().load(e,t),h=o((async(e,t)=>{const s=t?.();await H((async()=>{try{O(s??e?.()??await a())}catch(e){l?.(e)}}))})),E),stopAutoLoad:()=>(h&&(r(h),h=void 0),E),isAutoLoading:()=>!c(h),save:async e=>(1!=w&&(w=2,await E.schedule((async()=>{try{await n(T,e)}catch(e){l?.(e)}w=0}))),E),startAutoSave:async()=>(await E.stopAutoSave().save(),v=e.addDidFinishTransactionListener((()=>{const e=L();x(e)&&E.save((()=>e))})),E),stopAutoSave:()=>(i(v,e.delListener),v=void 0,E),isAutoSaving:()=>!c(v),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(S(m,y),...e),await(async()=>{if(!S(A,y)){for(C(A,y,1);!c((e=S(m,y),u=e.shift()));)try{await u()}catch(e){l?.(e)}C(A,y,0)}var e})(),E),getStore:()=>e,destroy:()=>E.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...d};return f(E)})(e,(async()=>{const e=await I();return e[0]!=a?e:void 0}),(async()=>{y(null,null,1,e.getMergeableContentHashes())}),(e=>d=e),(()=>d=void 0),l,0,{getClient:()=>n,startSync:async()=>await(await W.startAutoLoad()).startAutoSave(),stopSync:()=>W.stopAutoLoad().stopAutoSave(),destroy:()=>(h(),W.stopSync())});return W},e.createWsClient=async e=>{let t;e.on("message",(e=>{if(!c(t)){const a=e.toString(n),s=a.indexOf(I);-1!==s&&t(l(a,0,s),...N(l(a,s+1)))}}));const s={send:(t,...s)=>{e.send((t??a)+I+JSON.stringify(s,((e,t)=>t instanceof Map?d.fromEntries([...t]):t)))},onReceive:e=>{t=e},destroy:()=>{e.close()},getStats:()=>({})};return g(((t,a)=>{e.readyState!=e.OPEN?(e.on("error",a),e.on("open",(()=>t(s)))):t(s)}))},e.createWsSimpleServer=e=>{const t=w();return e.on("connection",((e,s)=>{const o=s.headers["sec-websocket-key"];C(t,o,e),e.on("message",(e=>{const s=e.toString(n),r=s.indexOf(I);if(-1!==r){const e=l(s,0,r),n=l(s,r+1);e===a?b(t,((e,t)=>e!=o?t.send(o+I+n):0)):S(t,e)?.send(o+I+n)}})),e.on("close",(()=>v(t,o)))})),{getWebSocketServer:()=>e,destroy:()=>{e.close(),t.clear()}}}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterSync={});
