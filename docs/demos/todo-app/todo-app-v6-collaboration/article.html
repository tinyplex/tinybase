<nav><ul><li><a href="/">TinyBase</a></li><li><a href="/demos/">Demos</a></li><li><a href="/demos/todo-app/">Todo App</a></li><li><a href="/demos/todo-app/todo-app-v6-collaboration/">Todo App v6 (collaboration)</a></li></ul></nav><section class="s1" id="/demos/todo-app/todo-app-v6-collaboration/" data-id="TA7"><h1>Todo App v6 (collaboration)</h1><iframe srcdoc="&lt;html&gt;&lt;head&gt;&lt;script src=&quot;/umd/react.production.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;/umd/react-dom.production.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;/umd/partysocket.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;/umd/tinybase.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;/umd/persister-browser.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;/umd/persister-partykit-client.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;/umd/ui-react.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;/umd/ui-react-dom-debug.js&quot;&gt;&lt;/script&gt;&lt;style&gt;@font-face{font-family:Inter;src:url(https://tinybase.org/fonts/inter.woff2) format(&#x27;woff2&#x27;)}body{display:grid;grid-template-columns:35% minmax(0,1fr);grid-template-rows:auto auto 1fr;box-sizing:border-box;font-family:Inter,sans-serif;letter-spacing:-.04rem;grid-gap:1rem .5rem;margin:0;min-height:100vh;padding:1rem}body *{box-sizing:border-box;outline-color:#d81b60}#newTodo{border:1px solid #ccc;display:block;font:inherit;letter-spacing:inherit;padding:.5rem;width:100%}#todos{grid-column:2;grid-row:2/span 2;margin:0;padding:0}#todos .todo{background:#fff;border:1px solid #ccc;display:flex;margin-bottom:.5rem;padding:.5rem}#todos .todo .text{cursor:pointer;flex:1;overflow:hidden;text-overflow:ellipsis;user-select:none;white-space:nowrap}#todos .todo .text::before{content:&#x27;\1F7E0&#x27;;padding:0 .5rem 0 .25rem}#todos .todo .text.done{color:#ccc}#todos .todo .text.done::before{content:&#x27;\2705&#x27;}#types{margin:0}#types .type{cursor:pointer;margin-bottom:.5rem;user-select:none}#types .type.current{color:#d81b60}#todos .todo .type{border:none;color:#777;font:inherit;font-size:.8rem;margin-top:.1rem}#undoRedo{grid-column:1;grid-row:3}#undoRedo #redo,#undoRedo #undo{cursor:pointer;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;user-select:none}#undoRedo #redo::before,#undoRedo #undo::before{padding-right:.5rem;vertical-align:middle}#undoRedo #redo.disabled,#undoRedo #undo.disabled{cursor:default;opacity:.3}#undoRedo #undo::before{content:&#x27;\21A9&#x27;}#undoRedo #redo::before{content:&#x27;\21AA&#x27;}#room a,#room span{background:#eee;border:1px solid #ccc;color:#000;cursor:pointer;display:inline-block;padding:.5rem 1rem;text-align:center;text-decoration:none;width:10rem}#room a{border-color:#d81b60;background:#ddd}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;script&gt;(()=&gt;{const l=React[&quot;createElement&quot;],{createCheckpoints:i,createIndexes:d,createMetrics:c,createStore:u}=TinyBase,{createLocalPersister:p,createSessionPersister:y}=TinyBasePersisterBrowser,w=TinyBasePersisterPartyKitClient[&quot;createPartyKitPersister&quot;],m=PartySocketModule[&quot;default&quot;],{CellView:v,Provider:h,SliceView:e,useAddRowCallback:n,useCell:s,useCheckpoints:C,useCreateCheckpoints:S,useCreateIndexes:k,useCreateMetrics:g,useCreatePersister:I,useCreateStore:b,useMetric:r,useRow:x,useSetCellCallback:f,useSetCheckpointCallback:A,useSetValueCallback:P,useValue:R}=TinyBaseUiReact,{useCallback:T,useState:B}=React,M=TinyBaseUiReactDomDebug[&quot;StoreInspector&quot;],D=[&quot;Home&quot;,&quot;Work&quot;,&quot;Archived&quot;],L={todos:{text:{type:&quot;string&quot;},done:{type:&quot;boolean&quot;,default:!1},type:{type:&quot;string&quot;,default:&quot;Home&quot;,allow:D}}},N={todos:{0:{text:&quot;Clean the floor&quot;,type:&quot;Home&quot;},1:{text:&quot;Install TinyBase&quot;,type:&quot;Work&quot;},2:{text:&quot;Book holiday&quot;,type:&quot;Archived&quot;}}},t=()=&gt;{const e=b(()=&gt;u().setTablesSchema(L)),t=S(e,i),[o,a]=(I(e,e=&gt;p(e,&quot;todos/store&quot;),[],async e=&gt;{await e.startAutoLoad(N),t.clear(),await e.startAutoSave()},[t]),O());I(e,e=&gt;{if(o)return w(e,new m({host:W,room:o}))},[o],async e=&gt;{e&amp;&amp;(await e.startAutoSave(),await e.startAutoLoad(),t.clear())},[t]);var r=b(()=&gt;u().setValuesSchema({type:{type:&quot;string&quot;,default:&quot;Home&quot;}})),s=(I(r,e=&gt;y(e,&quot;todos/viewStore&quot;),[],async e=&gt;{await e.startAutoLoad(),await e.startAutoSave()}),k(e,e=&gt;d(e).setIndexDefinition(&quot;types&quot;,&quot;todos&quot;,&quot;type&quot;))),n=g(e,e=&gt;{const o=c(e);return o.setMetricDefinition(&quot;pending&quot;,&quot;todos&quot;,&quot;sum&quot;,e=&gt;e(&quot;done&quot;)?0:1),D.forEach(t=&gt;{o.setMetricDefinition(t,&quot;todos&quot;,&quot;sum&quot;,e=&gt;e(&quot;type&quot;)!=t||e(&quot;done&quot;)?0:1)}),o});return l(h,{store:e,storesById:{viewStore:r},indexes:s,metrics:n,checkpoints:t},l(_,{roomId:o,createRoomId:a}),l($,null),l(E,null),l(H,null),l(V,null),l(M,null))},V=(window.addEventListener(&quot;load&quot;,()=&gt;ReactDOM.createRoot(document.body).render(l(t,null))),()=&gt;{var e=r(&quot;pending&quot;);return 0&lt;e?&quot;Todo: &quot;+e:&quot;All done!&quot;}),$=()=&gt;{const[e,t]=B(&quot;&quot;),o=R(&quot;type&quot;,&quot;viewStore&quot;),a=T(({target:{value:e}})=&gt;t(e),[]),r=A(()=&gt;`adding &#x27;${e}&#x27;`,[e]),s=n(&quot;todos&quot;,({which:e,target:{value:t}})=&gt;13==e&amp;&amp;&quot;&quot;!=t?{text:t,type:o}:null,[o],void 0,()=&gt;{t(&quot;&quot;),r()},[t,r]);return l(&quot;input&quot;,{id:&quot;newTodo&quot;,onChange:a,onKeyDown:s,placeholder:&quot;New Todo&quot;,value:e})},H=()=&gt;l(&quot;ul&quot;,{id:&quot;todos&quot;},l(e,{indexId:&quot;types&quot;,sliceId:R(&quot;type&quot;,&quot;viewStore&quot;),rowComponent:o})),o=e=&gt;l(&quot;li&quot;,{className:&quot;todo&quot;},l(a,{...e}),l(U,{...e})),a=({tableId:e,rowId:t})=&gt;{const{done:o,text:a}=x(e,t),r=&quot;text&quot;+(o?&quot; done&quot;:&quot;&quot;),s=f(e,t,&quot;done&quot;,()=&gt;!o,[o]),n=A(()=&gt;`${o?&quot;resuming&quot;:&quot;completing&quot;} &#x27;${a}&#x27;`,[o]),i=T(()=&gt;{s(),n()},[s,n]);return l(&quot;span&quot;,{className:r,onClick:i},l(v,{tableId:e,rowId:t,cellId:&quot;text&quot;}))},E=()=&gt;l(&quot;ul&quot;,{id:&quot;types&quot;},D.map(e=&gt;l(K,{key:e,type:e}))),K=({type:e})=&gt;{var t=r(e),o=R(&quot;type&quot;,&quot;viewStore&quot;),a=P(&quot;type&quot;,()=&gt;e,[e],&quot;viewStore&quot;),o=&quot;type&quot;+(e==o?&quot; current&quot;:&quot;&quot;);return l(&quot;li&quot;,{className:o,onClick:a},e,0&lt;t?` (${t})`:&quot;&quot;)},U=({tableId:e,rowId:t})=&gt;{const o=s(e,t,&quot;type&quot;),a=C(),r=f(e,t,&quot;type&quot;,({target:{value:e}})=&gt;e,[],void 0,(e,t)=&gt;a.addCheckpoint(`changing to &#x27;${t}&#x27;`),[a]);return l(&quot;select&quot;,{className:&quot;type&quot;,onChange:r,value:o},D.map(e=&gt;l(&quot;option&quot;,null,e)))},W=&quot;partykit-todo-server.tinyplexbot.partykit.dev&quot;,O=()=&gt;{const[e,t]=B(parent.location.search.substring(1));return[e,T(()=&gt;{var e=(&quot;&quot;+Math.random()).substring(2,12);parent.history.replaceState(null,null,&quot;?&quot;+e),t(e)},[])]},_=({roomId:e,createRoomId:t})=&gt;l(&quot;div&quot;,{id:&quot;room&quot;},e?l(&quot;a&quot;,{href:&quot;?&quot;+e,target:&quot;_blank&quot;},&quot;ðŸ”— Share link&quot;):l(&quot;span&quot;,{onClick:t},&quot;ðŸŽˆ Start sharing&quot;))})()&lt;/script&gt;&lt;/html&gt;"></iframe><p>In this version of the Todo app, we use the <a href="https://partykit.io/">PartyKit</a> <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> to make the application collaborative.</p><p>We&#x27;re making changes to the <a href="/demos/todo-app/todo-app-v5-checkpoints/">Todo App v5 (checkpoints)</a> demo.</p><h3 id="server-implementation">Server Implementation</h3><p>To have a collaborative PartyKit experience, you need to deploy a server. <a href="/">TinyBase</a> provides a ready-made PartyKit server that supports the synchronization and storage needed by client apps like this demo.</p><p>The server implementation for this demo is in the top level &#x27;support&#x27; directory of the <a href="/">TinyBase</a> repo for reference. But don&#x27;t get too excited. It is literally just this:</p><pre><code><span class="keyword">import</span> <span class="punctuation">{</span>TinyBasePartyKitServer<span class="punctuation">}</span> <span class="keyword">from</span> <span class="string">'tinybase/persisters/persister-partykit-server'</span><span class="punctuation">;</span>

<span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="class-name">extends</span> TinyBasePartyKitServer <span class="punctuation">{</span><span class="punctuation">}</span>
</code></pre><p>The TinyBasePartyKitServer class does all the work for synchronizing and storing data in the PartyKit cloud. Obviously if you need to enhance your server, you should just be able to extend that TinyBasePartyKitServer class accordingly.</p><p>For the purposes of this demo, this server has been deployed to partykit.dev, and so on the client, we need to set its address:</p><pre><code><span class="keyword">const</span> <span class="constant">PARTYKIT_HOST</span> <span class="operator">=</span> <span class="string">'partykit-todo-server.tinyplexbot.partykit.dev'</span><span class="punctuation">;</span>
</code></pre><p>When running the PartyKit server locally, you would want to set this to &#x27;127.0.0.1:1999&#x27; or something similar.</p><p>Anyway, back to the rest of the client app...</p><h3 id="additional-initialization">Additional Initialization</h3><p>To use the PartyKit <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a>, we will need to add PartyKit itself as a dependency. For the purposes of this demo, we have compiled a UMD version of the PartySocket module:</p><pre><code><span class="unchanged"><span class="prefix"> </span><span class="tag"><span class="tag"><span class="punctuation">&lt;</span>script</span> <span class="attr-name">src</span><span class="attr-value"><span class="punctuation">=</span><span class="punctuation">"</span>/umd/react.production.min.js<span class="punctuation">"</span></span><span class="punctuation">></span></span><span class="script"></span><span class="tag"><span class="tag"><span class="punctuation">&lt;/</span>script</span><span class="punctuation">></span></span>
<span class="prefix"> </span><span class="tag"><span class="tag"><span class="punctuation">&lt;</span>script</span> <span class="attr-name">src</span><span class="attr-value"><span class="punctuation">=</span><span class="punctuation">"</span>/umd/react-dom.production.min.js<span class="punctuation">"</span></span><span class="punctuation">></span></span><span class="script"></span><span class="tag"><span class="tag"><span class="punctuation">&lt;/</span>script</span><span class="punctuation">></span></span>
</span><span class="inserted-sign"><span class="prefix">+</span><span class="tag"><span class="tag"><span class="punctuation">&lt;</span>script</span> <span class="attr-name">src</span><span class="attr-value"><span class="punctuation">=</span><span class="punctuation">"</span>/umd/partysocket.js<span class="punctuation">"</span></span><span class="punctuation">></span></span><span class="script"></span><span class="tag"><span class="tag"><span class="punctuation">&lt;/</span>script</span><span class="punctuation">></span></span>
</span></code></pre><p>We also add the client portion of the <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a>:</p><pre><code><span class="unchanged"><span class="prefix"> </span><span class="tag"><span class="tag"><span class="punctuation">&lt;</span>script</span> <span class="attr-name">src</span><span class="attr-value"><span class="punctuation">=</span><span class="punctuation">"</span>/umd/persister-browser.js<span class="punctuation">"</span></span><span class="punctuation">></span></span><span class="script"></span><span class="tag"><span class="tag"><span class="punctuation">&lt;/</span>script</span><span class="punctuation">></span></span>
</span><span class="inserted-sign"><span class="prefix">+</span><span class="tag"><span class="tag"><span class="punctuation">&lt;</span>script</span> <span class="attr-name">src</span><span class="attr-value"><span class="punctuation">=</span><span class="punctuation">"</span>/umd/persister-partykit-client.js<span class="punctuation">"</span></span><span class="punctuation">></span></span><span class="script"></span><span class="tag"><span class="tag"><span class="punctuation">&lt;/</span>script</span><span class="punctuation">></span></span>
</span></code></pre><p>We add both to the &#x27;imports&#x27; so we can use them throughout the file:</p><pre><code><span class="unchanged"><span class="prefix"> </span><span class="keyword">const</span> <span class="punctuation">{</span>createLocalPersister<span class="punctuation">,</span> createSessionPersister<span class="punctuation">}</span> <span class="operator">=</span> TinyBasePersisterBrowser<span class="punctuation">;</span>
</span><span class="inserted-sign"><span class="prefix">+</span><span class="keyword">const</span> <span class="punctuation">{</span>createPartyKitPersister<span class="punctuation">}</span> <span class="operator">=</span> TinyBasePersisterPartyKitClient<span class="punctuation">;</span>
<span class="prefix">+</span><span class="keyword">const</span> <span class="punctuation">{</span><span class="keyword">default</span><span class="operator">:</span> PartySocket<span class="punctuation">}</span> <span class="operator">=</span> PartySocketModule<span class="punctuation">;</span>
</span></code></pre><h3 id="getting-and-creating-a-room">Getting And Creating A Room</h3><p>To make our application shareable, we need the concept of a &#x27;room&#x27;, which is basically a space on a PartyKit server with shared storage for multiple clients. We want to be able to create a room <a href="/api/common/type-aliases/identity/id/"><code>Id</code></a> from this app that then updates the browser URL so that it can be shared with others.</p><p>There are many more sophisticated ways to this, but we are going for a simple approach of using the URL parameters to store a random room <a href="/api/common/type-aliases/identity/id/"><code>Id</code></a>. We use a hook to store the room <a href="/api/common/type-aliases/identity/id/"><code>Id</code></a> in the App state, and which gets the initial value. It also provides a function that creates a new room and updates the URL accordingly.</p><pre><code><span class="keyword">const</span> <span class="function-variable">useRoomId</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
  <span class="keyword">const</span> <span class="punctuation">[</span>roomId<span class="punctuation">,</span> setRoomId<span class="punctuation">]</span> <span class="operator">=</span> <span class="function">useState</span><span class="punctuation">(</span>parent<span class="punctuation">.</span>location<span class="punctuation">.</span>search<span class="punctuation">.</span><span class="function">substring</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
  <span class="keyword">return</span> <span class="punctuation">[</span>
    roomId<span class="punctuation">,</span>
    <span class="function">useCallback</span><span class="punctuation">(</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
      <span class="keyword">const</span> newRoomId <span class="operator">=</span> <span class="punctuation">(</span><span class="string">''</span> <span class="operator">+</span> Math<span class="punctuation">.</span><span class="function">random</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">.</span><span class="function">substring</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">12</span><span class="punctuation">)</span><span class="punctuation">;</span>
      parent<span class="punctuation">.</span>history<span class="punctuation">.</span><span class="function">replaceState</span><span class="punctuation">(</span><span class="keyword">null</span><span class="punctuation">,</span> <span class="keyword">null</span><span class="punctuation">,</span> <span class="string">'?'</span> <span class="operator">+</span> newRoomId<span class="punctuation">)</span><span class="punctuation">;</span>
      <span class="function">setRoomId</span><span class="punctuation">(</span>newRoomId<span class="punctuation">)</span><span class="punctuation">;</span>
    <span class="punctuation">}</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span>
  <span class="punctuation">]</span><span class="punctuation">;</span>
<span class="punctuation">}</span><span class="punctuation">;</span>
</code></pre><p>Note that this ID generation is, um, not very safe. Instead of a random number you should instead implement or import a true UUID generator if using this in anger!</p><p>Note also that we work with the <code>parent</code> location, rather than the <code>window</code> object. This is because the <a href="/">TinyBase</a> demo runs in a trusted iframe and needs to get the URL from the outer page. Fortunately <code>parent</code> still resolves to <code>window</code> even when this <em>isn&#x27;t</em> running in an iframe.</p><h3 id="persisting-into-the-room">Persisting Into The Room</h3><p>We use this new hook in the top level of the App component, and then create the PartyKit <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a>. We make this conditional: if there is no room <a href="/api/common/type-aliases/identity/id/"><code>Id</code></a> (yet), the useCreatePersister method returns nothing. Once a room <a href="/api/common/type-aliases/identity/id/"><code>Id</code></a> exists, it will instead create the <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a>, using the host of the PartyKit server and the room <a href="/api/common/type-aliases/identity/id/"><code>Id</code></a>.</p><pre><code><span class="unchanged"><span class="prefix"> </span>  <span class="function"><a href="/api/ui-react/functions/persister-hooks/usecreatepersister/">useCreatePersister</a></span><span class="punctuation">(</span>
<span class="prefix"> </span>    store<span class="punctuation">,</span>
<span class="prefix"> </span>    <span class="punctuation">(</span><span class="parameter">store</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="function"><a href="/api/persister-browser/functions/creation/createlocalpersister/">createLocalPersister</a></span><span class="punctuation">(</span>store<span class="punctuation">,</span> <span class="string">'todos/store'</span><span class="punctuation">)</span><span class="punctuation">,</span>
<span class="prefix"> </span>    <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>
<span class="prefix"> </span>    <span class="keyword">async</span> <span class="punctuation">(</span><span class="parameter">persister</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
<span class="prefix"> </span>      <span class="keyword">await</span> persister<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/load/startautoload/">startAutoLoad</a></span><span class="punctuation">(</span><span class="constant">INITIAL_TODOS</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="prefix"> </span>      checkpoints<span class="punctuation">.</span><span class="function"><a href="/api/checkpoints/interfaces/checkpoints/checkpoints/methods/lifecycle/clear/">clear</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="prefix"> </span>      <span class="keyword">await</span> persister<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/save/startautosave/">startAutoSave</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="prefix"> </span>    <span class="punctuation">}</span><span class="punctuation">,</span>
<span class="prefix"> </span>    <span class="punctuation">[</span>checkpoints<span class="punctuation">]</span><span class="punctuation">,</span>
<span class="prefix"> </span>  <span class="punctuation">)</span><span class="punctuation">;</span>
</span><span class="inserted-sign"><span class="prefix">+</span>  <span class="keyword">const</span> <span class="punctuation">[</span>roomId<span class="punctuation">,</span> createRoomId<span class="punctuation">]</span> <span class="operator">=</span> <span class="function">useRoomId</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="prefix">+</span>  <span class="function"><a href="/api/ui-react/functions/persister-hooks/usecreatepersister/">useCreatePersister</a></span><span class="punctuation">(</span>
<span class="prefix">+</span>    store<span class="punctuation">,</span>
<span class="prefix">+</span>    <span class="punctuation">(</span><span class="parameter">store</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
<span class="prefix">+</span>      <span class="keyword">if</span> <span class="punctuation">(</span>roomId<span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="prefix">+</span>        <span class="keyword">return</span> <span class="function"><a href="/api/persister-partykit-client/functions/creation/createpartykitpersister/">createPartyKitPersister</a></span><span class="punctuation">(</span>
<span class="prefix">+</span>          store<span class="punctuation">,</span>
<span class="prefix">+</span>          <span class="keyword">new</span> <span class="class-name">PartySocket</span><span class="punctuation">(</span><span class="punctuation">{</span><span class="literal-property">host</span><span class="operator">:</span> <span class="constant">PARTYKIT_HOST</span><span class="punctuation">,</span> <span class="literal-property">room</span><span class="operator">:</span> roomId<span class="punctuation">}</span><span class="punctuation">)</span><span class="punctuation">,</span>
<span class="prefix">+</span>        <span class="punctuation">)</span><span class="punctuation">;</span>
<span class="prefix">+</span>      <span class="punctuation">}</span>
<span class="prefix">+</span>    <span class="punctuation">}</span><span class="punctuation">,</span>
<span class="prefix">+</span>    <span class="punctuation">[</span>roomId<span class="punctuation">]</span><span class="punctuation">,</span>
<span class="prefix">+</span>  <span class="punctuation">)</span><span class="punctuation">;</span>
</span></code></pre><p>Into this we also add an asynchronous &#x27;then&#x27; function that will fire once the <a href="/api/persisters/interfaces/persister/persister/"><code>Persister</code></a> is created. This will try to save the current local content to the room storage if it is empty (failing gracefully), and then load it if it is not. From here on, incremental changes are automatically saved and loaded over the websocket channel.</p><pre><code><span class="unchanged"><span class="prefix"> </span>    <span class="punctuation">}</span><span class="punctuation">,</span>
<span class="prefix"> </span>    <span class="punctuation">[</span>roomId<span class="punctuation">]</span><span class="punctuation">,</span>
</span><span class="inserted-sign"><span class="prefix">+</span>    <span class="keyword">async</span> <span class="punctuation">(</span><span class="parameter">persister</span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
<span class="prefix">+</span>      <span class="keyword">if</span> <span class="punctuation">(</span>persister<span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="prefix">+</span>        <span class="keyword">await</span> persister<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/save/startautosave/">startAutoSave</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="prefix">+</span>        <span class="keyword">await</span> persister<span class="punctuation">.</span><span class="function"><a href="/api/persisters/interfaces/persister/persister/methods/load/startautoload/">startAutoLoad</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="prefix">+</span>        checkpoints<span class="punctuation">.</span><span class="function"><a href="/api/checkpoints/interfaces/checkpoints/checkpoints/methods/lifecycle/clear/">clear</a></span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="prefix">+</span>      <span class="punctuation">}</span>
<span class="prefix">+</span>    <span class="punctuation">}</span><span class="punctuation">,</span>
<span class="prefix">+</span>    <span class="punctuation">[</span>checkpoints<span class="punctuation">]</span><span class="punctuation">,</span>
</span><span class="unchanged"><span class="prefix"> </span>  <span class="punctuation">)</span><span class="punctuation">;</span>
</span></code></pre><p>As we did for local storage, we also reset the checkpoints so this process does not appear on the undo stack.</p><h3 id="adding-a-share-button">Adding A Share Button</h3><p>All that remains is to give the user a way to create the room to start sharing! Let&#x27;s add a single component called Share to do that. It takes the room <a href="/api/common/type-aliases/identity/id/"><code>Id</code></a> value and function from the app-level state, and renders either a button to create a room and start sharing, or a link to the room that is already being shared to.</p><pre><code><span class="keyword">const</span> <span class="function-variable">Share</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="parameter"><span class="punctuation">{</span>roomId<span class="punctuation">,</span> createRoomId<span class="punctuation">}</span></span><span class="punctuation">)</span> <span class="operator">=></span> <span class="punctuation">{</span>
  <span class="keyword">return</span> <span class="punctuation">(</span>
    <span class="tag"><span class="tag"><span class="punctuation">&lt;</span>div</span> <span class="attr-name">id</span><span class="attr-value"><span class="punctuation">=</span><span class="punctuation">"</span>room<span class="punctuation">"</span></span><span class="punctuation">></span></span><span class="plain-text">
      </span><span class="punctuation">{</span>roomId <span class="operator">?</span> <span class="punctuation">(</span>
        <span class="tag"><span class="tag"><span class="punctuation">&lt;</span>a</span> <span class="attr-name">href</span><span class="script"><span class="script-punctuation">=</span><span class="punctuation">{</span><span class="string">'?'</span> <span class="operator">+</span> roomId<span class="punctuation">}</span></span> <span class="attr-name">target</span><span class="attr-value"><span class="punctuation">=</span><span class="punctuation">"</span>_blank<span class="punctuation">"</span></span><span class="punctuation">></span></span><span class="plain-text">
          &amp;#128279; Share link
        </span><span class="tag"><span class="tag"><span class="punctuation">&lt;/</span>a</span><span class="punctuation">></span></span>
      <span class="punctuation">)</span> <span class="operator">:</span> <span class="punctuation">(</span>
        <span class="tag"><span class="tag"><span class="punctuation">&lt;</span>span</span> <span class="attr-name">onClick</span><span class="script"><span class="script-punctuation">=</span><span class="punctuation">{</span>createRoomId<span class="punctuation">}</span></span><span class="punctuation">></span></span><span class="plain-text">&amp;#127880; Start sharing</span><span class="tag"><span class="tag"><span class="punctuation">&lt;/</span>span</span><span class="punctuation">></span></span>
      <span class="punctuation">)</span><span class="punctuation">}</span><span class="plain-text">
    </span><span class="tag"><span class="tag"><span class="punctuation">&lt;/</span>div</span><span class="punctuation">></span></span>
  <span class="punctuation">)</span><span class="punctuation">;</span>
<span class="punctuation">}</span><span class="punctuation">;</span>
</code></pre><p>We can add this to the top of the left-hand side of the app. For the sake of clarity, we remove the undo buttons for now:</p><pre><code><span class="deleted-sign"><span class="prefix">-</span>      <span class="operator">&lt;</span>Title <span class="operator">/</span><span class="operator">></span>
</span><span class="inserted-sign"><span class="prefix">+</span>      <span class="operator">&lt;</span>Share roomId<span class="operator">=</span><span class="punctuation">{</span>roomId<span class="punctuation">}</span> createRoomId<span class="operator">=</span><span class="punctuation">{</span>createRoomId<span class="punctuation">}</span> <span class="operator">/</span><span class="operator">></span>
</span><span class="unchanged"><span class="prefix"> </span>      <span class="operator">&lt;</span>NewTodo <span class="operator">/</span><span class="operator">></span>
<span class="prefix"> </span>      <span class="operator">&lt;</span>Types <span class="operator">/</span><span class="operator">></span>
</span><span class="deleted-sign"><span class="prefix">-</span>      <span class="operator">&lt;</span>UndoRedo <span class="operator">/</span><span class="operator">></span>
</span><span class="unchanged"><span class="prefix"> </span>      <span class="operator">&lt;</span>Todos <span class="operator">/</span><span class="operator">></span>
</span><span class="inserted-sign"><span class="prefix">+</span>      <span class="operator">&lt;</span>Title <span class="operator">/</span><span class="operator">></span>
</span><span class="unchanged"><span class="prefix"> </span>      <span class="operator">&lt;</span>StoreInspector <span class="operator">/</span><span class="operator">></span>
</span></code></pre><p>Let&#x27;s give it this share button some styling to make it prominent for this demo:</p><pre><code><span class="selector">#room</span> <span class="punctuation">{</span>
  <span class="selector">a,
  span</span> <span class="punctuation">{</span>
    <span class="property">background</span><span class="punctuation">:</span> #eee<span class="punctuation">;</span>
    <span class="property">border</span><span class="punctuation">:</span> <span class="variable">@border</span><span class="punctuation">;</span>
    <span class="property">color</span><span class="punctuation">:</span> #000<span class="punctuation">;</span>
    <span class="property">cursor</span><span class="punctuation">:</span> pointer<span class="punctuation">;</span>
    <span class="property">display</span><span class="punctuation">:</span> inline<span class="operator">-</span>block<span class="punctuation">;</span>
    <span class="property">padding</span><span class="punctuation">:</span> 0.5rem 1rem<span class="punctuation">;</span>
    <span class="property">text-align</span><span class="punctuation">:</span> center<span class="punctuation">;</span>
    <span class="property">text-decoration</span><span class="punctuation">:</span> none<span class="punctuation">;</span>
    <span class="property">width</span><span class="punctuation">:</span> 10rem<span class="punctuation">;</span>
  <span class="punctuation">}</span>
  <span class="selector">a</span> <span class="punctuation">{</span>
    <span class="property">border-color</span><span class="punctuation">:</span> <span class="variable">@accentColor</span><span class="punctuation">;</span>
    <span class="property">background</span><span class="punctuation">:</span> #ddd<span class="punctuation">;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</code></pre><p>And we are good to go! Clicking the &#x27;Start sharing&#x27; button will add a query string to the URL and start sharing to PartyKit. Clicking the &#x27;Share link&#x27; button will launch a new browser window with the same room <a href="/api/common/type-aliases/identity/id/"><code>Id</code></a> in it.</p><p>As you can see, the results are synchronized, but that&#x27;s also because the tabs of your browser are sharing the local storage we set up in a previous demo. A better demo is to launch a new window in incognito mode or even a completely different browser! If all goes well, you will still see the shared todo list.</p><h3 id="summary">Summary</h3><p>We went from local-first to collaboration with just a few chunks of code and the magic of PartyKit. Party on!</p></section>