{"title":"Todo App v4 (metrics)","description":"In this version of the Todo app, we add a Metrics object that tracks the number\nof todos of each type and how many are not yet done. This allows us to show\npeople how well they are getting through them.","html":"<script type=\"importmap\">\n  {\n    \"imports\": {\n      \"tinybase\": \"https://esm.sh/tinybase@8.0.0-beta.0\",\n      \"tinybase/persisters/persister-browser\": \"https://esm.sh/tinybase@8.0.0-beta.0/persisters/persister-browser\",\n      \"tinybase/ui-react\": \"https://esm.sh/tinybase@8.0.0-beta.0/ui-react\",\n      \"tinybase/ui-react-inspector\": \"https://esm.sh/tinybase@8.0.0-beta.0/ui-react-inspector\",\n      \"react\": \"https://esm.sh/react@^19.2.4\",\n      \"react/jsx-runtime\": \"https://esm.sh/react@^19.2.4/jsx-runtime\",\n      \"react-dom/client\": \"https://esm.sh/react-dom@^19.2.4/client\"\n    }\n  }\n</script>","css":"@accentColor: #d81b60;\n@spacing: 0.5rem;\n@border: 1px solid #ccc;\n@font-face {\n  font-family: Inter;\n  src: url(https://tinybase.org/fonts/inter.woff2) format(\"woff2\");\n}\n\nbody {\n  display: grid;\n  grid-template-columns: 35% minmax(0, 1fr);\n  grid-template-rows: auto 1fr;\n  box-sizing: border-box;\n  font-family: Inter, sans-serif;\n  letter-spacing: -0.04rem;\n  grid-gap: @spacing * 2 @spacing;\n  margin: 0;\n  min-height: 100vh;\n  padding: @spacing * 2;\n  * {\n    box-sizing: border-box;\n    outline-color: @accentColor;\n  }\n}\n\n#newTodo {\n  border: @border;\n  display: block;\n  font: inherit;\n  letter-spacing: inherit;\n  padding: @spacing;\n  width: 100%;\n}\n\n#todos {\n  grid-column: 2;\n  margin: 0;\n  padding: 0;\n}\n\n#todos .todo {\n  background: #fff;\n  border: @border;\n  display: flex;\n  margin-bottom: @spacing;\n  padding: @spacing;\n  .text {\n    cursor: pointer;\n    flex: 1;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    user-select: none;\n    white-space: nowrap;\n    &::before {\n      content: \"\\1F7E0\";\n      padding: 0 0.5rem 0 0.25rem;\n    }\n    &.done {\n      color: #ccc;\n      &::before {\n        content: \"\\2705\";\n      }\n    }\n  }\n}\n\n#types {\n  margin: 0;\n}\n\n#types .type {\n  cursor: pointer;\n  margin-bottom: @spacing;\n  user-select: none;\n  &.current {\n    color: @accentColor;\n  }\n}\n\n#todos .todo .type {\n  border: none;\n  color: #777;\n  font: inherit;\n  font-size: 0.8rem;\n  margin-top: 0.1rem;\n}","js":"import {useCallback, useState} from 'react';\nimport React from 'react';\nimport {createRoot} from 'react-dom/client';\nimport {createIndexes, createMetrics, createStore} from 'tinybase';\nimport {\n  createLocalPersister,\n  createSessionPersister,\n} from 'tinybase/persisters/persister-browser';\nimport {\n  CellView,\n  Provider,\n  SliceView,\n  useAddRowCallback,\n  useCellState,\n  useCreateIndexes,\n  useCreateMetrics,\n  useCreatePersister,\n  useCreateStore,\n  useMetric,\n  useValue,\n  useValueState,\n} from 'tinybase/ui-react';\nimport {Inspector} from 'tinybase/ui-react-inspector';\n\nconst TYPES = ['Home', 'Work', 'Archived'];\nconst SCHEMA = {\n  todos: {\n    text: {type: 'string'},\n    done: {type: 'boolean', default: false},\n    type: {type: 'string', default: 'Home'},\n  },\n};\nconst INITIAL_TODOS = {\n  todos: {\n    0: {text: 'Clean the floor', type: 'Home'},\n    1: {text: 'Install TinyBase', type: 'Work'},\n    2: {text: 'Book holiday', type: 'Archived'},\n  },\n};\n\nconst App = () => {\n  const store = useCreateStore(() => createStore().setTablesSchema(SCHEMA));\n  useCreatePersister(\n    store,\n    (store) => createLocalPersister(store, 'todos/store'),\n    [],\n    async (persister) => {\n      await persister.startAutoLoad([INITIAL_TODOS]);\n      await persister.startAutoSave();\n    },\n  );\n  const viewStore = useCreateStore(() =>\n    createStore().setValuesSchema({type: {type: 'string', default: 'Home'}}),\n  );\n  useCreatePersister(\n    viewStore,\n    (store) => createSessionPersister(store, 'todos/viewStore'),\n    [],\n    async (persister) => {\n      await persister.startAutoLoad();\n      await persister.startAutoSave();\n    },\n  );\n  const indexes = useCreateIndexes(store, (store) =>\n    createIndexes(store).setIndexDefinition('types', 'todos', 'type'),\n  );\n  const metrics = useCreateMetrics(store, (store) => {\n    const metrics = createMetrics(store);\n    metrics.setMetricDefinition('pending', 'todos', 'sum', (getCell) =>\n      !getCell('done') ? 1 : 0,\n    );\n    TYPES.forEach((type) => {\n      metrics.setMetricDefinition(type, 'todos', 'sum', (getCell) =>\n        getCell('type') == type && !getCell('done') ? 1 : 0,\n      );\n    });\n    return metrics;\n  });\n\n  return (\n    <Provider\n      store={store}\n      storesById={{viewStore}}\n      indexes={indexes}\n      metrics={metrics}\n    >\n      <Title />\n      <NewTodo />\n      <Types />\n      <Todos />\n      <Inspector />\n    </Provider>\n  );\n};\n\nwindow.addEventListener('load', () =>\n  createRoot(document.body).render(<App />),\n);\n\nconst Title = () => {\n  const pending = useMetric('pending');\n\n  return pending > 0 ? `Todo: ${pending}` : 'All done!';\n};\n\nconst NewTodo = () => {\n  const [text, setText] = useState('');\n  const type = useValue('type', 'viewStore');\n  const handleChange = useCallback(({target: {value}}) => setText(value), []);\n  const handleKeyDown = useAddRowCallback(\n    'todos',\n    ({which, target: {value: text}}) =>\n      which == 13 && text != '' ? {text, type} : undefined,\n    [type],\n    undefined,\n    () => setText(''),\n    [setText],\n  );\n\n  return (\n    <input\n      id=\"newTodo\"\n      onChange={handleChange}\n      onKeyDown={handleKeyDown}\n      placeholder=\"New Todo\"\n      value={text}\n    />\n  );\n};\n\nconst Todos = () => (\n  <ul id=\"todos\">\n    <SliceView\n      indexId=\"types\"\n      sliceId={useValue('type', 'viewStore')}\n      rowComponent={Todo}\n    />\n  </ul>\n);\n\nconst Todo = (props) => (\n  <li className=\"todo\">\n    <TodoText {...props} />\n    <TodoType {...props} />\n  </li>\n);\n\nconst TodoText = ({tableId, rowId}) => {\n  const [done, setDone] = useCellState(tableId, rowId, 'done');\n  const className = 'text' + (done ? ' done' : '');\n\n  return (\n    <span className={className} onClick={() => setDone(!done)}>\n      <CellView tableId={tableId} rowId={rowId} cellId=\"text\" />\n    </span>\n  );\n};\n\nconst Types = () => (\n  <ul id=\"types\">\n    {TYPES.map((type) => (\n      <Type key={type} type={type} />\n    ))}\n  </ul>\n);\n\nconst Type = ({type}) => {\n  const pending = useMetric(type);\n  const [currentType, setCurrentType] = useValueState('type', 'viewStore');\n  const className = 'type' + (type == currentType ? ' current' : '');\n\n  return (\n    <li className={className} onClick={() => setCurrentType(type)}>\n      {type}\n      {pending > 0 ? ` (${pending})` : ''}\n    </li>\n  );\n};\n\nconst TodoType = ({tableId, rowId}) => {\n  const [type, setType] = useCellState(tableId, rowId, 'type');\n\n  return (\n    <select\n      className=\"type\"\n      onChange={({target: {value}}) => setType(value)}\n      value={type}\n    >\n      {TYPES.map((type) => (\n        <option>{type}</option>\n      ))}\n    </select>\n  );\n};","css_pre_processor":"less","js_pre_processor":"typescript","editors":"012","tags":["tinybase"]}